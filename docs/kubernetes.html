<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Kubernetes | MLOps Architecture from scratch</title>
  <meta name="description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Kubernetes | MLOps Architecture from scratch" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  <meta name="github-repo" content="seblum/mlops-practice" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Kubernetes | MLOps Architecture from scratch" />
  
  <meta name="twitter:description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  

<meta name="author" content="Sebastian Blum" />


<meta name="date" content="2022-11-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="architecture.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#topics"><i class="fa fa-check"></i>Topics</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#a-work-in-progress"><i class="fa fa-check"></i>A work in progress</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>3</b> Terraform</a>
<ul>
<li class="chapter" data-level="3.1" data-path="terraform.html"><a href="terraform.html#prerequisites"><i class="fa fa-check"></i><b>3.1</b> Prerequisites</a></li>
<li class="chapter" data-level="3.2" data-path="terraform.html"><a href="terraform.html#basic-usage"><i class="fa fa-check"></i><b>3.2</b> Basic usage</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="terraform.html"><a href="terraform.html#terraform-init"><i class="fa fa-check"></i><b>3.2.1</b> terraform init</a></li>
<li class="chapter" data-level="3.2.2" data-path="terraform.html"><a href="terraform.html#terraform-validate"><i class="fa fa-check"></i><b>3.2.2</b> terraform validate</a></li>
<li class="chapter" data-level="3.2.3" data-path="terraform.html"><a href="terraform.html#terraform-plan"><i class="fa fa-check"></i><b>3.2.3</b> terraform plan</a></li>
<li class="chapter" data-level="3.2.4" data-path="terraform.html"><a href="terraform.html#terraform-apply"><i class="fa fa-check"></i><b>3.2.4</b> terraform apply</a></li>
<li class="chapter" data-level="3.2.5" data-path="terraform.html"><a href="terraform.html#terraform-destroy"><i class="fa fa-check"></i><b>3.2.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="terraform.html"><a href="terraform.html#core-concepts"><i class="fa fa-check"></i><b>3.3</b> Core Concepts</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="terraform.html"><a href="terraform.html#providers"><i class="fa fa-check"></i><b>3.3.1</b> Providers</a></li>
<li class="chapter" data-level="3.3.2" data-path="terraform.html"><a href="terraform.html#resources"><i class="fa fa-check"></i><b>3.3.2</b> Resources</a></li>
<li class="chapter" data-level="3.3.3" data-path="terraform.html"><a href="terraform.html#data-sources"><i class="fa fa-check"></i><b>3.3.3</b> Data Sources</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="terraform.html"><a href="terraform.html#state"><i class="fa fa-check"></i><b>3.4</b> State</a></li>
<li class="chapter" data-level="3.5" data-path="terraform.html"><a href="terraform.html#modules"><i class="fa fa-check"></i><b>3.5</b> Modules</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="terraform.html"><a href="terraform.html#input-variables"><i class="fa fa-check"></i><b>3.5.1</b> Input Variables</a></li>
<li class="chapter" data-level="3.5.2" data-path="terraform.html"><a href="terraform.html#output-variables"><i class="fa fa-check"></i><b>3.5.2</b> Output Variables</a></li>
<li class="chapter" data-level="3.5.3" data-path="terraform.html"><a href="terraform.html#local-variables"><i class="fa fa-check"></i><b>3.5.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="terraform.html"><a href="terraform.html#additional-tips-tricks"><i class="fa fa-check"></i><b>3.6</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="terraform.html"><a href="terraform.html#count"><i class="fa fa-check"></i><b>3.6.1</b> count</a></li>
<li class="chapter" data-level="3.6.2" data-path="terraform.html"><a href="terraform.html#for-each"><i class="fa fa-check"></i><b>3.6.2</b> for-each</a></li>
<li class="chapter" data-level="3.6.3" data-path="terraform.html"><a href="terraform.html#for"><i class="fa fa-check"></i><b>3.6.3</b> for</a></li>
<li class="chapter" data-level="3.6.4" data-path="terraform.html"><a href="terraform.html#workspaces"><i class="fa fa-check"></i><b>3.6.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="terraform.html"><a href="terraform.html#putting-it-together"><i class="fa fa-check"></i><b>3.7</b> Putting it together</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="terraform.html"><a href="terraform.html#root"><i class="fa fa-check"></i><b>3.7.1</b> Root</a></li>
<li class="chapter" data-level="3.7.2" data-path="terraform.html"><a href="terraform.html#networking"><i class="fa fa-check"></i><b>3.7.2</b> Networking</a></li>
<li class="chapter" data-level="3.7.3" data-path="terraform.html"><a href="terraform.html#ec2"><i class="fa fa-check"></i><b>3.7.3</b> EC2</a></li>
<li class="chapter" data-level="3.7.4" data-path="terraform.html"><a href="terraform.html#s3"><i class="fa fa-check"></i><b>3.7.4</b> S3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="todo.html"><a href="todo.html"><i class="fa fa-check"></i><b>4</b> TODO</a></li>
<li class="chapter" data-level="5" data-path="architecture.html"><a href="architecture.html"><i class="fa fa-check"></i><b>5</b> Architecture</a>
<ul>
<li class="chapter" data-level="5.1" data-path="architecture.html"><a href="architecture.html#airflow"><i class="fa fa-check"></i><b>5.1</b> Airflow</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="architecture.html"><a href="architecture.html#rds"><i class="fa fa-check"></i><b>5.1.1</b> RDS</a></li>
<li class="chapter" data-level="5.1.2" data-path="architecture.html"><a href="architecture.html#github-sync"><i class="fa fa-check"></i><b>5.1.2</b> Github Sync</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="architecture.html"><a href="architecture.html#mlflow"><i class="fa fa-check"></i><b>5.2</b> MLFlow</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="architecture.html"><a href="architecture.html#airflow-integration"><i class="fa fa-check"></i><b>5.2.1</b> Airflow integration</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="architecture.html"><a href="architecture.html#eks-cluster"><i class="fa fa-check"></i><b>5.3</b> EKS Cluster</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="architecture.html"><a href="architecture.html#user-management"><i class="fa fa-check"></i><b>5.3.1</b> User Management</a></li>
<li class="chapter" data-level="5.3.2" data-path="architecture.html"><a href="architecture.html#monitoring"><i class="fa fa-check"></i><b>5.3.2</b> Monitoring</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="architecture.html"><a href="architecture.html#deployment"><i class="fa fa-check"></i><b>5.4</b> Deployment</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>6</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="6.1" data-path="kubernetes.html"><a href="kubernetes.html#prerequisites-1"><i class="fa fa-check"></i><b>6.1</b> Prerequisites</a></li>
<li class="chapter" data-level="6.2" data-path="kubernetes.html"><a href="kubernetes.html#nodes"><i class="fa fa-check"></i><b>6.2</b> Nodes</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="kubernetes.html"><a href="kubernetes.html#master-control-plane"><i class="fa fa-check"></i><b>6.2.1</b> Master &amp; Control Plane</a></li>
<li class="chapter" data-level="6.2.2" data-path="kubernetes.html"><a href="kubernetes.html#worker-nodes"><i class="fa fa-check"></i><b>6.2.2</b> Worker Nodes</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="kubernetes.html"><a href="kubernetes.html#pods"><i class="fa fa-check"></i><b>6.3</b> Pods</a>
<ul>
<li class="chapter" data-level="" data-path="kubernetes.html"><a href="kubernetes.html#imperative-declarative-management"><i class="fa fa-check"></i>Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="kubernetes.html"><a href="kubernetes.html#deployments"><i class="fa fa-check"></i><b>6.4</b> Deployments</a></li>
<li class="chapter" data-level="6.5" data-path="kubernetes.html"><a href="kubernetes.html#services"><i class="fa fa-check"></i><b>6.5</b> Services</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="kubernetes.html"><a href="kubernetes.html#exemplary-setup-of-database-and-frontend-microservices"><i class="fa fa-check"></i><b>6.5.1</b> Exemplary setup of database and frontend microservices</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="kubernetes.html"><a href="kubernetes.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>6.6</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="6.7" data-path="kubernetes.html"><a href="kubernetes.html#namespaces"><i class="fa fa-check"></i><b>6.7</b> Namespaces</a></li>
<li class="chapter" data-level="6.8" data-path="kubernetes.html"><a href="kubernetes.html#service-discovery"><i class="fa fa-check"></i><b>6.8</b> Service Discovery</a></li>
<li class="chapter" data-level="6.9" data-path="kubernetes.html"><a href="kubernetes.html#volume-storage"><i class="fa fa-check"></i><b>6.9</b> Volume &amp; Storage</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="kubernetes.html"><a href="kubernetes.html#emptydir-volume"><i class="fa fa-check"></i><b>6.9.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="6.9.2" data-path="kubernetes.html"><a href="kubernetes.html#hostpath-volume"><i class="fa fa-check"></i><b>6.9.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="6.9.3" data-path="kubernetes.html"><a href="kubernetes.html#persistent-volumes"><i class="fa fa-check"></i><b>6.9.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="kubernetes.html"><a href="kubernetes.html#configmaps"><i class="fa fa-check"></i><b>6.10</b> ConfigMaps</a></li>
<li class="chapter" data-level="6.11" data-path="kubernetes.html"><a href="kubernetes.html#secrets"><i class="fa fa-check"></i><b>6.11</b> Secrets</a>
<ul>
<li class="chapter" data-level="6.11.1" data-path="kubernetes.html"><a href="kubernetes.html#exemplary-use-case-of-secrets"><i class="fa fa-check"></i><b>6.11.1</b> Exemplary use case of secrets</a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="kubernetes.html"><a href="kubernetes.html#health-checks"><i class="fa fa-check"></i><b>6.12</b> Health Checks</a>
<ul>
<li class="chapter" data-level="6.12.1" data-path="kubernetes.html"><a href="kubernetes.html#liveness-probe"><i class="fa fa-check"></i><b>6.12.1</b> Liveness Probe</a></li>
<li class="chapter" data-level="6.12.2" data-path="kubernetes.html"><a href="kubernetes.html#readiness-probe"><i class="fa fa-check"></i><b>6.12.2</b> Readiness Probe</a></li>
</ul></li>
<li class="chapter" data-level="6.13" data-path="kubernetes.html"><a href="kubernetes.html#resource-management"><i class="fa fa-check"></i><b>6.13</b> Resource Management</a></li>
<li class="chapter" data-level="6.14" data-path="kubernetes.html"><a href="kubernetes.html#deamon-sets"><i class="fa fa-check"></i><b>6.14</b> Deamon Sets</a></li>
<li class="chapter" data-level="6.15" data-path="kubernetes.html"><a href="kubernetes.html#statefulsets"><i class="fa fa-check"></i><b>6.15</b> StatefulSets</a></li>
<li class="chapter" data-level="6.16" data-path="kubernetes.html"><a href="kubernetes.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>6.16</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Architecture from scratch</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="kubernetes" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Kubernetes<a href="kubernetes.html#kubernetes" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><strong>What is Kubernetes?</strong></p>
<p>Kubernetes (short: K8s) is greek and means pilot. K8s is an applications orchestrator that originated from Google and is open source. Beeing an application orchestrator, K8s deploys and manages application containers. It scales up and down so called Pod (A Pod manages a container) as needed and allows for zero downtime as well as the possibility of rollbacks. Thus, the meaning of <em>pilot</em> relates to its functionining in piloting containers.</p>
<div id="prerequisites-1" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Prerequisites<a href="kubernetes.html#prerequisites-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As a prerequisites to go through this tutorial and implement the scripts one has to have Docker installed, Kubectl to interact via the command line with K8s, as well as Minikube to run a K8s cluster on a local machine. Please refer to the corresponding sites.</p>
</div>
<div id="nodes" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Nodes<a href="kubernetes.html#nodes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A K8s Cluster usually consistes of a set of nodes. A Node can hereby be a virtual machine (VM) in the cloud, e.g. AWS, Azure, or GCP, or a node can also be of course a physical on-premise instance. K8s distinguishes the nodes between a <em>master node</em> and <em>worker nodes</em>. The master node is basically the brain of the cluster. This is where everything is organized, handled, and managed. In comparison, a worker nodes is where the heavy lifting is happening, such as running application. Both, master and worker nodes communicate with each other via the so called kubelet. One cluster has only one master node and usually multiple worker nodes.</p>
<div class="figure">
<img src="images/04-Kubernetes/k8s-cluster.png" alt="" />
<p class="caption">K8s Cluster</p>
</div>
<div id="master-control-plane" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Master &amp; Control Plane<a href="kubernetes.html#master-control-plane" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To be able to work as the brain of the cluster, the master node contains a controll plane made of several components, each of which serves a different function.</p>
<ul>
<li>Scheduler</li>
<li>Cluster Store</li>
<li>API Server</li>
<li>Controller Manager</li>
<li>Cloud Controller Manager</li>
</ul>
<div class="figure">
<img src="images/04-Kubernetes/master-node.png" alt="" />
<p class="caption">Master Node</p>
</div>
<div id="api-server" class="section level5 hasAnchor" number="6.2.1.0.1">
<h5><span class="header-section-number">6.2.1.0.1</span> API Server<a href="kubernetes.html#api-server" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The api servers serves as the connection between the frontend and the K8s controll plane. All communications, external and interal, go through it. Frontend to Kubernetes Controll Plane. It exposes a restful api on port 443 to allow communication, as well as performes authentication and authorization checks. Whenever we perform something on the K8s cluster, e.g. using a command like <code>kubectl apply -f &lt;file.yaml&gt;</code>, we communicate with the api server (what we do here is shown in the section about pods).</p>
</div>
<div id="cluster-store" class="section level5 hasAnchor" number="6.2.1.0.2">
<h5><span class="header-section-number">6.2.1.0.2</span> Cluster store<a href="kubernetes.html#cluster-store" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The cluster store stores the configuration and state of the entire cluster. It is a distributed key-value data store and the single source of truth database of the cluster. As in the example before, whenever we apply a command like <code>kubectl apply -f &lt;file.yaml&gt;</code>, the file is stored on the cluster store to store the configuration.</p>
</div>
<div id="scheduler" class="section level5 hasAnchor" number="6.2.1.0.3">
<h5><span class="header-section-number">6.2.1.0.3</span> Scheduler<a href="kubernetes.html#scheduler" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The scheduler of the control plane watches for new workloads/pods and assigns them to a node based on several scheduling factors. These factors include whether a node is healthy, whether there are enough resources available, whether the port is available, or according to affinity or anti-affinity rules.</p>
</div>
<div id="controller-manager" class="section level5 hasAnchor" number="6.2.1.0.4">
<h5><span class="header-section-number">6.2.1.0.4</span> Controller manager<a href="kubernetes.html#controller-manager" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The controller manager is a daemon that manages the control loop. This means, the controller manager is basically a controller of other controllers. Each controller watches the api server for changes to their state. Whenever a current state of a controller does not match the desired state, the control manager administers the changes. These controllers are for example replicasets, endpoints, namespace, or service accounts. There is also the cloud controller manager, which is responsible to interact with the underlying cloud infrastructure.</p>
</div>
</div>
<div id="worker-nodes" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Worker Nodes<a href="kubernetes.html#worker-nodes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There worker nodes are the part of the cluster where the heavy lifting happens. Their VMs (or physical machines) often run linux and thus provide a suitable and running environment for each application.</p>
<div class="figure">
<img src="images/04-Kubernetes/worker-node.png" alt="" />
<p class="caption">Worker Node</p>
</div>
<p>A worker node consists of three main components.</p>
<ul>
<li>Kubelet</li>
<li>Container runtime</li>
<li>Kube proxy</li>
</ul>
<div id="kubelet" class="section level5 hasAnchor" number="6.2.2.0.1">
<h5><span class="header-section-number">6.2.2.0.1</span> Kubelet<a href="kubernetes.html#kubelet" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The kubelet is the main agent of a worker node that runs on every single node. It receives pod definitions from the API server and interacts with the container runtime to run containers associated with the corresponding pods. The kubelet also reports node and pod state to the master node.</p>
</div>
<div id="container-runtime" class="section level5 hasAnchor" number="6.2.2.0.2">
<h5><span class="header-section-number">6.2.2.0.2</span> Container runtime<a href="kubernetes.html#container-runtime" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The container runtime is responsible to pull images from container registries, e.g. from DockerHub, or AWS ECR, as well as starting, and stoping containers. The container runtime thus abstracts container management for K8s and runs a Container Runtime Interface (CRI) within.</p>
</div>
<div id="kube-proxy" class="section level5 hasAnchor" number="6.2.2.0.3">
<h5><span class="header-section-number">6.2.2.0.3</span> Kube-proxy<a href="kubernetes.html#kube-proxy" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The kube-proxy runs on every node via a DaemondSet. It is responsible for network communications by maintaining network rules to allow communication to pods from inside and outside the cluster. If two pods want to talk to each other, the kube-proxy handles their communication. Each node of the cluster gets its own unique IP adress. The kube-proxy handels the local cluster networking as well as routing the network traffic to a load balanced service.</p>
</div>
</div>
</div>
<div id="pods" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Pods<a href="kubernetes.html#pods" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A pod is the smallest deployable unit in K8s (In contrast to K8s, the smallest deployable unit for docker are containers.). Therefore, a pod is a running process that runs on a clusters’ node. Within a pod, there is always one <em>main container</em> representing the application (in whatever language written, e.g. JS, Python, Go). There also may or may not be <em>init containers</em>, and/or <em>side containers</em>. Init containers are containers that are executed before the main container. Side containers are containers that support the main containers, e.g. a container that acts as a proxy to your main container. There may be volumes specified within a pod, which enables containers to share and store data.</p>
<div class="figure">
<img src="images/04-Kubernetes/pod.png" alt="" />
<p class="caption">Pod</p>
</div>
<p>The containers running within a pod communicate with each other using localhost and whatever port they expose. The port itself has a unique ip adress, which enables outward communication between pods.</p>
<p>The problem is that a pods does not have a long lifetime (also denoted as ephemeral) and is disposable. This suggests to never create a pod on its own within a K8s cluster and to rather use controllers instead to deploy and maintain a pods lifecycle, e.g. controllers like <em>Deployments</em>. In general, managing ressources in K8s is done via an imperative or declarative management.</p>
<div id="imperative-declarative-management" class="section level3 unnumbered hasAnchor">
<h3>Imperative &amp; Declarative Management<a href="kubernetes.html#imperative-declarative-management" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Imperative management means managing the pods via a CLI and specifying all necessary parameters using it. It is good for learning, troubleshooting, and experimenting on the cluster. In contrast, the declarative approach uses a yaml file to state all necessary parameters needed for a ressource, and then using the CLI to administer the changes. The declarative approach is reproducible, which means the same configuration can be applied in different environments (prod/dev). This is best practice to use when building a cluster. As stated, this differentiation does not only hold for pods, but for all ressources within a cluster.</p>
<div id="imperative-management" class="section level4 unnumbered hasAnchor">
<h4>Imperative Management<a href="kubernetes.html#imperative-management" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="kubernetes.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># start a pod by specifying the pods name, </span></span>
<span id="cb27-2"><a href="kubernetes.html#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the container image to run, and the port exposed</span></span>
<span id="cb27-3"><a href="kubernetes.html#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> run <span class="op">&lt;</span>pod-name<span class="op">&gt;</span> --image=<span class="st">&quot;&lt;image-name&gt;&quot;</span> <span class="at">--port</span><span class="op">=</span>80</span>
<span id="cb27-4"><a href="kubernetes.html#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="kubernetes.html#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># run following command to test the pod specified</span></span>
<span id="cb27-6"><a href="kubernetes.html#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># It will forward to localhost:8080</span></span>
<span id="cb27-7"><a href="kubernetes.html#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward pod/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span></code></pre></div>
</div>
<div id="declarative-management-configuration" class="section level4 unnumbered hasAnchor">
<h4>Declarative Management / Configuration<a href="kubernetes.html#declarative-management-configuration" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Declarative configuration is done using a <em>yaml</em> format, which works on key-value pairs.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb28-1"><a href="kubernetes.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pod.yaml</span></span>
<span id="cb28-2"><a href="kubernetes.html#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb28-3"><a href="kubernetes.html#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># specify which kind of configuration this is</span></span>
<span id="cb28-4"><a href="kubernetes.html#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># lets configure a simple pod</span></span>
<span id="cb28-5"><a href="kubernetes.html#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb28-6"><a href="kubernetes.html#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># metadata will be explained later on in more detail</span></span>
<span id="cb28-7"><a href="kubernetes.html#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb28-8"><a href="kubernetes.html#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb28-9"><a href="kubernetes.html#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb28-10"><a href="kubernetes.html#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb28-11"><a href="kubernetes.html#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb28-12"><a href="kubernetes.html#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">  # remember: a pod is a selection of one or more containers</span></span>
<span id="cb28-13"><a href="kubernetes.html#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">  # we could therefore specify multiple containers</span></span>
<span id="cb28-14"><a href="kubernetes.html#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb28-15"><a href="kubernetes.html#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">    # specify the container name</span></span>
<span id="cb28-16"><a href="kubernetes.html#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello</span></span>
<span id="cb28-17"><a href="kubernetes.html#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">  # specify which container image should be pulled</span></span>
<span id="cb28-18"><a href="kubernetes.html#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:cat-v1</span></span>
<span id="cb28-19"><a href="kubernetes.html#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">  # ressource configurations will be handled later as well</span></span>
<span id="cb28-20"><a href="kubernetes.html#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ressources</span><span class="kw">:</span></span>
<span id="cb28-21"><a href="kubernetes.html#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb28-22"><a href="kubernetes.html#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb28-23"><a href="kubernetes.html#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb28-24"><a href="kubernetes.html#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">  # specify the port on which the container should be exposed</span></span>
<span id="cb28-25"><a href="kubernetes.html#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">  # similar to the imperative approach</span></span>
<span id="cb28-26"><a href="kubernetes.html#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb28-27"><a href="kubernetes.html#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ContainerPorts</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
<p>Appyl this declarative configuration using the following kubectl command via the CLI.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="kubernetes.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="st">&quot;file-name.yaml&quot;</span></span>
<span id="cb29-2"><a href="kubernetes.html#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="kubernetes.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># similar to before, run following to test your pod on localhost:8080</span></span>
<span id="cb29-4"><a href="kubernetes.html#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward pod/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span></code></pre></div>
</div>
<div id="kubectl" class="section level4 hasAnchor" number="6.3.0.1">
<h4><span class="header-section-number">6.3.0.1</span> Kubectl<a href="kubernetes.html#kubectl" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One word to interacting with the cluster using the CLI. In general, <em>kubectl</em> is used to interact with the K8s cluster. This allows to run and apply pod configurations such as seen before, as well as the already shown port forwarding. We can also inspect the cluster, see what ressources are running on which nodes, see their configurations, and watch their logs. A small selection of commands are shown below.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="kubernetes.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># forward the pods to localhost:8080</span></span>
<span id="cb30-2"><a href="kubernetes.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward <span class="op">&lt;</span>ressource<span class="op">&gt;</span>/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span>
<span id="cb30-3"><a href="kubernetes.html#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="kubernetes.html#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show all pods currently running in the cluster</span></span>
<span id="cb30-5"><a href="kubernetes.html#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods</span>
<span id="cb30-6"><a href="kubernetes.html#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="kubernetes.html#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># delete a specific pod</span></span>
<span id="cb30-8"><a href="kubernetes.html#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> delete pods <span class="op">&lt;</span>pod-name<span class="op">&gt;</span></span>
<span id="cb30-9"><a href="kubernetes.html#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="kubernetes.html#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># delete a previously applied configuration</span></span>
<span id="cb30-11"><a href="kubernetes.html#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> delete <span class="at">-f</span> <span class="op">&lt;</span>file-name<span class="op">&gt;</span></span>
<span id="cb30-12"><a href="kubernetes.html#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="kubernetes.html#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># show all instances of a specific resource running on the cluster</span></span>
<span id="cb30-14"><a href="kubernetes.html#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># (nodes, pods, deployments, statefulsets, etc) </span></span>
<span id="cb30-15"><a href="kubernetes.html#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get <span class="op">&lt;</span>resource<span class="op">&gt;</span></span>
<span id="cb30-16"><a href="kubernetes.html#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="kubernetes.html#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># describe and show specific settings of a pods</span></span>
<span id="cb30-18"><a href="kubernetes.html#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe pod <span class="op">&lt;</span>pod-name<span class="op">&gt;</span></span></code></pre></div>
</div>
</div>
</div>
<div id="deployments" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Deployments<a href="kubernetes.html#deployments" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We should never deploy a pod using <code>kind:Pod</code>. Pods are ephemeral, so never treat them like pets. They do not heal on their own and if a pod is terminated, it does not restart by themselves. This is dangerous as there should always be one replica running of and application. This demands for a mechanism for the application to self heal and this is exactly where <em>Deployments</em> and <em>ReplicaSets</em> come in to solve the problem.</p>
<p>In general, Pods should be managed through Deployments. The purpose of a Deployment is to facilitate software deployment. They manage releases of a new application, they provide zero downtime of an application and create a ReplicaSet behind the scenes. K8s will take care of the full deployment process when applying a Deployment, even if we want to make a rolling update to change the version.</p>
<div id="replicasets" class="section level4 unnumbered hasAnchor">
<h4>Replicasets<a href="kubernetes.html#replicasets" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A ReplicaSet makes sure that a desired number of pods is running. When looking at Pods’ name of a Deployment, it usually has a random string attached. This is because a deployment can have multiple replicas and the random suffix ensures a different name after all. The way ReplicaSets work is that they implement a background control loop that checks the desired number of pods are always present on the cluster. We can specify the number of replicas by creating a yaml-file of a Deployment, similar to previous specifications done to a Pod. As a reminder, the Deployment can be applied using the <code>kubectl apply -f</code> as well.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb31-1"><a href="kubernetes.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># deployment.yaml</span></span>
<span id="cb31-2"><a href="kubernetes.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb31-3"><a href="kubernetes.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># specify that we want a deployment</span></span>
<span id="cb31-4"><a href="kubernetes.html#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb31-5"><a href="kubernetes.html#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb31-6"><a href="kubernetes.html#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb31-7"><a href="kubernetes.html#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb31-8"><a href="kubernetes.html#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">  # specify number of replicas</span></span>
<span id="cb31-9"><a href="kubernetes.html#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb31-10"><a href="kubernetes.html#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb31-11"><a href="kubernetes.html#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb31-12"><a href="kubernetes.html#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb31-13"><a href="kubernetes.html#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb31-14"><a href="kubernetes.html#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb31-15"><a href="kubernetes.html#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb31-16"><a href="kubernetes.html#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb31-17"><a href="kubernetes.html#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb31-18"><a href="kubernetes.html#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb31-19"><a href="kubernetes.html#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb31-20"><a href="kubernetes.html#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:cat-v1</span></span>
<span id="cb31-21"><a href="kubernetes.html#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb31-22"><a href="kubernetes.html#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb31-23"><a href="kubernetes.html#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb31-24"><a href="kubernetes.html#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb31-25"><a href="kubernetes.html#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb31-26"><a href="kubernetes.html#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
</div>
<div id="rolling-updates" class="section level4 hasAnchor" number="6.4.0.1">
<h4><span class="header-section-number">6.4.0.1</span> Rolling updates<a href="kubernetes.html#rolling-updates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A rolling update means that a new version of the application is rolled out. In general, a basic deployments strategy will delete every single pod before it creates a new version. This is very dangerous since there is downtime. The preferred strategy is to perform a rolling update. This ensures keeping traffic to the previous version until the new one is up and running and alternates traffic until the new version is fully healthy. K8s perfoms the update of an application while the application is up and running. For example, when there are two replicasets running, one with version v1 and one with v2, K8s performs the update such that it only scales v1 down when v2 is already up and running and the traffic has been redirected to v2 as well. How do the deployments need to be configured for that?</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="kubernetes.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># deployment_rolling-update.yaml</span></span>
<span id="cb32-2"><a href="kubernetes.html#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb32-3"><a href="kubernetes.html#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb32-4"><a href="kubernetes.html#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb32-5"><a href="kubernetes.html#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb32-6"><a href="kubernetes.html#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb32-7"><a href="kubernetes.html#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb32-8"><a href="kubernetes.html#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">  # a few new things have been added here</span></span>
<span id="cb32-9"><a href="kubernetes.html#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">revisionHistoryLimit</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb32-10"><a href="kubernetes.html#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">  # specify the deployments strategy</span></span>
<span id="cb32-11"><a href="kubernetes.html#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb32-12"><a href="kubernetes.html#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> RollingUpdate</span></span>
<span id="cb32-13"><a href="kubernetes.html#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">rollingUpdate</span><span class="kw">:</span></span>
<span id="cb32-14"><a href="kubernetes.html#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">      # only one pod at a time to become unavailable</span></span>
<span id="cb32-15"><a href="kubernetes.html#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">      # in our case scaling down of v1</span></span>
<span id="cb32-16"><a href="kubernetes.html#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">maxUnavailable</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb32-17"><a href="kubernetes.html#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">      # never have more than one pod above the mentioned replicas</span></span>
<span id="cb32-18"><a href="kubernetes.html#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">      # with three replicas, there will never be 5 pods running during a rollout</span></span>
<span id="cb32-19"><a href="kubernetes.html#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">maxSurge</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb32-20"><a href="kubernetes.html#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb32-21"><a href="kubernetes.html#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb32-22"><a href="kubernetes.html#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb32-23"><a href="kubernetes.html#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb32-24"><a href="kubernetes.html#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb32-25"><a href="kubernetes.html#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb32-26"><a href="kubernetes.html#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb32-27"><a href="kubernetes.html#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb32-28"><a href="kubernetes.html#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co">        # just an annotation the get the version change</span></span>
<span id="cb32-29"><a href="kubernetes.html#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">kubernetes.io/change-cause</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/mlops-public:cat-v2&quot;</span></span>
<span id="cb32-30"><a href="kubernetes.html#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb32-31"><a href="kubernetes.html#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb32-32"><a href="kubernetes.html#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb32-33"><a href="kubernetes.html#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">      # only change specification of the image to v2, k8s performs the update itself</span></span>
<span id="cb32-34"><a href="kubernetes.html#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:cat-v2</span></span>
<span id="cb32-35"><a href="kubernetes.html#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb32-36"><a href="kubernetes.html#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb32-37"><a href="kubernetes.html#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb32-38"><a href="kubernetes.html#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb32-39"><a href="kubernetes.html#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb32-40"><a href="kubernetes.html#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
<p>The changes can be applied as well using <code>kubectl apply -f "file-name.yaml"</code>. Good to know, K8s is not deleting the replicasets of previous versions. They are still stored on the Cluster Store. The <code>spec.revisionHistory: &lt;?&gt;</code> state in the yaml denoted this. The last ten previous versions are stored on default. However, it doesn’t really make sense to keep more such for example in the previous yaml where there are the last 20 versions specified. This enables to perform <strong>Rollbacks</strong> to previous versions. To not have discrepancies in a cluster, one should always update using the declarative approach. Below stated are a number of commands that trigger and help with a rollback or with rollouts in general.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="kubernetes.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the status of the current deployment process</span></span>
<span id="cb33-2"><a href="kubernetes.html#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout status deployments <span class="op">&lt;</span>name<span class="op">&gt;</span></span>
<span id="cb33-3"><a href="kubernetes.html#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="kubernetes.html#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pause the rollout of the deployment.</span></span>
<span id="cb33-5"><a href="kubernetes.html#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout pause</span>
<span id="cb33-6"><a href="kubernetes.html#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="kubernetes.html#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check the rollout history of a specific deployment</span></span>
<span id="cb33-8"><a href="kubernetes.html#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout history deployment <span class="op">&lt;</span>name<span class="op">&gt;</span></span>
<span id="cb33-9"><a href="kubernetes.html#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="kubernetes.html#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># undo the rollout of a deployment and switch to previous version</span></span>
<span id="cb33-11"><a href="kubernetes.html#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout undo deployment <span class="op">&lt;</span>name<span class="op">&gt;</span></span>
<span id="cb33-12"><a href="kubernetes.html#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="kubernetes.html#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># goes back to a specific revision</span></span>
<span id="cb33-14"><a href="kubernetes.html#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># there is a limit of history and k8s only keeps 10 previous versions</span></span>
<span id="cb33-15"><a href="kubernetes.html#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> rollout undo deployment <span class="op">&lt;</span>name<span class="op">&gt;</span> --to-revision=</span></code></pre></div>
</div>
</div>
<div id="services" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Services<a href="kubernetes.html#services" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To overall question when deploying an application is how we can access it. Each individual Pod has its own IP address. Thereby, the client can access this Pod via its IP address. Previously, we have made the app available via <code>kubectl port-forward</code> by forwarding the Pods’ IP to localhost. However, should only be done for testing purposes and is not a reliable and stable way to enable access. Since Pods are ephemeral, the client cannot rely on the ip address alone. For example, if an application is scaled up or down, there will be new IPs associated with each new Pod.</p>
<div class="figure">
<img src="images/04-Kubernetes/services.png" alt="" />
<p class="caption">Services</p>
</div>
<p>Instead, <em>Services</em> should be used. A service is an abstract way to expose an application as a network service. The service can connect access to a pod via an interal reference, so a change of the Pods IP will not interfere with its accessibility. The service itself has a stable IP adress, a stable DNS name, and a stable port. This allows for a reliable and stable connection from the client to the service, which can then direct the traffic to the pod. There are different types of Services.</p>
<ul>
<li>ClusterIP (Default)</li>
<li>NodePort</li>
<li>ExternalName</li>
<li>LoadBalancer</li>
</ul>
<div id="clusterip" class="section level4 hasAnchor" number="6.5.0.1">
<h4><span class="header-section-number">6.5.0.1</span> ClusterIP<a href="kubernetes.html#clusterip" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The ClusterIP is the default K8s service. This service type will be chosen if no specific type is selected. The ClusterIP is used for cluster internal access and does not allow for external communication. If one Pod wants to talk to another Pod inside the cluster, it will use ClusterIP to do so. The service will allow and send traffic to any pod that is healthy.</p>
</div>
<div id="nodeport" class="section level4 hasAnchor" number="6.5.0.2">
<h4><span class="header-section-number">6.5.0.2</span> NodePort<a href="kubernetes.html#nodeport" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The NodePort service allows to open a static port simultaneously on all nodes. Its range lies between between 30.000/32.767. If a client wants to communicate with a node of the cluster, the client directly communicates with the node via its IP address. When the request reaches the port of the node, the NodePort service handles the request and forwards it to the specifically marked pod. This way, an application running on a pod can be exposed directly on a nodes’ IP under a specific port. You’ll be able to contact the NodePort Service from outside the cluster by requesting <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code>.</p>
<p>Using a NodePort is beneficial for example when a request is sent to a node without a pod. The NodePort service will forward the request to a node which has a healthy associated pod running. However, only having one service specified per port is also a disadvantage. Having one ingress and multiple services is more desireable. The point of running K8s in the cloud is to scale up and down and if the NodeIP address changes, then we have a problem. So we should not aim to access a Node IP directly in the first place</p>
<p>If applying below example using the frontend-deployment and the backend-deployment, we can access the frontend using the nodeport. Since using minikube, we can access the service by using <code>minikube service frontend-node --url</code>. Using the given IP adress it is possible to access the frontend using the NodePort service. We can also test the NodePort service when inside of a node. When accessing a node e.g. via <code>minikube ssh</code>, we can run <code>curl localhost:PORT/</code> inside the node to derive the to derive the website data from the frontend.</p>
</div>
<div id="loadbalancer" class="section level4 hasAnchor" number="6.5.0.3">
<h4><span class="header-section-number">6.5.0.3</span> LoadBalancer<a href="kubernetes.html#loadbalancer" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Loadbalancers are a standard way of exposing applications to the extern, for example the internet. Loadbalancers automatically distribute incoming traffic across multiple targets to balance the load in an equal level. If K8s is running on the cloud, e.g. AWS or GCP, a Network Load Balancer (NLB) is created. The Cloud Controller Manager (remember the Controller Manager of a Node) is resposible to talk to the underlying cloud provier. In Minikube, the external IP to access the application via the LoadBalancer can be exposed using the command <code>minikube tunnel</code>.</p>
</div>
<div id="default-kubernetes-services" class="section level4 hasAnchor" number="6.5.0.4">
<h4><span class="header-section-number">6.5.0.4</span> default kubernetes services<a href="kubernetes.html#default-kubernetes-services" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>There are also default K8s services created automatically to access K8s with the K8s API. Check the endpoints of the <em>kubernetes</em> service and the endpoints of the <em>api-service</em> pod within kube-system namespace. They should be the same.</p>
<p>It is also possible to show all endpoints of the cluster using</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="kubernetes.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get endpoints</span></code></pre></div>
</div>
<div id="exemplary-setup-of-database-and-frontend-microservices" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Exemplary setup of database and frontend microservices<a href="kubernetes.html#exemplary-setup-of-database-and-frontend-microservices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following example show the deployment and linking of two different deployments. A <em>frontend-deployment.yaml</em> that pulls a container running a <a href="https://streamlit.io/">Streamlit App</a>, and a <em>database-deployment.yaml</em> that runs a flask application exposing a dictionary as an exemplary and very basic database. The frontend accesses the flask database using a ClusterIP Service linked to the database-deployment. It also exposes an external IP via a Loadbalancer Service, so the streamlit app can be accesses via the browser and without the use of <code>kubectl port-forward</code>. Since minikube is a closed network, use <code>minikube tunnel</code> to allow access to it using the LoadBalancer.</p>
<p>When looking at the ClusterIP service with <code>kubectl describe service backendflask</code> the IP address of the service to exposes, as well as the listed endpoints that connect to the database-deployments are shown. One can compare them to the IPs of the actual deployments - they are the same.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb35-1"><a href="kubernetes.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># services_frontend-deployment.yaml</span></span>
<span id="cb35-2"><a href="kubernetes.html#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb35-3"><a href="kubernetes.html#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb35-4"><a href="kubernetes.html#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb35-5"><a href="kubernetes.html#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-6"><a href="kubernetes.html#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb35-7"><a href="kubernetes.html#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb35-8"><a href="kubernetes.html#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb35-9"><a href="kubernetes.html#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb35-10"><a href="kubernetes.html#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-11"><a href="kubernetes.html#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb35-12"><a href="kubernetes.html#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb35-13"><a href="kubernetes.html#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb35-14"><a href="kubernetes.html#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-15"><a href="kubernetes.html#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb35-16"><a href="kubernetes.html#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb35-17"><a href="kubernetes.html#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-18"><a href="kubernetes.html#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:frontend-streamlit</span></span>
<span id="cb35-19"><a href="kubernetes.html#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Always&quot;</span></span>
<span id="cb35-20"><a href="kubernetes.html#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb35-21"><a href="kubernetes.html#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb35-22"><a href="kubernetes.html#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb35-23"><a href="kubernetes.html#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb35-24"><a href="kubernetes.html#cb35-24" aria-hidden="true" tabindex="-1"></a><span class="co">        # enviroment variable defined in the application and dockerfile</span></span>
<span id="cb35-25"><a href="kubernetes.html#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co">        # value is ip adress of the order</span></span>
<span id="cb35-26"><a href="kubernetes.html#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb35-27"><a href="kubernetes.html#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="co">            # using the ip adress would be a bad idea.</span></span>
<span id="cb35-28"><a href="kubernetes.html#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="co">            # use the service ip adress.</span></span>
<span id="cb35-29"><a href="kubernetes.html#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="co">            # value: &quot;&lt;order-service-ip-adress&gt;:8081&quot;</span></span>
<span id="cb35-30"><a href="kubernetes.html#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="co">            # how to do it should be this.</span></span>
<span id="cb35-31"><a href="kubernetes.html#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co">            # we reference to the order service</span></span>
<span id="cb35-32"><a href="kubernetes.html#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> DB_SERVICE</span></span>
<span id="cb35-33"><a href="kubernetes.html#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;backendflask:5001&quot;</span></span>
<span id="cb35-34"><a href="kubernetes.html#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb35-35"><a href="kubernetes.html#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="co">          # we can actually use the actual ip of the service or</span></span>
<span id="cb35-36"><a href="kubernetes.html#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="co">          # use the dns, as done in the example above.</span></span>
<span id="cb35-37"><a href="kubernetes.html#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8501</span></span>
<span id="cb35-38"><a href="kubernetes.html#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb35-39"><a href="kubernetes.html#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb35-40"><a href="kubernetes.html#cb35-40" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb35-41"><a href="kubernetes.html#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb35-42"><a href="kubernetes.html#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> frontend-lb</span></span>
<span id="cb35-43"><a href="kubernetes.html#cb35-43" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb35-44"><a href="kubernetes.html#cb35-44" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb35-45"><a href="kubernetes.html#cb35-45" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb35-46"><a href="kubernetes.html#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-47"><a href="kubernetes.html#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb35-48"><a href="kubernetes.html#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb35-49"><a href="kubernetes.html#cb35-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8501</span></span>
<span id="cb35-50"><a href="kubernetes.html#cb35-50" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb35-51"><a href="kubernetes.html#cb35-51" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb35-52"><a href="kubernetes.html#cb35-52" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb35-53"><a href="kubernetes.html#cb35-53" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb35-54"><a href="kubernetes.html#cb35-54" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> frontend-node</span></span>
<span id="cb35-55"><a href="kubernetes.html#cb35-55" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb35-56"><a href="kubernetes.html#cb35-56" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb35-57"><a href="kubernetes.html#cb35-57" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb35-58"><a href="kubernetes.html#cb35-58" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> frontend</span></span>
<span id="cb35-59"><a href="kubernetes.html#cb35-59" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb35-60"><a href="kubernetes.html#cb35-60" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb35-61"><a href="kubernetes.html#cb35-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8501</span></span>
<span id="cb35-62"><a href="kubernetes.html#cb35-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">30000</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb36-1"><a href="kubernetes.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># services_backend-deployment.yaml</span></span>
<span id="cb36-2"><a href="kubernetes.html#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb36-3"><a href="kubernetes.html#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb36-4"><a href="kubernetes.html#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb36-5"><a href="kubernetes.html#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-6"><a href="kubernetes.html#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb36-7"><a href="kubernetes.html#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb36-8"><a href="kubernetes.html#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb36-9"><a href="kubernetes.html#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb36-10"><a href="kubernetes.html#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-11"><a href="kubernetes.html#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb36-12"><a href="kubernetes.html#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb36-13"><a href="kubernetes.html#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb36-14"><a href="kubernetes.html#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-15"><a href="kubernetes.html#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb36-16"><a href="kubernetes.html#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb36-17"><a href="kubernetes.html#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-18"><a href="kubernetes.html#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:backend-flask</span></span>
<span id="cb36-19"><a href="kubernetes.html#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Always&quot;</span></span>
<span id="cb36-20"><a href="kubernetes.html#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb36-21"><a href="kubernetes.html#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb36-22"><a href="kubernetes.html#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb36-23"><a href="kubernetes.html#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb36-24"><a href="kubernetes.html#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb36-25"><a href="kubernetes.html#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span>
<span id="cb36-26"><a href="kubernetes.html#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb36-27"><a href="kubernetes.html#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb36-28"><a href="kubernetes.html#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb36-29"><a href="kubernetes.html#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb36-30"><a href="kubernetes.html#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-31"><a href="kubernetes.html#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb36-32"><a href="kubernetes.html#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="co">  # send traffic to any pod that matches the label</span></span>
<span id="cb36-33"><a href="kubernetes.html#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span><span class="co"> # does not need to be specified</span></span>
<span id="cb36-34"><a href="kubernetes.html#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb36-35"><a href="kubernetes.html#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask</span></span>
<span id="cb36-36"><a href="kubernetes.html#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb36-37"><a href="kubernetes.html#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="co">    # port the service is associated with</span></span>
<span id="cb36-38"><a href="kubernetes.html#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5001</span></span>
<span id="cb36-39"><a href="kubernetes.html#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="co">    # port to access targeted by the access</span></span>
<span id="cb36-40"><a href="kubernetes.html#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="co">    # in our case has to be the same as in backendflask.</span></span>
<span id="cb36-41"><a href="kubernetes.html#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
</div>
</div>
<div id="labels-selectors-and-annotations" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> Labels, Selectors and Annotations<a href="kubernetes.html#labels-selectors-and-annotations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the previous sections we already made use of labels, selectors, and annotations, e.g. when matching the ClusterIP service to the back-deployments. Labels are a key-value pair that can be attached to objects such as Pods, Deployments, Replicaset, Services, etc. Overall, they are used to organize and select objects.</p>
<p>Annotations are an unstructured key-value mapping stored with a resource that may be set by external tools to store and retrieve any metadata. In contrast to labels and selectors, annotations are not used for querying purposes but rather to attach arbitrary non-identifying metadata. These data are used to assist tools and libraries to work with the K8s ressource, for example to pass configuration around between systems, or to send values so external tools can perform more informed decisions based on the annotations provided.</p>
<p>Selectors are used to filter K8s objects based on a set of labels. A selector basically simply uses a boolean language to select pods. The selector matches the labels under a an all or nothing principle, meaning everything specified in the selector must be fulfilled by the labels. However, this works not the other way around. If there are multiple labels specified and the selector matches only one of them, the selector will match the ressource itself. How a selector matches the labels can be tested using the <code>kubectl</code> commands as seen below.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="kubernetes.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all pods including their labels</span></span>
<span id="cb37-2"><a href="kubernetes.html#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--show-labels</span></span>
<span id="cb37-3"><a href="kubernetes.html#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="kubernetes.html#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Show only pods that match the specified selector key-value pairs</span></span>
<span id="cb37-5"><a href="kubernetes.html#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--selector</span><span class="op">=</span><span class="st">&quot;key=value&quot;</span></span>
<span id="cb37-6"><a href="kubernetes.html#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--selector</span><span class="op">=</span><span class="st">&quot;key=value,key2=value2&quot;</span></span>
<span id="cb37-7"><a href="kubernetes.html#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="kubernetes.html#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># in short one can also write</span></span>
<span id="cb37-9"><a href="kubernetes.html#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">-l</span> key=value</span>
<span id="cb37-10"><a href="kubernetes.html#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># or also look for multiple</span></span>
<span id="cb37-11"><a href="kubernetes.html#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">-l</span> <span class="st">&#39;key in (value1, value2)&#39;</span></span></code></pre></div>
<p>When using ReplicaSets in a Deployment, their selector matches the labels to a specific pod (check e.g. the section describing Deployments). Any Pods matching the label of the selector will be created according to the specified replicas. Of course, there can also be multiple labels specified.
The same principle accounts when working with Services. Below example shows two different Pods and two NodePort services. Each service matches to a Pod based on their selector-label relationship. Have a look at their specific settings using <code>kubectl</code>. The Nodeport Service <em>labels-and-selectors-2</em> has no endpoints, as it is a all-or-none-principle and none of the created Pods matches the label <code>environment=dev</code>. In contrast, even though the Pod <em>cat-v1</em> has multiple labels specified <code>app: cat-v1; version: one</code>, the NodePort Service <em>labels-and-selectors</em> is linked to it. It is also linked to the second Pod <em>cat-v2</em>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb38-1"><a href="kubernetes.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># labels.yaml</span></span>
<span id="cb38-2"><a href="kubernetes.html#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb38-3"><a href="kubernetes.html#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb38-4"><a href="kubernetes.html#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb38-5"><a href="kubernetes.html#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cat-v1</span></span>
<span id="cb38-6"><a href="kubernetes.html#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb38-7"><a href="kubernetes.html#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> cat-v1  </span></span>
<span id="cb38-8"><a href="kubernetes.html#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">version</span><span class="kw">:</span><span class="at"> one  </span></span>
<span id="cb38-9"><a href="kubernetes.html#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb38-10"><a href="kubernetes.html#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb38-11"><a href="kubernetes.html#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cat-v1</span></span>
<span id="cb38-12"><a href="kubernetes.html#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/mlops-public:cat-v1&quot;</span></span>
<span id="cb38-13"><a href="kubernetes.html#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb38-14"><a href="kubernetes.html#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb38-15"><a href="kubernetes.html#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb38-16"><a href="kubernetes.html#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cpu</span><span class="kw">:</span><span class="at">  </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb38-17"><a href="kubernetes.html#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb38-18"><a href="kubernetes.html#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb38-19"><a href="kubernetes.html#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb38-20"><a href="kubernetes.html#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb38-21"><a href="kubernetes.html#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cat-v2</span></span>
<span id="cb38-22"><a href="kubernetes.html#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb38-23"><a href="kubernetes.html#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> cat-v1</span></span>
<span id="cb38-24"><a href="kubernetes.html#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb38-25"><a href="kubernetes.html#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb38-26"><a href="kubernetes.html#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cat-v2</span></span>
<span id="cb38-27"><a href="kubernetes.html#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/mlops-public:cat-v2&quot;</span></span>
<span id="cb38-28"><a href="kubernetes.html#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb38-29"><a href="kubernetes.html#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb38-30"><a href="kubernetes.html#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb38-31"><a href="kubernetes.html#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cpu</span><span class="kw">:</span><span class="at">  </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb38-32"><a href="kubernetes.html#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb38-33"><a href="kubernetes.html#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb38-34"><a href="kubernetes.html#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb38-35"><a href="kubernetes.html#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb38-36"><a href="kubernetes.html#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> labels-and-selectors</span></span>
<span id="cb38-37"><a href="kubernetes.html#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb38-38"><a href="kubernetes.html#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb38-39"><a href="kubernetes.html#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb38-40"><a href="kubernetes.html#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> cat-v1</span></span>
<span id="cb38-41"><a href="kubernetes.html#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb38-42"><a href="kubernetes.html#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb38-43"><a href="kubernetes.html#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span>
<span id="cb38-44"><a href="kubernetes.html#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb38-45"><a href="kubernetes.html#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb38-46"><a href="kubernetes.html#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb38-47"><a href="kubernetes.html#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb38-48"><a href="kubernetes.html#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> labels-and-selectors-2</span></span>
<span id="cb38-49"><a href="kubernetes.html#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb38-50"><a href="kubernetes.html#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb38-51"><a href="kubernetes.html#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb38-52"><a href="kubernetes.html#cb38-52" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> cat-v1</span></span>
<span id="cb38-53"><a href="kubernetes.html#cb38-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> dev</span></span>
<span id="cb38-54"><a href="kubernetes.html#cb38-54" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb38-55"><a href="kubernetes.html#cb38-55" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb38-56"><a href="kubernetes.html#cb38-56" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
</div>
<div id="namespaces" class="section level2 hasAnchor" number="6.7">
<h2><span class="header-section-number">6.7</span> Namespaces<a href="kubernetes.html#namespaces" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Namespaces allow to organize resources in the cluster, which makes it more overseeable when there are multiple resources for different needs. Maybe we want to organize by team, department, or according to a development environment (dev/prod), etc. By default, K8s will use the <em>default</em>-namespace for resources that have not been specified otherwise. Similarly, kubectl interacts with the default namespace as well. Yet, there are already different namespace in a basic K8s cluster</p>
<ul>
<li><strong>default</strong> - The default namespace for objects with no other namespace</li>
<li><strong>kube-system</strong> - The namespace for objects created by the Kubernetes system</li>
<li><strong>kube-public</strong> - This namespace is created automatically and is readable by all users (including those not authenticated). This namespace is mostly reserved for cluster usage, in case that some resources should be visible and readable publicly throughout the whole cluster. The public aspect of this namespace is only a convention, not a requirement.</li>
<li><em>kube-node-lease</em> - This namespace for the lease objects associated with each node which improves the performance of the node heartbeats as the cluster scales.</li>
</ul>
<p>Of course, there is also the possibility of creating ones own namespace and using it by attaching a e.g. Deployment to it, such as seen in the following example.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb39-1"><a href="kubernetes.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># namespace.yaml</span></span>
<span id="cb39-2"><a href="kubernetes.html#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb39-3"><a href="kubernetes.html#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb39-4"><a href="kubernetes.html#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb39-5"><a href="kubernetes.html#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitoring</span></span>
<span id="cb39-6"><a href="kubernetes.html#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb39-7"><a href="kubernetes.html#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb39-8"><a href="kubernetes.html#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb39-9"><a href="kubernetes.html#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb39-10"><a href="kubernetes.html#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitoring-deployment</span></span>
<span id="cb39-11"><a href="kubernetes.html#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> monitoring</span></span>
<span id="cb39-12"><a href="kubernetes.html#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb39-13"><a href="kubernetes.html#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb39-14"><a href="kubernetes.html#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb39-15"><a href="kubernetes.html#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb39-16"><a href="kubernetes.html#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> monitoring-deployment</span></span>
<span id="cb39-17"><a href="kubernetes.html#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb39-18"><a href="kubernetes.html#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb39-19"><a href="kubernetes.html#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb39-20"><a href="kubernetes.html#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> monitoring-deployment</span></span>
<span id="cb39-21"><a href="kubernetes.html#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb39-22"><a href="kubernetes.html#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb39-23"><a href="kubernetes.html#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitoring-deployment</span></span>
<span id="cb39-24"><a href="kubernetes.html#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;grafana/grafana:latest&quot;</span></span>
<span id="cb39-25"><a href="kubernetes.html#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb39-26"><a href="kubernetes.html#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb39-27"><a href="kubernetes.html#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb39-28"><a href="kubernetes.html#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb39-29"><a href="kubernetes.html#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb39-30"><a href="kubernetes.html#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
<p>When creating a Service, a corresponding DNS entry is created as well, such as seen in the Services section when calling <code>backendflask</code> directly. This entry is created according to the namespace which is denoted to the service. This can be useful when using the same configuration across multiple namespaces such as development, staging, and production. It is also possible to reach across namespaces. One needs to use the fully qualified domain name (FQDN) tough, such as <code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code>.</p>
</div>
<div id="service-discovery" class="section level2 hasAnchor" number="6.8">
<h2><span class="header-section-number">6.8</span> Service Discovery<a href="kubernetes.html#service-discovery" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Service Discovery is a mechanism that lets applications and microservices locate each other on a network. In fact, we have aready used Service Discovery in the previous sections, they just haven’t been mentioned yet. If a client wants to communicate with the application, it should not use the IP of an individual Pod should not use the individual pod ip. Instead, we should rely on services as they have a stable IP address. We have already seen this in the section about Services. Yet, each pod has also an individual DNS (Domain Name System). A DNS translates a domain names to an IP address, just one lookes up a number in a telephone book, so it’s much easier to reference to a resource online. This is where service Discovery enters the game.</p>
<div class="figure">
<img src="images/04-Kubernetes/service-discovery.png" alt="" />
<p class="caption">Service Discovery</p>
</div>
<p>Whenever a service is created, it is registered in the service registry with the service name and the service IP. Most clusters use CoreDNS as a service registry (this would be the telephone book itself). When having a look at the minikube cluster one should see are <em>core-dns</em> service running. Now you know what it is for. Having a closer look using <code>kubectl describe svc &lt;name&gt;</code>, the core-dns service has only one endpoint. If you want to have an even closer look, you can dive into a pod itself and check the file /etc/resolv.conf. There you find a nameserver <IP> where the IP is the one of the core-dns.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="kubernetes.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># when querying services, it necessary </span></span>
<span id="cb40-2"><a href="kubernetes.html#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to specify the corresponding namespace</span></span>
<span id="cb40-3"><a href="kubernetes.html#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get service <span class="at">-n</span> kube-system</span>
<span id="cb40-4"><a href="kubernetes.html#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="kubernetes.html#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># command for queriying the dns  </span></span>
<span id="cb40-6"><a href="kubernetes.html#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="ex">nslookup</span> <span class="op">&lt;</span>podname<span class="op">&gt;</span></span></code></pre></div>
<div id="kube-proxy-1" class="section level4 hasAnchor" number="6.8.0.1">
<h4><span class="header-section-number">6.8.0.1</span> kube-proxy<a href="kubernetes.html#kube-proxy-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As mentioned earlier, each node has three main components: Kubelet, Container Runtime, and the Kube-Proxy. <em>Kube-Proxy</em> is a network proxy running on each node and is responsible for internal network communications as well as external.</p>
<p>It also implements a controller that watches the API server for new services and endpoints. Whenever there is a new service or endpoint, the kube-proxy creates a local IPVS rule (IP Virtual Server) that tells the node to intercept traffic destined to the ClusterIP Service. IPVS is built on top of the network filter and implements a transport-layer load balancing. This gives the ability to load balance to real service as well as redirecting traffic to pods that match service label selectors.</p>
<p>This means, kube-proxy is intercepting all the requests and makes sure that when a request to the ClusterIP service is sent using endpoints, the request is forwarded to the healthy pods behind the endpoint.</p>
</div>
</div>
<div id="volume-storage" class="section level2 hasAnchor" number="6.9">
<h2><span class="header-section-number">6.9</span> Volume &amp; Storage<a href="kubernetes.html#volume-storage" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Since Pods are ephemeral, any data associated is deleted when a Pod or container restarts. Applications are run stateless the majority of the times, meaning the data does not needs to be kept on the node and the data is stored on an external database. However, there are times when the data wants to be kept, shared between Pods, or when it should persist on the host file system (disk). As described in the section about Pods, a Pod can contain volumes. Volumes are exactly what is needed for such tasks. They are used to store and access data which can be persistent or long lived on K8s.</p>
<p>There are different types of volumes, e.g.:</p>
<ul>
<li>EmptyDir</li>
<li>HostPath Volume</li>
<li>awsElasticBlockStore: AWS EBS volumes are persistent and originally unmounted. They are read-write-once-only tough.</li>
<li>There are multiple other types of volumes, a full list can be found here: <a href="https://kubernetes.io/docs/concepts/storage/volumes/#volume-types" class="uri">https://kubernetes.io/docs/concepts/storage/volumes/#volume-types</a></li>
</ul>
<div id="emptydir-volume" class="section level3 hasAnchor" number="6.9.1">
<h3><span class="header-section-number">6.9.1</span> EmptyDir Volume<a href="kubernetes.html#emptydir-volume" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An EmptyDir Volume is initially empty (as the name suggests). The volume is a temporary directory that shares the pods lifetime. If the pod dies, the contents of the emptyDir are lost as well. The EmptyDir is also used to share data between containers inside a Pod during runtime.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb41-1"><a href="kubernetes.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># volume_empty-dir.yaml</span></span>
<span id="cb41-2"><a href="kubernetes.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb41-3"><a href="kubernetes.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb41-4"><a href="kubernetes.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb41-5"><a href="kubernetes.html#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb41-6"><a href="kubernetes.html#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb41-7"><a href="kubernetes.html#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb41-8"><a href="kubernetes.html#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb41-9"><a href="kubernetes.html#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb41-10"><a href="kubernetes.html#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb41-11"><a href="kubernetes.html#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb41-12"><a href="kubernetes.html#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb41-13"><a href="kubernetes.html#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb41-14"><a href="kubernetes.html#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb41-15"><a href="kubernetes.html#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co">      # add a volume to the deployment</span></span>
<span id="cb41-16"><a href="kubernetes.html#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb41-17"><a href="kubernetes.html#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co">        # mimics a caching memory type</span></span>
<span id="cb41-18"><a href="kubernetes.html#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb41-19"><a href="kubernetes.html#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co">          # specify the volume type and the temp directory</span></span>
<span id="cb41-20"><a href="kubernetes.html#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">emptyDir</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span><span class="at">    </span></span>
<span id="cb41-21"><a href="kubernetes.html#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co">        # of course there could also be a second volume added</span></span>
<span id="cb41-22"><a href="kubernetes.html#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb41-23"><a href="kubernetes.html#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-one</span></span>
<span id="cb41-24"><a href="kubernetes.html#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox </span></span>
<span id="cb41-25"><a href="kubernetes.html#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co">        # image used for testing purposes</span></span>
<span id="cb41-26"><a href="kubernetes.html#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co">        # since the testing image immediately dies, we want to</span></span>
<span id="cb41-27"><a href="kubernetes.html#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co">        # execute an own sh command to interact with the volume</span></span>
<span id="cb41-28"><a href="kubernetes.html#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb41-29"><a href="kubernetes.html#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="co">          # The name must match the name of the volume</span></span>
<span id="cb41-30"><a href="kubernetes.html#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb41-31"><a href="kubernetes.html#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="co">            # interal reference of the pod </span></span>
<span id="cb41-32"><a href="kubernetes.html#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /foo</span></span>
<span id="cb41-33"><a href="kubernetes.html#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb41-34"><a href="kubernetes.html#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb41-35"><a href="kubernetes.html#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb41-36"><a href="kubernetes.html#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb41-37"><a href="kubernetes.html#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;touch /foo/bar.txt &amp;&amp; sleep 3600&quot;</span></span>
<span id="cb41-38"><a href="kubernetes.html#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb41-39"><a href="kubernetes.html#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb41-40"><a href="kubernetes.html#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb41-41"><a href="kubernetes.html#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb41-42"><a href="kubernetes.html#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="co">        # create a second container with a different internal mountPath</span></span>
<span id="cb41-43"><a href="kubernetes.html#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-two</span></span>
<span id="cb41-44"><a href="kubernetes.html#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb41-45"><a href="kubernetes.html#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb41-46"><a href="kubernetes.html#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb41-47"><a href="kubernetes.html#cb41-47" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /footwo</span></span>
<span id="cb41-48"><a href="kubernetes.html#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb41-49"><a href="kubernetes.html#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb41-50"><a href="kubernetes.html#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;3600&quot;</span></span>
<span id="cb41-51"><a href="kubernetes.html#cb41-51" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb41-52"><a href="kubernetes.html#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb41-53"><a href="kubernetes.html#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb41-54"><a href="kubernetes.html#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>As stated in the yaml, the busybox image immediately dies. If the Containers where created without the shell commands, the pod would be in a crashloopbackoff-state. To prevent the Pod to do so it is caught with the <code>sleep</code>commands until it scales down. Accessing a container using <code>kubectl exec</code>, it can be checked whether the foo/bar.txt has been created in <em>container-one</em>.</p>
<p>When checking the second container <em>container-two</em>, the same file should be visible as well. This is because both containers refer to the same volume. Keep in mind though that the mountPath of the <em>container-two</em> is different.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="kubernetes.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get in container</span></span>
<span id="cb42-2"><a href="kubernetes.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>emptydir-volume-name<span class="op">&gt;</span> -c container-one <span class="at">--</span> sh</span>
<span id="cb42-3"><a href="kubernetes.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check whether bar.txt is present</span></span>
<span id="cb42-4"><a href="kubernetes.html#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span>
<span id="cb42-5"><a href="kubernetes.html#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="kubernetes.html#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># accessing the second container, there is also a file foo/bar.txt</span></span>
<span id="cb42-7"><a href="kubernetes.html#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># remember, both containers share the same volume</span></span>
<span id="cb42-8"><a href="kubernetes.html#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>emptydir-volume-name<span class="op">&gt;</span> -c container-two <span class="at">--</span> sh</span>
<span id="cb42-9"><a href="kubernetes.html#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span></code></pre></div>
</div>
<div id="hostpath-volume" class="section level3 hasAnchor" number="6.9.2">
<h3><span class="header-section-number">6.9.2</span> HostPath Volume<a href="kubernetes.html#hostpath-volume" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>THe HostPath Volume type is used when an application needs to access the underlying host file system, meaning the file system of the node. HostPath represents a pre-existing file or directory on the host machine. However, this can be quite dangerous and should be used with caution. If having the right access, the application can interfere and basically mess up the host. It is therefore recommended to set the rights to read only to prevent this from happening.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb43-1"><a href="kubernetes.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># volume_hostpath.yaml</span></span>
<span id="cb43-2"><a href="kubernetes.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb43-3"><a href="kubernetes.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb43-4"><a href="kubernetes.html#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb43-5"><a href="kubernetes.html#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb43-6"><a href="kubernetes.html#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb43-7"><a href="kubernetes.html#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb43-8"><a href="kubernetes.html#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb43-9"><a href="kubernetes.html#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb43-10"><a href="kubernetes.html#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb43-11"><a href="kubernetes.html#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb43-12"><a href="kubernetes.html#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb43-13"><a href="kubernetes.html#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb43-14"><a href="kubernetes.html#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb43-15"><a href="kubernetes.html#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb43-16"><a href="kubernetes.html#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> var-log</span></span>
<span id="cb43-17"><a href="kubernetes.html#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co">          # specify the HostPath volume type</span></span>
<span id="cb43-18"><a href="kubernetes.html#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb43-19"><a href="kubernetes.html#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb43-20"><a href="kubernetes.html#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb43-21"><a href="kubernetes.html#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-one</span></span>
<span id="cb43-22"><a href="kubernetes.html#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox </span></span>
<span id="cb43-23"><a href="kubernetes.html#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb43-24"><a href="kubernetes.html#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb43-25"><a href="kubernetes.html#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> var-log</span></span>
<span id="cb43-26"><a href="kubernetes.html#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">readOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb43-27"><a href="kubernetes.html#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb43-28"><a href="kubernetes.html#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb43-29"><a href="kubernetes.html#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;3600&quot;</span></span>
<span id="cb43-30"><a href="kubernetes.html#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb43-31"><a href="kubernetes.html#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb43-32"><a href="kubernetes.html#cb43-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb43-33"><a href="kubernetes.html#cb43-33" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>Similar to the EmptyDir Volume example, you can check the implementation of the HostPath Volume by accessing the volume. When comparing the file structures of the <em>hostpath-volume</em> deployment and the directory <code>path: /var/log</code> on the node the deployment is running, they should be the same. All the changes made to either on of them will make the changes available on the other. By making changes via the pod we can directly influence the Node. Again, this is why it is important to keep it read-only.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="kubernetes.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># access the </span></span>
<span id="cb44-2"><a href="kubernetes.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>hostpath-volume-name<span class="op">&gt;</span> -- sh</span>
<span id="cb44-3"><a href="kubernetes.html#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="kubernetes.html#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ssh into node</span></span>
<span id="cb44-5"><a href="kubernetes.html#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="ex">minikube</span> ssh <span class="op">&lt;</span>node<span class="op">&gt;</span></span></code></pre></div>
</div>
<div id="persistent-volumes" class="section level3 hasAnchor" number="6.9.3">
<h3><span class="header-section-number">6.9.3</span> Persistent Volumes<a href="kubernetes.html#persistent-volumes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Persistent Volumes allow to store data beyond a Pods lifecycle. If a Pod fails, dies or moves to a different node, the data is still intact and can be shared between pods. Persistent Volume types are implemented as plugins that K8s can support(a full list can be found online). Different types of Persistent Volumes are:</p>
<ul>
<li>NFS</li>
<li>Local</li>
<li>Cloud Network storage (AWS EBS, Azure File Storage, Google Persistent Disk)</li>
</ul>
<p>The following example show how the usage of Persistent Volumes works on the AWS cloud.
K8s is running on an AWS EKS Cluster and AWS EBS Volumes attached to it. The Container storage interface (CSI) of K8s to use Persistent Volumes is implemented by the EBS provider, e.g. the aws-ebs-plugin. This enables a the use of Persistent Volumes in the EKS cluster. Therefore, a Persistent Volume (PV) is rather the mapping between the storage provider (EBS) and the K8s cluster, than a volume itself. The storage class of a Persistent Volume can be configured to the specific needs. Should the storage be fast or slow, or do we want to have each as a storage? Or might there be other parameters to configure the storage?</p>
<p>If a Pods or Deployments want to consume storage of the PV, they need to get access to the PV. This is done via a so called persistent volume claim (PVC).</p>
<p>All of this is part of a Persistent Volume Subsystem. The Persistent Volume Subsystem provides an API for users and administrators. The API abstracts details of how storage is provided from how it is consumed. Again, the provisioning of storage is done via a PV and the consumption via a PCV.</p>
<div class="figure">
<img src="images/04-Kubernetes/persistent-volume-subsystem.png" alt="" />
<p class="caption">Persistent Volume Subsystem</p>
</div>
<p>Listed below are again the three main components when dealing with Persistent Volumes in K8s</p>
<ul>
<li><strong>Persistent Volume</strong>: is a storage resource provisioned by an administrator</li>
<li><strong>PVC</strong>: is a user’s request for and claim to a persistent volume.</li>
<li><strong>Storage Class</strong>: describes the parameters for a class of storage for which PersistentVolumes can be dynamically provisioned.</li>
</ul>
<p>So how are Persistent Volumes specified in our deployments yamls? As there are <code>kind:Pod</code> ressources, there can similarly <code>kind:PersistentVolume</code> and <code>kind:PersistentVolumeClaim</code> be specified. At first, a PV is created. As we run on minikube and not on the cloud, a local storage in the node is allocated. Second, a PVC is created requesting a certain amount of that storage. This PVC is then linked in the specifications of a Deployment to allow its containers to utilized the storage.</p>
<p>Before applying the yaml-files we need to allocate the local storage by claiming storage on the node and set the paths specified in the yamls. To do this, we ssh into the node using <code>minikube ssh</code>. We can then create a specific path on the node such as <code>/mnt/data/</code>. We might also create a file in it to test accessing it when creating a PVC to a Pod. Since we do not know yet on what node the Pod is scheduled, we should create the directory on both nodes. Below are all steps listed again.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="kubernetes.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ssh into node</span></span>
<span id="cb45-2"><a href="kubernetes.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">minikube</span> ssh</span>
<span id="cb45-3"><a href="kubernetes.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create path</span></span>
<span id="cb45-4"><a href="kubernetes.html#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir /mnt/data</span>
<span id="cb45-5"><a href="kubernetes.html#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create a file with text</span></span>
<span id="cb45-6"><a href="kubernetes.html#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sh <span class="at">-c</span> <span class="st">&quot;echo &#39;this is a pvc test&#39; &gt; /mnt/data/index.html&quot;</span></span>
<span id="cb45-7"><a href="kubernetes.html#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># do this on both nodes as pod can land on either one of them</span></span></code></pre></div>
<p>Afterward we can apply the yaml files and create a PV, PVC, and the corresponding Deployment utilizing the PVC. The yaml code below shows this process.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb46-1"><a href="kubernetes.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># volume_persistent-volume.yaml</span></span>
<span id="cb46-2"><a href="kubernetes.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb46-3"><a href="kubernetes.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolume</span></span>
<span id="cb46-4"><a href="kubernetes.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb46-5"><a href="kubernetes.html#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mypv</span></span>
<span id="cb46-6"><a href="kubernetes.html#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb46-7"><a href="kubernetes.html#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">  # specifiy the capacity of the PersistentVolume</span></span>
<span id="cb46-8"><a href="kubernetes.html#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">capacity</span><span class="kw">:</span></span>
<span id="cb46-9"><a href="kubernetes.html#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;100Mi&quot;</span></span>
<span id="cb46-10"><a href="kubernetes.html#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">volumeMode</span><span class="kw">:</span><span class="at"> Filesystem</span></span>
<span id="cb46-11"><a href="kubernetes.html#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb46-12"><a href="kubernetes.html#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb46-13"><a href="kubernetes.html#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">persistentVolumeReclaimPolicy</span><span class="kw">:</span><span class="at"> Recycle</span></span>
<span id="cb46-14"><a href="kubernetes.html#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClassName</span><span class="kw">:</span><span class="at"> manual</span></span>
<span id="cb46-15"><a href="kubernetes.html#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb46-16"><a href="kubernetes.html#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/mnt/data&quot;</span></span>
<span id="cb46-17"><a href="kubernetes.html#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co">    # specify the hostPath on the node</span></span>
<span id="cb46-18"><a href="kubernetes.html#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="co">    # that&#39;s the path we specified on our node</span></span>
<span id="cb46-19"><a href="kubernetes.html#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb46-20"><a href="kubernetes.html#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb46-21"><a href="kubernetes.html#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolumeClaim</span></span>
<span id="cb46-22"><a href="kubernetes.html#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb46-23"><a href="kubernetes.html#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mypvc</span></span>
<span id="cb46-24"><a href="kubernetes.html#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb46-25"><a href="kubernetes.html#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb46-26"><a href="kubernetes.html#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb46-27"><a href="kubernetes.html#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="co">      # we request the same as the PV is specified</span></span>
<span id="cb46-28"><a href="kubernetes.html#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="co">      # so we basically request everything</span></span>
<span id="cb46-29"><a href="kubernetes.html#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;100Mi&quot;</span></span>
<span id="cb46-30"><a href="kubernetes.html#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">volumeMode</span><span class="kw">:</span><span class="at"> Filesystem</span></span>
<span id="cb46-31"><a href="kubernetes.html#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClassName</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;manual&quot;</span></span>
<span id="cb46-32"><a href="kubernetes.html#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb46-33"><a href="kubernetes.html#cb46-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb46-34"><a href="kubernetes.html#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb46-35"><a href="kubernetes.html#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb46-36"><a href="kubernetes.html#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb46-37"><a href="kubernetes.html#cb46-37" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb46-38"><a href="kubernetes.html#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc-deployment</span></span>
<span id="cb46-39"><a href="kubernetes.html#cb46-39" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb46-40"><a href="kubernetes.html#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb46-41"><a href="kubernetes.html#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb46-42"><a href="kubernetes.html#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb46-43"><a href="kubernetes.html#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb46-44"><a href="kubernetes.html#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb46-45"><a href="kubernetes.html#cb46-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb46-46"><a href="kubernetes.html#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb46-47"><a href="kubernetes.html#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb46-48"><a href="kubernetes.html#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb46-49"><a href="kubernetes.html#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> data</span></span>
<span id="cb46-50"><a href="kubernetes.html#cb46-50" aria-hidden="true" tabindex="-1"></a><span class="co">          # define the use of the PVC by specifying the name</span></span>
<span id="cb46-51"><a href="kubernetes.html#cb46-51" aria-hidden="true" tabindex="-1"></a><span class="co">          # specify the pod/deployment can use the PVC</span></span>
<span id="cb46-52"><a href="kubernetes.html#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">persistentVolumeClaim</span><span class="kw">:</span></span>
<span id="cb46-53"><a href="kubernetes.html#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">claimName</span><span class="kw">:</span><span class="at"> mypvc</span></span>
<span id="cb46-54"><a href="kubernetes.html#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb46-55"><a href="kubernetes.html#cb46-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb46-56"><a href="kubernetes.html#cb46-56" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx:latest</span></span>
<span id="cb46-57"><a href="kubernetes.html#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb46-58"><a href="kubernetes.html#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/usr/share/nginx/html&quot;</span></span>
<span id="cb46-59"><a href="kubernetes.html#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="co">            # since the PVC is stated, the container needs to </span></span>
<span id="cb46-60"><a href="kubernetes.html#cb46-60" aria-hidden="true" tabindex="-1"></a><span class="co">            # mount inside it</span></span>
<span id="cb46-61"><a href="kubernetes.html#cb46-61" aria-hidden="true" tabindex="-1"></a><span class="co">            # name is equal to the pvc name specified</span></span>
<span id="cb46-62"><a href="kubernetes.html#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> data</span></span>
<span id="cb46-63"><a href="kubernetes.html#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb46-64"><a href="kubernetes.html#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb46-65"><a href="kubernetes.html#cb46-65" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb46-66"><a href="kubernetes.html#cb46-66" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb46-67"><a href="kubernetes.html#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb46-68"><a href="kubernetes.html#cb46-68" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb46-69"><a href="kubernetes.html#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb46-70"><a href="kubernetes.html#cb46-70" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb46-71"><a href="kubernetes.html#cb46-71" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb46-72"><a href="kubernetes.html#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb46-73"><a href="kubernetes.html#cb46-73" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb46-74"><a href="kubernetes.html#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb46-75"><a href="kubernetes.html#cb46-75" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb46-76"><a href="kubernetes.html#cb46-76" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb46-77"><a href="kubernetes.html#cb46-77" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb46-78"><a href="kubernetes.html#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb46-79"><a href="kubernetes.html#cb46-79" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb46-80"><a href="kubernetes.html#cb46-80" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
<p>By accessing a pod using <code>kubectl exec -it &lt;persistent-volume-name&gt; -- sh</code> we can check whether the path is linked using the PVC. Now, the end result may seem the same as what we did with the HostPath Volume. But it actually is not, it just looks like it since both, the PersistentVolume and the HostPath connect to the Host. Yet, the locally mounted path would be somewhere else when running in the cloud. The PV configuration would point to another storage source instead of a local file system, for example an attached EBS of EFS storage. Since we also created a LoadBalancer service, we can run <code>minikube tunnel</code> to expose the application deplyment under localhost:80. It should show the input of the index.html file we created on the storage.</p>
</div>
</div>
<div id="configmaps" class="section level2 hasAnchor" number="6.10">
<h2><span class="header-section-number">6.10</span> ConfigMaps<a href="kubernetes.html#configmaps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When building software, the same container image should be used for development, testing, staging, and production stage. Thus, container images should be reusable. What usually changes are only the configuration settings of the application. <em>ConfigMaps</em> allow to store such configurations as a simple mapping of key-value pairs. Most of the time, the configuration within a config map is injected using environment variables and volumes. However, ConfigMaps should only be used to store configuration files, not sensitive data, as they do not secure them.
Besides allow for an easy change of variables, another benefit of using ConfigMaps is that changes in the configuration are not disruptive, meaning the application can still run while the configuration changes without affecting the application. However, one needs to keep in mind that change made to ConfigMaps and environment variables will not be reflected on already and currently running containers.</p>
<p>The following example creates two different ConfigMaps. The first one includes three environment variables as data. The second one include a more complex configuration of an nginx server.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb47-1"><a href="kubernetes.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># configmaps.yaml</span></span>
<span id="cb47-2"><a href="kubernetes.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb47-3"><a href="kubernetes.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb47-4"><a href="kubernetes.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb47-5"><a href="kubernetes.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb47-6"><a href="kubernetes.html#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb47-7"><a href="kubernetes.html#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">app-name</span><span class="kw">:</span><span class="at"> kitty</span></span>
<span id="cb47-8"><a href="kubernetes.html#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">app-version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb47-9"><a href="kubernetes.html#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">team</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb47-10"><a href="kubernetes.html#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb47-11"><a href="kubernetes.html#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb47-12"><a href="kubernetes.html#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb47-13"><a href="kubernetes.html#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb47-14"><a href="kubernetes.html#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb47-15"><a href="kubernetes.html#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb47-16"><a href="kubernetes.html#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">  # configuration in .conf</span></span>
<span id="cb47-17"><a href="kubernetes.html#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="fu">  nginx.conf</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb47-18"><a href="kubernetes.html#cb47-18" aria-hidden="true" tabindex="-1"></a>    server {</span>
<span id="cb47-19"><a href="kubernetes.html#cb47-19" aria-hidden="true" tabindex="-1"></a>        listen       80;</span>
<span id="cb47-20"><a href="kubernetes.html#cb47-20" aria-hidden="true" tabindex="-1"></a>        server_name  localhost;</span>
<span id="cb47-21"><a href="kubernetes.html#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="kubernetes.html#cb47-22" aria-hidden="true" tabindex="-1"></a>        location / {</span>
<span id="cb47-23"><a href="kubernetes.html#cb47-23" aria-hidden="true" tabindex="-1"></a>            root   /usr/share/nginx/html;</span>
<span id="cb47-24"><a href="kubernetes.html#cb47-24" aria-hidden="true" tabindex="-1"></a>            index  index.html index.htm;</span>
<span id="cb47-25"><a href="kubernetes.html#cb47-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-26"><a href="kubernetes.html#cb47-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-27"><a href="kubernetes.html#cb47-27" aria-hidden="true" tabindex="-1"></a>        # redirect server error pages to the static page /50x.html</span>
<span id="cb47-28"><a href="kubernetes.html#cb47-28" aria-hidden="true" tabindex="-1"></a>        #</span>
<span id="cb47-29"><a href="kubernetes.html#cb47-29" aria-hidden="true" tabindex="-1"></a>        error_page   500 502 503 504  /50x.html;</span>
<span id="cb47-30"><a href="kubernetes.html#cb47-30" aria-hidden="true" tabindex="-1"></a>        location = /50x.html {</span>
<span id="cb47-31"><a href="kubernetes.html#cb47-31" aria-hidden="true" tabindex="-1"></a>            root   /usr/share/nginx/html;</span>
<span id="cb47-32"><a href="kubernetes.html#cb47-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-33"><a href="kubernetes.html#cb47-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-34"><a href="kubernetes.html#cb47-34" aria-hidden="true" tabindex="-1"></a>        location /health {</span>
<span id="cb47-35"><a href="kubernetes.html#cb47-35" aria-hidden="true" tabindex="-1"></a>            access_log off;</span>
<span id="cb47-36"><a href="kubernetes.html#cb47-36" aria-hidden="true" tabindex="-1"></a>            return 200 &quot;healthy\n&quot;;</span>
<span id="cb47-37"><a href="kubernetes.html#cb47-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb47-38"><a href="kubernetes.html#cb47-38" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>Additionally, a Deployment is created which uses both ConfigMaps. A ConfigMap is declared under <code>spec.volumes</code> as well. It is also possible to state a reference to both ConfigMaps simultaneously. The Deployment creates two containers. The first container mounts each ConfigMap as a Volume. Container two uses environment variables to access and configure the key-value pairs of the ConfigMaps and store them on the container.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb48-1"><a href="kubernetes.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># configmaps_deployment.yaml</span></span>
<span id="cb48-2"><a href="kubernetes.html#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb48-3"><a href="kubernetes.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb48-4"><a href="kubernetes.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb48-5"><a href="kubernetes.html#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb48-6"><a href="kubernetes.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb48-7"><a href="kubernetes.html#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb48-8"><a href="kubernetes.html#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb48-9"><a href="kubernetes.html#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb48-10"><a href="kubernetes.html#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb48-11"><a href="kubernetes.html#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb48-12"><a href="kubernetes.html#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb48-13"><a href="kubernetes.html#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb48-14"><a href="kubernetes.html#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb48-15"><a href="kubernetes.html#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb48-16"><a href="kubernetes.html#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co">        # specify ConfigMap nginx-conf</span></span>
<span id="cb48-17"><a href="kubernetes.html#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb48-18"><a href="kubernetes.html#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb48-19"><a href="kubernetes.html#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb48-20"><a href="kubernetes.html#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co">        # specify ConfigMap app-properties</span></span>
<span id="cb48-21"><a href="kubernetes.html#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-22"><a href="kubernetes.html#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb48-23"><a href="kubernetes.html#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-24"><a href="kubernetes.html#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="co">        # if both configmaps shall be mounted under one directory,</span></span>
<span id="cb48-25"><a href="kubernetes.html#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="co">        # we need to use projected</span></span>
<span id="cb48-26"><a href="kubernetes.html#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config</span></span>
<span id="cb48-27"><a href="kubernetes.html#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">projected</span><span class="kw">:</span></span>
<span id="cb48-28"><a href="kubernetes.html#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">sources</span><span class="kw">:</span></span>
<span id="cb48-29"><a href="kubernetes.html#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb48-30"><a href="kubernetes.html#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb48-31"><a href="kubernetes.html#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb48-32"><a href="kubernetes.html#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-33"><a href="kubernetes.html#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb48-34"><a href="kubernetes.html#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map-volume</span></span>
<span id="cb48-35"><a href="kubernetes.html#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb48-36"><a href="kubernetes.html#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb48-37"><a href="kubernetes.html#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/cfmp/ngnix</span></span>
<span id="cb48-38"><a href="kubernetes.html#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="co">          # is defined here in the nginx-volume to mount</span></span>
<span id="cb48-39"><a href="kubernetes.html#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb48-40"><a href="kubernetes.html#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="co">          # everything from that configMap is mounted as a file</span></span>
<span id="cb48-41"><a href="kubernetes.html#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="co">          # the file content is the value themselves</span></span>
<span id="cb48-42"><a href="kubernetes.html#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/cfmp/properties</span></span>
<span id="cb48-43"><a href="kubernetes.html#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-44"><a href="kubernetes.html#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> etc/cfmp/config</span></span>
<span id="cb48-45"><a href="kubernetes.html#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config</span></span>
<span id="cb48-46"><a href="kubernetes.html#cb48-46" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb48-47"><a href="kubernetes.html#cb48-47" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb48-48"><a href="kubernetes.html#cb48-48" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb48-49"><a href="kubernetes.html#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb48-50"><a href="kubernetes.html#cb48-50" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep 3600&quot;</span></span>
<span id="cb48-51"><a href="kubernetes.html#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb48-52"><a href="kubernetes.html#cb48-52" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb48-53"><a href="kubernetes.html#cb48-53" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb48-54"><a href="kubernetes.html#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb48-55"><a href="kubernetes.html#cb48-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map-env</span></span>
<span id="cb48-56"><a href="kubernetes.html#cb48-56" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb48-57"><a href="kubernetes.html#cb48-57" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb48-58"><a href="kubernetes.html#cb48-58" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb48-59"><a href="kubernetes.html#cb48-59" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb48-60"><a href="kubernetes.html#cb48-60" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb48-61"><a href="kubernetes.html#cb48-61" aria-hidden="true" tabindex="-1"></a><span class="co">        # as previously, keep the busybox container alive</span></span>
<span id="cb48-62"><a href="kubernetes.html#cb48-62" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb48-63"><a href="kubernetes.html#cb48-63" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb48-64"><a href="kubernetes.html#cb48-64" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb48-65"><a href="kubernetes.html#cb48-65" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb48-66"><a href="kubernetes.html#cb48-66" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;env &amp;&amp; sleep 3600&quot;</span></span>
<span id="cb48-67"><a href="kubernetes.html#cb48-67" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb48-68"><a href="kubernetes.html#cb48-68" aria-hidden="true" tabindex="-1"></a><span class="co">          # environment variables to read in from config map</span></span>
<span id="cb48-69"><a href="kubernetes.html#cb48-69" aria-hidden="true" tabindex="-1"></a><span class="co">          # for every data key-value pair in config Map, an own</span></span>
<span id="cb48-70"><a href="kubernetes.html#cb48-70" aria-hidden="true" tabindex="-1"></a><span class="co">          # environment variable is created, which gets </span></span>
<span id="cb48-71"><a href="kubernetes.html#cb48-71" aria-hidden="true" tabindex="-1"></a><span class="co">          # the value from the corresponding key</span></span>
<span id="cb48-72"><a href="kubernetes.html#cb48-72" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> APP_VERSION</span></span>
<span id="cb48-73"><a href="kubernetes.html#cb48-73" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb48-74"><a href="kubernetes.html#cb48-74" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb48-75"><a href="kubernetes.html#cb48-75" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-76"><a href="kubernetes.html#cb48-76" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> app-version</span></span>
<span id="cb48-77"><a href="kubernetes.html#cb48-77" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> APP_NAME</span></span>
<span id="cb48-78"><a href="kubernetes.html#cb48-78" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb48-79"><a href="kubernetes.html#cb48-79" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb48-80"><a href="kubernetes.html#cb48-80" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-81"><a href="kubernetes.html#cb48-81" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> app-name</span></span>
<span id="cb48-82"><a href="kubernetes.html#cb48-82" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> TEAM</span></span>
<span id="cb48-83"><a href="kubernetes.html#cb48-83" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb48-84"><a href="kubernetes.html#cb48-84" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb48-85"><a href="kubernetes.html#cb48-85" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb48-86"><a href="kubernetes.html#cb48-86" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> team</span></span>
<span id="cb48-87"><a href="kubernetes.html#cb48-87" aria-hidden="true" tabindex="-1"></a><span class="co">          # reads from second config map</span></span>
<span id="cb48-88"><a href="kubernetes.html#cb48-88" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> NGINX_CONF</span></span>
<span id="cb48-89"><a href="kubernetes.html#cb48-89" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb48-90"><a href="kubernetes.html#cb48-90" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb48-91"><a href="kubernetes.html#cb48-91" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb48-92"><a href="kubernetes.html#cb48-92" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> nginx.conf  </span></span></code></pre></div>
<p>We can check for the attached configs by accessing the containers via the shell, similar to what we did in the section about Volumes. In the container <em>config-map-volume</em>, the configs are saved under the respective <code>mountPath</code> of the volume. In the <em>config-map-env</em>, the configs are stored as environment variables.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="kubernetes.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get in container -volume or -env</span></span>
<span id="cb49-2"><a href="kubernetes.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>config-map-name<span class="op">&gt;</span> -c <span class="op">&gt;</span>container-name<span class="op">&lt;</span> -- sh</span>
<span id="cb49-3"><a href="kubernetes.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check subdirectories</span></span>
<span id="cb49-4"><a href="kubernetes.html#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span>
<span id="cb49-5"><a href="kubernetes.html#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="kubernetes.html#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print environment variables</span></span>
<span id="cb49-7"><a href="kubernetes.html#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">printenv</span></span></code></pre></div>
</div>
<div id="secrets" class="section level2 hasAnchor" number="6.11">
<h2><span class="header-section-number">6.11</span> Secrets<a href="kubernetes.html#secrets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Secrets, as the name suggests, store and manage sensitive information. However, secrets are actually not secrets in K8s. They can quite easily decoded using <code>kubectl describe</code> on a secret and decode it using the shell command <code>echo &lt;password&gt; | base64 -d</code>. Thus, sensitive information like database password should never be stored in secrets. There are much better ressources to store such data, for example a Vault on the cloud provider itself. However, secret can be used so that you don’t need to include confidential data in your application code. Since they are stored and created independently of the Pods that use them, there is less risk of being exposed during the workflow of creating, viewing, and editing Pods.</p>
<p>It is possible to create secrets using imperative approach as shown below.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="kubernetes.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the two secrets db-password and api-token</span></span>
<span id="cb50-2"><a href="kubernetes.html#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic mysecret-from-cli <span class="at">--from-literal</span><span class="op">=</span>db-password=123 <span class="at">--from-literal</span><span class="op">=</span>api-token=token</span>
<span id="cb50-3"><a href="kubernetes.html#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="kubernetes.html#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># output the new secret as yaml</span></span>
<span id="cb50-5"><a href="kubernetes.html#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get secret mysecret <span class="at">-o</span> yaml</span>
<span id="cb50-6"><a href="kubernetes.html#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="kubernetes.html#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a file called secret with a file-password in it</span></span>
<span id="cb50-8"><a href="kubernetes.html#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;super-save-password&quot;</span> <span class="op">&gt;</span> secret </span>
<span id="cb50-9"><a href="kubernetes.html#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="kubernetes.html#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create a secret from file</span></span>
<span id="cb50-11"><a href="kubernetes.html#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic mysecret-from-file <span class="at">--from-file</span><span class="op">=</span>secret</span></code></pre></div>
<p>Similar to ConfigMaps, secrets are accessed via an environment variable or a volume.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb51-1"><a href="kubernetes.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># secrets.yaml</span></span>
<span id="cb51-2"><a href="kubernetes.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb51-3"><a href="kubernetes.html#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb51-4"><a href="kubernetes.html#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb51-5"><a href="kubernetes.html#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb51-6"><a href="kubernetes.html#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb51-7"><a href="kubernetes.html#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb51-8"><a href="kubernetes.html#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb51-9"><a href="kubernetes.html#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb51-10"><a href="kubernetes.html#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb51-11"><a href="kubernetes.html#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb51-12"><a href="kubernetes.html#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb51-13"><a href="kubernetes.html#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb51-14"><a href="kubernetes.html#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb51-15"><a href="kubernetes.html#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb51-16"><a href="kubernetes.html#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="co">        # get the secret from a volume</span></span>
<span id="cb51-17"><a href="kubernetes.html#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-vol</span></span>
<span id="cb51-18"><a href="kubernetes.html#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">secret</span><span class="kw">:</span></span>
<span id="cb51-19"><a href="kubernetes.html#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="co">            # the name of the secret we created earlier</span></span>
<span id="cb51-20"><a href="kubernetes.html#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">secretName</span><span class="kw">:</span><span class="at"> mysecret-from-cli</span></span>
<span id="cb51-21"><a href="kubernetes.html#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb51-22"><a href="kubernetes.html#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb51-23"><a href="kubernetes.html#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb51-24"><a href="kubernetes.html#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb51-25"><a href="kubernetes.html#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/secrets</span></span>
<span id="cb51-26"><a href="kubernetes.html#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-vol</span></span>
<span id="cb51-27"><a href="kubernetes.html#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb51-28"><a href="kubernetes.html#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="co">          # nane of the secret in the container</span></span>
<span id="cb51-29"><a href="kubernetes.html#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> CUSTOM_SECRET</span></span>
<span id="cb51-30"><a href="kubernetes.html#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="co">            # get the secret from an environment variable</span></span>
<span id="cb51-31"><a href="kubernetes.html#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb51-32"><a href="kubernetes.html#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb51-33"><a href="kubernetes.html#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="co">                # name and key of the secret we created earlier</span></span>
<span id="cb51-34"><a href="kubernetes.html#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mysecret-from-file</span></span>
<span id="cb51-35"><a href="kubernetes.html#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> secret</span></span>
<span id="cb51-36"><a href="kubernetes.html#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb51-37"><a href="kubernetes.html#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb51-38"><a href="kubernetes.html#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;3600&quot;</span></span>
<span id="cb51-39"><a href="kubernetes.html#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb51-40"><a href="kubernetes.html#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb51-41"><a href="kubernetes.html#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb51-42"><a href="kubernetes.html#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<div id="exemplary-use-case-of-secrets" class="section level3 hasAnchor" number="6.11.1">
<h3><span class="header-section-number">6.11.1</span> Exemplary use case of secrets<a href="kubernetes.html#exemplary-use-case-of-secrets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When pulling from a private dockerhub repository, applying the deployment will throw an error since there are no username and password specified. As they should not be coded into the deployment yaml itself, they can be accessed via a secret. In fact, a specific secret can be specified for docker registry. The secret can be specified using the imperative approach.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="kubernetes.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret docker-registry docker-hub-private <span class="dt">\</span></span>
<span id="cb52-2"><a href="kubernetes.html#cb52-2" aria-hidden="true" tabindex="-1"></a>--docker-username=YOUR_USERNAME <span class="dt">\</span></span>
<span id="cb52-3"><a href="kubernetes.html#cb52-3" aria-hidden="true" tabindex="-1"></a>--docker-password=YOUR_PASSWORD <span class="dt">\</span></span>
<span id="cb52-4"><a href="kubernetes.html#cb52-4" aria-hidden="true" tabindex="-1"></a>--docker-email=YOUR_EMAIL</span></code></pre></div>
<p>Finally, the secret is specified in the deployment configuration where it can be accessed during application.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb53-1"><a href="kubernetes.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># secret_dockerhub.yaml</span></span>
<span id="cb53-2"><a href="kubernetes.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb53-3"><a href="kubernetes.html#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb53-4"><a href="kubernetes.html#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb53-5"><a href="kubernetes.html#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb53-6"><a href="kubernetes.html#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb53-7"><a href="kubernetes.html#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb53-8"><a href="kubernetes.html#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb53-9"><a href="kubernetes.html#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb53-10"><a href="kubernetes.html#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb53-11"><a href="kubernetes.html#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb53-12"><a href="kubernetes.html#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb53-13"><a href="kubernetes.html#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb53-14"><a href="kubernetes.html#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb53-15"><a href="kubernetes.html#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">      # specifiy the docker-registry secret to be accessed</span></span>
<span id="cb53-16"><a href="kubernetes.html#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">imagePullSecrets</span><span class="kw">:</span></span>
<span id="cb53-17"><a href="kubernetes.html#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> docker-hub-private</span></span>
<span id="cb53-18"><a href="kubernetes.html#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb53-19"><a href="kubernetes.html#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb53-20"><a href="kubernetes.html#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="co">        # of course you need an own private repository</span></span>
<span id="cb53-21"><a href="kubernetes.html#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="co">        # to pull and change the name accordingly</span></span>
<span id="cb53-22"><a href="kubernetes.html#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/private:cat-v1</span></span>
<span id="cb53-23"><a href="kubernetes.html#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb53-24"><a href="kubernetes.html#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb53-25"><a href="kubernetes.html#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb53-26"><a href="kubernetes.html#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb53-27"><a href="kubernetes.html#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb53-28"><a href="kubernetes.html#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
</div>
</div>
<div id="health-checks" class="section level2 hasAnchor" number="6.12">
<h2><span class="header-section-number">6.12</span> Health Checks<a href="kubernetes.html#health-checks" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Applications running in service need to be healthy at all times so they are ready to receive traffic. K8s uses a process called health checks to test whether an application is alive. If there are any issues and the application is unhealthy, K8s will restart the process. Yet, checking only whether a process is up and running might be not sufficient. What if, e.g., a client wants to connect to a database and the connection cannot be established, even though the app is up and running? To solve more specific issues like this, health checks like a <em>liveness probe</em> or <em>readiness probe</em> can be used. If there have not been specified, K8s will use the default checks to test whether a process is running.</p>
<div id="liveness-probe" class="section level3 hasAnchor" number="6.12.1">
<h3><span class="header-section-number">6.12.1</span> Liveness Probe<a href="kubernetes.html#liveness-probe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Kubelet of a node uses <em>Liveness Probes</em> to check whether an application runs fine or whether it is unable to make progress and its stuck on a broken state. For example, it could catch a deadlock, a database connection failure, etc. The Liveness Probe can restart a container accordingly. To use a Liveness Probe, an endpoint needs to be specified. The benefit of this is, that it is simple to define what it means for an application to be healthy just by defining a path.</p>
</div>
<div id="readiness-probe" class="section level3 hasAnchor" number="6.12.2">
<h3><span class="header-section-number">6.12.2</span> Readiness Probe<a href="kubernetes.html#readiness-probe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Similar to a Liveness Probe, the <em>Readniness Probe</em> is used by the kubelet to check when the container is ready to start accepting traffic. A Pod is considered ready when all of its containers are ready. Its configuration is also done by specifying a path to what it means the application is healthy. A lot of frameworks, like e.g. springboot, actually provide a path to use.</p>
<p>Belows configuration shows a Deployment which includes a Liveness and a Readiness Probe. The image of the deployment is set up so its process is killed after a given number of seconds. This has been passed using environment variables such as seen in the script. Both, the Liveness and the Readiness Probe have the same parameters in the given example.</p>
<ul>
<li>initialDelaySeconds: The probe will not be called until x seconds after all the containers in the Pod are created.</li>
<li>timeoutSeconds: The probe must respond within a x-second timeout and the HTTP status code must be equal to or greater than 200 and less than 400.</li>
<li>periodSeconds: The probe is called every x seconds by K8s</li>
<li>failureThreshold: The container will fail and restart if more than x consecutive probes fail</li>
</ul>
<div class="sourceCode" id="cb54"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb54-1"><a href="kubernetes.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># healthchecks.yaml</span></span>
<span id="cb54-2"><a href="kubernetes.html#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb54-3"><a href="kubernetes.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb54-4"><a href="kubernetes.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb54-5"><a href="kubernetes.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-6"><a href="kubernetes.html#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb54-7"><a href="kubernetes.html#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb54-8"><a href="kubernetes.html#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb54-9"><a href="kubernetes.html#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb54-10"><a href="kubernetes.html#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-11"><a href="kubernetes.html#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb54-12"><a href="kubernetes.html#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb54-13"><a href="kubernetes.html#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb54-14"><a href="kubernetes.html#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-15"><a href="kubernetes.html#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb54-16"><a href="kubernetes.html#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> backend</span></span>
<span id="cb54-17"><a href="kubernetes.html#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">department</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb54-18"><a href="kubernetes.html#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb54-19"><a href="kubernetes.html#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb54-20"><a href="kubernetes.html#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-21"><a href="kubernetes.html#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co">          # check whether I have to change the backend app to do this.</span></span>
<span id="cb54-22"><a href="kubernetes.html#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/mlops-public:backend-flask&quot;</span></span>
<span id="cb54-23"><a href="kubernetes.html#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Always&quot;</span></span>
<span id="cb54-24"><a href="kubernetes.html#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb54-25"><a href="kubernetes.html#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb54-26"><a href="kubernetes.html#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb54-27"><a href="kubernetes.html#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb54-28"><a href="kubernetes.html#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co">          # Specification of the the Liveness Probe</span></span>
<span id="cb54-29"><a href="kubernetes.html#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb54-30"><a href="kubernetes.html#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb54-31"><a href="kubernetes.html#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="co">              # path of the url</span></span>
<span id="cb54-32"><a href="kubernetes.html#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /liveness</span></span>
<span id="cb54-33"><a href="kubernetes.html#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span>
<span id="cb54-34"><a href="kubernetes.html#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co">            # time the liveness probe starts after pod is started</span></span>
<span id="cb54-35"><a href="kubernetes.html#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb54-36"><a href="kubernetes.html#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">timeoutSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb54-37"><a href="kubernetes.html#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">failureThreshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb54-38"><a href="kubernetes.html#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co">            # period of time when the checks should be performed</span></span>
<span id="cb54-39"><a href="kubernetes.html#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb54-40"><a href="kubernetes.html#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="co">          # Specification of the Readiness Probe</span></span>
<span id="cb54-41"><a href="kubernetes.html#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb54-42"><a href="kubernetes.html#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb54-43"><a href="kubernetes.html#cb54-43" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /readiness</span></span>
<span id="cb54-44"><a href="kubernetes.html#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span>
<span id="cb54-45"><a href="kubernetes.html#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb54-46"><a href="kubernetes.html#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="co">            # change to 1 seconds and see the pod not going to go ready</span></span>
<span id="cb54-47"><a href="kubernetes.html#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">timeoutSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb54-48"><a href="kubernetes.html#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">failureThreshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb54-49"><a href="kubernetes.html#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb54-50"><a href="kubernetes.html#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb54-51"><a href="kubernetes.html#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="co">            # variable for the container to be killed after 60 seconds</span></span>
<span id="cb54-52"><a href="kubernetes.html#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;KILL_IN_SECONDS&quot;</span></span>
<span id="cb54-53"><a href="kubernetes.html#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;60&quot;</span></span>
<span id="cb54-54"><a href="kubernetes.html#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb54-55"><a href="kubernetes.html#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span>
<span id="cb54-56"><a href="kubernetes.html#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb54-57"><a href="kubernetes.html#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb54-58"><a href="kubernetes.html#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb54-59"><a href="kubernetes.html#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb54-60"><a href="kubernetes.html#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-61"><a href="kubernetes.html#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb54-62"><a href="kubernetes.html#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb54-63"><a href="kubernetes.html#cb54-63" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb54-64"><a href="kubernetes.html#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-65"><a href="kubernetes.html#cb54-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb54-66"><a href="kubernetes.html#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb54-67"><a href="kubernetes.html#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb54-68"><a href="kubernetes.html#cb54-68" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">30000</span></span>
<span id="cb54-69"><a href="kubernetes.html#cb54-69" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb54-70"><a href="kubernetes.html#cb54-70" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb54-71"><a href="kubernetes.html#cb54-71" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb54-72"><a href="kubernetes.html#cb54-72" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb54-73"><a href="kubernetes.html#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-74"><a href="kubernetes.html#cb54-74" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb54-75"><a href="kubernetes.html#cb54-75" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb54-76"><a href="kubernetes.html#cb54-76" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb54-77"><a href="kubernetes.html#cb54-77" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> backendflask-healthcheck</span></span>
<span id="cb54-78"><a href="kubernetes.html#cb54-78" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb54-79"><a href="kubernetes.html#cb54-79" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb54-80"><a href="kubernetes.html#cb54-80" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span></code></pre></div>
</div>
</div>
<div id="resource-management" class="section level2 hasAnchor" number="6.13">
<h2><span class="header-section-number">6.13</span> Resource Management<a href="kubernetes.html#resource-management" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Besides the importance of a healthy application itself, there should be also enough resources allocated so the application can perform well, e.g. memory &amp; CPU. Yet, it should also only consume the resources needed and not block unneeded ones. It might be dangerous, as one application using a lot of ressources, leaving nothing left for other applications and eventually starving them. To prevent this from happening in K8s. there can be a minimum amount of resources defined a container needs (request) as well as the maximum amount of resources a container can have (limit). Configuring limits and requests for a container can be done within the spec for a Pod or Deployment. Actually, we have been using them all the time previously.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb55-1"><a href="kubernetes.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># resource-management.yaml</span></span>
<span id="cb55-2"><a href="kubernetes.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb55-3"><a href="kubernetes.html#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># specify that we want a deployment</span></span>
<span id="cb55-4"><a href="kubernetes.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb55-5"><a href="kubernetes.html#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb55-6"><a href="kubernetes.html#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> rm-deployment</span></span>
<span id="cb55-7"><a href="kubernetes.html#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb55-8"><a href="kubernetes.html#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">  # specify number of replicas</span></span>
<span id="cb55-9"><a href="kubernetes.html#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb55-10"><a href="kubernetes.html#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb55-11"><a href="kubernetes.html#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb55-12"><a href="kubernetes.html#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> rm-deployment</span></span>
<span id="cb55-13"><a href="kubernetes.html#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb55-14"><a href="kubernetes.html#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb55-15"><a href="kubernetes.html#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb55-16"><a href="kubernetes.html#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> rm-deployment</span></span>
<span id="cb55-17"><a href="kubernetes.html#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb55-18"><a href="kubernetes.html#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb55-19"><a href="kubernetes.html#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> rm-deployment</span></span>
<span id="cb55-20"><a href="kubernetes.html#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/mlops-public:cat-v1</span></span>
<span id="cb55-21"><a href="kubernetes.html#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb55-22"><a href="kubernetes.html#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;512Mi&quot;</span></span>
<span id="cb55-23"><a href="kubernetes.html#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;1000m&quot;</span></span>
<span id="cb55-24"><a href="kubernetes.html#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="co">        # Limits</span></span>
<span id="cb55-25"><a href="kubernetes.html#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb55-26"><a href="kubernetes.html#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb55-27"><a href="kubernetes.html#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb55-28"><a href="kubernetes.html#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb55-29"><a href="kubernetes.html#cb55-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code></pre></div>
</div>
<div id="deamon-sets" class="section level2 hasAnchor" number="6.14">
<h2><span class="header-section-number">6.14</span> Deamon Sets<a href="kubernetes.html#deamon-sets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The master node of K8s decides on what worker nodes a pod is scheduled or not. However, there are times where we want to have a copy of a pod across the cluster. A <em>DeamonSet</em> ensures a copy of the specified Pod is exactly doing this. This can be useful for example to deploy system daemons such as log collectors and monitoring agents. DeamonSets are automatically deployed on every single node, unless specified on which node to run. They therefore do not need a specification of nodes and can scale up and down with the cluster as needed. They will automatically scheduled a pod on each new node.</p>
<p>The given example deploys a DaemonSet to cover logging using K8s FluendID.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb56-1"><a href="kubernetes.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># daemonsets.yaml</span></span>
<span id="cb56-2"><a href="kubernetes.html#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb56-3"><a href="kubernetes.html#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb56-4"><a href="kubernetes.html#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb56-5"><a href="kubernetes.html#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> logging</span></span>
<span id="cb56-6"><a href="kubernetes.html#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb56-7"><a href="kubernetes.html#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb56-8"><a href="kubernetes.html#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> DaemonSet</span></span>
<span id="cb56-9"><a href="kubernetes.html#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb56-10"><a href="kubernetes.html#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb56-11"><a href="kubernetes.html#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> logging</span></span>
<span id="cb56-12"><a href="kubernetes.html#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb56-13"><a href="kubernetes.html#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">k8s-app</span><span class="kw">:</span><span class="at"> fluentd-logging</span></span>
<span id="cb56-14"><a href="kubernetes.html#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb56-15"><a href="kubernetes.html#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb56-16"><a href="kubernetes.html#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb56-17"><a href="kubernetes.html#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb56-18"><a href="kubernetes.html#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb56-19"><a href="kubernetes.html#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb56-20"><a href="kubernetes.html#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb56-21"><a href="kubernetes.html#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb56-22"><a href="kubernetes.html#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb56-23"><a href="kubernetes.html#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">tolerations</span><span class="kw">:</span></span>
<span id="cb56-24"><a href="kubernetes.html#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co">      # this toleration is to have the daemonset runnable on master nodes</span></span>
<span id="cb56-25"><a href="kubernetes.html#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="co">      # remove it if your masters can&#39;t run pods</span></span>
<span id="cb56-26"><a href="kubernetes.html#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">key</span><span class="kw">:</span><span class="at"> node-role.kubernetes.io/master</span></span>
<span id="cb56-27"><a href="kubernetes.html#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> Exists</span></span>
<span id="cb56-28"><a href="kubernetes.html#cb56-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">effect</span><span class="kw">:</span><span class="at"> NoSchedule</span></span>
<span id="cb56-29"><a href="kubernetes.html#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="co">      # specify the containers as done in Pods or Deployments</span></span>
<span id="cb56-30"><a href="kubernetes.html#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb56-31"><a href="kubernetes.html#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb56-32"><a href="kubernetes.html#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb56-33"><a href="kubernetes.html#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb56-34"><a href="kubernetes.html#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlibdockercontainers</span></span>
<span id="cb56-35"><a href="kubernetes.html#cb56-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb56-36"><a href="kubernetes.html#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/lib/docker/containers</span></span>
<span id="cb56-37"><a href="kubernetes.html#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb56-38"><a href="kubernetes.html#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb56-39"><a href="kubernetes.html#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="co">        # allows to collect logs from nodes</span></span>
<span id="cb56-40"><a href="kubernetes.html#cb56-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span>
<span id="cb56-41"><a href="kubernetes.html#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb56-42"><a href="kubernetes.html#cb56-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb56-43"><a href="kubernetes.html#cb56-43" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 200Mi</span></span>
<span id="cb56-44"><a href="kubernetes.html#cb56-44" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb56-45"><a href="kubernetes.html#cb56-45" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 100m</span></span>
<span id="cb56-46"><a href="kubernetes.html#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 200Mi</span></span>
<span id="cb56-47"><a href="kubernetes.html#cb56-47" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb56-48"><a href="kubernetes.html#cb56-48" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb56-49"><a href="kubernetes.html#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb56-50"><a href="kubernetes.html#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlibdockercontainers</span></span>
<span id="cb56-51"><a href="kubernetes.html#cb56-51" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/lib/docker/containers</span></span>
<span id="cb56-52"><a href="kubernetes.html#cb56-52" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">readOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb56-53"><a href="kubernetes.html#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">terminationGracePeriodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span></code></pre></div>
</div>
<div id="statefulsets" class="section level2 hasAnchor" number="6.15">
<h2><span class="header-section-number">6.15</span> StatefulSets<a href="kubernetes.html#statefulsets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><em>StatefulSets</em> are used to deploy and manage stateful applications. Stateful applications are applications which are long lived, for example databases. Most applications of K8s are stateless as they only run for a specific task. However, a database is a state of truth and should be present at all time. StatefulSets manage the pods based on the same container specifications such as Deployments.</p>
<p>Lets assume we have a StatefulSet with 3 replicas. Each Pod has a PV attached.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode yaml"><code class="sourceCode yaml"></code></pre></div>
</div>
<div id="jobs-cron-jobs" class="section level2 hasAnchor" number="6.16">
<h2><span class="header-section-number">6.16</span> Jobs &amp; Cron Jobs<a href="kubernetes.html#jobs-cron-jobs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Using the <em>busybox</em> image in the section about volumes we experienced that the image is very short lived. K8s is not aware of this and runs into a CrashLoopBackOff-Error. K8s will try and restart the container itself though until it BackOffs completley. Because the image is so short live, a job within the image has to be executed such as done with a shell command previously. However, what if we have a simple task that only should run like every 5 minutes, or every single day? A good idea is to use CronJobs for such tasks that start the image if needed. When comparingJobs jobs and CronJobs, jobs execute only once, whereas CronJobs execute depending on an specified expression.</p>
<p>The following job simulates a backup to a database that runs 30 seconds in total. The part in the <code>args</code> specifies that the container will sleep for 20 seconds (the hypothetical backup). Afterward, the container will wait 10 seconds to shut down, as specified in <code>ttlSecondsAfterFinished</code>.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb58-1"><a href="kubernetes.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># job.yaml</span></span>
<span id="cb58-2"><a href="kubernetes.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb58-3"><a href="kubernetes.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Job</span></span>
<span id="cb58-4"><a href="kubernetes.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb58-5"><a href="kubernetes.html#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> db-backup-job</span></span>
<span id="cb58-6"><a href="kubernetes.html#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb58-7"><a href="kubernetes.html#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co">  # time it takes to terminate the job for one completion</span></span>
<span id="cb58-8"><a href="kubernetes.html#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb58-9"><a href="kubernetes.html#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb58-10"><a href="kubernetes.html#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb58-11"><a href="kubernetes.html#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb58-12"><a href="kubernetes.html#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backup</span></span>
<span id="cb58-13"><a href="kubernetes.html#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb58-14"><a href="kubernetes.html#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="kw">]</span></span>
<span id="cb58-15"><a href="kubernetes.html#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb58-16"><a href="kubernetes.html#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;echo &#39;performing db backup...&#39; &amp;&amp; sleep 20&quot;</span></span>
<span id="cb58-17"><a href="kubernetes.html#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>
<p>The CronJob below runs run every minute. Given the structure of ( * * * * * * ) - ( Minutes Hours Day-of-month Month Day-of-week Year), the cronjob expression defines as follows:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb59-1"><a href="kubernetes.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cronjob.yaml</span></span>
<span id="cb59-2"><a href="kubernetes.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb59-3"><a href="kubernetes.html#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CronJob</span></span>
<span id="cb59-4"><a href="kubernetes.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb59-5"><a href="kubernetes.html#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> db-backup-cron-job</span></span>
<span id="cb59-6"><a href="kubernetes.html#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb59-7"><a href="kubernetes.html#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;*/1 * * * *&quot;</span></span>
<span id="cb59-8"><a href="kubernetes.html#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobTemplate</span><span class="kw">:</span></span>
<span id="cb59-9"><a href="kubernetes.html#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb59-10"><a href="kubernetes.html#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb59-11"><a href="kubernetes.html#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb59-12"><a href="kubernetes.html#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb59-13"><a href="kubernetes.html#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backup</span></span>
<span id="cb59-14"><a href="kubernetes.html#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb59-15"><a href="kubernetes.html#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="kw">]</span></span>
<span id="cb59-16"><a href="kubernetes.html#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb59-17"><a href="kubernetes.html#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;echo &#39;performing db backup...&#39; &amp;&amp; sleep 20&quot;</span></span>
<span id="cb59-18"><a href="kubernetes.html#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="architecture.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/04-Kubernetes.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
