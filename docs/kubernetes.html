<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Kubernetes | MLOps Architecture from scratch</title>
  <meta name="description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Kubernetes | MLOps Architecture from scratch" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  <meta name="github-repo" content="seblum/kubernetes-training" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Kubernetes | MLOps Architecture from scratch" />
  
  <meta name="twitter:description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  

<meta name="author" content="Sebastian Blum" />


<meta name="date" content="2022-07-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#topics"><i class="fa fa-check"></i>Topics</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#a-work-in-progress"><i class="fa fa-check"></i>A work in progress</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>3</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="3.1" data-path="kubernetes.html"><a href="kubernetes.html#pods"><i class="fa fa-check"></i><b>3.1</b> Pods</a>
<ul>
<li class="chapter" data-level="" data-path="kubernetes.html"><a href="kubernetes.html#imperative-declarative-management"><i class="fa fa-check"></i>Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="kubernetes.html"><a href="kubernetes.html#kubectl"><i class="fa fa-check"></i><b>3.2</b> Kubectl</a></li>
<li class="chapter" data-level="3.3" data-path="kubernetes.html"><a href="kubernetes.html#labels-selectors-and-annotations---tbf"><i class="fa fa-check"></i><b>3.3</b> Labels, Selectors and Annotations - TBF</a></li>
<li class="chapter" data-level="3.4" data-path="kubernetes.html"><a href="kubernetes.html#service-discovery"><i class="fa fa-check"></i><b>3.4</b> Service Discovery</a></li>
<li class="chapter" data-level="3.5" data-path="kubernetes.html"><a href="kubernetes.html#volume-storage"><i class="fa fa-check"></i><b>3.5</b> Volume &amp; Storage</a></li>
<li class="chapter" data-level="3.6" data-path="kubernetes.html"><a href="kubernetes.html#configmaps"><i class="fa fa-check"></i><b>3.6</b> ConfigMaps</a></li>
<li class="chapter" data-level="3.7" data-path="kubernetes.html"><a href="kubernetes.html#secrets"><i class="fa fa-check"></i><b>3.7</b> Secrets</a></li>
<li class="chapter" data-level="3.8" data-path="kubernetes.html"><a href="kubernetes.html#namespaces"><i class="fa fa-check"></i><b>3.8</b> Namespaces</a></li>
<li class="chapter" data-level="3.9" data-path="kubernetes.html"><a href="kubernetes.html#health-checks"><i class="fa fa-check"></i><b>3.9</b> Health Checks</a></li>
<li class="chapter" data-level="3.10" data-path="kubernetes.html"><a href="kubernetes.html#ressource-management"><i class="fa fa-check"></i><b>3.10</b> Ressource Management</a></li>
<li class="chapter" data-level="3.11" data-path="kubernetes.html"><a href="kubernetes.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>3.11</b> Jobs &amp; Cron Jobs</a></li>
<li class="chapter" data-level="3.12" data-path="kubernetes.html"><a href="kubernetes.html#deamon-sets"><i class="fa fa-check"></i><b>3.12</b> Deamon Sets</a></li>
<li class="chapter" data-level="3.13" data-path="kubernetes.html"><a href="kubernetes.html#statefulsets"><i class="fa fa-check"></i><b>3.13</b> StatefulSets</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Architecture from scratch</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="kubernetes" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Kubernetes<a href="kubernetes.html#kubernetes" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>To render this example to PDF as a <code>bookdown::pdf_book</code>, youâ€™ll need to install XeLaTeX.</p>
<div id="pods" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Pods<a href="kubernetes.html#pods" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In K8s, a pod is the smallest deployable unit (and not containers | In contrast to K8s, the smallest deployable unit for docker are containers.). Within a pod there is always one <em>main container</em> representing the application (in whatever language written, e.g.Â JS, Python, Go). Further within a pod, there may or may not be <em>init containers</em>, and/or <em>side containers</em>. Init containers are containers that are executed before the main container. Side containers are containers that support the main containers, e.g.Â a container that acts as a proxy to your main container. Also within pods there may also be volumes, which enables containers to share data between them.</p>
<!--- TODO: insert image --->
<div class="figure">
<img src="kubernetes_pod.png" alt="" />
<p class="caption">Pod</p>
</div>
<p>Containers communicate with each other within a pod using localhost and whatever port they expose. The port itself has a unique ip adress. This enables communication between pods via the unique adress.</p>
<ul>
<li>group of one or more Container</li>
<li>represents a running process</li>
<li>shares Network and Volumes</li>
<li>Never Create Pods on its own. Use Controllers instead, e.g.Â Deployments</li>
<li>Ephemeral (not a long lifetime) and disposable</li>
</ul>
<div id="imperative-declarative-management" class="section level3 unnumbered hasAnchor">
<h3>Imperative &amp; Declarative Management<a href="kubernetes.html#imperative-declarative-management" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The imperative approach is good for learning, troubleshooting, and experimenting on the cluster. While the declarative approach is reproducible, which means the same configuration can be applied in different environments (prod/dev). This is best practice to use when building a cluster. This differentiation does not only hold for pods, but for all ressources within a cluster.</p>
<div id="imperative-management" class="section level4 unnumbered hasAnchor">
<h4>Imperative Management<a href="kubernetes.html#imperative-management" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="kubernetes.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> run <span class="op">&lt;</span>pod-name<span class="op">&gt;</span> --image=<span class="st">&quot;&lt;image-name&gt;&quot;</span> <span class="at">--port</span><span class="op">=</span>80</span>
<span id="cb1-2"><a href="kubernetes.html#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="kubernetes.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># run following to test your pods</span></span>
<span id="cb1-4"><a href="kubernetes.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># in your browser, go to localhost:8080</span></span>
<span id="cb1-5"><a href="kubernetes.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward pod/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span></code></pre></div>
</div>
<div id="declarative-management-configuration" class="section level4 unnumbered hasAnchor">
<h4>Declarative Management / Configuration<a href="kubernetes.html#declarative-management-configuration" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Declarative configuration is done using a <em>yaml</em>. This works basically on key-value pairs.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="kubernetes.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb2-2"><a href="kubernetes.html#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb2-3"><a href="kubernetes.html#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="kubernetes.html#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb2-5"><a href="kubernetes.html#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="kubernetes.html#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello-world</span></span>
<span id="cb2-7"><a href="kubernetes.html#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="kubernetes.html#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">  # remember: a pod is a selection of one or more containers, </span></span>
<span id="cb2-9"><a href="kubernetes.html#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">  # we can also set more</span></span>
<span id="cb2-10"><a href="kubernetes.html#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb2-11"><a href="kubernetes.html#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hello</span></span>
<span id="cb2-12"><a href="kubernetes.html#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;&lt;image-name&gt;&quot;</span></span>
<span id="cb2-13"><a href="kubernetes.html#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    # This pod can access only a the amount of ressources specified under limits</span></span>
<span id="cb2-14"><a href="kubernetes.html#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ressources</span><span class="kw">:</span></span>
<span id="cb2-15"><a href="kubernetes.html#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb2-16"><a href="kubernetes.html#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb2-17"><a href="kubernetes.html#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb2-18"><a href="kubernetes.html#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb2-19"><a href="kubernetes.html#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ContainerPorts</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
<p>Appyl this declarative configuration using the following kubectl command.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="kubernetes.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> <span class="st">&quot;file-name.yaml&quot;</span></span>
<span id="cb3-2"><a href="kubernetes.html#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="kubernetes.html#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># run following to test your pods</span></span>
<span id="cb3-4"><a href="kubernetes.html#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># in your browser, go to localhost:8080</span></span>
<span id="cb3-5"><a href="kubernetes.html#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward pod/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span></code></pre></div>
</div>
</div>
</div>
<div id="kubectl" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Kubectl<a href="kubernetes.html#kubectl" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="kubernetes.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run following to test your pods</span></span>
<span id="cb4-2"><a href="kubernetes.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in your browser, go to localhost:8080</span></span>
<span id="cb4-3"><a href="kubernetes.html#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> port-forward pod/<span class="op">&lt;</span>pod-name<span class="op">&gt;</span> 8080:80</span>
<span id="cb4-4"><a href="kubernetes.html#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="kubernetes.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># show all pods currently running in the cluster</span></span>
<span id="cb4-6"><a href="kubernetes.html#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods</span>
<span id="cb4-7"><a href="kubernetes.html#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="kubernetes.html#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># delete a pod</span></span>
<span id="cb4-9"><a href="kubernetes.html#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> delete pods <span class="op">&lt;</span>pod-name<span class="op">&gt;</span></span></code></pre></div>
</div>
<div id="labels-selectors-and-annotations---tbf" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Labels, Selectors and Annotations - TBF<a href="kubernetes.html#labels-selectors-and-annotations---tbf" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have seen labels in the yamls under metadata beforehand. What are they actually doing? Labels are a key-value pair that can be attached to objects such as Pods, Deployments, Replicaset, Services, etc. They are used to organize and select objects.</p>
<p>Selectors are used to filter K8s objects based on a set of labels. A selector basically simply uses a boolean language to select pods. The selector matches all or nothing. Everything specified in the selector must be fulfilled in the labels. However, this goes not the other way around. If we have multiple labels and the only one selector, which actually matches one of the labels, the selector will match the object This is seen in below example.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="kubernetes.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all pods including their labels</span></span>
<span id="cb5-2"><a href="kubernetes.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--show-labels</span></span>
<span id="cb5-3"><a href="kubernetes.html#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="kubernetes.html#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Show only pods that match the specified selector key-value pairs</span></span>
<span id="cb5-5"><a href="kubernetes.html#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--selector</span><span class="op">=</span><span class="st">&quot;key=value&quot;</span></span>
<span id="cb5-6"><a href="kubernetes.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--selector</span><span class="op">=</span><span class="st">&quot;key=value,key2=value2&quot;</span></span>
<span id="cb5-7"><a href="kubernetes.html#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="kubernetes.html#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># in short you can also write</span></span>
<span id="cb5-9"><a href="kubernetes.html#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">-l</span> key=value</span>
<span id="cb5-10"><a href="kubernetes.html#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># or also look for multiple</span></span>
<span id="cb5-11"><a href="kubernetes.html#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">-l</span> <span class="st">&#39;key in (value1, value2)&#39;</span></span></code></pre></div>
<p>Match a replicaset to a Pod. Any Pods has the label app:customer. The replicaset create replicas by selecting only labels matching to app: customer. We can also use multiple labels.
Service matches to both pods, blue and green. The Service labels-and-selectors-2 has no endpoints, as it is all or none, and no pod has the label environment=service.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="kubernetes.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb6-2"><a href="kubernetes.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb6-3"><a href="kubernetes.html#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-4"><a href="kubernetes.html#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> blue</span></span>
<span id="cb6-5"><a href="kubernetes.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="kubernetes.html#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> blue</span></span>
<span id="cb6-7"><a href="kubernetes.html#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb6-8"><a href="kubernetes.html#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kubernetes.io/change-cause</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/kubernetes:hello-world&quot;</span></span>
<span id="cb6-9"><a href="kubernetes.html#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-10"><a href="kubernetes.html#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb6-11"><a href="kubernetes.html#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> blue</span></span>
<span id="cb6-12"><a href="kubernetes.html#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/kubernetes:blue&quot;</span></span>
<span id="cb6-13"><a href="kubernetes.html#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb6-14"><a href="kubernetes.html#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb6-15"><a href="kubernetes.html#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb6-16"><a href="kubernetes.html#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cpu</span><span class="kw">:</span><span class="at">    </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb6-17"><a href="kubernetes.html#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb6-18"><a href="kubernetes.html#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb6-19"><a href="kubernetes.html#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb6-20"><a href="kubernetes.html#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-21"><a href="kubernetes.html#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> green</span></span>
<span id="cb6-22"><a href="kubernetes.html#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb6-23"><a href="kubernetes.html#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> blue    </span></span>
<span id="cb6-24"><a href="kubernetes.html#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-25"><a href="kubernetes.html#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb6-26"><a href="kubernetes.html#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> green</span></span>
<span id="cb6-27"><a href="kubernetes.html#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;seblum/kubernetes:green&quot;</span></span>
<span id="cb6-28"><a href="kubernetes.html#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb6-29"><a href="kubernetes.html#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb6-30"><a href="kubernetes.html#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb6-31"><a href="kubernetes.html#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cpu</span><span class="kw">:</span><span class="at">  </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb6-32"><a href="kubernetes.html#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb6-33"><a href="kubernetes.html#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb6-34"><a href="kubernetes.html#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb6-35"><a href="kubernetes.html#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-36"><a href="kubernetes.html#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> labels-and-selectors</span></span>
<span id="cb6-37"><a href="kubernetes.html#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-38"><a href="kubernetes.html#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb6-39"><a href="kubernetes.html#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb6-40"><a href="kubernetes.html#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> blue</span></span>
<span id="cb6-41"><a href="kubernetes.html#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb6-42"><a href="kubernetes.html#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb6-43"><a href="kubernetes.html#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb6-44"><a href="kubernetes.html#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb6-45"><a href="kubernetes.html#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb6-46"><a href="kubernetes.html#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb6-47"><a href="kubernetes.html#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb6-48"><a href="kubernetes.html#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> labels-and-selectors-2</span></span>
<span id="cb6-49"><a href="kubernetes.html#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb6-50"><a href="kubernetes.html#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb6-51"><a href="kubernetes.html#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb6-52"><a href="kubernetes.html#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> blue</span></span>
<span id="cb6-53"><a href="kubernetes.html#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> service</span></span>
<span id="cb6-54"><a href="kubernetes.html#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb6-55"><a href="kubernetes.html#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb6-56"><a href="kubernetes.html#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8081</span></span></code></pre></div>
<p>Test it using:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="kubernetes.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all pods including their labels</span></span>
<span id="cb7-2"><a href="kubernetes.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe svc labels-and-selectors</span>
<span id="cb7-3"><a href="kubernetes.html#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="kubernetes.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Show only pods that match the specified selector key-value pairs</span></span>
<span id="cb7-5"><a href="kubernetes.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">--selector</span><span class="op">=</span><span class="st">&quot;key=value&quot;</span></span></code></pre></div>
<p>Annotations is an unstructures key value map stored with a resource that may be set by external tools to store and retrieve any metadata. They are not used for queriying purposes. They are used to assist tools and libraries to work with the Kubernetes object. For e.g.Â to pass configuration around between systems. Send some value that external tools know more perform informed decisions based on the annotiations provided.</p>
</div>
<div id="service-discovery" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Service Discovery<a href="kubernetes.html#service-discovery" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Service Discovery is a mechanism for applications and microservices to locate each other on a network. Actually, we have used Service Discovery already in the previous sections, we just havenâ€™t mentioned it yet. As the name says, Service Discovery happens through services.</p>
<p>If a client wants to communicate with the application, we should not use the individual pod ip, because pods are ephemeral. Instead, we should rely on services, because they have a stable IP address. Also, it has a DNS.</p>
<p>DNS (Domain Name System) translates domain names to IP addresses so browsers can load internet resources.</p>
<!--- TODO: insert image --->
<div class="figure">
<img src="kubernetes_service-discovery.png" alt="" />
<p class="caption">Service Discovery</p>
</div>
<p>How does service registration work?
When a service is created, it is registered in the service registry with the service name and the service IP. Most clusters use CoreDNS as a service registry. Looking it the cluster, one will see that der is a core-dns service running. If you have a closer look using describe, this service has only one endpoint. Now you know what it is good for.</p>
<p>If you want to have an even closer look, you can look on the pods themselves and check the file /etc/resolv.conf. There you find a nameserver <IP> where the IP is the one of the core-dns</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="kubernetes.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get pods <span class="at">-n</span> kube-system</span>
<span id="cb8-2"><a href="kubernetes.html#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="kubernetes.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get service <span class="at">-n</span> kube-system</span>
<span id="cb8-4"><a href="kubernetes.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="kubernetes.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># command for queriying the dns  </span></span>
<span id="cb8-6"><a href="kubernetes.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">nslookup</span> <span class="op">&lt;</span>podname<span class="op">&gt;</span></span></code></pre></div>
<p>Accessing services from different namespaces. Querying services depends on the namespace you are in.</p>
<p>With a service, one gets an associated endpoint with it. The endpoint contains a list of ip adresses to pods which have matched a particular selector, and also which are healthy. If a pod is not healthy, there is no point of a service to loadbalance traffic between those pods.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="kubernetes.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get endpoints</span></code></pre></div>
<div id="kube-proxy" class="section level4 hasAnchor" number="3.4.0.1">
<h4><span class="header-section-number">3.4.0.1</span> kube-proxy<a href="kubernetes.html#kube-proxy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Each node has three components: Kubelet, Container Runtime, Kube Proxy.</p>
<p>Kubeproxy is a networkd proxy that runs on each node. Implementing part of the K8s service. It maintains networks rules to allow communication to pods from inside and outside the cluster. Kubeproxy also implements a controller that watches the API server for new services and endpoints. When there is a new service or endpoint, the kubeproxy creates a local IPVS rule that tells the node to intercept traffic destined to the service clusterIP. IPVS (IP virtual server) is built on top of the net filter and implements a transport layer load balancing as part of the linux kernel. It gives the ability to load balance to real service.
Kubepory also redirects traffic to pods that match service label selectors.</p>
<p>Kubeproy is intercepting all the requests and makes sure that when a request to the cluster ip is sent. using endpoints. Request is sent to the healthy pods behind the endpoints.</p>
</div>
</div>
<div id="volume-storage" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Volume &amp; Storage<a href="kubernetes.html#volume-storage" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Since Pods are ephemeral, any data associated is deleted when a pod or container restarts. However, there are times when data wants to be kept, share data between Pods, or persist data to the host file system (disk). The majority of the times, applications are run stateless, meaning we dont want to keep data on the node and store data in a DB. Yet, there are times we want to have access to the file system.
When we look at the previous section of the pods. A pod can contain volumes. They are used to store and access data which can be sure or long lived on K8s.</p>
<p>Different types of volumes
+ EmptyDir
+ HostPath Volume</p>
<p>Volume: EmptyDir
The volume is initially empty (as the name suggests), and the volume is a temporary directory that shares the pods lifetime. If the pod dies, the contents of the emptyDir are lost. It is also used to share data between containers inside a Pod.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="kubernetes.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb10-2"><a href="kubernetes.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb10-3"><a href="kubernetes.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="kubernetes.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb10-5"><a href="kubernetes.html#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb10-6"><a href="kubernetes.html#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb10-7"><a href="kubernetes.html#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb10-8"><a href="kubernetes.html#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb10-9"><a href="kubernetes.html#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb10-10"><a href="kubernetes.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb10-11"><a href="kubernetes.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb10-12"><a href="kubernetes.html#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> emptydir-volume</span></span>
<span id="cb10-13"><a href="kubernetes.html#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb10-14"><a href="kubernetes.html#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb10-15"><a href="kubernetes.html#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">        # mimic a caching memory type</span></span>
<span id="cb10-16"><a href="kubernetes.html#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">        # we can also add a second volume</span></span>
<span id="cb10-17"><a href="kubernetes.html#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb10-18"><a href="kubernetes.html#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">          # now that we have this temp directory, we can use it in the containers</span></span>
<span id="cb10-19"><a href="kubernetes.html#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">emptyDir</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span><span class="at">    </span></span>
<span id="cb10-20"><a href="kubernetes.html#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb10-21"><a href="kubernetes.html#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-one</span></span>
<span id="cb10-22"><a href="kubernetes.html#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox </span></span>
<span id="cb10-23"><a href="kubernetes.html#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">        # image used for testing purposes</span></span>
<span id="cb10-24"><a href="kubernetes.html#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">        # since the testing image immediately dies, we want to</span></span>
<span id="cb10-25"><a href="kubernetes.html#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">        # execute our own sh command to interact with the volume</span></span>
<span id="cb10-26"><a href="kubernetes.html#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb10-27"><a href="kubernetes.html#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">            # The name must match the name of the volume</span></span>
<span id="cb10-28"><a href="kubernetes.html#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb10-29"><a href="kubernetes.html#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">            # interal reference of the pod </span></span>
<span id="cb10-30"><a href="kubernetes.html#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /foo</span></span>
<span id="cb10-31"><a href="kubernetes.html#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb10-32"><a href="kubernetes.html#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb10-33"><a href="kubernetes.html#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb10-34"><a href="kubernetes.html#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb10-35"><a href="kubernetes.html#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;touch /foo/bar.txt &amp;&amp; sleep 3600&quot;</span></span>
<span id="cb10-36"><a href="kubernetes.html#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb10-37"><a href="kubernetes.html#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb10-38"><a href="kubernetes.html#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb10-39"><a href="kubernetes.html#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb10-40"><a href="kubernetes.html#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-two</span></span>
<span id="cb10-41"><a href="kubernetes.html#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb10-42"><a href="kubernetes.html#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb10-43"><a href="kubernetes.html#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> cache</span></span>
<span id="cb10-44"><a href="kubernetes.html#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /footwo</span></span>
<span id="cb10-45"><a href="kubernetes.html#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb10-46"><a href="kubernetes.html#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb10-47"><a href="kubernetes.html#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;3600&quot;</span></span>
<span id="cb10-48"><a href="kubernetes.html#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb10-49"><a href="kubernetes.html#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb10-50"><a href="kubernetes.html#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb10-51"><a href="kubernetes.html#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>if we would create it without the shell commands, the pod will be in a crashloopbackoff. So it is caught in the sleep command. We can check whether the foo/bar.txt is actually created.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="kubernetes.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get in container</span></span>
<span id="cb11-2"><a href="kubernetes.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>emptydir-volume-name<span class="op">&gt;</span> -c container-one <span class="at">--</span> sh</span>
<span id="cb11-3"><a href="kubernetes.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check whether bar.txt is present</span></span>
<span id="cb11-4"><a href="kubernetes.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span>
<span id="cb11-5"><a href="kubernetes.html#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="kubernetes.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># going in the second container, there is also a file foo/bar.txt</span></span>
<span id="cb11-7"><a href="kubernetes.html#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># remember, both containers share the same volume</span></span>
<span id="cb11-8"><a href="kubernetes.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> exec <span class="at">-it</span> <span class="op">&lt;</span>emptydir-volume-name<span class="op">&gt;</span> -c container-two <span class="at">--</span> sh</span>
<span id="cb11-9"><a href="kubernetes.html#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span></code></pre></div>
<p>Volume: HostPath Volume type is used when an application need to access the underlying host file system, so the node file system. This can be quite dangerous. If you have the right access, the application can mess up the host. Thus, it is recommended to have it read only. HostPath represents a pre-existing file or directory on the host machine.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb12-1"><a href="kubernetes.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb12-2"><a href="kubernetes.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb12-3"><a href="kubernetes.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb12-4"><a href="kubernetes.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb12-5"><a href="kubernetes.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb12-6"><a href="kubernetes.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb12-7"><a href="kubernetes.html#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb12-8"><a href="kubernetes.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb12-9"><a href="kubernetes.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb12-10"><a href="kubernetes.html#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb12-11"><a href="kubernetes.html#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb12-12"><a href="kubernetes.html#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> hostpath-volume</span></span>
<span id="cb12-13"><a href="kubernetes.html#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb12-14"><a href="kubernetes.html#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb12-15"><a href="kubernetes.html#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> var-log</span></span>
<span id="cb12-16"><a href="kubernetes.html#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">HostPath</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb12-17"><a href="kubernetes.html#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb12-18"><a href="kubernetes.html#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb12-19"><a href="kubernetes.html#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> container-one</span></span>
<span id="cb12-20"><a href="kubernetes.html#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox </span></span>
<span id="cb12-21"><a href="kubernetes.html#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb12-22"><a href="kubernetes.html#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> var-log</span></span>
<span id="cb12-23"><a href="kubernetes.html#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="at">             </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb12-24"><a href="kubernetes.html#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb12-25"><a href="kubernetes.html#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb12-26"><a href="kubernetes.html#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb12-27"><a href="kubernetes.html#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb12-28"><a href="kubernetes.html#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;touch /foo/bar.txt &amp;&amp; sleep 3600&quot;</span></span>
<span id="cb12-29"><a href="kubernetes.html#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb12-30"><a href="kubernetes.html#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb12-31"><a href="kubernetes.html#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb12-32"><a href="kubernetes.html#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>If you ssh into the node, you see the file /foo/bar.txt</p>
<p>Other volume types
+ awsElasticBlockStore: EBS volumes are persisted and originally unmounted. Read Write one only
+ Full list can be found here: <a href="https://kubernetes.io/docs/concepts/storage/volumes/#volume-types" class="uri">https://kubernetes.io/docs/concepts/storage/volumes/#volume-types</a></p>
<div id="persistent-volumes" class="section level4 hasAnchor" number="3.5.0.1">
<h4><span class="header-section-number">3.5.0.1</span> Persistent Volumes<a href="kubernetes.html#persistent-volumes" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Persistent Volumes allow us to store data beyond Pod lifecycle. If a Pod fails, dies or moves to a different node, it does not matter. The data is still intact and will be shared between pods. Persistent Volume types are implemented as plugins (a full list can be found online). Kubernetes supports different persistent volume types, such as:
+ NFS
+ Local
+ Cloud Network storage (AWS EBS, Azure File Storage, Google Persistent Disk)</p>
<p>How it works:
K8s is running on EKS. We have a AWS EBS. In K8s we have a Container storage interface (CSI). This CSI has to be implemented by the EBS. There is a aws-ebs-plugin, which is implemented by the provider. This gives us a persistent volume. Really, a Persistent Volume is the mapping between the storage provider (EBS) To the kubernetes cluster. If a pod wants to consume storage of a volume, We have to use a persistent volume claim (PVC)</p>
<!--- TODO: insert image --->
<div class="figure">
<img src="kubernetes_Persistent-Volume-Subsystem.png" alt="" />
<p class="caption">Persistent Volume Subsystem</p>
</div>
<p>All of this is part of a Persistent Volume Subsystem. A Persistent Volume Subsystem provides an API for users and administrators that abstracts details of how storage is provided from how it is consumed. This is done using Persistent Volume and PVC.</p>
<p>From a PV, we can configure the storage class. Do we want a fast, slow, or both storage. What are the paramters to configure our storage?
PVC is how an enduser (pods) gets access to the persistent volume.</p>
<p>Persistent Volume: is a storage resource provisioned by an administrator
PVC: is a userâ€™s request for and claim to a persistent volume.
Storage Class: describes the parameters for a class of storage for which PersistentVolumes can be dynamically provisioned.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb13-1"><a href="kubernetes.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb13-2"><a href="kubernetes.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolume</span></span>
<span id="cb13-3"><a href="kubernetes.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-4"><a href="kubernetes.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mypv</span></span>
<span id="cb13-5"><a href="kubernetes.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-6"><a href="kubernetes.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">capacity</span><span class="kw">:</span></span>
<span id="cb13-7"><a href="kubernetes.html#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;100Mi&quot;</span></span>
<span id="cb13-8"><a href="kubernetes.html#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">volumeMode</span><span class="kw">:</span><span class="at"> Filesystem</span></span>
<span id="cb13-9"><a href="kubernetes.html#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb13-10"><a href="kubernetes.html#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb13-11"><a href="kubernetes.html#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">persistentVolumeReclaimPolicy</span><span class="kw">:</span><span class="at"> Recycle</span></span>
<span id="cb13-12"><a href="kubernetes.html#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClassName</span><span class="kw">:</span><span class="at"> manual</span></span>
<span id="cb13-13"><a href="kubernetes.html#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb13-14"><a href="kubernetes.html#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">    # this path on node</span></span>
<span id="cb13-15"><a href="kubernetes.html#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/mnt/data&quot;</span></span>
<span id="cb13-16"><a href="kubernetes.html#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="kubernetes.html#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb13-18"><a href="kubernetes.html#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="kubernetes.html#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb13-20"><a href="kubernetes.html#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> PersistentVolumeClaim</span></span>
<span id="cb13-21"><a href="kubernetes.html#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-22"><a href="kubernetes.html#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mypvc</span></span>
<span id="cb13-23"><a href="kubernetes.html#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-24"><a href="kubernetes.html#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb13-25"><a href="kubernetes.html#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb13-26"><a href="kubernetes.html#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;100Mi&quot;</span></span>
<span id="cb13-27"><a href="kubernetes.html#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">volumeMode</span><span class="kw">:</span><span class="at"> Filesystem</span></span>
<span id="cb13-28"><a href="kubernetes.html#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClassName</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;manual&quot;</span></span>
<span id="cb13-29"><a href="kubernetes.html#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">accessModes</span><span class="kw">:</span></span>
<span id="cb13-30"><a href="kubernetes.html#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ReadWriteOnce</span></span>
<span id="cb13-31"><a href="kubernetes.html#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="kubernetes.html#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb13-33"><a href="kubernetes.html#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="kubernetes.html#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb13-35"><a href="kubernetes.html#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb13-36"><a href="kubernetes.html#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-37"><a href="kubernetes.html#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc-deployment</span></span>
<span id="cb13-38"><a href="kubernetes.html#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-39"><a href="kubernetes.html#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb13-40"><a href="kubernetes.html#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb13-41"><a href="kubernetes.html#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb13-42"><a href="kubernetes.html#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb13-43"><a href="kubernetes.html#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-44"><a href="kubernetes.html#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb13-45"><a href="kubernetes.html#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb13-46"><a href="kubernetes.html#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-47"><a href="kubernetes.html#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb13-48"><a href="kubernetes.html#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> data</span></span>
<span id="cb13-49"><a href="kubernetes.html#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co">          # here we define that we want to use the PVC by the name</span></span>
<span id="cb13-50"><a href="kubernetes.html#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">persistentVolumeClaim</span><span class="kw">:</span></span>
<span id="cb13-51"><a href="kubernetes.html#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">claimName</span><span class="kw">:</span><span class="at"> mypvc</span></span>
<span id="cb13-52"><a href="kubernetes.html#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb13-53"><a href="kubernetes.html#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb13-54"><a href="kubernetes.html#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">        # default image</span></span>
<span id="cb13-55"><a href="kubernetes.html#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb13-56"><a href="kubernetes.html#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb13-57"><a href="kubernetes.html#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co">            # now that we have the claim, we have to mount inside the container</span></span>
<span id="cb13-58"><a href="kubernetes.html#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="co">            # is this on pod</span></span>
<span id="cb13-59"><a href="kubernetes.html#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/usr/share/nginx/html&quot;</span></span>
<span id="cb13-60"><a href="kubernetes.html#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="co">            # name is equal to the pvc name specified</span></span>
<span id="cb13-61"><a href="kubernetes.html#cb13-61" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> data</span></span>
<span id="cb13-62"><a href="kubernetes.html#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb13-63"><a href="kubernetes.html#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb13-64"><a href="kubernetes.html#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb13-65"><a href="kubernetes.html#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb13-66"><a href="kubernetes.html#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb13-67"><a href="kubernetes.html#cb13-67" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb13-68"><a href="kubernetes.html#cb13-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-69"><a href="kubernetes.html#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb13-70"><a href="kubernetes.html#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="kubernetes.html#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb13-72"><a href="kubernetes.html#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb13-73"><a href="kubernetes.html#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-74"><a href="kubernetes.html#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb13-75"><a href="kubernetes.html#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-76"><a href="kubernetes.html#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb13-77"><a href="kubernetes.html#cb13-77" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb13-78"><a href="kubernetes.html#cb13-78" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> pv-pvc</span></span>
<span id="cb13-79"><a href="kubernetes.html#cb13-79" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb13-80"><a href="kubernetes.html#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb13-81"><a href="kubernetes.html#cb13-81" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
</div>
</div>
<div id="configmaps" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> ConfigMaps<a href="kubernetes.html#configmaps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Container Images shoud be reusable. So when you build software, the same Image should be used for Dev, Test, Staging, and Production. What only changes in your application is the configuration.</p>
<p>ConfigMaps should only be used to store configuration files, not sensitive data.</p>
<p>This allows for reusable application images. It is much simpler to test, and further configuration changes are disruptive, meaning the application can still run while the configuration changes without affecting the application.</p>
<p>ConfigMaps allow to store this configruation. Basically, they are really just a map of key value pair.</p>
<p>Most of the time, the configuration within a config map is injected using environment variables and volumes.</p>
<p>One drawback wiht configmaps and environment variables ist, that the changes made to a ConfigMap will not be reflected on the container.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="kubernetes.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb14-2"><a href="kubernetes.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb14-3"><a href="kubernetes.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb14-4"><a href="kubernetes.html#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb14-5"><a href="kubernetes.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="kubernetes.html#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">app-name</span><span class="kw">:</span><span class="at"> order</span></span>
<span id="cb14-7"><a href="kubernetes.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">app-version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb14-8"><a href="kubernetes.html#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">team</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb14-9"><a href="kubernetes.html#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="kubernetes.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb14-11"><a href="kubernetes.html#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="kubernetes.html#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb14-13"><a href="kubernetes.html#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ConfigMap</span></span>
<span id="cb14-14"><a href="kubernetes.html#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb14-15"><a href="kubernetes.html#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb14-16"><a href="kubernetes.html#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb14-17"><a href="kubernetes.html#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    # configuration in .conf</span></span>
<span id="cb14-18"><a href="kubernetes.html#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">  nginx.conf</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-19"><a href="kubernetes.html#cb14-19" aria-hidden="true" tabindex="-1"></a>    server {</span>
<span id="cb14-20"><a href="kubernetes.html#cb14-20" aria-hidden="true" tabindex="-1"></a>        listen       80;</span>
<span id="cb14-21"><a href="kubernetes.html#cb14-21" aria-hidden="true" tabindex="-1"></a>        server_name  localhost;</span>
<span id="cb14-22"><a href="kubernetes.html#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="kubernetes.html#cb14-23" aria-hidden="true" tabindex="-1"></a>        location / {</span>
<span id="cb14-24"><a href="kubernetes.html#cb14-24" aria-hidden="true" tabindex="-1"></a>            root   /usr/share/nginx/html;</span>
<span id="cb14-25"><a href="kubernetes.html#cb14-25" aria-hidden="true" tabindex="-1"></a>            index  index.html index.htm;</span>
<span id="cb14-26"><a href="kubernetes.html#cb14-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-27"><a href="kubernetes.html#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="kubernetes.html#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="kubernetes.html#cb14-29" aria-hidden="true" tabindex="-1"></a>        # redirect server error pages to the static page /50x.html</span>
<span id="cb14-30"><a href="kubernetes.html#cb14-30" aria-hidden="true" tabindex="-1"></a>        #</span>
<span id="cb14-31"><a href="kubernetes.html#cb14-31" aria-hidden="true" tabindex="-1"></a>        error_page   500 502 503 504  /50x.html;</span>
<span id="cb14-32"><a href="kubernetes.html#cb14-32" aria-hidden="true" tabindex="-1"></a>        location = /50x.html {</span>
<span id="cb14-33"><a href="kubernetes.html#cb14-33" aria-hidden="true" tabindex="-1"></a>            root   /usr/share/nginx/html;</span>
<span id="cb14-34"><a href="kubernetes.html#cb14-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-35"><a href="kubernetes.html#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="kubernetes.html#cb14-36" aria-hidden="true" tabindex="-1"></a>        location /health {</span>
<span id="cb14-37"><a href="kubernetes.html#cb14-37" aria-hidden="true" tabindex="-1"></a>            access_log off;</span>
<span id="cb14-38"><a href="kubernetes.html#cb14-38" aria-hidden="true" tabindex="-1"></a>            return 200 &quot;healthy\n&quot;;</span>
<span id="cb14-39"><a href="kubernetes.html#cb14-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-40"><a href="kubernetes.html#cb14-40" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="kubernetes.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb15-2"><a href="kubernetes.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb15-3"><a href="kubernetes.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb15-4"><a href="kubernetes.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb15-5"><a href="kubernetes.html#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-6"><a href="kubernetes.html#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb15-7"><a href="kubernetes.html#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb15-8"><a href="kubernetes.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb15-9"><a href="kubernetes.html#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb15-10"><a href="kubernetes.html#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb15-11"><a href="kubernetes.html#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb15-12"><a href="kubernetes.html#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> config-map</span></span>
<span id="cb15-13"><a href="kubernetes.html#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-14"><a href="kubernetes.html#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb15-15"><a href="kubernetes.html#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">        # this is for volumes</span></span>
<span id="cb15-16"><a href="kubernetes.html#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb15-17"><a href="kubernetes.html#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb15-18"><a href="kubernetes.html#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb15-19"><a href="kubernetes.html#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-20"><a href="kubernetes.html#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb15-21"><a href="kubernetes.html#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-22"><a href="kubernetes.html#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">          # if both configmaps shall be mounted under one direc,</span></span>
<span id="cb15-23"><a href="kubernetes.html#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">          # we need to use projected</span></span>
<span id="cb15-24"><a href="kubernetes.html#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config</span></span>
<span id="cb15-25"><a href="kubernetes.html#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">projected</span><span class="kw">:</span></span>
<span id="cb15-26"><a href="kubernetes.html#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">sources</span><span class="kw">:</span></span>
<span id="cb15-27"><a href="kubernetes.html#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb15-28"><a href="kubernetes.html#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb15-29"><a href="kubernetes.html#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="fu">configMap</span><span class="kw">:</span></span>
<span id="cb15-30"><a href="kubernetes.html#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-31"><a href="kubernetes.html#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb15-32"><a href="kubernetes.html#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map-volume</span></span>
<span id="cb15-33"><a href="kubernetes.html#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb15-34"><a href="kubernetes.html#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/order/ngnix</span></span>
<span id="cb15-35"><a href="kubernetes.html#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="co">          # is defined here in the nginx-volume to mount</span></span>
<span id="cb15-36"><a href="kubernetes.html#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb15-37"><a href="kubernetes.html#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="co">            # everything from that configMap in mounted as a file</span></span>
<span id="cb15-38"><a href="kubernetes.html#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="co">            # the file content is the value themselves</span></span>
<span id="cb15-39"><a href="kubernetes.html#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/order/properties</span></span>
<span id="cb15-40"><a href="kubernetes.html#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-41"><a href="kubernetes.html#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="co">            # both configmaps under one</span></span>
<span id="cb15-42"><a href="kubernetes.html#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> etc/order/config</span></span>
<span id="cb15-43"><a href="kubernetes.html#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config</span></span>
<span id="cb15-44"><a href="kubernetes.html#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb15-45"><a href="kubernetes.html#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb15-46"><a href="kubernetes.html#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb15-47"><a href="kubernetes.html#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb15-48"><a href="kubernetes.html#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb15-49"><a href="kubernetes.html#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep 3600&quot;</span></span>
<span id="cb15-50"><a href="kubernetes.html#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb15-51"><a href="kubernetes.html#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb15-52"><a href="kubernetes.html#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb15-53"><a href="kubernetes.html#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb15-54"><a href="kubernetes.html#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> config-map-env</span></span>
<span id="cb15-55"><a href="kubernetes.html#cb15-55" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb15-56"><a href="kubernetes.html#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb15-57"><a href="kubernetes.html#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb15-58"><a href="kubernetes.html#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb15-59"><a href="kubernetes.html#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb15-60"><a href="kubernetes.html#cb15-60" aria-hidden="true" tabindex="-1"></a><span class="co">        # as previous, keep the busybox container alive</span></span>
<span id="cb15-61"><a href="kubernetes.html#cb15-61" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb15-62"><a href="kubernetes.html#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;/bin/sh&quot;</span></span>
<span id="cb15-63"><a href="kubernetes.html#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;-c&quot;</span></span>
<span id="cb15-64"><a href="kubernetes.html#cb15-64" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb15-65"><a href="kubernetes.html#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;env &amp;&amp; sleep 3600&quot;</span></span>
<span id="cb15-66"><a href="kubernetes.html#cb15-66" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb15-67"><a href="kubernetes.html#cb15-67" aria-hidden="true" tabindex="-1"></a><span class="co">          # environment variables to read in from config map</span></span>
<span id="cb15-68"><a href="kubernetes.html#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="co">          # for every data key-value pair in config Map, and own</span></span>
<span id="cb15-69"><a href="kubernetes.html#cb15-69" aria-hidden="true" tabindex="-1"></a><span class="co">          # environment variable is created, which get the value from the corresponding key</span></span>
<span id="cb15-70"><a href="kubernetes.html#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> APP_VERSION</span></span>
<span id="cb15-71"><a href="kubernetes.html#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb15-72"><a href="kubernetes.html#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb15-73"><a href="kubernetes.html#cb15-73" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-74"><a href="kubernetes.html#cb15-74" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> app-version</span></span>
<span id="cb15-75"><a href="kubernetes.html#cb15-75" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> APP_NAME</span></span>
<span id="cb15-76"><a href="kubernetes.html#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb15-77"><a href="kubernetes.html#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb15-78"><a href="kubernetes.html#cb15-78" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-79"><a href="kubernetes.html#cb15-79" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> app-name</span></span>
<span id="cb15-80"><a href="kubernetes.html#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> TEAM</span></span>
<span id="cb15-81"><a href="kubernetes.html#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb15-82"><a href="kubernetes.html#cb15-82" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb15-83"><a href="kubernetes.html#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> app-properties</span></span>
<span id="cb15-84"><a href="kubernetes.html#cb15-84" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> team</span></span>
<span id="cb15-85"><a href="kubernetes.html#cb15-85" aria-hidden="true" tabindex="-1"></a><span class="co">          # reads from second config map</span></span>
<span id="cb15-86"><a href="kubernetes.html#cb15-86" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> NGINX_CONF</span></span>
<span id="cb15-87"><a href="kubernetes.html#cb15-87" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb15-88"><a href="kubernetes.html#cb15-88" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">configMapKeyRef</span><span class="kw">:</span></span>
<span id="cb15-89"><a href="kubernetes.html#cb15-89" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-conf</span></span>
<span id="cb15-90"><a href="kubernetes.html#cb15-90" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> nginx.conf  </span></span></code></pre></div>
<p>config map env</p>
<p>config maps and volumes. One pod is a selection of one or more containers, as well as one or more volumes. The volume is mounted inside the container. Whereever a volume is mounted, we get a file structure like this:</p>
<p>/etc/name
/app.version
/server.name</p>
<p>the contents of that file is the values for each key inside of that data.</p>
</div>
<div id="secrets" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> Secrets<a href="kubernetes.html#secrets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Secrets, as the name suggests, store and manage sensitive information. ConfigMaps should only be used to store configuration files, not sensitive data.</p>
<p>create a generic secrets using the imperative approach</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="kubernetes.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic mysecret <span class="at">--from-literal</span><span class="op">=</span>db-password=123 <span class="at">-from-literal</span><span class="op">=</span>api-token=token</span>
<span id="cb16-2"><a href="kubernetes.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="kubernetes.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># output the new secret as yaml.</span></span>
<span id="cb16-4"><a href="kubernetes.html#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get secret mysecret <span class="at">-o</span> yaml</span>
<span id="cb16-5"><a href="kubernetes.html#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="kubernetes.html#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create a secret from file</span></span>
<span id="cb16-7"><a href="kubernetes.html#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret generic mysecret-from-file <span class="at">--from-file</span><span class="op">=</span>secret</span></code></pre></div>
<p>similar to the configmaps, we can get the secrets from a environment variable or a volume</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="kubernetes.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb17-2"><a href="kubernetes.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb17-3"><a href="kubernetes.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-4"><a href="kubernetes.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb17-5"><a href="kubernetes.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-6"><a href="kubernetes.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-7"><a href="kubernetes.html#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb17-8"><a href="kubernetes.html#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb17-9"><a href="kubernetes.html#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb17-10"><a href="kubernetes.html#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="kubernetes.html#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb17-12"><a href="kubernetes.html#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb17-13"><a href="kubernetes.html#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-14"><a href="kubernetes.html#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb17-15"><a href="kubernetes.html#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">        # get the secret from a volume</span></span>
<span id="cb17-16"><a href="kubernetes.html#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-vol</span></span>
<span id="cb17-17"><a href="kubernetes.html#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">secret</span><span class="kw">:</span></span>
<span id="cb17-18"><a href="kubernetes.html#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">            # this is the name of the scret we created earlier</span></span>
<span id="cb17-19"><a href="kubernetes.html#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">secretName</span><span class="kw">:</span><span class="at"> mysecret</span></span>
<span id="cb17-20"><a href="kubernetes.html#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb17-21"><a href="kubernetes.html#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secrets</span></span>
<span id="cb17-22"><a href="kubernetes.html#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb17-23"><a href="kubernetes.html#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb17-24"><a href="kubernetes.html#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /etc/secrets</span></span>
<span id="cb17-25"><a href="kubernetes.html#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-vol</span></span>
<span id="cb17-26"><a href="kubernetes.html#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb17-27"><a href="kubernetes.html#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">          # nane of the secret</span></span>
<span id="cb17-28"><a href="kubernetes.html#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> CUSTOM_SECRET</span></span>
<span id="cb17-29"><a href="kubernetes.html#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co">          # get the secret from an environment variable</span></span>
<span id="cb17-30"><a href="kubernetes.html#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">valueFrom</span><span class="kw">:</span></span>
<span id="cb17-31"><a href="kubernetes.html#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">secretKeyRef</span><span class="kw">:</span></span>
<span id="cb17-32"><a href="kubernetes.html#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co">                # name and key of the secret we created earlier</span></span>
<span id="cb17-33"><a href="kubernetes.html#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mysecret-from-file</span></span>
<span id="cb17-34"><a href="kubernetes.html#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">key</span><span class="kw">:</span><span class="at"> secret</span></span>
<span id="cb17-35"><a href="kubernetes.html#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb17-36"><a href="kubernetes.html#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb17-37"><a href="kubernetes.html#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;3600&quot;</span></span>
<span id="cb17-38"><a href="kubernetes.html#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb17-39"><a href="kubernetes.html#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb17-40"><a href="kubernetes.html#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb17-41"><a href="kubernetes.html#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>Secrets are actually not secrets in Kubernetes, but what does that mean? They can actually quite easily decoded. If you kubectl describe on a secret and decode it using</p>
<pre class="base"><code>echo &lt;password&gt; | base64 -d</code></pre>
<p>We should never store sensitive information, like database passwords, in secrets. For such, we should use a vault.</p>
<p><strong>exemplary use case of secrets</strong></p>
<p>If we want to pull from a private repository, how do we configure this?
Assume we pull from this private docker hub. We can apply this deployment, yet it will throw an error. This is because we did not configure a secret for docker registry.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb19-1"><a href="kubernetes.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb19-2"><a href="kubernetes.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb19-3"><a href="kubernetes.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-4"><a href="kubernetes.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb19-5"><a href="kubernetes.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-6"><a href="kubernetes.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb19-7"><a href="kubernetes.html#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb19-8"><a href="kubernetes.html#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb19-9"><a href="kubernetes.html#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb19-10"><a href="kubernetes.html#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb19-11"><a href="kubernetes.html#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb19-12"><a href="kubernetes.html#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb19-13"><a href="kubernetes.html#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-14"><a href="kubernetes.html#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">imagePullSecrets</span><span class="kw">:</span></span>
<span id="cb19-15"><a href="kubernetes.html#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> docker-hub-private</span></span>
<span id="cb19-16"><a href="kubernetes.html#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb19-17"><a href="kubernetes.html#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> secret-app</span></span>
<span id="cb19-18"><a href="kubernetes.html#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> seblum/private</span></span>
<span id="cb19-19"><a href="kubernetes.html#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb19-20"><a href="kubernetes.html#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb19-21"><a href="kubernetes.html#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb19-22"><a href="kubernetes.html#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb19-23"><a href="kubernetes.html#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb19-24"><a href="kubernetes.html#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
<p>lets create the secret.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="kubernetes.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create secret docker-registry docker-hub-private <span class="dt">\</span></span>
<span id="cb20-2"><a href="kubernetes.html#cb20-2" aria-hidden="true" tabindex="-1"></a>--docker-username=YOUR_USERNAME <span class="dt">\</span></span>
<span id="cb20-3"><a href="kubernetes.html#cb20-3" aria-hidden="true" tabindex="-1"></a>--docker-password=YOUR_PASSWORD <span class="dt">\</span></span>
<span id="cb20-4"><a href="kubernetes.html#cb20-4" aria-hidden="true" tabindex="-1"></a>--docker-email=YOUR_EMAIL</span></code></pre></div>
</div>
<div id="namespaces" class="section level2 hasAnchor" number="3.8">
<h2><span class="header-section-number">3.8</span> Namespaces<a href="kubernetes.html#namespaces" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Namespaces allows us to organize objects in the cluster. Maybe we want to organize by team, department, environment, etc. By default, kubectl interacts with the defaul namespace.</p>
<ul>
<li>default The default namespace for objects with no other namespace</li>
<li>kube-system The namespace for objects created by the Kubernetes system</li>
<li>kube-public This namespace is created automatically and is readable by all users (including those not authenticated). This namespace is mostly reserved for cluster usage, in case that some resources should be visible and readable publicly throughout the whole cluster. The public aspect of this namespace is only a convention, not a requirement.</li>
<li>kube-node-lease This namespace for the lease objects associated with each node which improves the performance of the node heartbeats as the cluster scales.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb21-1"><a href="kubernetes.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb21-2"><a href="kubernetes.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb21-3"><a href="kubernetes.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb21-4"><a href="kubernetes.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> dev</span></span>
<span id="cb21-5"><a href="kubernetes.html#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb21-6"><a href="kubernetes.html#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb21-7"><a href="kubernetes.html#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb21-8"><a href="kubernetes.html#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb21-9"><a href="kubernetes.html#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> prod</span></span>
<span id="cb21-10"><a href="kubernetes.html#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb21-11"><a href="kubernetes.html#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb21-12"><a href="kubernetes.html#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb21-13"><a href="kubernetes.html#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb21-14"><a href="kubernetes.html#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitoring</span></span>
<span id="cb21-15"><a href="kubernetes.html#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb21-16"><a href="kubernetes.html#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb21-17"><a href="kubernetes.html#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb21-18"><a href="kubernetes.html#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb21-19"><a href="kubernetes.html#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> logging</span></span>
<span id="cb21-20"><a href="kubernetes.html#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb21-21"><a href="kubernetes.html#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb21-22"><a href="kubernetes.html#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb21-23"><a href="kubernetes.html#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb21-24"><a href="kubernetes.html#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> monitoring-deployment</span></span>
<span id="cb21-25"><a href="kubernetes.html#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> monitoring</span></span>
<span id="cb21-26"><a href="kubernetes.html#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb21-27"><a href="kubernetes.html#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb21-28"><a href="kubernetes.html#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb21-29"><a href="kubernetes.html#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;grafana&quot;</span></span>
<span id="cb21-30"><a href="kubernetes.html#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb21-31"><a href="kubernetes.html#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb21-32"><a href="kubernetes.html#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb21-33"><a href="kubernetes.html#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cpu</span><span class="kw">:</span><span class="at">    </span><span class="st">&quot;500m&quot;</span></span></code></pre></div>
<p>Cross communication and network policies between namespaces
develoment namespace and customer svc
demo namespace and customer svc
calling from demo to dev, we call customer.dev
However, we do not usually want them to talk to each other. <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" class="uri">https://kubernetes.io/docs/concepts/services-networking/network-policies/</a></p>
<div id="kubectx-kubens" class="section level4 hasAnchor" number="3.8.0.1">
<h4><span class="header-section-number">3.8.0.1</span> kubectx &amp; kubens<a href="kubernetes.html#kubectx-kubens" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Used for switching between namespaces. <a href="https://github.com/ahmetb/kubectx" class="uri">https://github.com/ahmetb/kubectx</a></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="kubernetes.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># switch namespace</span></span>
<span id="cb22-2"><a href="kubernetes.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kubens</span> <span class="op">&lt;</span>namespace<span class="op">&gt;</span></span></code></pre></div>
</div>
</div>
<div id="health-checks" class="section level2 hasAnchor" number="3.9">
<h2><span class="header-section-number">3.9</span> Health Checks<a href="kubernetes.html#health-checks" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When building applications, we need to make sure that they are healthy at all times and that they are ready to receive traffic. Kubernetes uses a process health check to check if application is alive and if it is not it restart the process. Yes, checking in the process on its own is not sufficient. What if we want to connect an app to a database and it cannot? To solve such issues, we use <em>liveness probe</em> and <em>readiness probe</em>. If not specified any of these, kubernetes will use the default, which might not be sufficient.</p>
<p><strong>Liveness Probe</strong>
The kubelet uses liveness probes to know when to restart a container. For example, liveness probes could catch a deadlock, db connection failure, etc. In order to dothat, we can specify an endpoint for a liveness probe.
The kubelet will use the liveness probe to check whether the application runs fine and whether it can receive traffic. The benefit is, that it is simple to define want it means for the application to be healthy, just by the url defined.</p>
<p><strong>Readiness Probe</strong>
Similar to the liveness Probe, the readniness probe is used by the kubelet to check when the container is ready to start accepting traffic.</p>
<p>Regarding the path to specify: A lot of frameworks, like springboot, give you a path to use.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb23-1"><a href="kubernetes.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb23-2"><a href="kubernetes.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb23-3"><a href="kubernetes.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb23-4"><a href="kubernetes.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-5"><a href="kubernetes.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb23-6"><a href="kubernetes.html#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb23-7"><a href="kubernetes.html#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb23-8"><a href="kubernetes.html#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb23-9"><a href="kubernetes.html#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb23-10"><a href="kubernetes.html#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-11"><a href="kubernetes.html#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb23-12"><a href="kubernetes.html#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb23-13"><a href="kubernetes.html#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb23-14"><a href="kubernetes.html#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-15"><a href="kubernetes.html#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb23-16"><a href="kubernetes.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> backend</span></span>
<span id="cb23-17"><a href="kubernetes.html#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">department</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb23-18"><a href="kubernetes.html#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb23-19"><a href="kubernetes.html#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb23-20"><a href="kubernetes.html#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-21"><a href="kubernetes.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;amigoscode/kubernetes:customer-v1&quot;</span></span>
<span id="cb23-22"><a href="kubernetes.html#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb23-23"><a href="kubernetes.html#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb23-24"><a href="kubernetes.html#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb23-25"><a href="kubernetes.html#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb23-26"><a href="kubernetes.html#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">          # the liveness probe for us</span></span>
<span id="cb23-27"><a href="kubernetes.html#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">livenessProbe</span><span class="kw">:</span></span>
<span id="cb23-28"><a href="kubernetes.html#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb23-29"><a href="kubernetes.html#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co">              # path of the url</span></span>
<span id="cb23-30"><a href="kubernetes.html#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb23-31"><a href="kubernetes.html#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb23-32"><a href="kubernetes.html#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">            # time the liveness probe start after pod is started</span></span>
<span id="cb23-33"><a href="kubernetes.html#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb23-34"><a href="kubernetes.html#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">timeoutSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb23-35"><a href="kubernetes.html#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">failureThreshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb23-36"><a href="kubernetes.html#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="co">            # period on when the checks should be performed</span></span>
<span id="cb23-37"><a href="kubernetes.html#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb23-38"><a href="kubernetes.html#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co">          # readiness probe</span></span>
<span id="cb23-39"><a href="kubernetes.html#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">readinessProbe</span><span class="kw">:</span></span>
<span id="cb23-40"><a href="kubernetes.html#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">httpGet</span><span class="kw">:</span></span>
<span id="cb23-41"><a href="kubernetes.html#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /health</span></span>
<span id="cb23-42"><a href="kubernetes.html#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb23-43"><a href="kubernetes.html#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">initialDelaySeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb23-44"><a href="kubernetes.html#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">timeoutSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb23-45"><a href="kubernetes.html#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">failureThreshold</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb23-46"><a href="kubernetes.html#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">periodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">5</span></span>
<span id="cb23-47"><a href="kubernetes.html#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb23-48"><a href="kubernetes.html#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="co">            # variable for the container to be killed after 30 seconds</span></span>
<span id="cb23-49"><a href="kubernetes.html#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="co">            # needs to be implemented within the container though</span></span>
<span id="cb23-50"><a href="kubernetes.html#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;KILL_IN_SECODS&quot;</span></span>
<span id="cb23-51"><a href="kubernetes.html#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;30&quot;</span></span>
<span id="cb23-52"><a href="kubernetes.html#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ORDER_SERVICE</span></span>
<span id="cb23-53"><a href="kubernetes.html#cb23-53" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">value</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;order&quot;</span></span>
<span id="cb23-54"><a href="kubernetes.html#cb23-54" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb23-55"><a href="kubernetes.html#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb23-56"><a href="kubernetes.html#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="kubernetes.html#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb23-58"><a href="kubernetes.html#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb23-59"><a href="kubernetes.html#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb23-60"><a href="kubernetes.html#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb23-61"><a href="kubernetes.html#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer-node</span></span>
<span id="cb23-62"><a href="kubernetes.html#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb23-63"><a href="kubernetes.html#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb23-64"><a href="kubernetes.html#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb23-65"><a href="kubernetes.html#cb23-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb23-66"><a href="kubernetes.html#cb23-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-67"><a href="kubernetes.html#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb23-68"><a href="kubernetes.html#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb23-69"><a href="kubernetes.html#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span>
<span id="cb23-70"><a href="kubernetes.html#cb23-70" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">30000</span></span>
<span id="cb23-71"><a href="kubernetes.html#cb23-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-72"><a href="kubernetes.html#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb23-73"><a href="kubernetes.html#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb23-74"><a href="kubernetes.html#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb23-75"><a href="kubernetes.html#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb23-76"><a href="kubernetes.html#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-77"><a href="kubernetes.html#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> engineering</span></span>
<span id="cb23-78"><a href="kubernetes.html#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb23-79"><a href="kubernetes.html#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> ClusterIP</span></span>
<span id="cb23-80"><a href="kubernetes.html#cb23-80" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb23-81"><a href="kubernetes.html#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb23-82"><a href="kubernetes.html#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb23-83"><a href="kubernetes.html#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb23-84"><a href="kubernetes.html#cb23-84" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span></code></pre></div>
</div>
<div id="ressource-management" class="section level2 hasAnchor" number="3.10">
<h2><span class="header-section-number">3.10</span> Ressource Management<a href="kubernetes.html#ressource-management" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Sometimes, an app uses a lot of resources, e.g.Â memory &amp; CPU. This might be dangerous, as one app might use a lot of ressources, leaving nothing left for other applications and starving them. In K8s, we can define the minimum amount of resources a container needs (request) as well as the maximum amount of resources a contaienr can have (limit).</p>
<p>Configuring limits for a container can be within the spec for a Pod or deployment. We have been using the actually previously.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb24-1"><a href="kubernetes.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb24-2"><a href="kubernetes.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb24-3"><a href="kubernetes.html#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-4"><a href="kubernetes.html#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb24-5"><a href="kubernetes.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-6"><a href="kubernetes.html#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb24-7"><a href="kubernetes.html#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb24-8"><a href="kubernetes.html#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb24-9"><a href="kubernetes.html#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb24-10"><a href="kubernetes.html#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb24-11"><a href="kubernetes.html#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb24-12"><a href="kubernetes.html#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb24-13"><a href="kubernetes.html#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb24-14"><a href="kubernetes.html#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb24-15"><a href="kubernetes.html#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb24-16"><a href="kubernetes.html#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> customer</span></span>
<span id="cb24-17"><a href="kubernetes.html#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;amigoscode/kubernetes:customer-v1&quot;</span></span>
<span id="cb24-18"><a href="kubernetes.html#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb24-19"><a href="kubernetes.html#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">            # Requests</span></span>
<span id="cb24-20"><a href="kubernetes.html#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb24-21"><a href="kubernetes.html#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;512Mi&quot;</span></span>
<span id="cb24-22"><a href="kubernetes.html#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;1000m&quot;</span></span>
<span id="cb24-23"><a href="kubernetes.html#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">            # Limits</span></span>
<span id="cb24-24"><a href="kubernetes.html#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb24-25"><a href="kubernetes.html#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;128Mi&quot;</span></span>
<span id="cb24-26"><a href="kubernetes.html#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></span>
<span id="cb24-27"><a href="kubernetes.html#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb24-28"><a href="kubernetes.html#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">8080</span></span></code></pre></div>
</div>
<div id="jobs-cron-jobs" class="section level2 hasAnchor" number="3.11">
<h2><span class="header-section-number">3.11</span> Jobs &amp; Cron Jobs<a href="kubernetes.html#jobs-cron-jobs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When looking at the busybox image deployment. Kubernets does not know that the image is only short lived and will run in a CrashLoopBackOff-Error. This is why we have to execute jobs on it such as done with the shell commands previously.
Kubernetes will try and restart the container itself though until it BackOffs completley. However, what if we have a task that only should run like every 5 minutes, or every single day? This is when CronJobs are good to used.
Jobs execute only once. CronJobs execute depending on the specified expression.</p>
<p>lets create a job that, e.g.Â simulates a database backup. This job will only run 30 seconds. 20 for the command to complete, 10 waiting to shut down.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="kubernetes.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1</span></span>
<span id="cb25-2"><a href="kubernetes.html#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Job</span></span>
<span id="cb25-3"><a href="kubernetes.html#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb25-4"><a href="kubernetes.html#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> db-backup-job</span></span>
<span id="cb25-5"><a href="kubernetes.html#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb25-6"><a href="kubernetes.html#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # time it takes to terminate the job for one completion</span></span>
<span id="cb25-7"><a href="kubernetes.html#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ttlSecondsAfterFinished</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb25-8"><a href="kubernetes.html#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb25-9"><a href="kubernetes.html#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb25-10"><a href="kubernetes.html#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb25-11"><a href="kubernetes.html#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backup</span></span>
<span id="cb25-12"><a href="kubernetes.html#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb25-13"><a href="kubernetes.html#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="kw">]</span></span>
<span id="cb25-14"><a href="kubernetes.html#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb25-15"><a href="kubernetes.html#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;echo &#39;performing db backup...&#39; &amp;&amp; sleep 20&quot;</span></span>
<span id="cb25-16"><a href="kubernetes.html#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>
<p>If we want to run this job every minute, we use a cronjob. The cronjob expression defines as follows:
( * * * * * * ) - ( Minutes Hours Day-of-month Month Day-of-week Year)</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="kubernetes.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> batch/v1beta1</span></span>
<span id="cb26-2"><a href="kubernetes.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CronJob</span></span>
<span id="cb26-3"><a href="kubernetes.html#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb26-4"><a href="kubernetes.html#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> db-backup-cron-job</span></span>
<span id="cb26-5"><a href="kubernetes.html#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb26-6"><a href="kubernetes.html#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;*/1 * * * *&quot;</span></span>
<span id="cb26-7"><a href="kubernetes.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobTemplate</span><span class="kw">:</span></span>
<span id="cb26-8"><a href="kubernetes.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb26-9"><a href="kubernetes.html#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb26-10"><a href="kubernetes.html#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb26-11"><a href="kubernetes.html#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb26-12"><a href="kubernetes.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> backup</span></span>
<span id="cb26-13"><a href="kubernetes.html#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> busybox</span></span>
<span id="cb26-14"><a href="kubernetes.html#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-c&quot;</span><span class="kw">]</span></span>
<span id="cb26-15"><a href="kubernetes.html#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb26-16"><a href="kubernetes.html#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;echo &#39;performing db backup...&#39; &amp;&amp; sleep 20&quot;</span></span>
<span id="cb26-17"><a href="kubernetes.html#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Never</span></span></code></pre></div>
</div>
<div id="deamon-sets" class="section level2 hasAnchor" number="3.12">
<h2><span class="header-section-number">3.12</span> Deamon Sets<a href="kubernetes.html#deamon-sets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is up to Kubernetes, on what node a pod is scheduled. However, there are times where we want to have a copy of a pod across the cluster. A DeamonSet ensures a copy of a Pod is running across the cluster. They are used to deploy system daemons such as log collectors and monitoring agents. They run on every single node unless we tell which node to run on.</p>
<p>DeamonSets are automatically deployed on a node, so they also do not need a specification on how many nodes. They will automatically be spawned on each node. If the cluster is scaled, the DaemonSet will automatically scale as well and schedule a copy of the pod on the new Node as well.</p>
<p>In the given example we want to cover logging and daemon sets. K8s FluentD.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="kubernetes.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb27-2"><a href="kubernetes.html#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb27-3"><a href="kubernetes.html#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb27-4"><a href="kubernetes.html#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> logging</span></span>
<span id="cb27-5"><a href="kubernetes.html#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb27-6"><a href="kubernetes.html#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb27-7"><a href="kubernetes.html#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> DaemonSet</span></span>
<span id="cb27-8"><a href="kubernetes.html#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb27-9"><a href="kubernetes.html#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb27-10"><a href="kubernetes.html#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> logging</span></span>
<span id="cb27-11"><a href="kubernetes.html#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb27-12"><a href="kubernetes.html#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">k8s-app</span><span class="kw">:</span><span class="at"> fluentd-logging</span></span>
<span id="cb27-13"><a href="kubernetes.html#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb27-14"><a href="kubernetes.html#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb27-15"><a href="kubernetes.html#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb27-16"><a href="kubernetes.html#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb27-17"><a href="kubernetes.html#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb27-18"><a href="kubernetes.html#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb27-19"><a href="kubernetes.html#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb27-20"><a href="kubernetes.html#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb27-21"><a href="kubernetes.html#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb27-22"><a href="kubernetes.html#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">tolerations</span><span class="kw">:</span></span>
<span id="cb27-23"><a href="kubernetes.html#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co">      # this toleration is to have the daemonset runnable on master nodes</span></span>
<span id="cb27-24"><a href="kubernetes.html#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co">      # remove it if your masters can&#39;t run pods</span></span>
<span id="cb27-25"><a href="kubernetes.html#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">key</span><span class="kw">:</span><span class="at"> node-role.kubernetes.io/master</span></span>
<span id="cb27-26"><a href="kubernetes.html#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> Exists</span></span>
<span id="cb27-27"><a href="kubernetes.html#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">effect</span><span class="kw">:</span><span class="at"> NoSchedule</span></span>
<span id="cb27-28"><a href="kubernetes.html#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb27-29"><a href="kubernetes.html#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> fluentd-elasticsearch</span></span>
<span id="cb27-30"><a href="kubernetes.html#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co">        # allows to collect logs from nodes</span></span>
<span id="cb27-31"><a href="kubernetes.html#cb27-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span>
<span id="cb27-32"><a href="kubernetes.html#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb27-33"><a href="kubernetes.html#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb27-34"><a href="kubernetes.html#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 200Mi</span></span>
<span id="cb27-35"><a href="kubernetes.html#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb27-36"><a href="kubernetes.html#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 100m</span></span>
<span id="cb27-37"><a href="kubernetes.html#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 200Mi</span></span>
<span id="cb27-38"><a href="kubernetes.html#cb27-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb27-39"><a href="kubernetes.html#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb27-40"><a href="kubernetes.html#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb27-41"><a href="kubernetes.html#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlibdockercontainers</span></span>
<span id="cb27-42"><a href="kubernetes.html#cb27-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/lib/docker/containers</span></span>
<span id="cb27-43"><a href="kubernetes.html#cb27-43" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">readOnly</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb27-44"><a href="kubernetes.html#cb27-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">terminationGracePeriodSeconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">30</span></span>
<span id="cb27-45"><a href="kubernetes.html#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb27-46"><a href="kubernetes.html#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb27-47"><a href="kubernetes.html#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb27-48"><a href="kubernetes.html#cb27-48" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/log</span></span>
<span id="cb27-49"><a href="kubernetes.html#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlibdockercontainers</span></span>
<span id="cb27-50"><a href="kubernetes.html#cb27-50" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">hostPath</span><span class="kw">:</span></span>
<span id="cb27-51"><a href="kubernetes.html#cb27-51" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /var/lib/docker/containers</span></span></code></pre></div>
</div>
<div id="statefulsets" class="section level2 hasAnchor" number="3.13">
<h2><span class="header-section-number">3.13</span> StatefulSets<a href="kubernetes.html#statefulsets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>StatefulSets are used to deploy and manage stateful applications. Stateful applications are applications which are long lived, such as Databases. Most Applications of K8s are stateless as they only run for a specific task. However, the Database is the state of truth and should be present at all time.</p>
<p>Lets assume we have a StatefulSet with 3 replicas. Each Pod has a PV attached.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/04-Kubernetes.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
