<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9.3 Pipeline Workflow Steps | MLOps Engineering</title>
  <meta name="description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="9.3 Pipeline Workflow Steps | MLOps Engineering" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="github-repo" content="seblum/mlops-engineering-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9.3 Pipeline Workflow Steps | MLOps Engineering" />
  
  <meta name="twitter:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  

<meta name="author" content="Sebastian Blum" />


<meta name="date" content="2024-02-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="training-deployment-pipeline-workflow.html"/>
<link rel="next" href="model-inferencing.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MLOps Engineering</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="preamble.html"><a href="preamble.html"><i class="fa fa-check"></i>Preamble</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html"><i class="fa fa-check"></i><b>1.1</b> Machine Learning Workflow</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#ml-worflow-tools"><i class="fa fa-check"></i><b>1.1.1</b> ML Worflow Tools</a></li>
<li class="chapter" data-level="1.1.2" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#developing-machine-learning-models"><i class="fa fa-check"></i><b>1.1.2</b> Developing Machine Learning Models</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html"><i class="fa fa-check"></i><b>1.2</b> Machine Learning Operations (MLOps)</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#ml-dev-ops"><i class="fa fa-check"></i><b>1.2.1</b> ML + (Dev)-Ops</a></li>
<li class="chapter" data-level="1.2.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-lifecycle"><i class="fa fa-check"></i><b>1.2.2</b> MLOps Lifecycle</a></li>
<li class="chapter" data-level="1.2.3" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-engineering"><i class="fa fa-check"></i><b>1.2.3</b> MLOps Engineering</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html"><i class="fa fa-check"></i><b>1.3</b> Roles and Tasks in MLOps</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-engineer"><i class="fa fa-check"></i><b>1.3.1</b> Data Engineer</a></li>
<li class="chapter" data-level="1.3.2" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-scientist"><i class="fa fa-check"></i><b>1.3.2</b> Data Scientist</a></li>
<li class="chapter" data-level="1.3.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#ml-engineer"><i class="fa fa-check"></i><b>1.3.3</b> ML Engineer</a></li>
<li class="chapter" data-level="1.3.4" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#mlops-engineer"><i class="fa fa-check"></i><b>1.3.4</b> MLOps Engineer</a></li>
<li class="chapter" data-level="1.3.5" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#devops-engineer"><i class="fa fa-check"></i><b>1.3.5</b> DevOps Engineer</a></li>
<li class="chapter" data-level="1.3.6" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#additional-roles-function"><i class="fa fa-check"></i><b>1.3.6</b> Additional roles &amp; function</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ops-tools-and-principles.html"><a href="ops-tools-and-principles.html"><i class="fa fa-check"></i><b>2</b> Ops Tools and Principles</a>
<ul>
<li class="chapter" data-level="2.1" data-path="containerization.html"><a href="containerization.html"><i class="fa fa-check"></i><b>2.1</b> Containerization</a></li>
<li class="chapter" data-level="2.2" data-path="version-control.html"><a href="version-control.html"><i class="fa fa-check"></i><b>2.2</b> Version Control</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="version-control.html"><a href="version-control.html#github"><i class="fa fa-check"></i><b>2.2.1</b> Github</a></li>
<li class="chapter" data-level="2.2.2" data-path="version-control.html"><a href="version-control.html#git-lifecycle"><i class="fa fa-check"></i><b>2.2.2</b> Git lifecycle</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="cicd.html"><a href="cicd.html"><i class="fa fa-check"></i><b>2.3</b> CI/CD</a>
<ul>
<li class="chapter" data-level="" data-path="cicd.html"><a href="cicd.html#github-actions"><i class="fa fa-check"></i>Github Actions</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="infrastructure-as-code.html"><a href="infrastructure-as-code.html"><i class="fa fa-check"></i><b>2.4</b> Infrastructure as code</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="airflow.html"><a href="airflow.html"><i class="fa fa-check"></i><b>3</b> Airflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="core-components.html"><a href="core-components.html"><i class="fa fa-check"></i><b>3.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="core-components.html"><a href="core-components.html#dags"><i class="fa fa-check"></i><b>3.1.1</b> DAGs</a></li>
<li class="chapter" data-level="3.1.2" data-path="core-components.html"><a href="core-components.html#operators"><i class="fa fa-check"></i><b>3.1.2</b> Operators</a></li>
<li class="chapter" data-level="3.1.3" data-path="core-components.html"><a href="core-components.html#tasks"><i class="fa fa-check"></i><b>3.1.3</b> Tasks</a></li>
<li class="chapter" data-level="3.1.4" data-path="core-components.html"><a href="core-components.html#xcom"><i class="fa fa-check"></i><b>3.1.4</b> XCom</a></li>
<li class="chapter" data-level="3.1.5" data-path="core-components.html"><a href="core-components.html#scheduling"><i class="fa fa-check"></i><b>3.1.5</b> Scheduling</a></li>
<li class="chapter" data-level="3.1.6" data-path="core-components.html"><a href="core-components.html#taskflow"><i class="fa fa-check"></i><b>3.1.6</b> Taskflow</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="exemplary-ml-workflow.html"><a href="exemplary-ml-workflow.html"><i class="fa fa-check"></i><b>3.2</b> Exemplary ML workflow</a></li>
<li class="chapter" data-level="3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html"><i class="fa fa-check"></i><b>3.3</b> Airflow infrastructure</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#airflow-as-a-distributed-system"><i class="fa fa-check"></i><b>3.3.1</b> Airflow as a distributed system</a></li>
<li class="chapter" data-level="3.3.2" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#scheduler"><i class="fa fa-check"></i><b>3.3.2</b> Scheduler</a></li>
<li class="chapter" data-level="3.3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#webserver"><i class="fa fa-check"></i><b>3.3.3</b> Webserver</a></li>
<li class="chapter" data-level="3.3.4" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#executor"><i class="fa fa-check"></i><b>3.3.4</b> Executor</a></li>
<li class="chapter" data-level="3.3.5" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#dag-directory"><i class="fa fa-check"></i><b>3.3.5</b> DAG Directory</a></li>
<li class="chapter" data-level="3.3.6" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#metadata-database"><i class="fa fa-check"></i><b>3.3.6</b> Metadata Database</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mlflow.html"><a href="mlflow.html"><i class="fa fa-check"></i><b>4</b> MLflow</a>
<ul>
<li class="chapter" data-level="4.1" data-path="core-components-1.html"><a href="core-components-1.html"><i class="fa fa-check"></i><b>4.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-tracking"><i class="fa fa-check"></i><b>4.1.1</b> MLflow Tracking</a></li>
<li class="chapter" data-level="4.1.2" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-models"><i class="fa fa-check"></i><b>4.1.2</b> MLflow Models</a></li>
<li class="chapter" data-level="4.1.3" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-model-registry"><i class="fa fa-check"></i><b>4.1.3</b> MLflow Model Registry</a></li>
<li class="chapter" data-level="4.1.4" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-projects"><i class="fa fa-check"></i><b>4.1.4</b> MLflow Projects</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html"><i class="fa fa-check"></i><b>4.2</b> MLFflow Architecture</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-tracking-server"><i class="fa fa-check"></i><b>4.2.1</b> MLflow Tracking Server</a></li>
<li class="chapter" data-level="4.2.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-backend-store"><i class="fa fa-check"></i><b>4.2.2</b> MLflow Backend Store</a></li>
<li class="chapter" data-level="4.2.3" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-artifact-store"><i class="fa fa-check"></i><b>4.2.3</b> MLflow Artifact Store</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>5</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="5.1" data-path="core-components-2.html"><a href="core-components-2.html"><i class="fa fa-check"></i><b>5.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="core-components-2.html"><a href="core-components-2.html#nodes"><i class="fa fa-check"></i><b>5.1.1</b> Nodes</a></li>
<li class="chapter" data-level="5.1.2" data-path="core-components-2.html"><a href="core-components-2.html#pods"><i class="fa fa-check"></i><b>5.1.2</b> Pods</a></li>
<li class="chapter" data-level="5.1.3" data-path="core-components-2.html"><a href="core-components-2.html#imperative-declarative-management"><i class="fa fa-check"></i><b>5.1.3</b> Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html"><i class="fa fa-check"></i><b>5.2</b> Application Deployment &amp; Design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="application-deployment-design.html"><a href="application-deployment-design.html#deployments"><i class="fa fa-check"></i><b>5.2.1</b> Deployments</a></li>
<li class="chapter" data-level="5.2.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html#resource-management"><i class="fa fa-check"></i><b>5.2.2</b> Resource Management</a></li>
<li class="chapter" data-level="5.2.3" data-path="application-deployment-design.html"><a href="application-deployment-design.html#daemonsets"><i class="fa fa-check"></i><b>5.2.3</b> DaemonSets</a></li>
<li class="chapter" data-level="5.2.4" data-path="application-deployment-design.html"><a href="application-deployment-design.html#statefulsets"><i class="fa fa-check"></i><b>5.2.4</b> StatefulSets</a></li>
<li class="chapter" data-level="5.2.5" data-path="application-deployment-design.html"><a href="application-deployment-design.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>5.2.5</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="services-and-networking.html"><a href="services-and-networking.html"><i class="fa fa-check"></i><b>5.3</b> Services and Networking</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="services-and-networking.html"><a href="services-and-networking.html#services"><i class="fa fa-check"></i><b>5.3.1</b> Services</a></li>
<li class="chapter" data-level="5.3.2" data-path="services-and-networking.html"><a href="services-and-networking.html#service-discovery"><i class="fa fa-check"></i><b>5.3.2</b> Service Discovery</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html"><i class="fa fa-check"></i><b>5.4</b> Volumes and Storage</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#emptydir-volume"><i class="fa fa-check"></i><b>5.4.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="5.4.2" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#hostpath-volume"><i class="fa fa-check"></i><b>5.4.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="5.4.3" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#persistent-volumes"><i class="fa fa-check"></i><b>5.4.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html"><i class="fa fa-check"></i><b>5.5</b> Environment, Configuration &amp; Security</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#namespaces"><i class="fa fa-check"></i><b>5.5.1</b> Namespaces</a></li>
<li class="chapter" data-level="5.5.2" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>5.5.2</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="5.5.3" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#configmaps"><i class="fa fa-check"></i><b>5.5.3</b> ConfigMaps</a></li>
<li class="chapter" data-level="5.5.4" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#secrets"><i class="fa fa-check"></i><b>5.5.4</b> Secrets</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="observability-maintenance.html"><a href="observability-maintenance.html"><i class="fa fa-check"></i><b>5.6</b> Observability &amp; Maintenance</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="observability-maintenance.html"><a href="observability-maintenance.html#health-checks"><i class="fa fa-check"></i><b>5.6.1</b> Health Checks</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="helm.html"><a href="helm.html"><i class="fa fa-check"></i><b>5.7</b> Helm</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="helm.html"><a href="helm.html#helm-chart-structure"><i class="fa fa-check"></i><b>5.7.1</b> Helm Chart Structure</a></li>
<li class="chapter" data-level="5.7.2" data-path="helm.html"><a href="helm.html#working-with-helm"><i class="fa fa-check"></i><b>5.7.2</b> Working with Helm</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>6</b> Terraform</a>
<ul>
<li class="chapter" data-level="6.1" data-path="basic-usage.html"><a href="basic-usage.html"><i class="fa fa-check"></i><b>6.1</b> Basic usage</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="basic-usage.html"><a href="basic-usage.html#terraform-init"><i class="fa fa-check"></i><b>6.1.1</b> terraform init</a></li>
<li class="chapter" data-level="6.1.2" data-path="basic-usage.html"><a href="basic-usage.html#terraform-validate"><i class="fa fa-check"></i><b>6.1.2</b> terraform validate</a></li>
<li class="chapter" data-level="6.1.3" data-path="basic-usage.html"><a href="basic-usage.html#terraform-plan"><i class="fa fa-check"></i><b>6.1.3</b> terraform plan</a></li>
<li class="chapter" data-level="6.1.4" data-path="basic-usage.html"><a href="basic-usage.html#terraform-apply"><i class="fa fa-check"></i><b>6.1.4</b> terraform apply</a></li>
<li class="chapter" data-level="6.1.5" data-path="basic-usage.html"><a href="basic-usage.html#terraform-destroy"><i class="fa fa-check"></i><b>6.1.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="core-components-3.html"><a href="core-components-3.html"><i class="fa fa-check"></i><b>6.2</b> Core Components</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="core-components-3.html"><a href="core-components-3.html#providers"><i class="fa fa-check"></i><b>6.2.1</b> Providers</a></li>
<li class="chapter" data-level="6.2.2" data-path="core-components-3.html"><a href="core-components-3.html#resources"><i class="fa fa-check"></i><b>6.2.2</b> Resources</a></li>
<li class="chapter" data-level="6.2.3" data-path="core-components-3.html"><a href="core-components-3.html#data-sources"><i class="fa fa-check"></i><b>6.2.3</b> Data Sources</a></li>
<li class="chapter" data-level="6.2.4" data-path="core-components-3.html"><a href="core-components-3.html#state"><i class="fa fa-check"></i><b>6.2.4</b> State</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="modules.html"><a href="modules.html"><i class="fa fa-check"></i><b>6.3</b> Modules</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="modules.html"><a href="modules.html#input-variables"><i class="fa fa-check"></i><b>6.3.1</b> Input Variables</a></li>
<li class="chapter" data-level="6.3.2" data-path="modules.html"><a href="modules.html#output-variables"><i class="fa fa-check"></i><b>6.3.2</b> Output Variables</a></li>
<li class="chapter" data-level="6.3.3" data-path="modules.html"><a href="modules.html#local-variables"><i class="fa fa-check"></i><b>6.3.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html"><i class="fa fa-check"></i><b>6.4</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#count"><i class="fa fa-check"></i><b>6.4.1</b> count</a></li>
<li class="chapter" data-level="6.4.2" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for-each"><i class="fa fa-check"></i><b>6.4.2</b> for-each</a></li>
<li class="chapter" data-level="6.4.3" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for"><i class="fa fa-check"></i><b>6.4.3</b> for</a></li>
<li class="chapter" data-level="6.4.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#workspaces"><i class="fa fa-check"></i><b>6.4.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html"><i class="fa fa-check"></i><b>6.5</b> Exemplary Deployment</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#root"><i class="fa fa-check"></i><b>6.5.1</b> root</a></li>
<li class="chapter" data-level="6.5.2" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#vpc"><i class="fa fa-check"></i><b>6.5.2</b> vpc</a></li>
<li class="chapter" data-level="6.5.3" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#run-the-code"><i class="fa fa-check"></i><b>6.5.3</b> Run the code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ml-platform-design.html"><a href="ml-platform-design.html"><i class="fa fa-check"></i><b>7</b> ML Platform Design</a>
<ul>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#infrastructure"><i class="fa fa-check"></i>Infrastructure</a></li>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#mlops-tools"><i class="fa fa-check"></i>MLOps Tools</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="platform-deployment.html"><a href="platform-deployment.html"><i class="fa fa-check"></i><b>8</b> Platform Deployment</a>
<ul>
<li class="chapter" data-level="8.1" data-path="root-module.html"><a href="root-module.html"><i class="fa fa-check"></i><b>8.1</b> Root module</a></li>
<li class="chapter" data-level="8.2" data-path="infrastructure-2.html"><a href="infrastructure-2.html"><i class="fa fa-check"></i><b>8.2</b> Infrastructure</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="infrastructure-2.html"><a href="infrastructure-2.html#virtual-private-cloud"><i class="fa fa-check"></i><b>8.2.1</b> Virtual Private Cloud</a></li>
<li class="chapter" data-level="8.2.2" data-path="infrastructure-2.html"><a href="infrastructure-2.html#elastic-kubernetes-service"><i class="fa fa-check"></i><b>8.2.2</b> Elastic Kubernetes Service</a></li>
<li class="chapter" data-level="8.2.3" data-path="infrastructure-2.html"><a href="infrastructure-2.html#networking"><i class="fa fa-check"></i><b>8.2.3</b> Networking</a></li>
<li class="chapter" data-level="8.2.4" data-path="infrastructure-2.html"><a href="infrastructure-2.html#relational-database-service"><i class="fa fa-check"></i><b>8.2.4</b> Relational Database Service</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="components.html"><a href="components.html"><i class="fa fa-check"></i><b>8.3</b> Components</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="components.html"><a href="components.html#user-profiles"><i class="fa fa-check"></i><b>8.3.1</b> User Profiles</a></li>
<li class="chapter" data-level="8.3.2" data-path="components.html"><a href="components.html#airflow-1"><i class="fa fa-check"></i><b>8.3.2</b> Airflow</a></li>
<li class="chapter" data-level="8.3.3" data-path="components.html"><a href="components.html#mlflow-1"><i class="fa fa-check"></i><b>8.3.3</b> Mlflow</a></li>
<li class="chapter" data-level="8.3.4" data-path="components.html"><a href="components.html#jupyterhub"><i class="fa fa-check"></i><b>8.3.4</b> Jupyterhub</a></li>
<li class="chapter" data-level="8.3.5" data-path="components.html"><a href="components.html#monitoring"><i class="fa fa-check"></i><b>8.3.5</b> Monitoring</a></li>
<li class="chapter" data-level="8.3.6" data-path="components.html"><a href="components.html#sagemaker"><i class="fa fa-check"></i><b>8.3.6</b> Sagemaker</a></li>
<li class="chapter" data-level="8.3.7" data-path="components.html"><a href="components.html#dashboard"><i class="fa fa-check"></i><b>8.3.7</b> Dashboard</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="design-decisions.html"><a href="design-decisions.html"><i class="fa fa-check"></i><b>8.4</b> Design Decisions</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="use-case-development.html"><a href="use-case-development.html"><i class="fa fa-check"></i><b>9</b> Use Case Development</a>
<ul>
<li class="chapter" data-level="9.1" data-path="integrated-development-environment-1.html"><a href="integrated-development-environment-1.html"><i class="fa fa-check"></i><b>9.1</b> Integrated Development Environment</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="integrated-development-environment-1.html"><a href="integrated-development-environment-1.html#github-repository"><i class="fa fa-check"></i><b>9.1.1</b> Github Repository</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html"><i class="fa fa-check"></i><b>9.2</b> Training &amp; Deployment Pipeline Workflow</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#airflow-workflow"><i class="fa fa-check"></i><b>9.2.1</b> Airflow Workflow</a></li>
<li class="chapter" data-level="9.2.2" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#mlflow-integration"><i class="fa fa-check"></i><b>9.2.2</b> MLflow integration</a></li>
<li class="chapter" data-level="9.2.3" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#pipeline-workflow"><i class="fa fa-check"></i><b>9.2.3</b> Pipeline Workflow</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="pipeline-workflow-steps.html"><a href="pipeline-workflow-steps.html"><i class="fa fa-check"></i><b>9.3</b> Pipeline Workflow Steps</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="pipeline-workflow-steps.html"><a href="pipeline-workflow-steps.html#data-preprocessing"><i class="fa fa-check"></i><b>9.3.1</b> Data Preprocessing</a></li>
<li class="chapter" data-level="9.3.2" data-path="pipeline-workflow-steps.html"><a href="pipeline-workflow-steps.html#model-training"><i class="fa fa-check"></i><b>9.3.2</b> Model Training</a></li>
<li class="chapter" data-level="9.3.3" data-path="pipeline-workflow-steps.html"><a href="pipeline-workflow-steps.html#model-comparison"><i class="fa fa-check"></i><b>9.3.3</b> Model Comparison</a></li>
<li class="chapter" data-level="9.3.4" data-path="pipeline-workflow-steps.html"><a href="pipeline-workflow-steps.html#model-deployment-serving"><i class="fa fa-check"></i><b>9.3.4</b> Model Deployment &amp; Serving</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="model-inferencing.html"><a href="model-inferencing.html"><i class="fa fa-check"></i><b>9.4</b> Model Inferencing</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="model-inferencing.html"><a href="model-inferencing.html#pipeline-workflow-1"><i class="fa fa-check"></i><b>9.4.1</b> Pipeline Workflow</a></li>
<li class="chapter" data-level="9.4.2" data-path="model-inferencing.html"><a href="model-inferencing.html#inference-workflow-code"><i class="fa fa-check"></i><b>9.4.2</b> Inference Workflow Code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i>Glossary</a></li>
<li class="chapter" data-level="" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i>Contributing</a></li>
<li class="chapter" data-level="" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Engineering</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pipeline-workflow-steps" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Pipeline Workflow Steps<a href="pipeline-workflow-steps.html#pipeline-workflow-steps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As mentioned previously, the machine learning pipeline for this particular use case comprises three primary stages: preprocessing, training, and serving. Furthermore, only the model that achieves the highest accuracy is chosen for deployment, which introduces an additional step for model comparison. Each of these steps will be further explained in the upcoming sections.</p>

<div id="data-preprocessing" class="section level3 hasAnchor" number="9.3.1">
<h3><span class="header-section-number">9.3.1</span> Data Preprocessing<a href="pipeline-workflow-steps.html#data-preprocessing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The data processing stage involves three primary processes. First, the raw data is loaded from an S3 Bucket. Second, the data is preprocessed and converted into the required format. Finally, the preprocessed data is stored in a way that allows it to be utilized by subsequent models. The data processing functionality is implemented within the given <code>data_preprocessing</code> function. The <code>utils</code> module, imported at the beginning, provides the functionality to access, load, and store data from S3. The data is normalized and transformed into a NumPy array to make it compatible with TensorFlow Keras models. The function returns the names and paths of the preprocessed and uploaded data, making it convenient for selecting them for future model training. Moreover, the data preprocessing stage establishes a connection with MLflow to record the sizes of the datasets.</p>
<p>At the beginning of each pipeline step are the import statements for various Python modules and libraries used in the code. They will not be mentioned within the description, but you can look them up in the <a href="https://github.com/seblum/mlops-airflow-DAGs/blob/main/cnn_skin_cancer/src/preprocessing.py">provided code</a>.</p>
<p>The code starts with the function definition <code>data_preprocessing</code>. The function takes several input parameters and returns a tuple with paths to the preprocessed data stored as NumPy arrays. The function is equipped with a <code>@timeit</code> decorator, which serves to measure the execution time of the preprocessing operation.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb169-1"><a href="pipeline-workflow-steps.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="at">@timeit</span></span>
<span id="cb169-2"><a href="pipeline-workflow-steps.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_preprocessing(</span>
<span id="cb169-3"><a href="pipeline-workflow-steps.html#cb169-3" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_id: <span class="bu">str</span>,</span>
<span id="cb169-4"><a href="pipeline-workflow-steps.html#cb169-4" aria-hidden="true" tabindex="-1"></a>    aws_bucket: <span class="bu">str</span>,</span>
<span id="cb169-5"><a href="pipeline-workflow-steps.html#cb169-5" aria-hidden="true" tabindex="-1"></a>    path_preprocessed: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;preprocessed&quot;</span>,</span>
<span id="cb169-6"><a href="pipeline-workflow-steps.html#cb169-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>]:</span>
<span id="cb169-7"><a href="pipeline-workflow-steps.html#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Preprocesses data for further use within model training. Raw data is read from given S3 Bucket, normalized, and stored ad a NumPy Array within S3 again. Output directory is on &quot;/preprocessed&quot;. The shape of the data set is logged to MLflow.</span></span>
<span id="cb169-8"><a href="pipeline-workflow-steps.html#cb169-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-9"><a href="pipeline-workflow-steps.html#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb169-10"><a href="pipeline-workflow-steps.html#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_experiment_id (str): Experiment ID of the MLflow run to log data</span></span>
<span id="cb169-11"><a href="pipeline-workflow-steps.html#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="co">        aws_bucket (str): S3 Bucket to read raw data from and write preprocessed data</span></span>
<span id="cb169-12"><a href="pipeline-workflow-steps.html#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co">        path_preprocessed (str, optional): Subdirectory to store the preprocessed data on the provided S3 Bucket. Defaults to &quot;preprocessed&quot;.</span></span>
<span id="cb169-13"><a href="pipeline-workflow-steps.html#cb169-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-14"><a href="pipeline-workflow-steps.html#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb169-15"><a href="pipeline-workflow-steps.html#cb169-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[str, str, str, str]: Four strings denoting the path of the preprocessed data stored as NumPy Arrays: X_train_data_path, y_train_data_path, X_test_data_path, y_test_data_path</span></span>
<span id="cb169-16"><a href="pipeline-workflow-steps.html#cb169-16" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span></code></pre></div>
<p>It continues by retrieving the MLflow tracking URI from an environment variable and setting it as the tracking URI for MLflow.
An AWS session is set up based on AWS Access Key and AWS Secret Access Key, which is similarly provided using environment variables. The <code>AWSSession</code> Object is a custom class to handle the interaction with S3 buckets.
Afterward. the paths within an S3 bucket for different data folders are defined, including training and testing data for benign and malignant cases.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb170-1"><a href="pipeline-workflow-steps.html#cb170-1" aria-hidden="true" tabindex="-1"></a>mlflow_tracking_uri <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb170-2"><a href="pipeline-workflow-steps.html#cb170-2" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(mlflow_tracking_uri)</span>
<span id="cb170-3"><a href="pipeline-workflow-steps.html#cb170-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-4"><a href="pipeline-workflow-steps.html#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate aws session based on AWS Access Key</span></span>
<span id="cb170-5"><a href="pipeline-workflow-steps.html#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="co"># AWS Access Key is fetched within AWS Session by os.getenv</span></span>
<span id="cb170-6"><a href="pipeline-workflow-steps.html#cb170-6" aria-hidden="true" tabindex="-1"></a>aws_session <span class="op">=</span> AWSSession()</span>
<span id="cb170-7"><a href="pipeline-workflow-steps.html#cb170-7" aria-hidden="true" tabindex="-1"></a>aws_session.set_sessions()</span>
<span id="cb170-8"><a href="pipeline-workflow-steps.html#cb170-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-9"><a href="pipeline-workflow-steps.html#cb170-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set paths within s3</span></span>
<span id="cb170-10"><a href="pipeline-workflow-steps.html#cb170-10" aria-hidden="true" tabindex="-1"></a>path_raw_data <span class="op">=</span> <span class="ss">f&quot;s3://</span><span class="sc">{</span>aws_bucket<span class="sc">}</span><span class="ss">/data/&quot;</span></span>
<span id="cb170-11"><a href="pipeline-workflow-steps.html#cb170-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-12"><a href="pipeline-workflow-steps.html#cb170-12" aria-hidden="true" tabindex="-1"></a>folder_benign_train <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">train/benign&quot;</span></span>
<span id="cb170-13"><a href="pipeline-workflow-steps.html#cb170-13" aria-hidden="true" tabindex="-1"></a>folder_malignant_train <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">train/malignant&quot;</span></span>
<span id="cb170-14"><a href="pipeline-workflow-steps.html#cb170-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-15"><a href="pipeline-workflow-steps.html#cb170-15" aria-hidden="true" tabindex="-1"></a>folder_benign_test <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">test/benign&quot;</span></span>
<span id="cb170-16"><a href="pipeline-workflow-steps.html#cb170-16" aria-hidden="true" tabindex="-1"></a>folder_malignant_test <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">test/malignant&quot;</span></span></code></pre></div>
<p>The code proceeds by defining three hidden functions that play a crucial role in the preprocessing of the data:</p>
<p><strong>Image Loading and Conversion</strong>: A function named <code>_load_and_convert_images</code> designed to handle the loading and conversion of images retrieved from an S3 bucket folder into a NumPy array. It utilizes the <code>aws_session</code> to access and process these images.</p>
<p><strong>Creating Labels</strong>: The following function, <code>_create_label</code>, serves the purpose of generating a label array suitable for a given dataset. This function is responsible for preparing labels essential for classification tasks. The inner function, <code>create_label</code>, undertakes the task of constructing a label array that corresponds to a specific dataset, thus facilitating classification operations.</p>
<p><strong>Merging Data</strong>: Lastly, the function <code>_merge_data</code> is introduced to combine two datasets into a unified dataset. This inner function, <code>_merge_data_</code>, plays the role of merging two distinct datasets into a single, consolidated dataset. It effectively combines data originating from diverse sources, allowing for a comprehensive dataset.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb171-1"><a href="pipeline-workflow-steps.html#cb171-1" aria-hidden="true" tabindex="-1"></a>    <span class="at">@timeit</span></span>
<span id="cb171-2"><a href="pipeline-workflow-steps.html#cb171-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _load_and_convert_images(folder_path: <span class="bu">str</span>) <span class="op">-&gt;</span> np.array:</span>
<span id="cb171-3"><a href="pipeline-workflow-steps.html#cb171-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb171-4"><a href="pipeline-workflow-steps.html#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co">        Loads and converts images from an S3 bucket folder into a NumPy array.</span></span>
<span id="cb171-5"><a href="pipeline-workflow-steps.html#cb171-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-6"><a href="pipeline-workflow-steps.html#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb171-7"><a href="pipeline-workflow-steps.html#cb171-7" aria-hidden="true" tabindex="-1"></a><span class="co">            folder_path (str): The path to the S3 bucket folder.</span></span>
<span id="cb171-8"><a href="pipeline-workflow-steps.html#cb171-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-9"><a href="pipeline-workflow-steps.html#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb171-10"><a href="pipeline-workflow-steps.html#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="co">            np.array: The NumPy array containing the converted images.</span></span>
<span id="cb171-11"><a href="pipeline-workflow-steps.html#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="pipeline-workflow-steps.html#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Raises:</span></span>
<span id="cb171-13"><a href="pipeline-workflow-steps.html#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="co">            None</span></span>
<span id="cb171-14"><a href="pipeline-workflow-steps.html#cb171-14" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb171-15"><a href="pipeline-workflow-steps.html#cb171-15" aria-hidden="true" tabindex="-1"></a>        ims <span class="op">=</span> [</span>
<span id="cb171-16"><a href="pipeline-workflow-steps.html#cb171-16" aria-hidden="true" tabindex="-1"></a>            aws_session.read_image_from_s3(s3_bucket<span class="op">=</span>aws_bucket, imname<span class="op">=</span>filename)</span>
<span id="cb171-17"><a href="pipeline-workflow-steps.html#cb171-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> filename <span class="kw">in</span> tqdm(aws_session.list_files_in_bucket(folder_path))</span>
<span id="cb171-18"><a href="pipeline-workflow-steps.html#cb171-18" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb171-19"><a href="pipeline-workflow-steps.html#cb171-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(ims, dtype<span class="op">=</span><span class="st">&quot;uint8&quot;</span>)</span>
<span id="cb171-20"><a href="pipeline-workflow-steps.html#cb171-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-21"><a href="pipeline-workflow-steps.html#cb171-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _create_label(x_dataset: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb171-22"><a href="pipeline-workflow-steps.html#cb171-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb171-23"><a href="pipeline-workflow-steps.html#cb171-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Creates label array for the given dataset.</span></span>
<span id="cb171-24"><a href="pipeline-workflow-steps.html#cb171-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-25"><a href="pipeline-workflow-steps.html#cb171-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb171-26"><a href="pipeline-workflow-steps.html#cb171-26" aria-hidden="true" tabindex="-1"></a><span class="co">            x_dataset (np.array): The dataset for which labels are to be created.</span></span>
<span id="cb171-27"><a href="pipeline-workflow-steps.html#cb171-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-28"><a href="pipeline-workflow-steps.html#cb171-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb171-29"><a href="pipeline-workflow-steps.html#cb171-29" aria-hidden="true" tabindex="-1"></a><span class="co">            np.array: The label array.</span></span>
<span id="cb171-30"><a href="pipeline-workflow-steps.html#cb171-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-31"><a href="pipeline-workflow-steps.html#cb171-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Raises:</span></span>
<span id="cb171-32"><a href="pipeline-workflow-steps.html#cb171-32" aria-hidden="true" tabindex="-1"></a><span class="co">            None</span></span>
<span id="cb171-33"><a href="pipeline-workflow-steps.html#cb171-33" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb171-34"><a href="pipeline-workflow-steps.html#cb171-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.zeros(x_dataset.shape[<span class="dv">0</span>])</span>
<span id="cb171-35"><a href="pipeline-workflow-steps.html#cb171-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-36"><a href="pipeline-workflow-steps.html#cb171-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _merge_data(set_one: np.array, set_two: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb171-37"><a href="pipeline-workflow-steps.html#cb171-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb171-38"><a href="pipeline-workflow-steps.html#cb171-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Merges two datasets into a single dataset.</span></span>
<span id="cb171-39"><a href="pipeline-workflow-steps.html#cb171-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-40"><a href="pipeline-workflow-steps.html#cb171-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb171-41"><a href="pipeline-workflow-steps.html#cb171-41" aria-hidden="true" tabindex="-1"></a><span class="co">            set_one (np.array): The first dataset.</span></span>
<span id="cb171-42"><a href="pipeline-workflow-steps.html#cb171-42" aria-hidden="true" tabindex="-1"></a><span class="co">            set_two (np.array): The second dataset.</span></span>
<span id="cb171-43"><a href="pipeline-workflow-steps.html#cb171-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-44"><a href="pipeline-workflow-steps.html#cb171-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb171-45"><a href="pipeline-workflow-steps.html#cb171-45" aria-hidden="true" tabindex="-1"></a><span class="co">            np.array: The merged dataset.</span></span>
<span id="cb171-46"><a href="pipeline-workflow-steps.html#cb171-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-47"><a href="pipeline-workflow-steps.html#cb171-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Raises:</span></span>
<span id="cb171-48"><a href="pipeline-workflow-steps.html#cb171-48" aria-hidden="true" tabindex="-1"></a><span class="co">            None</span></span>
<span id="cb171-49"><a href="pipeline-workflow-steps.html#cb171-49" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb171-50"><a href="pipeline-workflow-steps.html#cb171-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.concatenate((set_one, set_two), axis<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div>
<p>The code continues further with the actual data preprocessing steps, including calling the previously stated hidden functions and loading images, creating labels, merging data, and performing data normalization and augmentation. An MLflow run is created for this step to log parameters such as the training and testing size of the data.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb172-1"><a href="pipeline-workflow-steps.html#cb172-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start a MLflow run to log the size of the data</span></span>
<span id="cb172-2"><a href="pipeline-workflow-steps.html#cb172-2" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S&quot;</span>)</span>
<span id="cb172-3"><a href="pipeline-workflow-steps.html#cb172-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(experiment_id<span class="op">=</span>mlflow_experiment_id, run_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">_Preprocessing&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb172-4"><a href="pipeline-workflow-steps.html#cb172-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Loading images from S3...&quot;</span>)</span>
<span id="cb172-5"><a href="pipeline-workflow-steps.html#cb172-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load in training pictures</span></span>
<span id="cb172-6"><a href="pipeline-workflow-steps.html#cb172-6" aria-hidden="true" tabindex="-1"></a>        X_benign <span class="op">=</span> _load_and_convert_images(folder_benign_train)</span>
<span id="cb172-7"><a href="pipeline-workflow-steps.html#cb172-7" aria-hidden="true" tabindex="-1"></a>        X_malignant <span class="op">=</span> _load_and_convert_images(folder_malignant_train)</span>
<span id="cb172-8"><a href="pipeline-workflow-steps.html#cb172-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-9"><a href="pipeline-workflow-steps.html#cb172-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load in testing pictures</span></span>
<span id="cb172-10"><a href="pipeline-workflow-steps.html#cb172-10" aria-hidden="true" tabindex="-1"></a>        X_benign_test <span class="op">=</span> _load_and_convert_images(folder_benign_test)</span>
<span id="cb172-11"><a href="pipeline-workflow-steps.html#cb172-11" aria-hidden="true" tabindex="-1"></a>        X_malignant_test <span class="op">=</span> _load_and_convert_images(folder_malignant_test)</span>
<span id="cb172-12"><a href="pipeline-workflow-steps.html#cb172-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-13"><a href="pipeline-workflow-steps.html#cb172-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log train-test size in MLflow</span></span>
<span id="cb172-14"><a href="pipeline-workflow-steps.html#cb172-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Log data parameters&quot;</span>)</span>
<span id="cb172-15"><a href="pipeline-workflow-steps.html#cb172-15" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;train_size_benign&quot;</span>, X_benign.shape[<span class="dv">0</span>])</span>
<span id="cb172-16"><a href="pipeline-workflow-steps.html#cb172-16" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;train_size_malignant&quot;</span>, X_malignant.shape[<span class="dv">0</span>])</span>
<span id="cb172-17"><a href="pipeline-workflow-steps.html#cb172-17" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;test_size_benign&quot;</span>, X_benign_test.shape[<span class="dv">0</span>])</span>
<span id="cb172-18"><a href="pipeline-workflow-steps.html#cb172-18" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;test_size_malignant&quot;</span>, X_malignant_test.shape[<span class="dv">0</span>])</span>
<span id="cb172-19"><a href="pipeline-workflow-steps.html#cb172-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-20"><a href="pipeline-workflow-steps.html#cb172-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Preprocessing...&quot;</span>)</span>
<span id="cb172-21"><a href="pipeline-workflow-steps.html#cb172-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create labels</span></span>
<span id="cb172-22"><a href="pipeline-workflow-steps.html#cb172-22" aria-hidden="true" tabindex="-1"></a>        y_benign <span class="op">=</span> _create_label(X_benign)</span>
<span id="cb172-23"><a href="pipeline-workflow-steps.html#cb172-23" aria-hidden="true" tabindex="-1"></a>        y_malignant <span class="op">=</span> _create_label(X_malignant)</span>
<span id="cb172-24"><a href="pipeline-workflow-steps.html#cb172-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-25"><a href="pipeline-workflow-steps.html#cb172-25" aria-hidden="true" tabindex="-1"></a>        y_benign_test <span class="op">=</span> _create_label(X_benign_test)</span>
<span id="cb172-26"><a href="pipeline-workflow-steps.html#cb172-26" aria-hidden="true" tabindex="-1"></a>        y_malignant_test <span class="op">=</span> _create_label(X_malignant_test)</span>
<span id="cb172-27"><a href="pipeline-workflow-steps.html#cb172-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-28"><a href="pipeline-workflow-steps.html#cb172-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge data</span></span>
<span id="cb172-29"><a href="pipeline-workflow-steps.html#cb172-29" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> _merge_data(y_benign, y_malignant)</span>
<span id="cb172-30"><a href="pipeline-workflow-steps.html#cb172-30" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> _merge_data(y_benign_test, y_malignant_test)</span>
<span id="cb172-31"><a href="pipeline-workflow-steps.html#cb172-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-32"><a href="pipeline-workflow-steps.html#cb172-32" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> _merge_data(X_benign, X_malignant)</span>
<span id="cb172-33"><a href="pipeline-workflow-steps.html#cb172-33" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> _merge_data(X_benign_test, X_malignant_test)</span>
<span id="cb172-34"><a href="pipeline-workflow-steps.html#cb172-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-35"><a href="pipeline-workflow-steps.html#cb172-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shuffle data</span></span>
<span id="cb172-36"><a href="pipeline-workflow-steps.html#cb172-36" aria-hidden="true" tabindex="-1"></a>        X_train, y_train <span class="op">=</span> shuffle(X_train, y_train)</span>
<span id="cb172-37"><a href="pipeline-workflow-steps.html#cb172-37" aria-hidden="true" tabindex="-1"></a>        X_test, y_test <span class="op">=</span> shuffle(X_test, y_test)</span>
<span id="cb172-38"><a href="pipeline-workflow-steps.html#cb172-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-39"><a href="pipeline-workflow-steps.html#cb172-39" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> to_categorical(y_train, num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb172-40"><a href="pipeline-workflow-steps.html#cb172-40" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> to_categorical(y_test, num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb172-41"><a href="pipeline-workflow-steps.html#cb172-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-42"><a href="pipeline-workflow-steps.html#cb172-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># With data augmentation to prevent overfitting</span></span>
<span id="cb172-43"><a href="pipeline-workflow-steps.html#cb172-43" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> X_train <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb172-44"><a href="pipeline-workflow-steps.html#cb172-44" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> X_test <span class="op">/</span> <span class="fl">255.0</span></span></code></pre></div>
<p>Once the data has been normalized and converted into a NumPy array, it is then transferred to an S3 bucket with the assistance of the <code>aws_session</code>. The function returns the names and paths of the preprocessed data that has been uploaded. This information is made available for use in subsequent functions.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb173-1"><a href="pipeline-workflow-steps.html#cb173-1" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Upload numpy arrays to S3...&quot;</span>)</span>
<span id="cb173-2"><a href="pipeline-workflow-steps.html#cb173-2" aria-hidden="true" tabindex="-1"></a>        aws_session.upload_npy_to_s3(</span>
<span id="cb173-3"><a href="pipeline-workflow-steps.html#cb173-3" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>X_train,</span>
<span id="cb173-4"><a href="pipeline-workflow-steps.html#cb173-4" aria-hidden="true" tabindex="-1"></a>            s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb173-5"><a href="pipeline-workflow-steps.html#cb173-5" aria-hidden="true" tabindex="-1"></a>            file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_train.pkl&quot;</span>,</span>
<span id="cb173-6"><a href="pipeline-workflow-steps.html#cb173-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb173-7"><a href="pipeline-workflow-steps.html#cb173-7" aria-hidden="true" tabindex="-1"></a>        aws_session.upload_npy_to_s3(</span>
<span id="cb173-8"><a href="pipeline-workflow-steps.html#cb173-8" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>y_train,</span>
<span id="cb173-9"><a href="pipeline-workflow-steps.html#cb173-9" aria-hidden="true" tabindex="-1"></a>            s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb173-10"><a href="pipeline-workflow-steps.html#cb173-10" aria-hidden="true" tabindex="-1"></a>            file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_train.pkl&quot;</span>,</span>
<span id="cb173-11"><a href="pipeline-workflow-steps.html#cb173-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb173-12"><a href="pipeline-workflow-steps.html#cb173-12" aria-hidden="true" tabindex="-1"></a>        aws_session.upload_npy_to_s3(</span>
<span id="cb173-13"><a href="pipeline-workflow-steps.html#cb173-13" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>X_test,</span>
<span id="cb173-14"><a href="pipeline-workflow-steps.html#cb173-14" aria-hidden="true" tabindex="-1"></a>            s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb173-15"><a href="pipeline-workflow-steps.html#cb173-15" aria-hidden="true" tabindex="-1"></a>            file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_test.pkl&quot;</span>,</span>
<span id="cb173-16"><a href="pipeline-workflow-steps.html#cb173-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb173-17"><a href="pipeline-workflow-steps.html#cb173-17" aria-hidden="true" tabindex="-1"></a>        aws_session.upload_npy_to_s3(</span>
<span id="cb173-18"><a href="pipeline-workflow-steps.html#cb173-18" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>y_test,</span>
<span id="cb173-19"><a href="pipeline-workflow-steps.html#cb173-19" aria-hidden="true" tabindex="-1"></a>            s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb173-20"><a href="pipeline-workflow-steps.html#cb173-20" aria-hidden="true" tabindex="-1"></a>            file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_test.pkl&quot;</span>,</span>
<span id="cb173-21"><a href="pipeline-workflow-steps.html#cb173-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb173-22"><a href="pipeline-workflow-steps.html#cb173-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-23"><a href="pipeline-workflow-steps.html#cb173-23" aria-hidden="true" tabindex="-1"></a>    X_train_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_train.pkl&quot;</span></span>
<span id="cb173-24"><a href="pipeline-workflow-steps.html#cb173-24" aria-hidden="true" tabindex="-1"></a>    y_train_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_train.pkl&quot;</span></span>
<span id="cb173-25"><a href="pipeline-workflow-steps.html#cb173-25" aria-hidden="true" tabindex="-1"></a>    X_test_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_test.pkl&quot;</span></span>
<span id="cb173-26"><a href="pipeline-workflow-steps.html#cb173-26" aria-hidden="true" tabindex="-1"></a>    y_test_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_test.pkl&quot;</span></span>
<span id="cb173-27"><a href="pipeline-workflow-steps.html#cb173-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-28"><a href="pipeline-workflow-steps.html#cb173-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train_data_path, y_train_data_path, X_test_data_path, y_test_data_path</span></code></pre></div>

</div>
<div id="model-training" class="section level3 hasAnchor" number="9.3.2">
<h3><span class="header-section-number">9.3.2</span> Model Training<a href="pipeline-workflow-steps.html#model-training" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The training step is designed to accommodate different models based on the selected model. The custom <code>model.utils</code> package, imported at the beginning, enables the selection and retrieval of models. The chosen model can be specified by passing its name to the <code>get_model</code> function, which then returns the corresponding model. These models are implemented using TensorFlow Keras and their code is stored in the <code>/model</code> directory. The model is trained using the <code>model_params</code> parameters provided to the training function, which include all the necessary hyperparameters. The training and evaluation are conducted using the preprocessed data from the previous step, which is downloaded from S3 at the beginning. Depending on the selected model, a KFold cross-validation is performed to improve the model’s fit.</p>
<p>MLflow is utilized to track the model’s progress. By invoking <code>mlflow.start_run()</code>, a new MLflow run is initiated. The <code>model_params</code> are logged using <code>mlflow.log_params</code>, and MLflow autolog is enabled for Keras models through <code>mlflow.keras.autolog()</code>. After successful training, the models are stored in the model registry. The trained model is logged using <code>mlflow.keras.register_model</code>, with the specified <code>model_name</code> as the destination.</p>
<p>The Function Definition <code>train_model</code> takes several input parameters, including <code>mlflow_experiment_id</code>, <code>model_class</code>, <code>model_params</code>, <code>aws_bucket</code>, and an optional <code>import_dict</code> for importing data. It returns a tuple containing information about the run and model. The code of the functions starts by setting the tracking URI for MLflow.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb174-1"><a href="pipeline-workflow-steps.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(</span>
<span id="cb174-2"><a href="pipeline-workflow-steps.html#cb174-2" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_id: <span class="bu">str</span>,</span>
<span id="cb174-3"><a href="pipeline-workflow-steps.html#cb174-3" aria-hidden="true" tabindex="-1"></a>    model_class: Enum,</span>
<span id="cb174-4"><a href="pipeline-workflow-steps.html#cb174-4" aria-hidden="true" tabindex="-1"></a>    model_params: <span class="bu">dict</span>,</span>
<span id="cb174-5"><a href="pipeline-workflow-steps.html#cb174-5" aria-hidden="true" tabindex="-1"></a>    aws_bucket: <span class="bu">str</span>,</span>
<span id="cb174-6"><a href="pipeline-workflow-steps.html#cb174-6" aria-hidden="true" tabindex="-1"></a>    import_dict: <span class="bu">dict</span> <span class="op">=</span> {},</span>
<span id="cb174-7"><a href="pipeline-workflow-steps.html#cb174-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">int</span>, <span class="bu">str</span>]:</span>
<span id="cb174-8"><a href="pipeline-workflow-steps.html#cb174-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb174-9"><a href="pipeline-workflow-steps.html#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a machine learning model and logs the results to MLflow.</span></span>
<span id="cb174-10"><a href="pipeline-workflow-steps.html#cb174-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-11"><a href="pipeline-workflow-steps.html#cb174-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb174-12"><a href="pipeline-workflow-steps.html#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_experiment_id (str): The ID of the MLflow experiment to log the results.</span></span>
<span id="cb174-13"><a href="pipeline-workflow-steps.html#cb174-13" aria-hidden="true" tabindex="-1"></a><span class="co">        model_class (Enum): The class of the model to train.</span></span>
<span id="cb174-14"><a href="pipeline-workflow-steps.html#cb174-14" aria-hidden="true" tabindex="-1"></a><span class="co">        model_params (dict): A dictionary containing the parameters for the model.</span></span>
<span id="cb174-15"><a href="pipeline-workflow-steps.html#cb174-15" aria-hidden="true" tabindex="-1"></a><span class="co">        aws_bucket (str): The AWS S3 bucket name for data storage.</span></span>
<span id="cb174-16"><a href="pipeline-workflow-steps.html#cb174-16" aria-hidden="true" tabindex="-1"></a><span class="co">        import_dict (dict, optional): A dictionary containing paths for importing data. Defaults to {}.</span></span>
<span id="cb174-17"><a href="pipeline-workflow-steps.html#cb174-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-18"><a href="pipeline-workflow-steps.html#cb174-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb174-19"><a href="pipeline-workflow-steps.html#cb174-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[str, str, int, str]: A tuple containing the run ID, model name, model version, and current stage.</span></span>
<span id="cb174-20"><a href="pipeline-workflow-steps.html#cb174-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-21"><a href="pipeline-workflow-steps.html#cb174-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb174-22"><a href="pipeline-workflow-steps.html#cb174-22" aria-hidden="true" tabindex="-1"></a><span class="co">        None</span></span>
<span id="cb174-23"><a href="pipeline-workflow-steps.html#cb174-23" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb174-24"><a href="pipeline-workflow-steps.html#cb174-24" aria-hidden="true" tabindex="-1"></a>    mlflow_tracking_uri <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb174-25"><a href="pipeline-workflow-steps.html#cb174-25" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(mlflow_tracking_uri)</span></code></pre></div>
<p>Afterward, the data required for training and testing the model is loaded from AWS S3 buckets. It fetches file paths from the <code>import_dict</code> dictionary, and instantiates an <code>AWSSession</code>. It uses the <code>AWSSession</code> class to download NumPy arrays from the specified S3 bucket.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb175-1"><a href="pipeline-workflow-steps.html#cb175-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-2"><a href="pipeline-workflow-steps.html#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Loading data...&quot;</span>)</span>
<span id="cb175-3"><a href="pipeline-workflow-steps.html#cb175-3" aria-hidden="true" tabindex="-1"></a>    X_train_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;X_train_data_path&quot;</span>)</span>
<span id="cb175-4"><a href="pipeline-workflow-steps.html#cb175-4" aria-hidden="true" tabindex="-1"></a>    y_train_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;y_train_data_path&quot;</span>)</span>
<span id="cb175-5"><a href="pipeline-workflow-steps.html#cb175-5" aria-hidden="true" tabindex="-1"></a>    X_test_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;X_test_data_path&quot;</span>)</span>
<span id="cb175-6"><a href="pipeline-workflow-steps.html#cb175-6" aria-hidden="true" tabindex="-1"></a>    y_test_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;y_test_data_path&quot;</span>)</span>
<span id="cb175-7"><a href="pipeline-workflow-steps.html#cb175-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-8"><a href="pipeline-workflow-steps.html#cb175-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate aws session based on AWS Access Key</span></span>
<span id="cb175-9"><a href="pipeline-workflow-steps.html#cb175-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AWS Access Key is fetched within AWS Session by os.getenv</span></span>
<span id="cb175-10"><a href="pipeline-workflow-steps.html#cb175-10" aria-hidden="true" tabindex="-1"></a>    aws_session <span class="op">=</span> AWSSession()</span>
<span id="cb175-11"><a href="pipeline-workflow-steps.html#cb175-11" aria-hidden="true" tabindex="-1"></a>    aws_session.set_sessions()</span>
<span id="cb175-12"><a href="pipeline-workflow-steps.html#cb175-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-13"><a href="pipeline-workflow-steps.html#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read NumPy Arrays from S3</span></span>
<span id="cb175-14"><a href="pipeline-workflow-steps.html#cb175-14" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>X_train_data_path)</span>
<span id="cb175-15"><a href="pipeline-workflow-steps.html#cb175-15" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>y_train_data_path)</span>
<span id="cb175-16"><a href="pipeline-workflow-steps.html#cb175-16" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>X_test_data_path)</span>
<span id="cb175-17"><a href="pipeline-workflow-steps.html#cb175-17" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>y_test_data_path)</span></code></pre></div>
<p>The training of the machine learning model is contingent upon the chosen model class. If the <code>model_class</code> is set to <code>Model_Class.CrossVal</code>, the training process involves k-fold cross-validation using the BasicNet as the model. Conversely, if the <code>model_class</code> is anything other than <code>Model_Class.CrossVal</code>, the model undergoes training without cross-validation, following the specifications associated with the provided class and parameters.</p>
<p>The selection of the model is based on the <code>model_class</code> Enum, which could be either <code>Model_Class.CrossVal</code> or <code>Model_Class.ResNet50</code>. During the training process, the <code>mlflow.autolog</code> functionality is employed, allowing for the automatic logging of all essential run parameters. This feature can be enabled or disabled as needed to facilitate model training and parameter logging.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb176-1"><a href="pipeline-workflow-steps.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Training model...&quot;</span>)</span>
<span id="cb176-2"><a href="pipeline-workflow-steps.html#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_class)</span>
<span id="cb176-3"><a href="pipeline-workflow-steps.html#cb176-3" aria-hidden="true" tabindex="-1"></a>timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S&quot;</span>)</span>
<span id="cb176-4"><a href="pipeline-workflow-steps.html#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(experiment_id<span class="op">=</span>mlflow_experiment_id, run_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>model_class<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb176-5"><a href="pipeline-workflow-steps.html#cb176-5" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params(model_params)</span>
<span id="cb176-6"><a href="pipeline-workflow-steps.html#cb176-6" aria-hidden="true" tabindex="-1"></a>    learning_rate_reduction <span class="op">=</span> ReduceLROnPlateau(monitor<span class="op">=</span><span class="st">&quot;accuracy&quot;</span>, patience<span class="op">=</span><span class="dv">5</span>, verbose<span class="op">=</span><span class="dv">1</span>, factor<span class="op">=</span><span class="fl">0.5</span>, min_lr<span class="op">=</span><span class="fl">1e-7</span>)</span>
<span id="cb176-7"><a href="pipeline-workflow-steps.html#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="pipeline-workflow-steps.html#cb176-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If CrossVal is selected, train BasicNet as Cross-Validated Model</span></span>
<span id="cb176-9"><a href="pipeline-workflow-steps.html#cb176-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_class <span class="op">==</span> Model_Class.CrossVal.value:</span>
<span id="cb176-10"><a href="pipeline-workflow-steps.html#cb176-10" aria-hidden="true" tabindex="-1"></a>        kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">3</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb176-11"><a href="pipeline-workflow-steps.html#cb176-11" aria-hidden="true" tabindex="-1"></a>        cvscores <span class="op">=</span> []</span>
<span id="cb176-12"><a href="pipeline-workflow-steps.html#cb176-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train, test <span class="kw">in</span> kfold.split(X_train, y_train):</span>
<span id="cb176-13"><a href="pipeline-workflow-steps.html#cb176-13" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> get_model(Model_Class.Basic.value, model_params)</span>
<span id="cb176-14"><a href="pipeline-workflow-steps.html#cb176-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train Model</span></span>
<span id="cb176-15"><a href="pipeline-workflow-steps.html#cb176-15" aria-hidden="true" tabindex="-1"></a>            model.fit(</span>
<span id="cb176-16"><a href="pipeline-workflow-steps.html#cb176-16" aria-hidden="true" tabindex="-1"></a>                X_train[train],</span>
<span id="cb176-17"><a href="pipeline-workflow-steps.html#cb176-17" aria-hidden="true" tabindex="-1"></a>                y_train[train],</span>
<span id="cb176-18"><a href="pipeline-workflow-steps.html#cb176-18" aria-hidden="true" tabindex="-1"></a>                epochs<span class="op">=</span>model_params.get(<span class="st">&quot;epochs&quot;</span>),</span>
<span id="cb176-19"><a href="pipeline-workflow-steps.html#cb176-19" aria-hidden="true" tabindex="-1"></a>                batch_size<span class="op">=</span>model_params.get(<span class="st">&quot;batch_size&quot;</span>),</span>
<span id="cb176-20"><a href="pipeline-workflow-steps.html#cb176-20" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span>model_params.get(<span class="st">&quot;verbose&quot;</span>),</span>
<span id="cb176-21"><a href="pipeline-workflow-steps.html#cb176-21" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb176-22"><a href="pipeline-workflow-steps.html#cb176-22" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> model.evaluate(X_train[test], y_train[test], verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb176-23"><a href="pipeline-workflow-steps.html#cb176-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%.2f%%</span><span class="st">&quot;</span> <span class="op">%</span> (model.metrics_names[<span class="dv">1</span>], scores[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>))</span>
<span id="cb176-24"><a href="pipeline-workflow-steps.html#cb176-24" aria-hidden="true" tabindex="-1"></a>            cvscores.append(scores[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb176-25"><a href="pipeline-workflow-steps.html#cb176-25" aria-hidden="true" tabindex="-1"></a>            K.clear_session()</span>
<span id="cb176-26"><a href="pipeline-workflow-steps.html#cb176-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: not very safe, create if-else on other Enums</span></span>
<span id="cb176-27"><a href="pipeline-workflow-steps.html#cb176-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb176-28"><a href="pipeline-workflow-steps.html#cb176-28" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> get_model(model_class, model_params)</span>
<span id="cb176-29"><a href="pipeline-workflow-steps.html#cb176-29" aria-hidden="true" tabindex="-1"></a>        mlflow.keras.autolog()</span>
<span id="cb176-30"><a href="pipeline-workflow-steps.html#cb176-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train Model</span></span>
<span id="cb176-31"><a href="pipeline-workflow-steps.html#cb176-31" aria-hidden="true" tabindex="-1"></a>        model.fit(</span>
<span id="cb176-32"><a href="pipeline-workflow-steps.html#cb176-32" aria-hidden="true" tabindex="-1"></a>            X_train,</span>
<span id="cb176-33"><a href="pipeline-workflow-steps.html#cb176-33" aria-hidden="true" tabindex="-1"></a>            y_train,</span>
<span id="cb176-34"><a href="pipeline-workflow-steps.html#cb176-34" aria-hidden="true" tabindex="-1"></a>            validation_split<span class="op">=</span>model_params.get(<span class="st">&quot;validation_split&quot;</span>),</span>
<span id="cb176-35"><a href="pipeline-workflow-steps.html#cb176-35" aria-hidden="true" tabindex="-1"></a>            epochs<span class="op">=</span>model_params.get(<span class="st">&quot;epochs&quot;</span>),</span>
<span id="cb176-36"><a href="pipeline-workflow-steps.html#cb176-36" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>model_params.get(<span class="st">&quot;batch_size&quot;</span>),</span>
<span id="cb176-37"><a href="pipeline-workflow-steps.html#cb176-37" aria-hidden="true" tabindex="-1"></a>            verbose<span class="op">=</span>model_params.get(<span class="st">&quot;verbose&quot;</span>),</span>
<span id="cb176-38"><a href="pipeline-workflow-steps.html#cb176-38" aria-hidden="true" tabindex="-1"></a>            callbacks<span class="op">=</span>[learning_rate_reduction],</span>
<span id="cb176-39"><a href="pipeline-workflow-steps.html#cb176-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb176-40"><a href="pipeline-workflow-steps.html#cb176-40" aria-hidden="true" tabindex="-1"></a>        mlflow.keras.autolog(disable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb176-41"><a href="pipeline-workflow-steps.html#cb176-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-42"><a href="pipeline-workflow-steps.html#cb176-42" aria-hidden="true" tabindex="-1"></a>    run_id <span class="op">=</span> run.info.run_id</span>
<span id="cb176-43"><a href="pipeline-workflow-steps.html#cb176-43" aria-hidden="true" tabindex="-1"></a>    model_uri <span class="op">=</span> <span class="ss">f&quot;runs:/</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_class<span class="sc">}</span><span class="ss">&quot;</span></span></code></pre></div>
<p>After model training, the trained model is tested on a separate test dataset and log the prediction accuracy as a metric in MLflow. The model is then registered with MLflow and necessary metadata about the registered model are stored in the variable <code>mv</code>.</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb177-1"><a href="pipeline-workflow-steps.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Testing model on test data to evaluate</span></span>
<span id="cb177-2"><a href="pipeline-workflow-steps.html#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Testing model...&quot;</span>)</span>
<span id="cb177-3"><a href="pipeline-workflow-steps.html#cb177-3" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb177-4"><a href="pipeline-workflow-steps.html#cb177-4" aria-hidden="true" tabindex="-1"></a>prediction_accuracy <span class="op">=</span> accuracy_score(np.argmax(y_test, axis<span class="op">=</span><span class="dv">1</span>), np.argmax(y_pred, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb177-5"><a href="pipeline-workflow-steps.html#cb177-5" aria-hidden="true" tabindex="-1"></a>mlflow.log_metric(<span class="st">&quot;prediction_accuracy&quot;</span>, prediction_accuracy)</span>
<span id="cb177-6"><a href="pipeline-workflow-steps.html#cb177-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Prediction Accuracy: </span><span class="sc">{</span>prediction_accuracy<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb177-7"><a href="pipeline-workflow-steps.html#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Register model...&quot;</span>)</span>
<span id="cb177-8"><a href="pipeline-workflow-steps.html#cb177-8" aria-hidden="true" tabindex="-1"></a>mv <span class="op">=</span> mlflow.register_model(model_uri, model_class)</span></code></pre></div>
<p>Finally, the function returns a tuple containing the run ID and crucial information about the model, such as its name, version, and stage.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb178-1"><a href="pipeline-workflow-steps.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> run_id, mv.name, mv.version, mv.current_stage</span></code></pre></div>

</div>
<div id="model-comparison" class="section level3 hasAnchor" number="9.3.3">
<h3><span class="header-section-number">9.3.3</span> Model Comparison<a href="pipeline-workflow-steps.html#model-comparison" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>compare_models</code> function is responsible for model comparison within MLflow. It evaluates MLflow models by considering a specified metric and promotes the best-performing model to the <code>"Staging"</code> stage within the MLflow Registry. This function accepts two arguments: <code>input_dict</code>, which is a dictionary containing model names and run IDs, and an optional <code>metric</code> parameter (defaulting to <code>"prediction_accuracy"</code>) used for conducting the comparison.</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb179-1"><a href="pipeline-workflow-steps.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_models(input_dict: <span class="bu">dict</span>, metric: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;prediction_accuracy&quot;</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">int</span>]:</span>
<span id="cb179-2"><a href="pipeline-workflow-steps.html#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb179-3"><a href="pipeline-workflow-steps.html#cb179-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compares a given set of MLflow models based on their logged metric. The model with the best metric will be</span></span>
<span id="cb179-4"><a href="pipeline-workflow-steps.html#cb179-4" aria-hidden="true" tabindex="-1"></a><span class="co">    transferred to a &quot;Staging&quot; stage within the MLflow Registry.</span></span>
<span id="cb179-5"><a href="pipeline-workflow-steps.html#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="pipeline-workflow-steps.html#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb179-7"><a href="pipeline-workflow-steps.html#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="co">        input_dict (dict): A dictionary containing the names and run IDs of the MLflow models to compare.</span></span>
<span id="cb179-8"><a href="pipeline-workflow-steps.html#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="co">        metric (str, optional): The metric to compare the models. Defaults to &quot;prediction_accuracy&quot;.</span></span>
<span id="cb179-9"><a href="pipeline-workflow-steps.html#cb179-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-10"><a href="pipeline-workflow-steps.html#cb179-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb179-11"><a href="pipeline-workflow-steps.html#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[str, str, int]: A tuple containing the name of the best performing model, its MLflow URI,</span></span>
<span id="cb179-12"><a href="pipeline-workflow-steps.html#cb179-12" aria-hidden="true" tabindex="-1"></a><span class="co">                              and the version of the model.</span></span>
<span id="cb179-13"><a href="pipeline-workflow-steps.html#cb179-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-14"><a href="pipeline-workflow-steps.html#cb179-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb179-15"><a href="pipeline-workflow-steps.html#cb179-15" aria-hidden="true" tabindex="-1"></a><span class="co">        None</span></span>
<span id="cb179-16"><a href="pipeline-workflow-steps.html#cb179-16" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb179-17"><a href="pipeline-workflow-steps.html#cb179-17" aria-hidden="true" tabindex="-1"></a>    mlflow_tracking_uri <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb179-18"><a href="pipeline-workflow-steps.html#cb179-18" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(mlflow_tracking_uri)</span></code></pre></div>
<p>Once the MLflow tracking URI is configured to align with the “MLFLOW_TRACKING_URI” environment variable, an MLflow client is established. This client is integral to a process known as the Model Comparison Loop. In this loop, models listed in the <code>input_dict</code> dictionary are individually processed. The loop retrieves their respective metrics and aggregates this data within the <code>all_results</code> dictionary, facilitating direct model comparisons.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb180-1"><a href="pipeline-workflow-steps.html#cb180-1" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> mlflow.MlflowClient(tracking_uri<span class="op">=</span>mlflow_tracking_uri)</span>
<span id="cb180-2"><a href="pipeline-workflow-steps.html#cb180-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-3"><a href="pipeline-workflow-steps.html#cb180-3" aria-hidden="true" tabindex="-1"></a>    all_results <span class="op">=</span> {}</span>
<span id="cb180-4"><a href="pipeline-workflow-steps.html#cb180-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> input_dict.items():</span>
<span id="cb180-5"><a href="pipeline-workflow-steps.html#cb180-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract params/metrics data for run `test_run_id` in a single dict</span></span>
<span id="cb180-6"><a href="pipeline-workflow-steps.html#cb180-6" aria-hidden="true" tabindex="-1"></a>        model_results_data_dict <span class="op">=</span> client.get_run(value).data.to_dictionary()</span>
<span id="cb180-7"><a href="pipeline-workflow-steps.html#cb180-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get params and metrics for this run (test_run_id)</span></span>
<span id="cb180-8"><a href="pipeline-workflow-steps.html#cb180-8" aria-hidden="true" tabindex="-1"></a>        model_results_accuracy <span class="op">=</span> model_results_data_dict[<span class="st">&quot;metrics&quot;</span>][metric]</span>
<span id="cb180-9"><a href="pipeline-workflow-steps.html#cb180-9" aria-hidden="true" tabindex="-1"></a>        all_results[key] <span class="op">=</span> model_results_accuracy</span>
<span id="cb180-10"><a href="pipeline-workflow-steps.html#cb180-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-11"><a href="pipeline-workflow-steps.html#cb180-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get model with maximum accuracy</span></span>
<span id="cb180-12"><a href="pipeline-workflow-steps.html#cb180-12" aria-hidden="true" tabindex="-1"></a>    serving_model_name <span class="op">=</span> <span class="bu">max</span>(all_results, key<span class="op">=</span>all_results.get)</span>
<span id="cb180-13"><a href="pipeline-workflow-steps.html#cb180-13" aria-hidden="true" tabindex="-1"></a>    serving_model_version <span class="op">=</span> client.get_latest_versions(name<span class="op">=</span>serving_model_name, stages<span class="op">=</span>[<span class="st">&quot;None&quot;</span>])[<span class="dv">0</span>].version</span>
<span id="cb180-14"><a href="pipeline-workflow-steps.html#cb180-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;acc_dict: </span><span class="sc">{</span>all_results<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb180-15"><a href="pipeline-workflow-steps.html#cb180-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;acc_dict_model: </span><span class="sc">{</span>serving_model_name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb180-16"><a href="pipeline-workflow-steps.html#cb180-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;latest_model_version: </span><span class="sc">{</span>serving_model_version<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>Subsequently, the model with the highest accuracy, as determined from the gathered metrics, is singled out for special attention. This exceptional model is then moved to the <code>"Staging"</code> stage within the MLflow Registry, indicating its preparedness for subsequent evaluation and deployment. As a result, a tuple is returned, containing the name of the top-performing model, its corresponding MLflow URI, and the model’s version information.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb181-1"><a href="pipeline-workflow-steps.html#cb181-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transition model to stage &quot;Staging&quot;</span></span>
<span id="cb181-2"><a href="pipeline-workflow-steps.html#cb181-2" aria-hidden="true" tabindex="-1"></a>    model_stage <span class="op">=</span> <span class="st">&quot;Staging&quot;</span></span>
<span id="cb181-3"><a href="pipeline-workflow-steps.html#cb181-3" aria-hidden="true" tabindex="-1"></a>    client.transition_model_version_stage(name<span class="op">=</span>serving_model_name, version<span class="op">=</span>serving_model_version, stage<span class="op">=</span>model_stage)</span>
<span id="cb181-4"><a href="pipeline-workflow-steps.html#cb181-4" aria-hidden="true" tabindex="-1"></a>    serving_model_uri <span class="op">=</span> <span class="ss">f&quot;models:/</span><span class="sc">{</span>serving_model_name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_stage<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb181-5"><a href="pipeline-workflow-steps.html#cb181-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-6"><a href="pipeline-workflow-steps.html#cb181-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> serving_model_name, serving_model_uri, serving_model_version</span></code></pre></div>

</div>
<div id="model-deployment-serving" class="section level3 hasAnchor" number="9.3.4">
<h3><span class="header-section-number">9.3.4</span> Model Deployment &amp; Serving<a href="pipeline-workflow-steps.html#model-deployment-serving" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This code serves a specific purpose: to simplify the deployment of MLflow models to AWS SageMaker. It achieves this by meticulously configuring and overseeing the deployment process through a combination of environment variables and utility functions. By making use of MLflow’s SageMaker integration, this code automates the deployment of a pre-trained TensorFlow model from the MLflow registry to a SageMaker instance.</p>
<p>The primary responsibility for deploying an MLflow model to an AWS SageMaker endpoint lies with the <code>deploy_model_to_sagemaker</code> function. To kickstart the deployment process, various AWS and MLflow-related environment variables, essential for the deployment, are initially fetched.</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb182-1"><a href="pipeline-workflow-steps.html#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deploy_model_to_sagemaker(</span>
<span id="cb182-2"><a href="pipeline-workflow-steps.html#cb182-2" aria-hidden="true" tabindex="-1"></a>    mlflow_model_name: <span class="bu">str</span>,</span>
<span id="cb182-3"><a href="pipeline-workflow-steps.html#cb182-3" aria-hidden="true" tabindex="-1"></a>    mlflow_model_uri: <span class="bu">str</span>,</span>
<span id="cb182-4"><a href="pipeline-workflow-steps.html#cb182-4" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_name: <span class="bu">str</span>,</span>
<span id="cb182-5"><a href="pipeline-workflow-steps.html#cb182-5" aria-hidden="true" tabindex="-1"></a>    mlflow_model_version: <span class="bu">int</span>,</span>
<span id="cb182-6"><a href="pipeline-workflow-steps.html#cb182-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_endpoint_name: <span class="bu">str</span>,</span>
<span id="cb182-7"><a href="pipeline-workflow-steps.html#cb182-7" aria-hidden="true" tabindex="-1"></a>    sagemaker_instance_type: <span class="bu">str</span>,</span>
<span id="cb182-8"><a href="pipeline-workflow-steps.html#cb182-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb182-9"><a href="pipeline-workflow-steps.html#cb182-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb182-10"><a href="pipeline-workflow-steps.html#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Deploy a machine learning model to AWS SageMaker from MLflow.</span></span>
<span id="cb182-11"><a href="pipeline-workflow-steps.html#cb182-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-12"><a href="pipeline-workflow-steps.html#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="co">    This function deploys an MLflow model to an AWS SageMaker endpoint using the specified configuration.</span></span>
<span id="cb182-13"><a href="pipeline-workflow-steps.html#cb182-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-14"><a href="pipeline-workflow-steps.html#cb182-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb182-15"><a href="pipeline-workflow-steps.html#cb182-15" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_model_name (str): The name of the MLflow model to deploy.</span></span>
<span id="cb182-16"><a href="pipeline-workflow-steps.html#cb182-16" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_model_uri (str): The URI of the MLflow model from the registry.</span></span>
<span id="cb182-17"><a href="pipeline-workflow-steps.html#cb182-17" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_experiment_name (str): The name of the MLflow experiment containing the model.</span></span>
<span id="cb182-18"><a href="pipeline-workflow-steps.html#cb182-18" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_model_version (int): The version of the MLflow model to deploy.</span></span>
<span id="cb182-19"><a href="pipeline-workflow-steps.html#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="co">        sagemaker_endpoint_name (str): The desired name for the SageMaker endpoint.</span></span>
<span id="cb182-20"><a href="pipeline-workflow-steps.html#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="co">        sagemaker_instance_type (str): The SageMaker instance type for deployment.</span></span>
<span id="cb182-21"><a href="pipeline-workflow-steps.html#cb182-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-22"><a href="pipeline-workflow-steps.html#cb182-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb182-23"><a href="pipeline-workflow-steps.html#cb182-23" aria-hidden="true" tabindex="-1"></a><span class="co">        bool: True if the task was completed successfully, otherwise False.</span></span>
<span id="cb182-24"><a href="pipeline-workflow-steps.html#cb182-24" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb182-25"><a href="pipeline-workflow-steps.html#cb182-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve AWS and MLflow environment variables</span></span>
<span id="cb182-26"><a href="pipeline-workflow-steps.html#cb182-26" aria-hidden="true" tabindex="-1"></a>    AWS_ID <span class="op">=</span> os.getenv(<span class="st">&quot;AWS_ID&quot;</span>)</span>
<span id="cb182-27"><a href="pipeline-workflow-steps.html#cb182-27" aria-hidden="true" tabindex="-1"></a>    AWS_REGION <span class="op">=</span> os.getenv(<span class="st">&quot;AWS_REGION&quot;</span>)</span>
<span id="cb182-28"><a href="pipeline-workflow-steps.html#cb182-28" aria-hidden="true" tabindex="-1"></a>    AWS_ACCESS_ROLE_NAME_SAGEMAKER <span class="op">=</span> os.getenv(<span class="st">&quot;AWS_ROLE_NAME_SAGEMAKER&quot;</span>)</span>
<span id="cb182-29"><a href="pipeline-workflow-steps.html#cb182-29" aria-hidden="true" tabindex="-1"></a>    ECR_REPOSITORY_NAME <span class="op">=</span> os.getenv(<span class="st">&quot;ECR_REPOSITORY_NAME&quot;</span>)</span>
<span id="cb182-30"><a href="pipeline-workflow-steps.html#cb182-30" aria-hidden="true" tabindex="-1"></a>    ECR_SAGEMAKER_IMAGE_TAG <span class="op">=</span> os.getenv(<span class="st">&quot;ECR_SAGEMAKER_IMAGE_TAG&quot;</span>)</span>
<span id="cb182-31"><a href="pipeline-workflow-steps.html#cb182-31" aria-hidden="true" tabindex="-1"></a>    MLFLOW_TRACKING_URI <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb182-32"><a href="pipeline-workflow-steps.html#cb182-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-33"><a href="pipeline-workflow-steps.html#cb182-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the MLflow tracking URI</span></span>
<span id="cb182-34"><a href="pipeline-workflow-steps.html#cb182-34" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)</span></code></pre></div>
<p>Within this main deployment function, there are three utility functions that have been defined:</p>
<ul>
<li><code>_build_image_url</code>: This function constructs the ECR image URL required for SageMaker.</li>
<li><code>_build_execution_role_arn</code>: It is responsible for generating the SageMaker execution role ARN.</li>
<li><code>_get_mlflow_parameters</code>: This utility function retrieves crucial MLflow model parameters, including the model URI and source code.</li>
</ul>
<div class="sourceCode" id="cb183"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb183-1"><a href="pipeline-workflow-steps.html#cb183-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _build_image_url(</span>
<span id="cb183-2"><a href="pipeline-workflow-steps.html#cb183-2" aria-hidden="true" tabindex="-1"></a>        aws_id: <span class="bu">str</span>,</span>
<span id="cb183-3"><a href="pipeline-workflow-steps.html#cb183-3" aria-hidden="true" tabindex="-1"></a>        aws_region: <span class="bu">str</span>,</span>
<span id="cb183-4"><a href="pipeline-workflow-steps.html#cb183-4" aria-hidden="true" tabindex="-1"></a>        ecr_repository_name: <span class="bu">str</span>,</span>
<span id="cb183-5"><a href="pipeline-workflow-steps.html#cb183-5" aria-hidden="true" tabindex="-1"></a>        ecr_sagemaker_image_tag: <span class="bu">str</span>,</span>
<span id="cb183-6"><a href="pipeline-workflow-steps.html#cb183-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb183-7"><a href="pipeline-workflow-steps.html#cb183-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb183-8"><a href="pipeline-workflow-steps.html#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Build the ECR image URL for SageMaker.</span></span>
<span id="cb183-9"><a href="pipeline-workflow-steps.html#cb183-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-10"><a href="pipeline-workflow-steps.html#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb183-11"><a href="pipeline-workflow-steps.html#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="co">            aws_id (str): AWS account ID.</span></span>
<span id="cb183-12"><a href="pipeline-workflow-steps.html#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="co">            aws_region (str): AWS region.</span></span>
<span id="cb183-13"><a href="pipeline-workflow-steps.html#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="co">            ecr_repository_name (str): Name of the ECR repository.</span></span>
<span id="cb183-14"><a href="pipeline-workflow-steps.html#cb183-14" aria-hidden="true" tabindex="-1"></a><span class="co">            ecr_sagemaker_image_tag (str): Tag for the ECR image.</span></span>
<span id="cb183-15"><a href="pipeline-workflow-steps.html#cb183-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-16"><a href="pipeline-workflow-steps.html#cb183-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb183-17"><a href="pipeline-workflow-steps.html#cb183-17" aria-hidden="true" tabindex="-1"></a><span class="co">            str: The ECR image URL for SageMaker.</span></span>
<span id="cb183-18"><a href="pipeline-workflow-steps.html#cb183-18" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb183-19"><a href="pipeline-workflow-steps.html#cb183-19" aria-hidden="true" tabindex="-1"></a>        image_url <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>aws_id<span class="sc">}</span><span class="ss">.dkr.ecr.</span><span class="sc">{</span>aws_region<span class="sc">}</span><span class="ss">.amazonaws.com/</span><span class="sc">{</span>ecr_repository_name<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>ecr_sagemaker_image_tag<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb183-20"><a href="pipeline-workflow-steps.html#cb183-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image_url</span>
<span id="cb183-21"><a href="pipeline-workflow-steps.html#cb183-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-22"><a href="pipeline-workflow-steps.html#cb183-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _build_execution_role_arn(aws_id: <span class="bu">str</span>, access_role_name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb183-23"><a href="pipeline-workflow-steps.html#cb183-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb183-24"><a href="pipeline-workflow-steps.html#cb183-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Build the SageMaker execution role ARN.</span></span>
<span id="cb183-25"><a href="pipeline-workflow-steps.html#cb183-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-26"><a href="pipeline-workflow-steps.html#cb183-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb183-27"><a href="pipeline-workflow-steps.html#cb183-27" aria-hidden="true" tabindex="-1"></a><span class="co">            aws_id (str): AWS account ID.</span></span>
<span id="cb183-28"><a href="pipeline-workflow-steps.html#cb183-28" aria-hidden="true" tabindex="-1"></a><span class="co">            access_role_name (str): SageMaker execution role name.</span></span>
<span id="cb183-29"><a href="pipeline-workflow-steps.html#cb183-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-30"><a href="pipeline-workflow-steps.html#cb183-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb183-31"><a href="pipeline-workflow-steps.html#cb183-31" aria-hidden="true" tabindex="-1"></a><span class="co">            str: The SageMaker execution role ARN.</span></span>
<span id="cb183-32"><a href="pipeline-workflow-steps.html#cb183-32" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb183-33"><a href="pipeline-workflow-steps.html#cb183-33" aria-hidden="true" tabindex="-1"></a>        execution_role_arn <span class="op">=</span> <span class="ss">f&quot;arn:aws:iam::</span><span class="sc">{</span>aws_id<span class="sc">}</span><span class="ss">:role/</span><span class="sc">{</span>access_role_name<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb183-34"><a href="pipeline-workflow-steps.html#cb183-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> execution_role_arn</span>
<span id="cb183-35"><a href="pipeline-workflow-steps.html#cb183-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-36"><a href="pipeline-workflow-steps.html#cb183-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_mlflow_parameters(experiment_name: <span class="bu">str</span>, model_name: <span class="bu">str</span>, model_version: <span class="bu">int</span>) <span class="op">-&gt;</span> (<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>):</span>
<span id="cb183-37"><a href="pipeline-workflow-steps.html#cb183-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb183-38"><a href="pipeline-workflow-steps.html#cb183-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve MLflow model parameters.</span></span>
<span id="cb183-39"><a href="pipeline-workflow-steps.html#cb183-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-40"><a href="pipeline-workflow-steps.html#cb183-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb183-41"><a href="pipeline-workflow-steps.html#cb183-41" aria-hidden="true" tabindex="-1"></a><span class="co">            experiment_name (str): Name of the MLflow experiment.</span></span>
<span id="cb183-42"><a href="pipeline-workflow-steps.html#cb183-42" aria-hidden="true" tabindex="-1"></a><span class="co">            model_name (str): Name of the MLflow model.</span></span>
<span id="cb183-43"><a href="pipeline-workflow-steps.html#cb183-43" aria-hidden="true" tabindex="-1"></a><span class="co">            model_version (int): Version of the MLflow model.</span></span>
<span id="cb183-44"><a href="pipeline-workflow-steps.html#cb183-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-45"><a href="pipeline-workflow-steps.html#cb183-45" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb183-46"><a href="pipeline-workflow-steps.html#cb183-46" aria-hidden="true" tabindex="-1"></a><span class="co">            Tuple[str, str]: The model URI and source.</span></span>
<span id="cb183-47"><a href="pipeline-workflow-steps.html#cb183-47" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb183-48"><a href="pipeline-workflow-steps.html#cb183-48" aria-hidden="true" tabindex="-1"></a>        client <span class="op">=</span> mlflow.MlflowClient()</span>
<span id="cb183-49"><a href="pipeline-workflow-steps.html#cb183-49" aria-hidden="true" tabindex="-1"></a>        model_version_details <span class="op">=</span> client.get_model_version(</span>
<span id="cb183-50"><a href="pipeline-workflow-steps.html#cb183-50" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>model_name,</span>
<span id="cb183-51"><a href="pipeline-workflow-steps.html#cb183-51" aria-hidden="true" tabindex="-1"></a>            version<span class="op">=</span>model_version,</span>
<span id="cb183-52"><a href="pipeline-workflow-steps.html#cb183-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb183-53"><a href="pipeline-workflow-steps.html#cb183-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-54"><a href="pipeline-workflow-steps.html#cb183-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This is for local</span></span>
<span id="cb183-55"><a href="pipeline-workflow-steps.html#cb183-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># experiment_id = dict(mlflow.get_experiment_by_name(experiment_name))[&quot;experiment_id&quot;]</span></span>
<span id="cb183-56"><a href="pipeline-workflow-steps.html#cb183-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># run_id = model_version_details.run_id</span></span>
<span id="cb183-57"><a href="pipeline-workflow-steps.html#cb183-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># model_uri = f&quot;mlruns/{experiment_id}/{run_id}/artifacts/{model_name}&quot;</span></span>
<span id="cb183-58"><a href="pipeline-workflow-steps.html#cb183-58" aria-hidden="true" tabindex="-1"></a>        model_source <span class="op">=</span> model_version_details.source</span>
<span id="cb183-59"><a href="pipeline-workflow-steps.html#cb183-59" aria-hidden="true" tabindex="-1"></a>        model_source_adapted <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>model_source<span class="sc">.</span>removesuffix(model_name)<span class="sc">}</span><span class="ss">model&quot;</span></span>
<span id="cb183-60"><a href="pipeline-workflow-steps.html#cb183-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-61"><a href="pipeline-workflow-steps.html#cb183-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> model_source, model_source_adapted</span></code></pre></div>
<p>Following their definition, these utility functions are invoked sequentially. Initially, the ECR image URL for SageMaker and the SageMaker execution role ARN are constructed using <code>_build_image_url</code> and <code>_build_execution_role_arn</code>. Subsequently, <code>_get_mlflow_parameters</code> is called to retrieve pertinent MLflow model parameters, encompassing the model source and any adaptations made to the source code.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb184-1"><a href="pipeline-workflow-steps.html#cb184-1" aria-hidden="true" tabindex="-1"></a>    image_url <span class="op">=</span> _build_image_url(</span>
<span id="cb184-2"><a href="pipeline-workflow-steps.html#cb184-2" aria-hidden="true" tabindex="-1"></a>        aws_id<span class="op">=</span>AWS_ID,</span>
<span id="cb184-3"><a href="pipeline-workflow-steps.html#cb184-3" aria-hidden="true" tabindex="-1"></a>        aws_region<span class="op">=</span>AWS_REGION,</span>
<span id="cb184-4"><a href="pipeline-workflow-steps.html#cb184-4" aria-hidden="true" tabindex="-1"></a>        ecr_repository_name<span class="op">=</span>ECR_REPOSITORY_NAME,</span>
<span id="cb184-5"><a href="pipeline-workflow-steps.html#cb184-5" aria-hidden="true" tabindex="-1"></a>        ecr_sagemaker_image_tag<span class="op">=</span>ECR_SAGEMAKER_IMAGE_TAG,</span>
<span id="cb184-6"><a href="pipeline-workflow-steps.html#cb184-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb184-7"><a href="pipeline-workflow-steps.html#cb184-7" aria-hidden="true" tabindex="-1"></a>    execution_role_arn <span class="op">=</span> _build_execution_role_arn(aws_id<span class="op">=</span>AWS_ID, access_role_name<span class="op">=</span>AWS_ACCESS_ROLE_NAME_SAGEMAKER)</span>
<span id="cb184-8"><a href="pipeline-workflow-steps.html#cb184-8" aria-hidden="true" tabindex="-1"></a>    model_source, model_source_adapted <span class="op">=</span> _get_mlflow_parameters(</span>
<span id="cb184-9"><a href="pipeline-workflow-steps.html#cb184-9" aria-hidden="true" tabindex="-1"></a>        experiment_name<span class="op">=</span>mlflow_experiment_name,</span>
<span id="cb184-10"><a href="pipeline-workflow-steps.html#cb184-10" aria-hidden="true" tabindex="-1"></a>        model_name<span class="op">=</span>mlflow_model_name,</span>
<span id="cb184-11"><a href="pipeline-workflow-steps.html#cb184-11" aria-hidden="true" tabindex="-1"></a>        model_version<span class="op">=</span>mlflow_model_version,</span>
<span id="cb184-12"><a href="pipeline-workflow-steps.html#cb184-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb184-13"><a href="pipeline-workflow-steps.html#cb184-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-14"><a href="pipeline-workflow-steps.html#cb184-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;model_source: </span><span class="sc">{</span>model_source<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb184-15"><a href="pipeline-workflow-steps.html#cb184-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;mlflow_model_uri: </span><span class="sc">{</span>mlflow_model_uri<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb184-16"><a href="pipeline-workflow-steps.html#cb184-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;model_source_adapted: </span><span class="sc">{</span>model_source_adapted<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>Each of these preceding steps is considered a prerequisite to the actual deployment of the model to SageMaker.</p>
<p>The MLflow model deployment to an AWS SageMaker endpoint is executed via MLflow’s SageMaker integration. This is accomplished by invoking <code>mlflow.sagemaker._deploy</code> with all the previously accumulated information. Given that the setup of the SageMaker instance and environment can be time-consuming, a suitable timeout is established. Ultimately, the function returns <code>True</code> upon successful completion of the deployment task; otherwise, it returns <code>False</code>.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb185-1"><a href="pipeline-workflow-steps.html#cb185-1" aria-hidden="true" tabindex="-1"></a>    mlflow.sagemaker._deploy(</span>
<span id="cb185-2"><a href="pipeline-workflow-steps.html#cb185-2" aria-hidden="true" tabindex="-1"></a>        mode<span class="op">=</span><span class="st">&quot;create&quot;</span>,</span>
<span id="cb185-3"><a href="pipeline-workflow-steps.html#cb185-3" aria-hidden="true" tabindex="-1"></a>        app_name<span class="op">=</span>sagemaker_endpoint_name,</span>
<span id="cb185-4"><a href="pipeline-workflow-steps.html#cb185-4" aria-hidden="true" tabindex="-1"></a>        model_uri<span class="op">=</span>model_source_adapted,</span>
<span id="cb185-5"><a href="pipeline-workflow-steps.html#cb185-5" aria-hidden="true" tabindex="-1"></a>        image_url<span class="op">=</span>image_url,</span>
<span id="cb185-6"><a href="pipeline-workflow-steps.html#cb185-6" aria-hidden="true" tabindex="-1"></a>        execution_role_arn<span class="op">=</span>execution_role_arn,</span>
<span id="cb185-7"><a href="pipeline-workflow-steps.html#cb185-7" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span>sagemaker_instance_type,</span>
<span id="cb185-8"><a href="pipeline-workflow-steps.html#cb185-8" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb185-9"><a href="pipeline-workflow-steps.html#cb185-9" aria-hidden="true" tabindex="-1"></a>        region_name<span class="op">=</span>AWS_REGION,</span>
<span id="cb185-10"><a href="pipeline-workflow-steps.html#cb185-10" aria-hidden="true" tabindex="-1"></a>        timeout_seconds<span class="op">=</span><span class="dv">2400</span>,</span>
<span id="cb185-11"><a href="pipeline-workflow-steps.html#cb185-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb185-12"><a href="pipeline-workflow-steps.html#cb185-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-13"><a href="pipeline-workflow-steps.html#cb185-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="training-deployment-pipeline-workflow.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="model-inferencing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/09.3-Deployment-Usage_Training-Model-Pipeline.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
