<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8.3 Building the Pipeline Steps | MLOps Engineering</title>
  <meta name="description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="8.3 Building the Pipeline Steps | MLOps Engineering" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="github-repo" content="seblum/mlops-engineering-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8.3 Building the Pipeline Steps | MLOps Engineering" />
  
  <meta name="twitter:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  

<meta name="author" content="Sebastian Blum" />


<meta name="date" content="2023-06-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="pipeline-workflow.html"/>
<link rel="next" href="model-serving-inferencing.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MLOps Engineering</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="preamble.html"><a href="preamble.html"><i class="fa fa-check"></i>Preamble</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html"><i class="fa fa-check"></i><b>1.1</b> Machine Learning Workflow</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#ml-worflow-tools"><i class="fa fa-check"></i><b>1.1.1</b> ML Worflow Tools</a></li>
<li class="chapter" data-level="1.1.2" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#developing-machine-learning-models"><i class="fa fa-check"></i><b>1.1.2</b> Developing Machine Learning Models</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html"><i class="fa fa-check"></i><b>1.2</b> Machine Learning Operations (MLOps)</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#ml-dev-ops"><i class="fa fa-check"></i><b>1.2.1</b> ML + (Dev)-Ops</a></li>
<li class="chapter" data-level="1.2.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-lifecycle"><i class="fa fa-check"></i><b>1.2.2</b> MLOps Lifecycle</a></li>
<li class="chapter" data-level="1.2.3" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-engineering"><i class="fa fa-check"></i><b>1.2.3</b> MLOps Engineering</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html"><i class="fa fa-check"></i><b>1.3</b> Roles and Tasks in MLOps</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-engineer"><i class="fa fa-check"></i><b>1.3.1</b> Data Engineer</a></li>
<li class="chapter" data-level="1.3.2" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-scientist"><i class="fa fa-check"></i><b>1.3.2</b> Data Scientist</a></li>
<li class="chapter" data-level="1.3.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#ml-engineer"><i class="fa fa-check"></i><b>1.3.3</b> ML Engineer</a></li>
<li class="chapter" data-level="1.3.4" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#mlops-engineer"><i class="fa fa-check"></i><b>1.3.4</b> MLOps Engineer</a></li>
<li class="chapter" data-level="1.3.5" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#devops-engineer"><i class="fa fa-check"></i><b>1.3.5</b> DevOps Engineer</a></li>
<li class="chapter" data-level="1.3.6" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#additional-roles-function"><i class="fa fa-check"></i><b>1.3.6</b> Additional roles &amp; function</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html"><i class="fa fa-check"></i><b>1.4</b> Ops Tools &amp; Principles</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html#containerization"><i class="fa fa-check"></i><b>1.4.1</b> Containerization</a></li>
<li class="chapter" data-level="1.4.2" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html#version-control"><i class="fa fa-check"></i><b>1.4.2</b> Version Control</a></li>
<li class="chapter" data-level="1.4.3" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html#cicd"><i class="fa fa-check"></i><b>1.4.3</b> CI/CD</a></li>
<li class="chapter" data-level="1.4.4" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html#infrastructure-as-code"><i class="fa fa-check"></i><b>1.4.4</b> Infrastructure as code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="mlops-engineering-with-airflow-and-mlflow-on-kubernetes.html"><a href="mlops-engineering-with-airflow-and-mlflow-on-kubernetes.html"><i class="fa fa-check"></i><b>2</b> MLOps Engineering with Airflow and MLflow on Kubernetes</a></li>
<li class="chapter" data-level="3" data-path="airflow.html"><a href="airflow.html"><i class="fa fa-check"></i><b>3</b> Airflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="core-components.html"><a href="core-components.html"><i class="fa fa-check"></i><b>3.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="core-components.html"><a href="core-components.html#dags"><i class="fa fa-check"></i><b>3.1.1</b> DAGs</a></li>
<li class="chapter" data-level="3.1.2" data-path="core-components.html"><a href="core-components.html#operators"><i class="fa fa-check"></i><b>3.1.2</b> Operators</a></li>
<li class="chapter" data-level="3.1.3" data-path="core-components.html"><a href="core-components.html#tasks"><i class="fa fa-check"></i><b>3.1.3</b> Tasks</a></li>
<li class="chapter" data-level="3.1.4" data-path="core-components.html"><a href="core-components.html#xcom"><i class="fa fa-check"></i><b>3.1.4</b> XCom</a></li>
<li class="chapter" data-level="3.1.5" data-path="core-components.html"><a href="core-components.html#scheduling"><i class="fa fa-check"></i><b>3.1.5</b> Scheduling</a></li>
<li class="chapter" data-level="3.1.6" data-path="core-components.html"><a href="core-components.html#taskflow"><i class="fa fa-check"></i><b>3.1.6</b> Taskflow</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="exemplary-ml-workflow.html"><a href="exemplary-ml-workflow.html"><i class="fa fa-check"></i><b>3.2</b> Exemplary ML workflow</a></li>
<li class="chapter" data-level="3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html"><i class="fa fa-check"></i><b>3.3</b> Airflow infrastructure</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#airflow-as-a-distributed-system"><i class="fa fa-check"></i><b>3.3.1</b> Airflow as a distributed system</a></li>
<li class="chapter" data-level="3.3.2" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#scheduler"><i class="fa fa-check"></i><b>3.3.2</b> Scheduler</a></li>
<li class="chapter" data-level="3.3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#webserver"><i class="fa fa-check"></i><b>3.3.3</b> Webserver</a></li>
<li class="chapter" data-level="3.3.4" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#executor"><i class="fa fa-check"></i><b>3.3.4</b> Executor</a></li>
<li class="chapter" data-level="3.3.5" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#dag-directory"><i class="fa fa-check"></i><b>3.3.5</b> DAG Directory</a></li>
<li class="chapter" data-level="3.3.6" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#metadata-database"><i class="fa fa-check"></i><b>3.3.6</b> Metadata Database</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mlflow.html"><a href="mlflow.html"><i class="fa fa-check"></i><b>4</b> MLflow</a>
<ul>
<li class="chapter" data-level="4.1" data-path="core-components-1.html"><a href="core-components-1.html"><i class="fa fa-check"></i><b>4.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-tracking"><i class="fa fa-check"></i><b>4.1.1</b> MLflow Tracking</a></li>
<li class="chapter" data-level="4.1.2" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-models"><i class="fa fa-check"></i><b>4.1.2</b> MLflow Models</a></li>
<li class="chapter" data-level="4.1.3" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-model-registry"><i class="fa fa-check"></i><b>4.1.3</b> MLflow Model Registry</a></li>
<li class="chapter" data-level="4.1.4" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-projects"><i class="fa fa-check"></i><b>4.1.4</b> MLflow Projects</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html"><i class="fa fa-check"></i><b>4.2</b> MLFflow Architecture</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-tracking-server"><i class="fa fa-check"></i><b>4.2.1</b> MLflow Tracking Server</a></li>
<li class="chapter" data-level="4.2.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-backend-store"><i class="fa fa-check"></i><b>4.2.2</b> MLflow Backend Store</a></li>
<li class="chapter" data-level="4.2.3" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-artifact-store"><i class="fa fa-check"></i><b>4.2.3</b> MLflow Artifact Store</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>5</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="5.1" data-path="core-components-2.html"><a href="core-components-2.html"><i class="fa fa-check"></i><b>5.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="core-components-2.html"><a href="core-components-2.html#nodes"><i class="fa fa-check"></i><b>5.1.1</b> Nodes</a></li>
<li class="chapter" data-level="5.1.2" data-path="core-components-2.html"><a href="core-components-2.html#pods"><i class="fa fa-check"></i><b>5.1.2</b> Pods</a></li>
<li class="chapter" data-level="5.1.3" data-path="core-components-2.html"><a href="core-components-2.html#imperative-declarative-management"><i class="fa fa-check"></i><b>5.1.3</b> Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html"><i class="fa fa-check"></i><b>5.2</b> Application Deployment &amp; Design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="application-deployment-design.html"><a href="application-deployment-design.html#deployments"><i class="fa fa-check"></i><b>5.2.1</b> Deployments</a></li>
<li class="chapter" data-level="5.2.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html#resource-management"><i class="fa fa-check"></i><b>5.2.2</b> Resource Management</a></li>
<li class="chapter" data-level="5.2.3" data-path="application-deployment-design.html"><a href="application-deployment-design.html#daemonsets"><i class="fa fa-check"></i><b>5.2.3</b> DaemonSets</a></li>
<li class="chapter" data-level="5.2.4" data-path="application-deployment-design.html"><a href="application-deployment-design.html#statefulsets"><i class="fa fa-check"></i><b>5.2.4</b> StatefulSets</a></li>
<li class="chapter" data-level="5.2.5" data-path="application-deployment-design.html"><a href="application-deployment-design.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>5.2.5</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="services-networking.html"><a href="services-networking.html"><i class="fa fa-check"></i><b>5.3</b> Services &amp; Networking</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="services-networking.html"><a href="services-networking.html#services"><i class="fa fa-check"></i><b>5.3.1</b> Services</a></li>
<li class="chapter" data-level="5.3.2" data-path="services-networking.html"><a href="services-networking.html#service-discovery"><i class="fa fa-check"></i><b>5.3.2</b> Service Discovery</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="volume-storage.html"><a href="volume-storage.html"><i class="fa fa-check"></i><b>5.4</b> Volume &amp; Storage</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="volume-storage.html"><a href="volume-storage.html#emptydir-volume"><i class="fa fa-check"></i><b>5.4.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="5.4.2" data-path="volume-storage.html"><a href="volume-storage.html#hostpath-volume"><i class="fa fa-check"></i><b>5.4.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="5.4.3" data-path="volume-storage.html"><a href="volume-storage.html#persistent-volumes"><i class="fa fa-check"></i><b>5.4.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html"><i class="fa fa-check"></i><b>5.5</b> Environment, Configuration &amp; Security</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#namespaces"><i class="fa fa-check"></i><b>5.5.1</b> Namespaces</a></li>
<li class="chapter" data-level="5.5.2" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>5.5.2</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="5.5.3" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#configmaps"><i class="fa fa-check"></i><b>5.5.3</b> ConfigMaps</a></li>
<li class="chapter" data-level="5.5.4" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#secrets"><i class="fa fa-check"></i><b>5.5.4</b> Secrets</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="observability-maintenance.html"><a href="observability-maintenance.html"><i class="fa fa-check"></i><b>5.6</b> Observability &amp; Maintenance</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="observability-maintenance.html"><a href="observability-maintenance.html#health-checks"><i class="fa fa-check"></i><b>5.6.1</b> Health Checks</a></li>
<li class="chapter" data-level="5.6.2" data-path="observability-maintenance.html"><a href="observability-maintenance.html#debugging"><i class="fa fa-check"></i><b>5.6.2</b> Debugging</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="helm.html"><a href="helm.html"><i class="fa fa-check"></i><b>5.7</b> Helm</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="helm.html"><a href="helm.html#helm-chart-structure"><i class="fa fa-check"></i><b>5.7.1</b> Helm Chart Structure</a></li>
<li class="chapter" data-level="5.7.2" data-path="helm.html"><a href="helm.html#working-with-helm"><i class="fa fa-check"></i><b>5.7.2</b> Working with Helm</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>6</b> Terraform</a>
<ul>
<li class="chapter" data-level="6.1" data-path="basic-usage.html"><a href="basic-usage.html"><i class="fa fa-check"></i><b>6.1</b> Basic usage</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="basic-usage.html"><a href="basic-usage.html#terraform-init"><i class="fa fa-check"></i><b>6.1.1</b> terraform init</a></li>
<li class="chapter" data-level="6.1.2" data-path="basic-usage.html"><a href="basic-usage.html#terraform-validate"><i class="fa fa-check"></i><b>6.1.2</b> terraform validate</a></li>
<li class="chapter" data-level="6.1.3" data-path="basic-usage.html"><a href="basic-usage.html#terraform-plan"><i class="fa fa-check"></i><b>6.1.3</b> terraform plan</a></li>
<li class="chapter" data-level="6.1.4" data-path="basic-usage.html"><a href="basic-usage.html#terraform-apply"><i class="fa fa-check"></i><b>6.1.4</b> terraform apply</a></li>
<li class="chapter" data-level="6.1.5" data-path="basic-usage.html"><a href="basic-usage.html#terraform-destroy"><i class="fa fa-check"></i><b>6.1.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="core-components-3.html"><a href="core-components-3.html"><i class="fa fa-check"></i><b>6.2</b> Core Components</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="core-components-3.html"><a href="core-components-3.html#providers"><i class="fa fa-check"></i><b>6.2.1</b> Providers</a></li>
<li class="chapter" data-level="6.2.2" data-path="core-components-3.html"><a href="core-components-3.html#resources"><i class="fa fa-check"></i><b>6.2.2</b> Resources</a></li>
<li class="chapter" data-level="6.2.3" data-path="core-components-3.html"><a href="core-components-3.html#data-sources"><i class="fa fa-check"></i><b>6.2.3</b> Data Sources</a></li>
<li class="chapter" data-level="6.2.4" data-path="core-components-3.html"><a href="core-components-3.html#state"><i class="fa fa-check"></i><b>6.2.4</b> State</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="modules.html"><a href="modules.html"><i class="fa fa-check"></i><b>6.3</b> Modules</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="modules.html"><a href="modules.html#input-variables"><i class="fa fa-check"></i><b>6.3.1</b> Input Variables</a></li>
<li class="chapter" data-level="6.3.2" data-path="modules.html"><a href="modules.html#output-variables"><i class="fa fa-check"></i><b>6.3.2</b> Output Variables</a></li>
<li class="chapter" data-level="6.3.3" data-path="modules.html"><a href="modules.html#local-variables"><i class="fa fa-check"></i><b>6.3.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html"><i class="fa fa-check"></i><b>6.4</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#count"><i class="fa fa-check"></i><b>6.4.1</b> count</a></li>
<li class="chapter" data-level="6.4.2" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for-each"><i class="fa fa-check"></i><b>6.4.2</b> for-each</a></li>
<li class="chapter" data-level="6.4.3" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for"><i class="fa fa-check"></i><b>6.4.3</b> for</a></li>
<li class="chapter" data-level="6.4.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#workspaces"><i class="fa fa-check"></i><b>6.4.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html"><i class="fa fa-check"></i><b>6.5</b> Exemplary Deployment</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="infrastructure-deployment.html"><a href="infrastructure-deployment.html"><i class="fa fa-check"></i><b>7</b> Infrastructure Deployment</a></li>
<li class="chapter" data-level="8" data-path="use-case-development.html"><a href="use-case-development.html"><i class="fa fa-check"></i><b>8</b> Use Case Development</a>
<ul>
<li class="chapter" data-level="8.1" data-path="jupyterhub.html"><a href="jupyterhub.html"><i class="fa fa-check"></i><b>8.1</b> Jupyterhub</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="jupyterhub.html"><a href="jupyterhub.html#github-repository"><i class="fa fa-check"></i><b>8.1.1</b> Github Repository</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="pipeline-workflow.html"><a href="pipeline-workflow.html"><i class="fa fa-check"></i><b>8.2</b> Pipeline Workflow</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="pipeline-workflow.html"><a href="pipeline-workflow.html#airflow-workflow"><i class="fa fa-check"></i><b>8.2.1</b> Airflow Workflow</a></li>
<li class="chapter" data-level="8.2.2" data-path="pipeline-workflow.html"><a href="pipeline-workflow.html#mlflow-1"><i class="fa fa-check"></i><b>8.2.2</b> MLflow</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="building-the-pipeline-steps.html"><a href="building-the-pipeline-steps.html"><i class="fa fa-check"></i><b>8.3</b> Building the Pipeline Steps</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="building-the-pipeline-steps.html"><a href="building-the-pipeline-steps.html#data-preprocessing"><i class="fa fa-check"></i><b>8.3.1</b> Data Preprocessing</a></li>
<li class="chapter" data-level="8.3.2" data-path="building-the-pipeline-steps.html"><a href="building-the-pipeline-steps.html#model-training"><i class="fa fa-check"></i><b>8.3.2</b> Model Training</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="model-serving-inferencing.html"><a href="model-serving-inferencing.html"><i class="fa fa-check"></i><b>8.4</b> Model Serving &amp; Inferencing</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="model-serving-inferencing.html"><a href="model-serving-inferencing.html#model-serving-1"><i class="fa fa-check"></i><b>8.4.1</b> Model Serving</a></li>
<li class="chapter" data-level="8.4.2" data-path="model-serving-inferencing.html"><a href="model-serving-inferencing.html#streamlit-app"><i class="fa fa-check"></i><b>8.4.2</b> Streamlit App</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Engineering</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="building-the-pipeline-steps" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Building the Pipeline Steps<a href="building-the-pipeline-steps.html#building-the-pipeline-steps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As mentioned previously, the machine learning pipeline for this particular use case comprises three primary stages: preprocessing, training, and serving. Furthermore, only the model that achieves the highest accuracy is chosen for deployment, which introduces an additional step for model comparison. Each of these steps will be further explained in the upcoming sections.</p>
<div id="data-preprocessing" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Data Preprocessing<a href="building-the-pipeline-steps.html#data-preprocessing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The data processing stage involves three primary processes. First, the raw data is loaded from an S3 Bucket. Second, the data is preprocessed and converted into the required format. Finally, the preprocessed data is stored in a way that allows it to be utilized by subsequent models. The data processing functionality is implemented within the given <code>data_preprocessing</code> function. The <code>utils</code> module, imported at the beginning, provides the functionality to access, load, and store data from S3. The data is normalized and transformed into a NumPy array to make it compatible with TensorFlow Keras models. The function returns the names and paths of the preprocessed and uploaded data, making it convenient for selecting them for future model training. Moreover, the data preprocessing stage establishes a connection with MLflow to record the sizes of the datasets.</p>
<div id="importing-required-libraries" class="section level4 unlisted unnumbered hasAnchor">
<h4>Importing Required Libraries<a href="building-the-pipeline-steps.html#importing-required-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The following code imports the necessary libraries and modules required for the code execution. It includes libraries for handling file operations, data manipulation, machine learning, progress tracking, as well as custom modules.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="building-the-pipeline-steps.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imports necessary packages</span></span>
<span id="cb121-2"><a href="building-the-pipeline-steps.html#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb121-3"><a href="building-the-pipeline-steps.html#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb121-4"><a href="building-the-pipeline-steps.html#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb121-5"><a href="building-the-pipeline-steps.html#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="building-the-pipeline-steps.html#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb121-7"><a href="building-the-pipeline-steps.html#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb121-8"><a href="building-the-pipeline-steps.html#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils.np_utils <span class="im">import</span> to_categorical</span>
<span id="cb121-9"><a href="building-the-pipeline-steps.html#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> shuffle</span>
<span id="cb121-10"><a href="building-the-pipeline-steps.html#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.utils <span class="im">import</span> AWSSession, timeit</span>
<span id="cb121-11"><a href="building-the-pipeline-steps.html#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb121-12"><a href="building-the-pipeline-steps.html#cb121-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-13"><a href="building-the-pipeline-steps.html#cb121-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Import custom modules</span></span>
<span id="cb121-14"><a href="building-the-pipeline-steps.html#cb121-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.utils <span class="im">import</span> AWSSession</span></code></pre></div>
</div>
<div id="data-preprocessing-function-definition" class="section level4 unlisted unnumbered hasAnchor">
<h4>Data Preprocessing Function Definition<a href="building-the-pipeline-steps.html#data-preprocessing-function-definition" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>At first, the <code>data_preprocessing</code> function is defined, which performs the data preprocessing steps. The function takes three arguments: <code>mlflow_experiment_id</code> (the MLflow experiment ID for logging), aws_bucket (the S3 bucket for reading raw data and storing preprocessed data), and path_preprocessed (the subdirectory for storing preprocessed data, with a default value of “preprocessed”). The function returns a tuple of four strings representing the paths of the preprocessed data.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="building-the-pipeline-steps.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="at">@timeit</span></span>
<span id="cb122-2"><a href="building-the-pipeline-steps.html#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_preprocessing(</span>
<span id="cb122-3"><a href="building-the-pipeline-steps.html#cb122-3" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_id: <span class="bu">str</span>,</span>
<span id="cb122-4"><a href="building-the-pipeline-steps.html#cb122-4" aria-hidden="true" tabindex="-1"></a>    aws_bucket: <span class="bu">str</span>,</span>
<span id="cb122-5"><a href="building-the-pipeline-steps.html#cb122-5" aria-hidden="true" tabindex="-1"></a>    path_preprocessed: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;preprocessed&quot;</span>,</span>
<span id="cb122-6"><a href="building-the-pipeline-steps.html#cb122-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>]:</span>
<span id="cb122-7"><a href="building-the-pipeline-steps.html#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Preprocesses data for further use within model training. Raw data is read from given S3 Bucket, normalized, and stored ad a NumPy Array within S3 again. Output directory is on &quot;/preprocessed&quot;. The shape of the data set is logged to MLflow.</span></span>
<span id="cb122-8"><a href="building-the-pipeline-steps.html#cb122-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-9"><a href="building-the-pipeline-steps.html#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb122-10"><a href="building-the-pipeline-steps.html#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_experiment_id (str): Experiment ID of the MLflow run to log data</span></span>
<span id="cb122-11"><a href="building-the-pipeline-steps.html#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="co">        aws_bucket (str): S3 Bucket to read raw data from and write preprocessed data</span></span>
<span id="cb122-12"><a href="building-the-pipeline-steps.html#cb122-12" aria-hidden="true" tabindex="-1"></a><span class="co">        path_preprocessed (str, optional): Subdirectory to store the preprocessed data on the provided S3 Bucket. Defaults to &quot;preprocessed&quot;.</span></span>
<span id="cb122-13"><a href="building-the-pipeline-steps.html#cb122-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-14"><a href="building-the-pipeline-steps.html#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb122-15"><a href="building-the-pipeline-steps.html#cb122-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[str, str, str, str]: Four strings denoting the path of the preprocessed data stored as NumPy Arrays: X_train_data_path, y_train_data_path, X_test_data_path, y_test_data_path</span></span>
<span id="cb122-16"><a href="building-the-pipeline-steps.html#cb122-16" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div id="setting-mlflow-tracking-uri-and-aws-session" class="section level4 unlisted unnumbered hasAnchor">
<h4>Setting MLflow Tracking URI and AWS Session<a href="building-the-pipeline-steps.html#setting-mlflow-tracking-uri-and-aws-session" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Afterward, the MLflow tracking URI is set and an AWS session created using the AWS Access Key obtained from the environment variables and using the custom class <code>AWSSession()</code>.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="building-the-pipeline-steps.html#cb123-1" aria-hidden="true" tabindex="-1"></a>    mlflow_tracking_uri <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb123-2"><a href="building-the-pipeline-steps.html#cb123-2" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(mlflow_tracking_uri)</span>
<span id="cb123-3"><a href="building-the-pipeline-steps.html#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="building-the-pipeline-steps.html#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate aws session based on AWS Access Key</span></span>
<span id="cb123-5"><a href="building-the-pipeline-steps.html#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AWS Access Key is fetched within AWS Session by os.getenv</span></span>
<span id="cb123-6"><a href="building-the-pipeline-steps.html#cb123-6" aria-hidden="true" tabindex="-1"></a>    aws_session <span class="op">=</span> AWSSession()</span>
<span id="cb123-7"><a href="building-the-pipeline-steps.html#cb123-7" aria-hidden="true" tabindex="-1"></a>    aws_session.set_sessions()</span></code></pre></div>
</div>
<div id="setting-paths-and-helper-functions" class="section level4 unlisted unnumbered hasAnchor">
<h4>Setting Paths and Helper Functions<a href="building-the-pipeline-steps.html#setting-paths-and-helper-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The paths for storing raw and preprocessed data within the S3 bucket are defined in a next step. As well as the helper functions <code>_load_and_convert_images</code>, <code>_create_label</code> and <code>_merge_data</code>. The <code>_load_and_convert_images</code> function loads and converts images from an S3 bucket folder into a NumPy array. The <code>_create_label</code> function creates a label array for a given dataset, while the <code>_merge_data</code> function merges two datasets into a single dataset.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="building-the-pipeline-steps.html#cb124-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set paths within s3</span></span>
<span id="cb124-2"><a href="building-the-pipeline-steps.html#cb124-2" aria-hidden="true" tabindex="-1"></a>    path_raw_data <span class="op">=</span> <span class="ss">f&quot;s3://</span><span class="sc">{</span>aws_bucket<span class="sc">}</span><span class="ss">/data/&quot;</span></span>
<span id="cb124-3"><a href="building-the-pipeline-steps.html#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="building-the-pipeline-steps.html#cb124-4" aria-hidden="true" tabindex="-1"></a>    folder_benign_train <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">train/benign&quot;</span></span>
<span id="cb124-5"><a href="building-the-pipeline-steps.html#cb124-5" aria-hidden="true" tabindex="-1"></a>    folder_malignant_train <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">train/malignant&quot;</span></span>
<span id="cb124-6"><a href="building-the-pipeline-steps.html#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="building-the-pipeline-steps.html#cb124-7" aria-hidden="true" tabindex="-1"></a>    folder_benign_test <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">test/benign&quot;</span></span>
<span id="cb124-8"><a href="building-the-pipeline-steps.html#cb124-8" aria-hidden="true" tabindex="-1"></a>    folder_malignant_test <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_raw_data<span class="sc">}</span><span class="ss">test/malignant&quot;</span></span>
<span id="cb124-9"><a href="building-the-pipeline-steps.html#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="building-the-pipeline-steps.html#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inner helper functions to load the data to a NumPy Array, create labels, and merge Array</span></span>
<span id="cb124-11"><a href="building-the-pipeline-steps.html#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@timeit</span></span>
<span id="cb124-12"><a href="building-the-pipeline-steps.html#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _load_and_convert_images(folder_path: <span class="bu">str</span>) <span class="op">-&gt;</span> np.array:</span>
<span id="cb124-13"><a href="building-the-pipeline-steps.html#cb124-13" aria-hidden="true" tabindex="-1"></a>        ims <span class="op">=</span> [</span>
<span id="cb124-14"><a href="building-the-pipeline-steps.html#cb124-14" aria-hidden="true" tabindex="-1"></a>            aws_session.read_image_from_s3(s3_bucket<span class="op">=</span>aws_bucket, imname<span class="op">=</span>filename)</span>
<span id="cb124-15"><a href="building-the-pipeline-steps.html#cb124-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> filename <span class="kw">in</span> tqdm(aws_session.list_files_in_bucket(folder_path))</span>
<span id="cb124-16"><a href="building-the-pipeline-steps.html#cb124-16" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb124-17"><a href="building-the-pipeline-steps.html#cb124-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(ims, dtype<span class="op">=</span><span class="st">&quot;uint8&quot;</span>)</span>
<span id="cb124-18"><a href="building-the-pipeline-steps.html#cb124-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-19"><a href="building-the-pipeline-steps.html#cb124-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _create_label(x_dataset: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb124-20"><a href="building-the-pipeline-steps.html#cb124-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.zeros(x_dataset.shape[<span class="dv">0</span>])</span>
<span id="cb124-21"><a href="building-the-pipeline-steps.html#cb124-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-22"><a href="building-the-pipeline-steps.html#cb124-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _merge_data(set_one: np.array, set_two: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb124-23"><a href="building-the-pipeline-steps.html#cb124-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.concatenate((set_one, set_two), axis<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div>
</div>
<div id="preprocessing-steps-and-mlflow-logging" class="section level4 unlisted unnumbered hasAnchor">
<h4>Preprocessing Steps and MLflow Logging<a href="building-the-pipeline-steps.html#preprocessing-steps-and-mlflow-logging" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This section performs the main preprocessing steps. It loads images from the S3 bucket, creates labels, merges data, shuffles the data, performs data normalization, and uploads the preprocessed data as NumPy arrays to the S3 bucket. The MLflow logging is also performed, recording the sizes of the training and testing data.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="building-the-pipeline-steps.html#cb125-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start a MLflow run to log the size of the data</span></span>
<span id="cb125-2"><a href="building-the-pipeline-steps.html#cb125-2" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S&quot;</span>)</span>
<span id="cb125-3"><a href="building-the-pipeline-steps.html#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(experiment_id<span class="op">=</span>mlflow_experiment_id, run_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">_Preprocessing&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb125-4"><a href="building-the-pipeline-steps.html#cb125-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Loading images from S3...&quot;</span>)</span>
<span id="cb125-5"><a href="building-the-pipeline-steps.html#cb125-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load in training pictures</span></span>
<span id="cb125-6"><a href="building-the-pipeline-steps.html#cb125-6" aria-hidden="true" tabindex="-1"></a>        X_benign <span class="op">=</span> _load_and_convert_images(folder_benign_train)</span>
<span id="cb125-7"><a href="building-the-pipeline-steps.html#cb125-7" aria-hidden="true" tabindex="-1"></a>        X_malignant <span class="op">=</span> _load_and_convert_images(folder_malignant_train)</span>
<span id="cb125-8"><a href="building-the-pipeline-steps.html#cb125-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-9"><a href="building-the-pipeline-steps.html#cb125-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load in testing pictures</span></span>
<span id="cb125-10"><a href="building-the-pipeline-steps.html#cb125-10" aria-hidden="true" tabindex="-1"></a>        X_benign_test <span class="op">=</span> _load_and_convert_images(folder_benign_test)</span>
<span id="cb125-11"><a href="building-the-pipeline-steps.html#cb125-11" aria-hidden="true" tabindex="-1"></a>        X_malignant_test <span class="op">=</span> _load_and_convert_images(folder_malignant_test)</span>
<span id="cb125-12"><a href="building-the-pipeline-steps.html#cb125-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-13"><a href="building-the-pipeline-steps.html#cb125-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log train-test size in MLflow</span></span>
<span id="cb125-14"><a href="building-the-pipeline-steps.html#cb125-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Log data parameters&quot;</span>)</span>
<span id="cb125-15"><a href="building-the-pipeline-steps.html#cb125-15" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;train_size_benign&quot;</span>, X_benign.shape[<span class="dv">0</span>])</span>
<span id="cb125-16"><a href="building-the-pipeline-steps.html#cb125-16" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;train_size_malignant&quot;</span>, X_malignant.shape[<span class="dv">0</span>])</span>
<span id="cb125-17"><a href="building-the-pipeline-steps.html#cb125-17" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;test_size_benign&quot;</span>, X_benign_test.shape[<span class="dv">0</span>])</span>
<span id="cb125-18"><a href="building-the-pipeline-steps.html#cb125-18" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">&quot;test_size_malignant&quot;</span>, X_malignant_test.shape[<span class="dv">0</span>])</span>
<span id="cb125-19"><a href="building-the-pipeline-steps.html#cb125-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-20"><a href="building-the-pipeline-steps.html#cb125-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Preprocessing...&quot;</span>)</span>
<span id="cb125-21"><a href="building-the-pipeline-steps.html#cb125-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create labels</span></span>
<span id="cb125-22"><a href="building-the-pipeline-steps.html#cb125-22" aria-hidden="true" tabindex="-1"></a>        y_benign <span class="op">=</span> _create_label(X_benign)</span>
<span id="cb125-23"><a href="building-the-pipeline-steps.html#cb125-23" aria-hidden="true" tabindex="-1"></a>        y_malignant <span class="op">=</span> _create_label(X_malignant)</span>
<span id="cb125-24"><a href="building-the-pipeline-steps.html#cb125-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-25"><a href="building-the-pipeline-steps.html#cb125-25" aria-hidden="true" tabindex="-1"></a>        y_benign_test <span class="op">=</span> _create_label(X_benign_test)</span>
<span id="cb125-26"><a href="building-the-pipeline-steps.html#cb125-26" aria-hidden="true" tabindex="-1"></a>        y_malignant_test <span class="op">=</span> _create_label(X_malignant_test)</span>
<span id="cb125-27"><a href="building-the-pipeline-steps.html#cb125-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-28"><a href="building-the-pipeline-steps.html#cb125-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge data</span></span>
<span id="cb125-29"><a href="building-the-pipeline-steps.html#cb125-29" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> _merge_data(y_benign, y_malignant)</span>
<span id="cb125-30"><a href="building-the-pipeline-steps.html#cb125-30" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> _merge_data(y_benign_test, y_malignant_test)</span>
<span id="cb125-31"><a href="building-the-pipeline-steps.html#cb125-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-32"><a href="building-the-pipeline-steps.html#cb125-32" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> _merge_data(X_benign, X_malignant)</span>
<span id="cb125-33"><a href="building-the-pipeline-steps.html#cb125-33" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> _merge_data(X_benign_test, X_malignant_test)</span>
<span id="cb125-34"><a href="building-the-pipeline-steps.html#cb125-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-35"><a href="building-the-pipeline-steps.html#cb125-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shuffle data</span></span>
<span id="cb125-36"><a href="building-the-pipeline-steps.html#cb125-36" aria-hidden="true" tabindex="-1"></a>        X_train, y_train <span class="op">=</span> shuffle(X_train, y_train)</span>
<span id="cb125-37"><a href="building-the-pipeline-steps.html#cb125-37" aria-hidden="true" tabindex="-1"></a>        X_test, y_test <span class="op">=</span> shuffle(X_test, y_test)</span>
<span id="cb125-38"><a href="building-the-pipeline-steps.html#cb125-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-39"><a href="building-the-pipeline-steps.html#cb125-39" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> to_categorical(y_train, num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb125-40"><a href="building-the-pipeline-steps.html#cb125-40" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> to_categorical(y_test, num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb125-41"><a href="building-the-pipeline-steps.html#cb125-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-42"><a href="building-the-pipeline-steps.html#cb125-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># With data augmentation to prevent overfitting</span></span>
<span id="cb125-43"><a href="building-the-pipeline-steps.html#cb125-43" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> X_train <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb125-44"><a href="building-the-pipeline-steps.html#cb125-44" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> X_test <span class="op">/</span> <span class="fl">255.0</span></span></code></pre></div>
</div>
<div id="uploading-preprocessed-data" class="section level4 unlisted unnumbered hasAnchor">
<h4>Uploading preprocessed data<a href="building-the-pipeline-steps.html#uploading-preprocessed-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The four preprocessed numpy arrays (X_train, y_train, X_test, y_test) are uploaded to an S3 bucket. The arrays are stored as pickle files with specific file keys in the bucket. Finally, the paths of the preprocessed data are create and and returned as a tuple of strings.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="building-the-pipeline-steps.html#cb126-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Upload numpy arrays to S3...&quot;</span>)</span>
<span id="cb126-2"><a href="building-the-pipeline-steps.html#cb126-2" aria-hidden="true" tabindex="-1"></a>    aws_session.upload_npy_to_s3(</span>
<span id="cb126-3"><a href="building-the-pipeline-steps.html#cb126-3" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>X_train,</span>
<span id="cb126-4"><a href="building-the-pipeline-steps.html#cb126-4" aria-hidden="true" tabindex="-1"></a>        s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb126-5"><a href="building-the-pipeline-steps.html#cb126-5" aria-hidden="true" tabindex="-1"></a>        file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_train.pkl&quot;</span>,</span>
<span id="cb126-6"><a href="building-the-pipeline-steps.html#cb126-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-7"><a href="building-the-pipeline-steps.html#cb126-7" aria-hidden="true" tabindex="-1"></a>    aws_session.upload_npy_to_s3(</span>
<span id="cb126-8"><a href="building-the-pipeline-steps.html#cb126-8" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>y_train,</span>
<span id="cb126-9"><a href="building-the-pipeline-steps.html#cb126-9" aria-hidden="true" tabindex="-1"></a>        s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb126-10"><a href="building-the-pipeline-steps.html#cb126-10" aria-hidden="true" tabindex="-1"></a>        file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_train.pkl&quot;</span>,</span>
<span id="cb126-11"><a href="building-the-pipeline-steps.html#cb126-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-12"><a href="building-the-pipeline-steps.html#cb126-12" aria-hidden="true" tabindex="-1"></a>    aws_session.upload_npy_to_s3(</span>
<span id="cb126-13"><a href="building-the-pipeline-steps.html#cb126-13" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>X_test,</span>
<span id="cb126-14"><a href="building-the-pipeline-steps.html#cb126-14" aria-hidden="true" tabindex="-1"></a>        s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb126-15"><a href="building-the-pipeline-steps.html#cb126-15" aria-hidden="true" tabindex="-1"></a>        file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_test.pkl&quot;</span>,</span>
<span id="cb126-16"><a href="building-the-pipeline-steps.html#cb126-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-17"><a href="building-the-pipeline-steps.html#cb126-17" aria-hidden="true" tabindex="-1"></a>    aws_session.upload_npy_to_s3(</span>
<span id="cb126-18"><a href="building-the-pipeline-steps.html#cb126-18" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>y_test,</span>
<span id="cb126-19"><a href="building-the-pipeline-steps.html#cb126-19" aria-hidden="true" tabindex="-1"></a>        s3_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb126-20"><a href="building-the-pipeline-steps.html#cb126-20" aria-hidden="true" tabindex="-1"></a>        file_key<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_test.pkl&quot;</span>,</span>
<span id="cb126-21"><a href="building-the-pipeline-steps.html#cb126-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-22"><a href="building-the-pipeline-steps.html#cb126-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-23"><a href="building-the-pipeline-steps.html#cb126-23" aria-hidden="true" tabindex="-1"></a>    X_train_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_train.pkl&quot;</span></span>
<span id="cb126-24"><a href="building-the-pipeline-steps.html#cb126-24" aria-hidden="true" tabindex="-1"></a>    y_train_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_train.pkl&quot;</span></span>
<span id="cb126-25"><a href="building-the-pipeline-steps.html#cb126-25" aria-hidden="true" tabindex="-1"></a>    X_test_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/X_test.pkl&quot;</span></span>
<span id="cb126-26"><a href="building-the-pipeline-steps.html#cb126-26" aria-hidden="true" tabindex="-1"></a>    y_test_data_path <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>path_preprocessed<span class="sc">}</span><span class="ss">/y_test.pkl&quot;</span></span>
<span id="cb126-27"><a href="building-the-pipeline-steps.html#cb126-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-28"><a href="building-the-pipeline-steps.html#cb126-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return directory paths of the data stored in S3</span></span>
<span id="cb126-29"><a href="building-the-pipeline-steps.html#cb126-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X_train_data_path, y_train_data_path, X_test_data_path, y_test_data_path</span></code></pre></div>
</div>
</div>
<div id="model-training" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">8.3.2</span> Model Training<a href="building-the-pipeline-steps.html#model-training" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The training step is designed to accommodate different models based on the selected model. The custom <code>model.utils</code> package, imported at the beginning, enables the selection and retrieval of models. The chosen model can be specified by passing its name to the <code>get_model</code> function, which then returns the corresponding model. These models are implemented using TensorFlow Keras and their code is stored in the <code>/model</code> directory. The model is trained using the <code>model_params</code> parameters provided to the training function, which include all the necessary hyperparameters. The training and evaluation are conducted using the preprocessed data from the previous step, which is downloaded from S3 at the beginning. Depending on the selected model, a KFold cross-validation is performed to improve the model’s fit.</p>
<p>MLflow is utilized to track the model’s progress. By invoking <code>mlflow.start_run()</code>, a new MLflow run is initiated. The <code>model_params</code> are logged using <code>mlflow.log_params</code>, and MLflow autolog is enabled for Keras models through <code>mlflow.keras.autolog()</code>. After successful training, the models are stored in the model registry. The trained model is logged using <code>mlflow.keras.register_model</code>, with the specified <code>model_name</code> as the destination.</p>
<p>The function returns the MLflow run ID and crucial information about the model, such as its name, version, and stage.</p>
<div id="importing-dependencies-1" class="section level4 unlisted unnumbered hasAnchor">
<h4>Importing Dependencies<a href="building-the-pipeline-steps.html#importing-dependencies-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This section imports the necessary dependencies for the code, including libraries for machine learning, data manipulation, and utility functions.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="building-the-pipeline-steps.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imports necessary packages</span></span>
<span id="cb127-2"><a href="building-the-pipeline-steps.html#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb127-3"><a href="building-the-pipeline-steps.html#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb127-4"><a href="building-the-pipeline-steps.html#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb127-5"><a href="building-the-pipeline-steps.html#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb127-6"><a href="building-the-pipeline-steps.html#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb127-7"><a href="building-the-pipeline-steps.html#cb127-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-8"><a href="building-the-pipeline-steps.html#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb127-9"><a href="building-the-pipeline-steps.html#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.keras</span>
<span id="cb127-10"><a href="building-the-pipeline-steps.html#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb127-11"><a href="building-the-pipeline-steps.html#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> backend <span class="im">as</span> K</span>
<span id="cb127-12"><a href="building-the-pipeline-steps.html#cb127-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.callbacks <span class="im">import</span> ReduceLROnPlateau</span>
<span id="cb127-13"><a href="building-the-pipeline-steps.html#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb127-14"><a href="building-the-pipeline-steps.html#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb127-15"><a href="building-the-pipeline-steps.html#cb127-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-16"><a href="building-the-pipeline-steps.html#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Import custom modules</span></span>
<span id="cb127-17"><a href="building-the-pipeline-steps.html#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.model.utils <span class="im">import</span> Model_Class, get_model</span>
<span id="cb127-18"><a href="building-the-pipeline-steps.html#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.utils <span class="im">import</span> AWSSession</span></code></pre></div>
</div>
<div id="defining-the-train_model-function" class="section level4 unlisted unnumbered hasAnchor">
<h4>Defining the <em>train_model</em> Function<a href="building-the-pipeline-steps.html#defining-the-train_model-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The actual code starts by defining the train_model function, which takes several parameters for training a machine learning model, logging the results to MLflow, and returning relevant information. The MLflow tracking URI is retrieved from the environment variable and sets it as the tracking URI for MLflow.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="building-the-pipeline-steps.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(</span>
<span id="cb128-2"><a href="building-the-pipeline-steps.html#cb128-2" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_id: <span class="bu">str</span>,</span>
<span id="cb128-3"><a href="building-the-pipeline-steps.html#cb128-3" aria-hidden="true" tabindex="-1"></a>    model_class: Enum,</span>
<span id="cb128-4"><a href="building-the-pipeline-steps.html#cb128-4" aria-hidden="true" tabindex="-1"></a>    model_params: <span class="bu">dict</span>,</span>
<span id="cb128-5"><a href="building-the-pipeline-steps.html#cb128-5" aria-hidden="true" tabindex="-1"></a>    aws_bucket: <span class="bu">str</span>,</span>
<span id="cb128-6"><a href="building-the-pipeline-steps.html#cb128-6" aria-hidden="true" tabindex="-1"></a>    import_dict: <span class="bu">dict</span> <span class="op">=</span> {},</span>
<span id="cb128-7"><a href="building-the-pipeline-steps.html#cb128-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">int</span>, <span class="bu">str</span>]:</span>
<span id="cb128-8"><a href="building-the-pipeline-steps.html#cb128-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb128-9"><a href="building-the-pipeline-steps.html#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains a machine learning model and logs the results to MLflow.</span></span>
<span id="cb128-10"><a href="building-the-pipeline-steps.html#cb128-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-11"><a href="building-the-pipeline-steps.html#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb128-12"><a href="building-the-pipeline-steps.html#cb128-12" aria-hidden="true" tabindex="-1"></a><span class="co">        mlflow_experiment_id (str): The ID of the MLflow experiment to log the results.</span></span>
<span id="cb128-13"><a href="building-the-pipeline-steps.html#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="co">        model_class (Enum): The class of the model to train.</span></span>
<span id="cb128-14"><a href="building-the-pipeline-steps.html#cb128-14" aria-hidden="true" tabindex="-1"></a><span class="co">        model_params (dict): A dictionary containing the parameters for the model.</span></span>
<span id="cb128-15"><a href="building-the-pipeline-steps.html#cb128-15" aria-hidden="true" tabindex="-1"></a><span class="co">        aws_bucket (str): The AWS S3 bucket name for data storage.</span></span>
<span id="cb128-16"><a href="building-the-pipeline-steps.html#cb128-16" aria-hidden="true" tabindex="-1"></a><span class="co">        import_dict (dict, optional): A dictionary containing paths for importing data. Defaults to {}.</span></span>
<span id="cb128-17"><a href="building-the-pipeline-steps.html#cb128-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-18"><a href="building-the-pipeline-steps.html#cb128-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb128-19"><a href="building-the-pipeline-steps.html#cb128-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple[str, str, int, str]: A tuple containing the run ID, model name, model version, and current stage.</span></span>
<span id="cb128-20"><a href="building-the-pipeline-steps.html#cb128-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-21"><a href="building-the-pipeline-steps.html#cb128-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb128-22"><a href="building-the-pipeline-steps.html#cb128-22" aria-hidden="true" tabindex="-1"></a><span class="co">        None</span></span>
<span id="cb128-23"><a href="building-the-pipeline-steps.html#cb128-23" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb128-24"><a href="building-the-pipeline-steps.html#cb128-24" aria-hidden="true" tabindex="-1"></a>    mlflow_tracking_uri <span class="op">=</span> os.getenv(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb128-25"><a href="building-the-pipeline-steps.html#cb128-25" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tracking_uri(mlflow_tracking_uri)</span></code></pre></div>
</div>
<div id="loading-data" class="section level4 unlisted unnumbered hasAnchor">
<h4>Loading Data<a href="building-the-pipeline-steps.html#loading-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This section handles the loading of data required for training the model. It retrieves the file paths for the training and testing data from the <code>import_dict</code> parameter and loads the corresponding NumPy arrays from an AWS S3 bucket using the <code>AWSSession</code> class.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="building-the-pipeline-steps.html#cb129-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Loading data...&quot;</span>)</span>
<span id="cb129-2"><a href="building-the-pipeline-steps.html#cb129-2" aria-hidden="true" tabindex="-1"></a>    X_train_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;X_train_data_path&quot;</span>)</span>
<span id="cb129-3"><a href="building-the-pipeline-steps.html#cb129-3" aria-hidden="true" tabindex="-1"></a>    y_train_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;y_train_data_path&quot;</span>)</span>
<span id="cb129-4"><a href="building-the-pipeline-steps.html#cb129-4" aria-hidden="true" tabindex="-1"></a>    X_test_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;X_test_data_path&quot;</span>)</span>
<span id="cb129-5"><a href="building-the-pipeline-steps.html#cb129-5" aria-hidden="true" tabindex="-1"></a>    y_test_data_path <span class="op">=</span> import_dict.get(<span class="st">&quot;y_test_data_path&quot;</span>)</span>
<span id="cb129-6"><a href="building-the-pipeline-steps.html#cb129-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-7"><a href="building-the-pipeline-steps.html#cb129-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate aws session based on AWS Access Key</span></span>
<span id="cb129-8"><a href="building-the-pipeline-steps.html#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AWS Access Key is fetched within AWS Session by os.getenv</span></span>
<span id="cb129-9"><a href="building-the-pipeline-steps.html#cb129-9" aria-hidden="true" tabindex="-1"></a>    aws_session <span class="op">=</span> AWSSession()</span>
<span id="cb129-10"><a href="building-the-pipeline-steps.html#cb129-10" aria-hidden="true" tabindex="-1"></a>    aws_session.set_sessions()</span>
<span id="cb129-11"><a href="building-the-pipeline-steps.html#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="building-the-pipeline-steps.html#cb129-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read NumPy Arrays from S3</span></span>
<span id="cb129-13"><a href="building-the-pipeline-steps.html#cb129-13" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>X_train_data_path)</span>
<span id="cb129-14"><a href="building-the-pipeline-steps.html#cb129-14" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>y_train_data_path)</span>
<span id="cb129-15"><a href="building-the-pipeline-steps.html#cb129-15" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>X_test_data_path)</span>
<span id="cb129-16"><a href="building-the-pipeline-steps.html#cb129-16" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> aws_session.download_npy_from_s3(s3_bucket<span class="op">=</span>aws_bucket, file_key<span class="op">=</span>y_test_data_path)</span></code></pre></div>
</div>
<div id="training-the-model" class="section level4 unlisted unnumbered hasAnchor">
<h4>Training the Model<a href="building-the-pipeline-steps.html#training-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>After the data is loaded, the training process for the machine learning model is started. It begins by printing the model class and generating a timestamp for the run name. Then, it starts an MLflow run with the specified experiment ID and run name. The model parameters are logged using MLflow’s log_params function. Additionally, a callback for reducing the learning rate during training is configured using the ReduceLROnPlateau class from Keras.</p>
<p>The model training handles two different scenarios based on the selected <code>model_class</code>. If it is set to cross-validation (<code>Model_Class.CrossVal</code>), the model is trained using cross-validation. Otherwise, it is trained using the specified model class.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb130-1"><a href="building-the-pipeline-steps.html#cb130-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Training model...&quot;</span>)</span>
<span id="cb130-2"><a href="building-the-pipeline-steps.html#cb130-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model_class)</span>
<span id="cb130-3"><a href="building-the-pipeline-steps.html#cb130-3" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S&quot;</span>)</span>
<span id="cb130-4"><a href="building-the-pipeline-steps.html#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(experiment_id<span class="op">=</span>mlflow_experiment_id, run_name<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>model_class<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb130-5"><a href="building-the-pipeline-steps.html#cb130-5" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(model_params)</span>
<span id="cb130-6"><a href="building-the-pipeline-steps.html#cb130-6" aria-hidden="true" tabindex="-1"></a>        learning_rate_reduction <span class="op">=</span> ReduceLROnPlateau(monitor<span class="op">=</span><span class="st">&quot;accuracy&quot;</span>, patience<span class="op">=</span><span class="dv">5</span>, verbose<span class="op">=</span><span class="dv">1</span>, factor<span class="op">=</span><span class="fl">0.5</span>, min_lr<span class="op">=</span><span class="fl">1e-7</span>)</span>
<span id="cb130-7"><a href="building-the-pipeline-steps.html#cb130-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-8"><a href="building-the-pipeline-steps.html#cb130-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If CrossVal is selected, train BasicNet as Cross-Validated Model</span></span>
<span id="cb130-9"><a href="building-the-pipeline-steps.html#cb130-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_class <span class="op">==</span> Model_Class.CrossVal.value:</span>
<span id="cb130-10"><a href="building-the-pipeline-steps.html#cb130-10" aria-hidden="true" tabindex="-1"></a>            kfold <span class="op">=</span> KFold(n_splits<span class="op">=</span><span class="dv">3</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb130-11"><a href="building-the-pipeline-steps.html#cb130-11" aria-hidden="true" tabindex="-1"></a>            cvscores <span class="op">=</span> []</span>
<span id="cb130-12"><a href="building-the-pipeline-steps.html#cb130-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> train, test <span class="kw">in</span> kfold.split(X_train, y_train):</span>
<span id="cb130-13"><a href="building-the-pipeline-steps.html#cb130-13" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> get_model(Model_Class.Basic.value, model_params)</span>
<span id="cb130-14"><a href="building-the-pipeline-steps.html#cb130-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-15"><a href="building-the-pipeline-steps.html#cb130-15" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Train Model</span></span>
<span id="cb130-16"><a href="building-the-pipeline-steps.html#cb130-16" aria-hidden="true" tabindex="-1"></a>                model.fit(</span>
<span id="cb130-17"><a href="building-the-pipeline-steps.html#cb130-17" aria-hidden="true" tabindex="-1"></a>                    X_train[train],</span>
<span id="cb130-18"><a href="building-the-pipeline-steps.html#cb130-18" aria-hidden="true" tabindex="-1"></a>                    y_train[train],</span>
<span id="cb130-19"><a href="building-the-pipeline-steps.html#cb130-19" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span>model_params.get(<span class="st">&quot;epochs&quot;</span>),</span>
<span id="cb130-20"><a href="building-the-pipeline-steps.html#cb130-20" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span>model_params.get(<span class="st">&quot;batch_size&quot;</span>),</span>
<span id="cb130-21"><a href="building-the-pipeline-steps.html#cb130-21" aria-hidden="true" tabindex="-1"></a>                    verbose<span class="op">=</span>model_params.get(<span class="st">&quot;verbose&quot;</span>),</span>
<span id="cb130-22"><a href="building-the-pipeline-steps.html#cb130-22" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb130-23"><a href="building-the-pipeline-steps.html#cb130-23" aria-hidden="true" tabindex="-1"></a>                scores <span class="op">=</span> model.evaluate(X_train[test], y_train[test], verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb130-24"><a href="building-the-pipeline-steps.html#cb130-24" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%.2f%%</span><span class="st">&quot;</span> <span class="op">%</span> (model.metrics_names[<span class="dv">1</span>], scores[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>))</span>
<span id="cb130-25"><a href="building-the-pipeline-steps.html#cb130-25" aria-hidden="true" tabindex="-1"></a>                cvscores.append(scores[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb130-26"><a href="building-the-pipeline-steps.html#cb130-26" aria-hidden="true" tabindex="-1"></a>                K.clear_session()</span>
<span id="cb130-27"><a href="building-the-pipeline-steps.html#cb130-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb130-28"><a href="building-the-pipeline-steps.html#cb130-28" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> get_model(model_class, model_params)</span>
<span id="cb130-29"><a href="building-the-pipeline-steps.html#cb130-29" aria-hidden="true" tabindex="-1"></a>            mlflow.keras.autolog()</span>
<span id="cb130-30"><a href="building-the-pipeline-steps.html#cb130-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb130-31"><a href="building-the-pipeline-steps.html#cb130-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train Model</span></span>
<span id="cb130-32"><a href="building-the-pipeline-steps.html#cb130-32" aria-hidden="true" tabindex="-1"></a>            model.fit(</span>
<span id="cb130-33"><a href="building-the-pipeline-steps.html#cb130-33" aria-hidden="true" tabindex="-1"></a>                X_train,</span>
<span id="cb130-34"><a href="building-the-pipeline-steps.html#cb130-34" aria-hidden="true" tabindex="-1"></a>                y_train,</span>
<span id="cb130-35"><a href="building-the-pipeline-steps.html#cb130-35" aria-hidden="true" tabindex="-1"></a>                validation_split<span class="op">=</span>model_params.get(<span class="st">&quot;validation_split&quot;</span>),</span>
<span id="cb130-36"><a href="building-the-pipeline-steps.html#cb130-36" aria-hidden="true" tabindex="-1"></a>                epochs<span class="op">=</span>model_params.get(<span class="st">&quot;epochs&quot;</span>),</span>
<span id="cb130-37"><a href="building-the-pipeline-steps.html#cb130-37" aria-hidden="true" tabindex="-1"></a>                batch_size<span class="op">=</span>model_params.get(<span class="st">&quot;batch_size&quot;</span>),</span>
<span id="cb130-38"><a href="building-the-pipeline-steps.html#cb130-38" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span>model_params.get(<span class="st">&quot;verbose&quot;</span>),</span>
<span id="cb130-39"><a href="building-the-pipeline-steps.html#cb130-39" aria-hidden="true" tabindex="-1"></a>                callbacks<span class="op">=</span>[learning_rate_reduction],</span>
<span id="cb130-40"><a href="building-the-pipeline-steps.html#cb130-40" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb130-41"><a href="building-the-pipeline-steps.html#cb130-41" aria-hidden="true" tabindex="-1"></a>            mlflow.keras.autolog(disable<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div id="testing-and-evaluating-the-model" class="section level4 unlisted unnumbered hasAnchor">
<h4>Testing and Evaluating the Model<a href="building-the-pipeline-steps.html#testing-and-evaluating-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>After the model training, the trained model is tested on the test data and its prediction accuracy evaluated. The accuracy score is calculated using the <code>accuracy_score</code> function from scikit-learn and logged as a metric using MLflow. Afterward, the trained and evaluated model is registered with MLflow using the <code>register_model</code> function. The resulting model name, version, and stage are obtained to finally return them in the functions <code>return</code> statement.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="building-the-pipeline-steps.html#cb131-1" aria-hidden="true" tabindex="-1"></a>        run_id <span class="op">=</span> run.info.run_id</span>
<span id="cb131-2"><a href="building-the-pipeline-steps.html#cb131-2" aria-hidden="true" tabindex="-1"></a>        model_uri <span class="op">=</span> <span class="ss">f&quot;runs:/</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_class<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb131-3"><a href="building-the-pipeline-steps.html#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="building-the-pipeline-steps.html#cb131-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Testing model on test data to evaluate</span></span>
<span id="cb131-5"><a href="building-the-pipeline-steps.html#cb131-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Testing model...&quot;</span>)</span>
<span id="cb131-6"><a href="building-the-pipeline-steps.html#cb131-6" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb131-7"><a href="building-the-pipeline-steps.html#cb131-7" aria-hidden="true" tabindex="-1"></a>        prediction_accuracy <span class="op">=</span> accuracy_score(np.argmax(y_test, axis<span class="op">=</span><span class="dv">1</span>), np.argmax(y_pred, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb131-8"><a href="building-the-pipeline-steps.html#cb131-8" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;prediction_accuracy&quot;</span>, prediction_accuracy)</span>
<span id="cb131-9"><a href="building-the-pipeline-steps.html#cb131-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Prediction Accuracy: </span><span class="sc">{</span>prediction_accuracy<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb131-10"><a href="building-the-pipeline-steps.html#cb131-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-11"><a href="building-the-pipeline-steps.html#cb131-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&gt; Register model...&quot;</span>)</span>
<span id="cb131-12"><a href="building-the-pipeline-steps.html#cb131-12" aria-hidden="true" tabindex="-1"></a>        mv <span class="op">=</span> mlflow.register_model(model_uri, model_class)</span>
<span id="cb131-13"><a href="building-the-pipeline-steps.html#cb131-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-14"><a href="building-the-pipeline-steps.html#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return run ID, model name, model version, and current stage of the model</span></span>
<span id="cb131-15"><a href="building-the-pipeline-steps.html#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> run_id, mv.name, mv.version, mv.current_stage</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="pipeline-workflow.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="model-serving-inferencing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/09.3-Deployment-Usage_Building-Model-Pipeline.md",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
