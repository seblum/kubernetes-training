<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
<<<<<<< HEAD
  <title>Chapter 1 Terraform | MLOps Engineering</title>
  <meta name="description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 Terraform | MLOps Engineering" />
=======
  <title>Chapter 2 Terraform | MLOps Architecture from scratch</title>
  <meta name="description" content="This is a tutorial to build a MLOps Airflow architecture utilizing K8s, Terraform, MLFlow, and DVC." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Terraform | MLOps Architecture from scratch" />
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="github-repo" content="seblum/mlops-engineering-book" />

  <meta name="twitter:card" content="summary" />
<<<<<<< HEAD
  <meta name="twitter:title" content="Chapter 1 Terraform | MLOps Engineering" />
=======
  <meta name="twitter:title" content="Chapter 2 Terraform | MLOps Architecture from scratch" />
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
  
  <meta name="twitter:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  

<meta name="author" content="Sebastian Blum" />


<<<<<<< HEAD
<meta name="date" content="2023-02-16" />
=======
<meta name="date" content="2023-02-21" />
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<<<<<<< HEAD
<link rel="prev" href="index.html"/>
<link rel="next" href="basic-usage.html"/>
=======
<link rel="prev" href="introduction.html"/>
<link rel="next" href="kubernetes.html"/>
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<<<<<<< HEAD
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preamble</a></li>
<li class="chapter" data-level="1" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>1</b> Terraform</a>
<ul>
<li class="chapter" data-level="1.1" data-path="basic-usage.html"><a href="basic-usage.html"><i class="fa fa-check"></i><b>1.1</b> Basic usage</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="basic-usage.html"><a href="basic-usage.html#terraform-init"><i class="fa fa-check"></i><b>1.1.1</b> terraform init</a></li>
<li class="chapter" data-level="1.1.2" data-path="basic-usage.html"><a href="basic-usage.html#terraform-validate"><i class="fa fa-check"></i><b>1.1.2</b> terraform validate</a></li>
<li class="chapter" data-level="1.1.3" data-path="basic-usage.html"><a href="basic-usage.html#terraform-plan"><i class="fa fa-check"></i><b>1.1.3</b> terraform plan</a></li>
<li class="chapter" data-level="1.1.4" data-path="basic-usage.html"><a href="basic-usage.html#terraform-apply"><i class="fa fa-check"></i><b>1.1.4</b> terraform apply</a></li>
<li class="chapter" data-level="1.1.5" data-path="basic-usage.html"><a href="basic-usage.html#terraform-destroy"><i class="fa fa-check"></i><b>1.1.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="core-concepts.html"><a href="core-concepts.html"><i class="fa fa-check"></i><b>1.2</b> Core Concepts</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="core-concepts.html"><a href="core-concepts.html#providers"><i class="fa fa-check"></i><b>1.2.1</b> Providers</a></li>
<li class="chapter" data-level="1.2.2" data-path="core-concepts.html"><a href="core-concepts.html#resources"><i class="fa fa-check"></i><b>1.2.2</b> Resources</a></li>
<li class="chapter" data-level="1.2.3" data-path="core-concepts.html"><a href="core-concepts.html#data-sources"><i class="fa fa-check"></i><b>1.2.3</b> Data Sources</a></li>
<li class="chapter" data-level="1.2.4" data-path="core-concepts.html"><a href="core-concepts.html#state"><i class="fa fa-check"></i><b>1.2.4</b> State</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="modules.html"><a href="modules.html"><i class="fa fa-check"></i><b>1.3</b> Modules</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="modules.html"><a href="modules.html#input-variables"><i class="fa fa-check"></i><b>1.3.1</b> Input Variables</a></li>
<li class="chapter" data-level="1.3.2" data-path="modules.html"><a href="modules.html#output-variables"><i class="fa fa-check"></i><b>1.3.2</b> Output Variables</a></li>
<li class="chapter" data-level="1.3.3" data-path="modules.html"><a href="modules.html#local-variables"><i class="fa fa-check"></i><b>1.3.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html"><i class="fa fa-check"></i><b>1.4</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#count"><i class="fa fa-check"></i><b>1.4.1</b> count</a></li>
<li class="chapter" data-level="1.4.2" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for-each"><i class="fa fa-check"></i><b>1.4.2</b> for-each</a></li>
<li class="chapter" data-level="1.4.3" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for"><i class="fa fa-check"></i><b>1.4.3</b> for</a></li>
<li class="chapter" data-level="1.4.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#workspaces"><i class="fa fa-check"></i><b>1.4.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html"><i class="fa fa-check"></i><b>1.5</b> Exemplary Deployment</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>2</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="2.1" data-path="core-concepts-1.html"><a href="core-concepts-1.html"><i class="fa fa-check"></i><b>2.1</b> Core Concepts</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="core-concepts-1.html"><a href="core-concepts-1.html#nodes"><i class="fa fa-check"></i><b>2.1.1</b> Nodes</a></li>
<li class="chapter" data-level="2.1.2" data-path="core-concepts-1.html"><a href="core-concepts-1.html#pods"><i class="fa fa-check"></i><b>2.1.2</b> Pods</a></li>
<li class="chapter" data-level="2.1.3" data-path="core-concepts-1.html"><a href="core-concepts-1.html#imperative-declarative-management"><i class="fa fa-check"></i><b>2.1.3</b> Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html"><i class="fa fa-check"></i><b>2.2</b> Application Deployment &amp; Design</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="application-deployment-design.html"><a href="application-deployment-design.html#deployments"><i class="fa fa-check"></i><b>2.2.1</b> Deployments</a></li>
<li class="chapter" data-level="2.2.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html#resource-management"><i class="fa fa-check"></i><b>2.2.2</b> Resource Management</a></li>
<li class="chapter" data-level="2.2.3" data-path="application-deployment-design.html"><a href="application-deployment-design.html#daemonsets"><i class="fa fa-check"></i><b>2.2.3</b> DaemonSets</a></li>
<li class="chapter" data-level="2.2.4" data-path="application-deployment-design.html"><a href="application-deployment-design.html#statefulsets"><i class="fa fa-check"></i><b>2.2.4</b> StatefulSets</a></li>
<li class="chapter" data-level="2.2.5" data-path="application-deployment-design.html"><a href="application-deployment-design.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>2.2.5</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="services-networking.html"><a href="services-networking.html"><i class="fa fa-check"></i><b>2.3</b> Services &amp; Networking</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="services-networking.html"><a href="services-networking.html#services"><i class="fa fa-check"></i><b>2.3.1</b> Services</a></li>
<li class="chapter" data-level="2.3.2" data-path="services-networking.html"><a href="services-networking.html#service-discovery"><i class="fa fa-check"></i><b>2.3.2</b> Service Discovery</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="volume-storage.html"><a href="volume-storage.html"><i class="fa fa-check"></i><b>2.4</b> Volume &amp; Storage</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="volume-storage.html"><a href="volume-storage.html#emptydir-volume"><i class="fa fa-check"></i><b>2.4.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="2.4.2" data-path="volume-storage.html"><a href="volume-storage.html#hostpath-volume"><i class="fa fa-check"></i><b>2.4.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="2.4.3" data-path="volume-storage.html"><a href="volume-storage.html#persistent-volumes"><i class="fa fa-check"></i><b>2.4.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html"><i class="fa fa-check"></i><b>2.5</b> Environment, Configuration &amp; Security</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#namespaces"><i class="fa fa-check"></i><b>2.5.1</b> Namespaces</a></li>
<li class="chapter" data-level="2.5.2" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>2.5.2</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="2.5.3" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#configmaps"><i class="fa fa-check"></i><b>2.5.3</b> ConfigMaps</a></li>
<li class="chapter" data-level="2.5.4" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#secrets"><i class="fa fa-check"></i><b>2.5.4</b> Secrets</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="observability-maintenance.html"><a href="observability-maintenance.html"><i class="fa fa-check"></i><b>2.6</b> Observability &amp; Maintenance</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="observability-maintenance.html"><a href="observability-maintenance.html#health-checks"><i class="fa fa-check"></i><b>2.6.1</b> Health Checks</a></li>
<li class="chapter" data-level="2.6.2" data-path="observability-maintenance.html"><a href="observability-maintenance.html#debugging"><i class="fa fa-check"></i><b>2.6.2</b> Debugging</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="helm.html"><a href="helm.html"><i class="fa fa-check"></i><b>2.7</b> Helm</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="airflow.html"><a href="airflow.html"><i class="fa fa-check"></i><b>3</b> Airflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html"><i class="fa fa-check"></i><b>3.1</b> Fundamental concepts</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#dags"><i class="fa fa-check"></i><b>3.1.1</b> DAGs</a></li>
<li class="chapter" data-level="3.1.2" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#operators"><i class="fa fa-check"></i><b>3.1.2</b> Operators</a></li>
<li class="chapter" data-level="3.1.3" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#tasks"><i class="fa fa-check"></i><b>3.1.3</b> Tasks</a></li>
<li class="chapter" data-level="3.1.4" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#scheduling"><i class="fa fa-check"></i><b>3.1.4</b> Scheduling</a></li>
<li class="chapter" data-level="3.1.5" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#xcom"><i class="fa fa-check"></i><b>3.1.5</b> XCom</a></li>
<li class="chapter" data-level="3.1.6" data-path="fundamental-concepts.html"><a href="fundamental-concepts.html#taskflow"><i class="fa fa-check"></i><b>3.1.6</b> Taskflow</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="exemplary-ml-workflow.html"><a href="exemplary-ml-workflow.html"><i class="fa fa-check"></i><b>3.2</b> Exemplary ML workflow</a></li>
<li class="chapter" data-level="3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html"><i class="fa fa-check"></i><b>3.3</b> Airflow infrastructure</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#airflow-as-a-distributed-system"><i class="fa fa-check"></i><b>3.3.1</b> Airflow as a distributed system</a></li>
<li class="chapter" data-level="3.3.2" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#scheduler-1"><i class="fa fa-check"></i><b>3.3.2</b> Scheduler</a></li>
<li class="chapter" data-level="3.3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#webserver"><i class="fa fa-check"></i><b>3.3.3</b> Webserver</a></li>
<li class="chapter" data-level="3.3.4" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#executor"><i class="fa fa-check"></i><b>3.3.4</b> Executor</a></li>
<li class="chapter" data-level="3.3.5" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#dag-directory"><i class="fa fa-check"></i><b>3.3.5</b> DAG Directory</a></li>
<li class="chapter" data-level="3.3.6" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#metadata-database"><i class="fa fa-check"></i><b>3.3.6</b> Metadata Database</a></li>
=======
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preamble</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#topics"><i class="fa fa-check"></i>Topics</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#a-work-in-progress"><i class="fa fa-check"></i>A work in progress</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>2</b> Terraform</a>
<ul>
<li class="chapter" data-level="2.1" data-path="terraform.html"><a href="terraform.html#prerequisites"><i class="fa fa-check"></i><b>2.1</b> Prerequisites</a></li>
<li class="chapter" data-level="2.2" data-path="terraform.html"><a href="terraform.html#basic-usage"><i class="fa fa-check"></i><b>2.2</b> Basic usage</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="terraform.html"><a href="terraform.html#terraform-init"><i class="fa fa-check"></i><b>2.2.1</b> terraform init</a></li>
<li class="chapter" data-level="2.2.2" data-path="terraform.html"><a href="terraform.html#terraform-validate"><i class="fa fa-check"></i><b>2.2.2</b> terraform validate</a></li>
<li class="chapter" data-level="2.2.3" data-path="terraform.html"><a href="terraform.html#terraform-plan"><i class="fa fa-check"></i><b>2.2.3</b> terraform plan</a></li>
<li class="chapter" data-level="2.2.4" data-path="terraform.html"><a href="terraform.html#terraform-apply"><i class="fa fa-check"></i><b>2.2.4</b> terraform apply</a></li>
<li class="chapter" data-level="2.2.5" data-path="terraform.html"><a href="terraform.html#terraform-destroy"><i class="fa fa-check"></i><b>2.2.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="terraform.html"><a href="terraform.html#core-concepts"><i class="fa fa-check"></i><b>2.3</b> Core Concepts</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="terraform.html"><a href="terraform.html#providers"><i class="fa fa-check"></i><b>2.3.1</b> Providers</a></li>
<li class="chapter" data-level="2.3.2" data-path="terraform.html"><a href="terraform.html#resources"><i class="fa fa-check"></i><b>2.3.2</b> Resources</a></li>
<li class="chapter" data-level="2.3.3" data-path="terraform.html"><a href="terraform.html#data-sources"><i class="fa fa-check"></i><b>2.3.3</b> Data Sources</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="terraform.html"><a href="terraform.html#state"><i class="fa fa-check"></i><b>2.4</b> State</a></li>
<li class="chapter" data-level="2.5" data-path="terraform.html"><a href="terraform.html#modules"><i class="fa fa-check"></i><b>2.5</b> Modules</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="terraform.html"><a href="terraform.html#input-variables"><i class="fa fa-check"></i><b>2.5.1</b> Input Variables</a></li>
<li class="chapter" data-level="2.5.2" data-path="terraform.html"><a href="terraform.html#output-variables"><i class="fa fa-check"></i><b>2.5.2</b> Output Variables</a></li>
<li class="chapter" data-level="2.5.3" data-path="terraform.html"><a href="terraform.html#local-variables"><i class="fa fa-check"></i><b>2.5.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="terraform.html"><a href="terraform.html#additional-tips-tricks"><i class="fa fa-check"></i><b>2.6</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="terraform.html"><a href="terraform.html#count"><i class="fa fa-check"></i><b>2.6.1</b> count</a></li>
<li class="chapter" data-level="2.6.2" data-path="terraform.html"><a href="terraform.html#for-each"><i class="fa fa-check"></i><b>2.6.2</b> for-each</a></li>
<li class="chapter" data-level="2.6.3" data-path="terraform.html"><a href="terraform.html#for"><i class="fa fa-check"></i><b>2.6.3</b> for</a></li>
<li class="chapter" data-level="2.6.4" data-path="terraform.html"><a href="terraform.html#workspaces"><i class="fa fa-check"></i><b>2.6.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="terraform.html"><a href="terraform.html#putting-it-together"><i class="fa fa-check"></i><b>2.7</b> Putting it together</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>3</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="3.1" data-path="kubernetes.html"><a href="kubernetes.html#prerequisites-1"><i class="fa fa-check"></i><b>3.1</b> Prerequisites</a></li>
<li class="chapter" data-level="3.2" data-path="kubernetes.html"><a href="kubernetes.html#nodes"><i class="fa fa-check"></i><b>3.2</b> Nodes</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="kubernetes.html"><a href="kubernetes.html#master-control-plane"><i class="fa fa-check"></i><b>3.2.1</b> Master &amp; Control Plane</a></li>
<li class="chapter" data-level="3.2.2" data-path="kubernetes.html"><a href="kubernetes.html#worker-nodes"><i class="fa fa-check"></i><b>3.2.2</b> Worker Nodes</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="kubernetes.html"><a href="kubernetes.html#pods"><i class="fa fa-check"></i><b>3.3</b> Pods</a>
<ul>
<li class="chapter" data-level="" data-path="kubernetes.html"><a href="kubernetes.html#imperative-declarative-management"><i class="fa fa-check"></i>Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="kubernetes.html"><a href="kubernetes.html#deployments"><i class="fa fa-check"></i><b>3.4</b> Deployments</a></li>
<li class="chapter" data-level="3.5" data-path="kubernetes.html"><a href="kubernetes.html#services"><i class="fa fa-check"></i><b>3.5</b> Services</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="kubernetes.html"><a href="kubernetes.html#exemplary-setup-of-database-and-frontend-microservices"><i class="fa fa-check"></i><b>3.5.1</b> Exemplary setup of database and frontend microservices</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="kubernetes.html"><a href="kubernetes.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>3.6</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="3.7" data-path="kubernetes.html"><a href="kubernetes.html#namespaces"><i class="fa fa-check"></i><b>3.7</b> Namespaces</a></li>
<li class="chapter" data-level="3.8" data-path="kubernetes.html"><a href="kubernetes.html#service-discovery"><i class="fa fa-check"></i><b>3.8</b> Service Discovery</a></li>
<li class="chapter" data-level="3.9" data-path="kubernetes.html"><a href="kubernetes.html#volume-storage"><i class="fa fa-check"></i><b>3.9</b> Volume &amp; Storage</a>
<ul>
<li class="chapter" data-level="3.9.1" data-path="kubernetes.html"><a href="kubernetes.html#emptydir-volume"><i class="fa fa-check"></i><b>3.9.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="3.9.2" data-path="kubernetes.html"><a href="kubernetes.html#hostpath-volume"><i class="fa fa-check"></i><b>3.9.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="3.9.3" data-path="kubernetes.html"><a href="kubernetes.html#persistent-volumes"><i class="fa fa-check"></i><b>3.9.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="3.10" data-path="kubernetes.html"><a href="kubernetes.html#configmaps"><i class="fa fa-check"></i><b>3.10</b> ConfigMaps</a></li>
<li class="chapter" data-level="3.11" data-path="kubernetes.html"><a href="kubernetes.html#secrets"><i class="fa fa-check"></i><b>3.11</b> Secrets</a>
<ul>
<li class="chapter" data-level="3.11.1" data-path="kubernetes.html"><a href="kubernetes.html#exemplary-use-case-of-secrets"><i class="fa fa-check"></i><b>3.11.1</b> Exemplary use case of secrets</a></li>
</ul></li>
<li class="chapter" data-level="3.12" data-path="kubernetes.html"><a href="kubernetes.html#health-checks"><i class="fa fa-check"></i><b>3.12</b> Health Checks</a>
<ul>
<li class="chapter" data-level="3.12.1" data-path="kubernetes.html"><a href="kubernetes.html#liveness-probe"><i class="fa fa-check"></i><b>3.12.1</b> Liveness Probe</a></li>
<li class="chapter" data-level="3.12.2" data-path="kubernetes.html"><a href="kubernetes.html#readiness-probe"><i class="fa fa-check"></i><b>3.12.2</b> Readiness Probe</a></li>
</ul></li>
<li class="chapter" data-level="3.13" data-path="kubernetes.html"><a href="kubernetes.html#resource-management"><i class="fa fa-check"></i><b>3.13</b> Resource Management</a></li>
<li class="chapter" data-level="3.14" data-path="kubernetes.html"><a href="kubernetes.html#daemon-sets"><i class="fa fa-check"></i><b>3.14</b> Daemon Sets</a></li>
<li class="chapter" data-level="3.15" data-path="kubernetes.html"><a href="kubernetes.html#statefulsets"><i class="fa fa-check"></i><b>3.15</b> StatefulSets</a></li>
<li class="chapter" data-level="3.16" data-path="kubernetes.html"><a href="kubernetes.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>3.16</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mlflow.html"><a href="mlflow.html"><i class="fa fa-check"></i><b>4</b> MLflow</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mlflow.html"><a href="mlflow.html#fundamental-concept"><i class="fa fa-check"></i><b>4.1</b> Fundamental Concept</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="mlflow.html"><a href="mlflow.html#mlflow-tracking"><i class="fa fa-check"></i><b>4.1.1</b> MLflow Tracking</a></li>
<li class="chapter" data-level="4.1.2" data-path="mlflow.html"><a href="mlflow.html#mlflow-models"><i class="fa fa-check"></i><b>4.1.2</b> MLflow Models</a></li>
<li class="chapter" data-level="4.1.3" data-path="mlflow.html"><a href="mlflow.html#mlflow-model-registry"><i class="fa fa-check"></i><b>4.1.3</b> MLflow Model Registry</a></li>
<li class="chapter" data-level="4.1.4" data-path="mlflow.html"><a href="mlflow.html#mlflow-projects"><i class="fa fa-check"></i><b>4.1.4</b> MLflow Projects</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="mlflow.html"><a href="mlflow.html#mlfflow-architecture"><i class="fa fa-check"></i><b>4.2</b> MLFflow Architecture</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="mlflow.html"><a href="mlflow.html#mlflow-tracking-server"><i class="fa fa-check"></i><b>4.2.1</b> MLflow Tracking Server</a></li>
<li class="chapter" data-level="4.2.2" data-path="mlflow.html"><a href="mlflow.html#mlflow-backend-store"><i class="fa fa-check"></i><b>4.2.2</b> MLflow Backend Store</a></li>
<li class="chapter" data-level="4.2.3" data-path="mlflow.html"><a href="mlflow.html#mlflow-artifact-store"><i class="fa fa-check"></i><b>4.2.3</b> MLflow Artifact Store</a></li>
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Engineering</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<<<<<<< HEAD
<div id="terraform" class="section level1 hasAnchor" number="1">
<h1><span class="header-section-number">Chapter 1</span> Terraform<a href="terraform.html#terraform" class="anchor-section" aria-label="Anchor link to header"></a></h1>
=======
<div id="terraform" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> Terraform<a href="terraform.html#terraform" class="anchor-section" aria-label="Anchor link to header"></a></h1>
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
<p>Terraform is an open-source, declarative programming language developed by HashiCorp and allows to create both on-prem and cloud resources in the form of writing code. This is also know as Infrastructure as Code (IAC). There are several IaC tools in the market today and Terraform is only one of them. Yet it is a well known and established tool and during the course of this project we only focus on this.</p>
Hashicorp describes that:
<blockquote>
Terraform is an infrastructure as code (IaC) tool that allows you to build, change, and version infrastructure safely and efficiently. This includes both low-level components like compute instances, storage, and networking, as well as high-level components like DNS entries and SaaS features. <span class="citation">(<a href="#ref-hashicorpwebsite" role="doc-biblioref"><strong>hashicorpwebsite?</strong></a>)</span> (<a href="https://www.terraform.io/docs" class="uri">https://www.terraform.io/docs</a>)
</blockquote>
<p>This means that users are able to manage and provision an entire IT infrastructure using machine-readable definition files and thus allowing faster execution when configuring infrastructure, as well as enableing full traceability of changes. Terraform comes with several hundred different providers that can be used to provision infrastructure, such as Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, etc.</p>
<p>The given chapter introduces the concepts &amp; usage of Terraform which will be needed to create the introduced MLOps Airflow deployment in an automated and tracable way. We will learn how to use Terraform to provision ressources as well as to structure a Terraform Project.</p>
<<<<<<< HEAD
<div id="prerequisites" class="section level3 unlisted unnumbered hasAnchor">
<h3>Prerequisites<a href="terraform.html#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To be able to follow this tutorial, one needs to have the AWS CLI installed as well as the AWS credentials set up. Needles to say an AWS accounts needs to be present. It is also recommended to have basic knowledge of the AWS Cloud as this tutorials used the AWS infrastructure to provision cloud resources. The attached resource definitions are specified to the AWS region <code>eu-central-1</code>. It might be necessary to change accordingly if you are set in another region.
Further, Terraform itself needs to be installed. Please refer to the corresponding sites. The scripts are run under Terraform version <code>v1.2.4</code>. Later releases might have breaking changes. One can check its installation via <code>terraform version</code>.</p>
=======
<div id="prerequisites" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Prerequisites<a href="terraform.html#prerequisites" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To be able to follow this tutorial, one needs to have the AWS CLI installed as well as the AWS credentials set up. Needles to say an AWS accounts needs to be present. It is also recommended to have basic knowledge of the AWS Cloud as this tutorials used the AWS infrastructure to provision cloud resources. The attached resource definitions are specified to the AWS region <code>eu-central-1</code>. It might be necessary to change accordingly if you are set in another region.
Further, Terraform itself needs to be installed. Please refer to the corresponding sites. The scripts are run under Terraform version <code>v1.2.4</code>. Later releases might have breaking changes. One can check its installation via <code>terraform version</code>.</p>
</div>
<div id="basic-usage" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Basic usage<a href="terraform.html#basic-usage" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A Terraform project is basically just a set of files in a directory containing resource definitions of cloud ressources to be created. Those Terraform files, denoted by the ending <code>.tf</code>, use Terraform’s configuration language to define the specified resources. In the following example there are two definitions made: a <code>provider</code> and a <code>resource</code>. Later in this chapter we will dive deeper in the structure of the language. For now, we only need to know this script is creating a file called <code>hello.txt</code> that includes the text <code>"Hello, Terraform"</code>. It’s our Terraform version of Hello World!</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="terraform.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">provider</span> <span class="st">&quot;local&quot;</span> {</span>
<span id="cb1-2"><a href="terraform.html#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">version</span> = <span class="st">&quot;~&gt; 1.4&quot;</span></span>
<span id="cb1-3"><a href="terraform.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb1-4"><a href="terraform.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;local_file&quot;</span> <span class="st">&quot;hello&quot;</span> {</span>
<span id="cb1-5"><a href="terraform.html#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">content</span> = <span class="st">&quot;Hello, Terraform&quot;</span></span>
<span id="cb1-6"><a href="terraform.html#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">filename</span> = <span class="st">&quot;hello.txt&quot;</span></span>
<span id="cb1-7"><a href="terraform.html#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div id="terraform-init" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> terraform init<a href="terraform.html#terraform-init" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When a project is run for the first time the terraform project needs to be initialized. This is done via the <code>terraform init</code> command. Terraform scans the project files in this step and downloads any required providers needed (more details to providers in a following section). In the given example this is the local procider.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="terraform.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializes the working directory which consists of all the configuration files</span></span>
<span id="cb2-2"><a href="terraform.html#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> init</span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/terraform-init.png" alt="" />
<p class="caption">Terraform init</p>
</div>
</div>
<div id="terraform-validate" class="section level3 hasAnchor" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> terraform validate<a href="terraform.html#terraform-validate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>terraform validate</code> command checks the code for syntax errors. This is optional yet a way to handle initial errors or minor careless mistakes</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="terraform.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Validates the configuration files in a directory</span></span>
<span id="cb3-2"><a href="terraform.html#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> validate</span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/terraform-validate.png" alt="" />
<p class="caption">Terraform validate</p>
</div>
</div>
<div id="terraform-plan" class="section level3 hasAnchor" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> terraform plan<a href="terraform.html#terraform-plan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>terraform plan</code> command verifies what action Terraform will perform and what resources will be created. This step is basically a <em>dry run</em> of the code to be executed. It also returns the provided values and some permission attributes which have been set.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="terraform.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates an execution plan to reach a desired state of the infrastructure</span></span>
<span id="cb4-2"><a href="terraform.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> plan</span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/terraform-plan.png" alt="" />
<p class="caption">Terraform plan</p>
</div>
</div>
<div id="terraform-apply" class="section level3 hasAnchor" number="2.2.4">
<h3><span class="header-section-number">2.2.4</span> terraform apply<a href="terraform.html#terraform-apply" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The command <code>Terraform apply</code> creates the resource specified in the <code>.tf</code> files. Initially, the same output as in the <code>terraform plan</code> step is shown (hence its <em>dry run</em>). The output further states which resources are added, which will be changed, and which resources will be destroyed. After confirming the actions the resource creation will be executed.</p>
<p>Modifications to previously deployed ressources can be implemented by using <code>terraform apply</code> again. The output will denote that there are resources to change.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="terraform.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Provision the changes in the infrastructure as defined in the plan</span></span>
<span id="cb5-2"><a href="terraform.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> apply </span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/terraform-apply.png" alt="" />
<p class="caption">Terraform apply</p>
</div>
</div>
<div id="terraform-destroy" class="section level3 hasAnchor" number="2.2.5">
<h3><span class="header-section-number">2.2.5</span> terraform destroy<a href="terraform.html#terraform-destroy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To destoy all created ressouces and to delete everything we did before, there is a <code>terraform destroy</code> command.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="terraform.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deletes all the old infrastructure resources</span></span>
<span id="cb6-2"><a href="terraform.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> destroy</span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/terraform-destroy.png" alt="" />
<p class="caption">Terraform destroy</p>
</div>
</div>
</div>
<div id="core-concepts" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Core Concepts<a href="terraform.html#core-concepts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following section will explain the core concepts and building blocks of Terraform. This will enable you to build your very first Terraform definition files.</p>
<div id="providers" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Providers<a href="terraform.html#providers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Terraform relies on plugins called providers to interact with Cloud providers, SaaS providers, and other APIs. Each provider adds specific resource types and/or data sources that can be managed by Terraform. For example, the <code>aws</code> provider shown below allows to specify resources related to the AWS Cloud such as S3 Buckets or EC3 Instances.</p>
<p>Depending on the provider it is necessary to supply it with specific parameters. The aws provier for example needs the <code>region</code> as well as username and password. If nothing is specified it will automatically pull these information from the <em>AWS CLI</em> and the credentials specified under the directory <code>.aws/config</code>. It is also a best practice to specify the version of the provider, as the providers are usually maintained and updated on a regular basis.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="terraform.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">provider</span> <span class="st">&quot;aws&quot;</span> {</span>
<span id="cb7-2"><a href="terraform.html#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">region</span> = <span class="st">&quot;us-east-1&quot;</span></span>
<span id="cb7-3"><a href="terraform.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="resources" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Resources<a href="terraform.html#resources" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A <em>resource</em> is the core building block when working with Terraform. It can be a <code>"local_file"</code> such as shown in the example above, or a cloud resource such as an <code>"aws_instance"</code> on aws. The resource type is followed by the custom name of the resource in Terraform. Resource definitions are usually specified in the <code>main.tf</code>file. Each customization and setting to a ressource is done within its resource specification. The style convention when writing Terraform code states that the resource name is named in lowercase as well as it should not repeat the resource type. An example can be seen below</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="terraform.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ressource type: aws_instance</span></span>
<span id="cb8-2"><a href="terraform.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ressource name: my-instance</span></span>
<span id="cb8-3"><a href="terraform.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_instance&quot;</span> <span class="st">&quot;my-instance&quot;</span> {</span>
<span id="cb8-4"><a href="terraform.html#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># resource specification</span></span>
<span id="cb8-5"><a href="terraform.html#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ami</span>           = <span class="st">&quot;ami-0ddbdea833a8d2f0d&quot;</span></span>
<span id="cb8-6"><a href="terraform.html#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">instance_type</span> = <span class="st">&quot;t2.micro&quot;</span></span>
<span id="cb8-7"><a href="terraform.html#cb8-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-8"><a href="terraform.html#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">tags</span> = {</span>
<span id="cb8-9"><a href="terraform.html#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Name</span> = <span class="st">&quot;my-instance&quot;</span></span>
<span id="cb8-10"><a href="terraform.html#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ManagedBy</span> = <span class="st">&quot;Terraform&quot;</span></span>
<span id="cb8-11"><a href="terraform.html#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb8-12"><a href="terraform.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="data-sources" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Data Sources<a href="terraform.html#data-sources" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><em>Data sources</em> in Terraform are “read-only” resources, meaning that it is possible to get information about existing data sources but not to create or change them. They are usually used to fetch parameters needed to create resources or generally for using parameters elsewhere in Terraform configuration.</p>
<p>A typical example is shown below as the <code>"aws_ami"</code> data source available in the AWS provider. This data source is used to recover attributes from an existing AMI (Amazon Machine Image). The example creates a data source called <code>"ubuntu”</code> that queries the AMI registry and returns several attributes related to the located image.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="terraform.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">data</span> <span class="st">&quot;aws_ami&quot;</span> <span class="st">&quot;ubuntu&quot;</span> {</span>
<span id="cb9-2"><a href="terraform.html#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">most_recent</span> = true</span>
<span id="cb9-3"><a href="terraform.html#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">filter</span> {</span>
<span id="cb9-4"><a href="terraform.html#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">name</span>   = <span class="st">&quot;name&quot;</span></span>
<span id="cb9-5"><a href="terraform.html#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">values</span> = [<span class="st">&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-*&quot;</span>]</span>
<span id="cb9-6"><a href="terraform.html#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb9-7"><a href="terraform.html#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">filter</span> {</span>
<span id="cb9-8"><a href="terraform.html#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">name</span>   = <span class="st">&quot;virtualization-type&quot;</span></span>
<span id="cb9-9"><a href="terraform.html#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">values</span> = [<span class="st">&quot;hvm&quot;</span>]</span>
<span id="cb9-10"><a href="terraform.html#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb9-11"><a href="terraform.html#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">owners</span> = [<span class="st">&quot;099720109477&quot;</span>] <span class="co"># Canonical</span></span>
<span id="cb9-12"><a href="terraform.html#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>Data sources and their attributes can be used in resource definitions by prepending the <code>data</code> prefix to the attribute name. The following example used the <code>"aws_ami"</code> data source within an <code>"aws_instace"</code> resource.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="terraform.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_instance&quot;</span> <span class="st">&quot;web&quot;</span> {</span>
<span id="cb10-2"><a href="terraform.html#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ami</span> = data.aws_ami.ubuntu.id </span>
<span id="cb10-3"><a href="terraform.html#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">instance_type</span> = <span class="st">&quot;t2.micro&quot;</span></span>
<span id="cb10-4"><a href="terraform.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
</div>
<div id="state" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> State<a href="terraform.html#state" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A Terraform state stores all details about the resources and data created within a given context. Whenever a resource is create terrafrom stores its identifier in the statefile <code>terraform.tfstate</code>.
Providing information about already existing resources is the primary purpose of the statefile. Whenever a Terraform script is applied or whenever the resource definitions are modified, Terraform knows what to create, change, or delete based on the existing entries within the statefile. Everything specified and provisioned within Terraform will be stored in the statefile. This should be kept in mind and detain to store sensitive information such as initial passwords.</p>
<p>Terraform uses the concept of a backend to store and retrieve its statefile. The default backend is the local backend which means to store the statefile in the project’s root folder. However, we can also configure an alternative (remote) backend to store it elsewhere. The backend can be declared within a <code>terraform</code> block in the project files. The given example stores the statefile in an AWS S3 Bucket callen <code>some-bucket</code>. Keep in mind this needs access to an AWS account and also needs the AWS provider of terraform.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="terraform.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">terraform</span> {</span>
<span id="cb11-2"><a href="terraform.html#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">backend</span> <span class="st">&quot;s3&quot;</span> {</span>
<span id="cb11-3"><a href="terraform.html#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">bucket</span> = <span class="st">&quot;some-bucket&quot;</span></span>
<span id="cb11-4"><a href="terraform.html#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">key</span> = <span class="st">&quot;some-storage-key&quot;</span></span>
<span id="cb11-5"><a href="terraform.html#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">region</span> = <span class="st">&quot;us-east-1&quot;</span></span>
<span id="cb11-6"><a href="terraform.html#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb11-7"><a href="terraform.html#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="modules" class="section level2 hasAnchor" number="2.5">
<h2><span class="header-section-number">2.5</span> Modules<a href="terraform.html#modules" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A Terraform module allows to reuse resources in multiple places throughout the project. They act as a container to package resource configurations. Much like in standard programming languages, Terraform code can be organized across multiple files and packages instead of having one single file containing all the code. Wrapping code into a module not only allows to reuse it throughout the project, but also in different environments, for example when deploying a <em>dev</em> and a <em>prod</em> infrastructure. Both environments can reuse code from the same module, just with different settings.</p>
<p>A Terraform module is build as a directory containing one or more resource definition files. Basically, when putting all our code in a single directory, we already have a module. This is exactly what we did in our previous examples. However, terraform does not include subdirectories on its own. Subdirectories must be called explicitly using a terraform <code>module</code>parameter. The example below references a module located in a <code>./network</code> subdirectory and passes two parameters to it.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="terraform.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># main.tf</span></span>
<span id="cb12-2"><a href="terraform.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="st">&quot;network&quot;</span> {</span>
<span id="cb12-3"><a href="terraform.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">source</span> = <span class="st">&quot;./networking&quot;</span></span>
<span id="cb12-4"><a href="terraform.html#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">create_public_ip</span> = true</span>
<span id="cb12-5"><a href="terraform.html#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">environment</span> = <span class="st">&quot;prod&quot;</span></span>
<span id="cb12-6"><a href="terraform.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>Each module consists of a similar file structure as the root directory. This includes a <code>main.tf</code> where all resources are specified, as well as files for different data sources such as <code>variables.tf</code> and <code>outputs.tf</code>. However, providers are usually configured only in the root module and are not reused in modules. Note that there are different approaches on where to specify the providers. They are either specified in the <code>main.tf</code> or a separate <code>providers.tf</code>. It does not make a difference for Terraform as it does not distinguish between the resource definition files. It is merely a strategy to keep code and project in a clean and consistent structure.</p>
<pre><code>root
│   main.tf
│   variables.tf
│   outputs.tf
│
└── networking
    │   main.tf
    │   variables.tf
    │   outputs.tf</code></pre>
<div id="input-variables" class="section level3 hasAnchor" number="2.5.1">
<h3><span class="header-section-number">2.5.1</span> Input Variables<a href="terraform.html#input-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each module can have multiple <em>Input Variables</em>. Input Variables serve as parameters for a Terraform module so users can customize behavior without editing the source. In the previous example of importing a <code>network</code> module, there have been two input variables specified, <code>create_public_ip</code> and <code>environment</code>. Input variables are usually specified in the <code>variables.tf</code> file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="terraform.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variables.tf</span></span>
<span id="cb14-2"><a href="terraform.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">variable</span> <span class="st">&quot;instance_name&quot;</span> {</span>
<span id="cb14-3"><a href="terraform.html#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">type</span> = string</span>
<span id="cb14-4"><a href="terraform.html#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">default</span> = <span class="st">&quot;awesome-instance&quot;</span></span>
<span id="cb14-5"><a href="terraform.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">description</span> = <span class="st">&quot;Name of the aws instance to be created&quot;</span></span>
<span id="cb14-6"><a href="terraform.html#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>Each variable has a type (e.g. <code>string</code>, <code>map</code>, <code>set</code>, <code>boolen</code>) and may have a <code>default</code> value and <code>description</code>. Any variable that has no default must be supplied with a value when calling the <code>module</code> reference. This means that variables defined at the root module need values assigned to as a requirement so Terraform will not fail. This can be done by different resources, for example</p>
<ul>
<li>a variable’s <code>default</code> value</li>
<li>via the command line using the <code>terraform apply -var="variable=value"</code>option</li>
<li>via environment variables starting with <code>TF_VAR_</code>; Terraform will check them automatically</li>
<li>a <code>.tfvars</code> file where the variable values are specified; Terraform can load variable definitions from these files automatically (please check online resources for further insights)</li>
</ul>
<p>Variables can be used in expressions using the <code>var.</code>prefix such as shown in below example. We use the resource configuration of the previous example to create an <code>aws_instance</code> but this time its name is provided by an input variable.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="terraform.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># main.tf</span></span>
<span id="cb15-2"><a href="terraform.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_instance&quot;</span> <span class="st">&quot;awesome-instance&quot;</span> {</span>
<span id="cb15-3"><a href="terraform.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ami</span>           = <span class="st">&quot;ami-0ddbdea833a8d2f0d&quot;</span></span>
<span id="cb15-4"><a href="terraform.html#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">instance_type</span> = <span class="st">&quot;t2.micro&quot;</span></span>
<span id="cb15-5"><a href="terraform.html#cb15-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-6"><a href="terraform.html#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">tags</span> = {</span>
<span id="cb15-7"><a href="terraform.html#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Name</span> = var.instance_name</span>
<span id="cb15-8"><a href="terraform.html#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb15-9"><a href="terraform.html#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="output-variables" class="section level3 hasAnchor" number="2.5.2">
<h3><span class="header-section-number">2.5.2</span> Output Variables<a href="terraform.html#output-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Similar to Input variables, a terraform module has <em>output variables</em>. As their name states, output variables return values of a Terraform module and are denoted in the <em>outputs.tf</em> file as expected. A module’s consumer has no access to any resources or data created within the module itself. However, sometimes a modules attrivutes are needed for another module or resource. Output variables address this issue by exposing a defined subset of the created resources.</p>
<p>The example below defines an output value <em>instance_address</em> containing the IP address of an EC2 instance the we create with a module. Any module that reference this module can use the <em>instance_address</em> value by referencing it via <em>module.module_name.instance_address</em></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="terraform.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs.tf</span></span>
<span id="cb16-2"><a href="terraform.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> <span class="st">&quot;instance_address&quot;</span> {</span>
<span id="cb16-3"><a href="terraform.html#cb16-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">value</span> = aws_instance.awesome-instance.private_ip</span>
<span id="cb16-4"><a href="terraform.html#cb16-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">description</span> = <span class="st">&quot;Web server&#39;s private IP address&quot;</span></span>
<span id="cb16-5"><a href="terraform.html#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/outputs.png" title="outputs" alt="" />
<p class="caption">outputs</p>
</div>
</div>
<div id="local-variables" class="section level3 hasAnchor" number="2.5.3">
<h3><span class="header-section-number">2.5.3</span> Local Variables<a href="terraform.html#local-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Additionally to Input variables and output variables a module provides the use of local variables. Local values are basically just a convenience feature to assign a shorter name to an expression and work like standard variables. This means theor scope is also limited to the module they are declared in. Using local variables reduces code repetitions which can be especially valuable when dealing with output variables from a module.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="terraform.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># main.tf</span></span>
<span id="cb17-2"><a href="terraform.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">locals</span> {</span>
<span id="cb17-3"><a href="terraform.html#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">vpc_id</span> = module.network.vpc_id</span>
<span id="cb17-4"><a href="terraform.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb17-5"><a href="terraform.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="st">&quot;network&quot;</span> {</span>
<span id="cb17-6"><a href="terraform.html#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">source</span> = <span class="st">&quot;./network&quot;</span></span>
<span id="cb17-7"><a href="terraform.html#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb17-8"><a href="terraform.html#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="st">&quot;service1&quot;</span> {</span>
<span id="cb17-9"><a href="terraform.html#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">source</span> = <span class="st">&quot;./service1&quot;</span></span>
<span id="cb17-10"><a href="terraform.html#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">vpc_id</span> = local.vpc_id</span>
<span id="cb17-11"><a href="terraform.html#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb17-12"><a href="terraform.html#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="st">&quot;service2&quot;</span> {</span>
<span id="cb17-13"><a href="terraform.html#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">source</span> = <span class="st">&quot;./service2&quot;</span></span>
<span id="cb17-14"><a href="terraform.html#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">vpc_id</span> = local.vpc_id</span>
<span id="cb17-15"><a href="terraform.html#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
</div>
<div id="additional-tips-tricks" class="section level2 hasAnchor" number="2.6">
<h2><span class="header-section-number">2.6</span> Additional tips &amp; tricks<a href="terraform.html#additional-tips-tricks" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Of course there is much more to Terraform than these small examples can provide. Yet there are also some contrains when working with Terraform or declarative languages in general. Typically they do not have for-loops or other traditional procedural logic built into the language to repeat a piece of logic or conditional if-statements to configure reasources on demand. However, there are ways there are some ways to deal with this issue and to create multiple respurces without copy and paste.</p>
<p>Terraform comes with different looping constructs, each used slightly different. The <em>count</em> and <em>for_each</em> meta arguments enable us to create multiple instances of a resource.</p>
<div id="count" class="section level3 hasAnchor" number="2.6.1">
<h3><span class="header-section-number">2.6.1</span> count<a href="terraform.html#count" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Count can be used to loop over any resource and module. Every Terraform resource has a meta-parameter <em>count</em> one can use. Count is the simplest, and most limited iteration construct and all it does is to define how many copies to create of a resource. When creating multiple instance with one specification, the problem is that each instance must have a unique name, otherwise Terraform would cause an error. Therefore we need to index the meta-parameter just like doing it in a for-loop to give each resource a unique name. The example below shows how to do this on an AWS IAM user.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="terraform.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_iam_user&quot;</span> <span class="st">&quot;example&quot;</span> {</span>
<span id="cb18-2"><a href="terraform.html#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">count</span> = 2</span>
<span id="cb18-3"><a href="terraform.html#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>  = <span class="st">&quot;neo.</span><span class="va">${count</span><span class="er">.index</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb18-4"><a href="terraform.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_count.png" alt="" />
<p class="caption">count</p>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="terraform.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">variable</span> <span class="st">&quot;user_names&quot;</span> {</span>
<span id="cb19-2"><a href="terraform.html#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">description</span> = <span class="st">&quot;Create IAM users with these names&quot;</span></span>
<span id="cb19-3"><a href="terraform.html#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">type</span>        = list<span class="er">(</span><span class="ex">string</span><span class="kw">)</span></span>
<span id="cb19-4"><a href="terraform.html#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">default</span>     = [<span class="st">&quot;adam&quot;</span>, <span class="st">&quot;eve&quot;</span>, <span class="st">&quot;snake&quot;</span>, <span class="st">&quot;apple&quot;</span>]</span>
<span id="cb19-5"><a href="terraform.html#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb19-6"><a href="terraform.html#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="terraform.html#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_iam_user&quot;</span> <span class="st">&quot;example&quot;</span> {</span>
<span id="cb19-8"><a href="terraform.html#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">count</span> = length<span class="er">(</span><span class="ex">var.user_names</span><span class="kw">)</span> <span class="co"># returns the number of items in the given array</span></span>
<span id="cb19-9"><a href="terraform.html#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>  = var.user_names[count.index]</span>
<span id="cb19-10"><a href="terraform.html#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_count_list.png" alt="" />
<p class="caption">count list</p>
</div>
<p>After using count on a resource it becomes an array of resources rather than one single resource. The same hold when using count on modules. When adding count to a module it turns it into an array of modules.</p>
<p>This can round into problems because the way Terraform identifies each resource within the array is by its index. Now, when removing an item from the middle of the array, all items after it shift one index back. This will result in Terraform deleting every resource after that item and then re-creating these resources again from scratch</p>
<p>So after running <code>terraform plan</code> with just three names, Terraform’s internal representation will look like this:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="terraform.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">variable</span> <span class="st">&quot;user_names&quot;</span> {</span>
<span id="cb20-2"><a href="terraform.html#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">description</span> = <span class="st">&quot;Create IAM users with these names&quot;</span></span>
<span id="cb20-3"><a href="terraform.html#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">type</span>        = list<span class="er">(</span><span class="ex">string</span><span class="kw">)</span></span>
<span id="cb20-4"><a href="terraform.html#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">default</span>     = [<span class="st">&quot;adam&quot;</span>, <span class="st">&quot;eve&quot;</span>, <span class="st">&quot;apple&quot;</span>]</span>
<span id="cb20-5"><a href="terraform.html#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb20-6"><a href="terraform.html#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="terraform.html#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_iam_user&quot;</span> <span class="st">&quot;example&quot;</span> {</span>
<span id="cb20-8"><a href="terraform.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">count</span> = length<span class="er">(</span><span class="ex">var.user_names</span><span class="kw">)</span> <span class="co"># returns the number of items in the given array</span></span>
<span id="cb20-9"><a href="terraform.html#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>  = var.user_names[count.index]</span>
<span id="cb20-10"><a href="terraform.html#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_count_index_deletion.png" alt="" />
<p class="caption">count index deletion</p>
</div>
<p><strong>Count as conditional</strong>
Count can also be used as a form of a conditional if statement. This is possible as Terraform supports <em>conditional expressions</em>. If <code>count</code> is set to one 1, one copy of that resource is created; if set to 0, the resource is not created at all. Writing this as a conditional expression could look something like the follow, where var.enable_autoscaling is a boolean variable either set to <code>True</code> or <code>False</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="terraform.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;example-1&quot;</span> <span class="st">&quot;example&quot;</span> {</span>
<span id="cb21-2"><a href="terraform.html#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">count</span> = var.enable_autoscaling <span class="pp">?</span> 1 : 0</span>
<span id="cb21-3"><a href="terraform.html#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>  = var.user_names[count.index]</span>
<span id="cb21-4"><a href="terraform.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="for-each" class="section level3 hasAnchor" number="2.6.2">
<h3><span class="header-section-number">2.6.2</span> for-each<a href="terraform.html#for-each" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <em>for_each</em> expression allows to loop over lists, sets, and maps to create multiple copies of a resource just like the <em>count</em> meta. The main difference between them is that <em>count</em> expects a non-negative number, whereas <em>for_each</em> only accepts a list or map of values. Using the same example as above it would look like this:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="terraform.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">variable</span> <span class="st">&quot;user_names&quot;</span> {</span>
<span id="cb22-2"><a href="terraform.html#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">description</span> = <span class="st">&quot;Create IAM users with these names&quot;</span></span>
<span id="cb22-3"><a href="terraform.html#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">type</span>        = list<span class="er">(</span><span class="ex">string</span><span class="kw">)</span></span>
<span id="cb22-4"><a href="terraform.html#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">default</span>     = [<span class="st">&quot;adam&quot;</span>, <span class="st">&quot;eve&quot;</span>, <span class="st">&quot;snake&quot;</span>, <span class="st">&quot;apple&quot;</span>]</span>
<span id="cb22-5"><a href="terraform.html#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb22-6"><a href="terraform.html#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="terraform.html#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="ex">resource</span> <span class="st">&quot;aws_iam_user&quot;</span> <span class="st">&quot;example&quot;</span> {</span>
<span id="cb22-8"><a href="terraform.html#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">for_each</span> = toset<span class="er">(</span><span class="ex">var.user_names</span><span class="kw">)</span></span>
<span id="cb22-9"><a href="terraform.html#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>     = each.value</span>
<span id="cb22-10"><a href="terraform.html#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb22-11"><a href="terraform.html#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="terraform.html#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> <span class="st">&quot;all_users&quot;</span> {  </span>
<span id="cb22-13"><a href="terraform.html#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">value</span> = aws_iam_user.example  </span>
<span id="cb22-14"><a href="terraform.html#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_for_each_on_list.png" alt="" />
<p class="caption">for each on list</p>
</div>
<p>Using a map of resource with the <em>for_each</em> meta rather than an array of resources as with <em>count</em> has the benefit to remove items from the middle of the collection safely and without re-creating the resources following the deleted item. Of course, the same can also be done for modules.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="terraform.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> <span class="st">&quot;users&quot;</span> {  </span>
<span id="cb23-2"><a href="terraform.html#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">source</span> = <span class="st">&quot;./iam-user&quot;</span>  </span>
<span id="cb23-3"><a href="terraform.html#cb23-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-4"><a href="terraform.html#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">for_each</span>  = toset<span class="er">(</span><span class="ex">var.user_names</span><span class="kw">)</span>  </span>
<span id="cb23-5"><a href="terraform.html#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">user_name</span> = each.value  </span>
<span id="cb23-6"><a href="terraform.html#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</div>
<div id="for" class="section level3 hasAnchor" number="2.6.3">
<h3><span class="header-section-number">2.6.3</span> for<a href="terraform.html#for" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Terraform also offers a similar functionality as python list comprehension in the form of a for expression. This should not be confused with the <em>for-each</em> expression seen above. The basic syntax is shown below to convert the list of names of previous examples in var.names to uppercase:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="terraform.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> <span class="st">&quot;upper_names&quot;</span> {</span>
<span id="cb24-2"><a href="terraform.html#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">value</span> = [for name in var.names : upper<span class="er">(</span><span class="ex">name</span><span class="kw">)</span><span class="ex">]</span></span>
<span id="cb24-3"><a href="terraform.html#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb24-4"><a href="terraform.html#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="terraform.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> <span class="st">&quot;short_upper_names&quot;</span> {</span>
<span id="cb24-6"><a href="terraform.html#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">value</span> = [for name in var.names : upper<span class="er">(</span><span class="ex">name</span><span class="kw">)</span> <span class="cf">if</span> <span class="ex">length</span><span class="er">(</span><span class="ex">name</span><span class="kw">)</span> <span class="op">&lt;</span> 5]</span>
<span id="cb24-7"><a href="terraform.html#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_for_on_list.png" alt="" />
<p class="caption">for on list</p>
</div>
<p>Using for to loop over lists and maps within a string can be used similarly. This allows us to use control statements directly withing strings using a syntax similar to string interpolation.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="terraform.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">output</span> <span class="st">&quot;for_directive&quot;</span> {  </span>
<span id="cb25-2"><a href="terraform.html#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">value</span> = <span class="st">&quot;%{ for name in var.names }</span><span class="va">${name}</span><span class="st">, %{ endfor }&quot;</span>  </span>
<span id="cb25-3"><a href="terraform.html#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<div class="figure">
<img src="images/02-Terraform/additionals_for_on_string.png" title="Bild nicht gefunden: images/02-Terraform/additionals_for_on_string.png" alt="" />
<p class="caption">Bild nicht gefunden: images/02-Terraform/additionals_for_on_string.png</p>
</div>
</div>
<div id="workspaces" class="section level3 hasAnchor" number="2.6.4">
<h3><span class="header-section-number">2.6.4</span> Workspaces<a href="terraform.html#workspaces" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Terraform workspaces allow us to keep multiple state files for the same project. When we run Terraform for the first time in a project, the generated state file will go into the <em>default</em> workspace. Later, we can create a new workspace with the <code>terraform workspace new</code> command, optionally supplying an existing state file as a parameter.</p>
<div class="figure">
<img src="images/02-Terraform/additionals_workspaces.png" alt="" />
<p class="caption">workspaces</p>
</div>
</div>
</div>
<div id="putting-it-together" class="section level2 hasAnchor" number="2.7">
<h2><span class="header-section-number">2.7</span> Putting it together<a href="terraform.html#putting-it-together" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Building a VPC with EC2 &amp; S3</strong></p>
<p>Finally, we want to put everything together and provision our own cloud infrastructure using Terraform. We will create a AWS Virtual private Cloud with EC2 Instances running on it, and S3 Buckets attached to the them. We will use <em>for_each</em> and <em>count</em> to create multiple instaces. The Terraform infrastructure is separated into three modules <em>VPS</em>, <em>EC2</em>, and <em>S3</em>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="terraform.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span></span>
<span id="cb26-2"><a href="terraform.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   main.tf</span>
<span id="cb26-3"><a href="terraform.html#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   variables.tf</span>
<span id="cb26-4"><a href="terraform.html#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   outputs.tf</span>
<span id="cb26-5"><a href="terraform.html#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span></span>
<span id="cb26-6"><a href="terraform.html#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> networking</span>
<span id="cb26-7"><a href="terraform.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   main.tf</span>
<span id="cb26-8"><a href="terraform.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   variables.tf</span>
<span id="cb26-9"><a href="terraform.html#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   outputs.tf</span>
<span id="cb26-10"><a href="terraform.html#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span></span>
<span id="cb26-11"><a href="terraform.html#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> ec2</span>
<span id="cb26-12"><a href="terraform.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   main.tf</span>
<span id="cb26-13"><a href="terraform.html#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   variables.tf</span>
<span id="cb26-14"><a href="terraform.html#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   outputs.tf</span>
<span id="cb26-15"><a href="terraform.html#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span></span>
<span id="cb26-16"><a href="terraform.html#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> s3</span>
<span id="cb26-17"><a href="terraform.html#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">│</span>   main.tf</span>
<span id="cb26-18"><a href="terraform.html#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">│</span>   variables.tf</span>
<span id="cb26-19"><a href="terraform.html#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">│</span>   outputs.tf</span></code></pre></div>
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<<<<<<< HEAD
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="basic-usage.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
=======
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="kubernetes.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
>>>>>>> 2bfcb51151c9abd391f73c2b01160286b6f58a5b
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/02-Terraform.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
