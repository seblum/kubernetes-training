<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9.2 Training &amp; Deployment Pipeline Workflow | MLOps Engineering</title>
  <meta name="description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="9.2 Training &amp; Deployment Pipeline Workflow | MLOps Engineering" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  <meta name="github-repo" content="seblum/mlops-engineering-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9.2 Training &amp; Deployment Pipeline Workflow | MLOps Engineering" />
  
  <meta name="twitter:description" content="Implementing an MLOps infrastructure with Airflow and MLFlow utilizing K8s, Terraform, and GithubActions." />
  

<meta name="author" content="Sebastian Blum" />


<meta name="date" content="2024-02-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="integrated-development-environment-1.html"/>
<link rel="next" href="training-pipeline-steps.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MLOps Engineering</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="preamble.html"><a href="preamble.html"><i class="fa fa-check"></i>Preamble</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html"><i class="fa fa-check"></i><b>1.1</b> Machine Learning Workflow</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#ml-worflow-tools"><i class="fa fa-check"></i><b>1.1.1</b> ML Worflow Tools</a></li>
<li class="chapter" data-level="1.1.2" data-path="machine-learning-workflow.html"><a href="machine-learning-workflow.html#developing-machine-learning-models"><i class="fa fa-check"></i><b>1.1.2</b> Developing Machine Learning Models</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html"><i class="fa fa-check"></i><b>1.2</b> Machine Learning Operations (MLOps)</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#ml-dev-ops"><i class="fa fa-check"></i><b>1.2.1</b> ML + (Dev)-Ops</a></li>
<li class="chapter" data-level="1.2.2" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-lifecycle"><i class="fa fa-check"></i><b>1.2.2</b> MLOps Lifecycle</a></li>
<li class="chapter" data-level="1.2.3" data-path="machine-learning-operations-mlops.html"><a href="machine-learning-operations-mlops.html#mlops-engineering"><i class="fa fa-check"></i><b>1.2.3</b> MLOps Engineering</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html"><i class="fa fa-check"></i><b>1.3</b> Roles and Tasks in MLOps</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-engineer"><i class="fa fa-check"></i><b>1.3.1</b> Data Engineer</a></li>
<li class="chapter" data-level="1.3.2" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#data-scientist"><i class="fa fa-check"></i><b>1.3.2</b> Data Scientist</a></li>
<li class="chapter" data-level="1.3.3" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#ml-engineer"><i class="fa fa-check"></i><b>1.3.3</b> ML Engineer</a></li>
<li class="chapter" data-level="1.3.4" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#mlops-engineer"><i class="fa fa-check"></i><b>1.3.4</b> MLOps Engineer</a></li>
<li class="chapter" data-level="1.3.5" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#devops-engineer"><i class="fa fa-check"></i><b>1.3.5</b> DevOps Engineer</a></li>
<li class="chapter" data-level="1.3.6" data-path="roles-and-tasks-in-mlops.html"><a href="roles-and-tasks-in-mlops.html#additional-roles-function"><i class="fa fa-check"></i><b>1.3.6</b> Additional roles &amp; function</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ops-tools-principles.html"><a href="ops-tools-principles.html"><i class="fa fa-check"></i><b>2</b> Ops Tools &amp; Principles</a>
<ul>
<li class="chapter" data-level="2.1" data-path="containerization.html"><a href="containerization.html"><i class="fa fa-check"></i><b>2.1</b> Containerization</a></li>
<li class="chapter" data-level="2.2" data-path="version-control.html"><a href="version-control.html"><i class="fa fa-check"></i><b>2.2</b> Version Control</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="version-control.html"><a href="version-control.html#github"><i class="fa fa-check"></i><b>2.2.1</b> Github</a></li>
<li class="chapter" data-level="2.2.2" data-path="version-control.html"><a href="version-control.html#git-lifecycle"><i class="fa fa-check"></i><b>2.2.2</b> Git lifecycle</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="cicd.html"><a href="cicd.html"><i class="fa fa-check"></i><b>2.3</b> CI/CD</a></li>
<li class="chapter" data-level="2.4" data-path="infrastructure-as-code.html"><a href="infrastructure-as-code.html"><i class="fa fa-check"></i><b>2.4</b> Infrastructure as code</a></li>
<li class="chapter" data-level="2.5" data-path="containerization-1.html"><a href="containerization-1.html"><i class="fa fa-check"></i><b>2.5</b> Containerization</a></li>
<li class="chapter" data-level="2.6" data-path="version-control-1.html"><a href="version-control-1.html"><i class="fa fa-check"></i><b>2.6</b> Version Control</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="version-control-1.html"><a href="version-control-1.html#github-1"><i class="fa fa-check"></i><b>2.6.1</b> Github</a></li>
<li class="chapter" data-level="2.6.2" data-path="version-control-1.html"><a href="version-control-1.html#git-lifecycle-1"><i class="fa fa-check"></i><b>2.6.2</b> Git lifecycle</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="cicd-1.html"><a href="cicd-1.html"><i class="fa fa-check"></i><b>2.7</b> CI/CD</a>
<ul>
<li class="chapter" data-level="" data-path="cicd-1.html"><a href="cicd-1.html#github-actions"><i class="fa fa-check"></i>Github Actions</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="infrastructure-as-code-1.html"><a href="infrastructure-as-code-1.html"><i class="fa fa-check"></i><b>2.8</b> Infrastructure as code</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="airflow.html"><a href="airflow.html"><i class="fa fa-check"></i><b>3</b> Airflow</a>
<ul>
<li class="chapter" data-level="3.1" data-path="core-components.html"><a href="core-components.html"><i class="fa fa-check"></i><b>3.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="core-components.html"><a href="core-components.html#dags"><i class="fa fa-check"></i><b>3.1.1</b> DAGs</a></li>
<li class="chapter" data-level="3.1.2" data-path="core-components.html"><a href="core-components.html#operators"><i class="fa fa-check"></i><b>3.1.2</b> Operators</a></li>
<li class="chapter" data-level="3.1.3" data-path="core-components.html"><a href="core-components.html#tasks"><i class="fa fa-check"></i><b>3.1.3</b> Tasks</a></li>
<li class="chapter" data-level="3.1.4" data-path="core-components.html"><a href="core-components.html#xcom"><i class="fa fa-check"></i><b>3.1.4</b> XCom</a></li>
<li class="chapter" data-level="3.1.5" data-path="core-components.html"><a href="core-components.html#scheduling"><i class="fa fa-check"></i><b>3.1.5</b> Scheduling</a></li>
<li class="chapter" data-level="3.1.6" data-path="core-components.html"><a href="core-components.html#taskflow"><i class="fa fa-check"></i><b>3.1.6</b> Taskflow</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="exemplary-ml-workflow.html"><a href="exemplary-ml-workflow.html"><i class="fa fa-check"></i><b>3.2</b> Exemplary ML workflow</a></li>
<li class="chapter" data-level="3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html"><i class="fa fa-check"></i><b>3.3</b> Airflow infrastructure</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#airflow-as-a-distributed-system"><i class="fa fa-check"></i><b>3.3.1</b> Airflow as a distributed system</a></li>
<li class="chapter" data-level="3.3.2" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#scheduler"><i class="fa fa-check"></i><b>3.3.2</b> Scheduler</a></li>
<li class="chapter" data-level="3.3.3" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#webserver"><i class="fa fa-check"></i><b>3.3.3</b> Webserver</a></li>
<li class="chapter" data-level="3.3.4" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#executor"><i class="fa fa-check"></i><b>3.3.4</b> Executor</a></li>
<li class="chapter" data-level="3.3.5" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#dag-directory"><i class="fa fa-check"></i><b>3.3.5</b> DAG Directory</a></li>
<li class="chapter" data-level="3.3.6" data-path="airflow-infrastructure.html"><a href="airflow-infrastructure.html#metadata-database"><i class="fa fa-check"></i><b>3.3.6</b> Metadata Database</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mlflow.html"><a href="mlflow.html"><i class="fa fa-check"></i><b>4</b> MLflow</a>
<ul>
<li class="chapter" data-level="4.1" data-path="core-components-1.html"><a href="core-components-1.html"><i class="fa fa-check"></i><b>4.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-tracking"><i class="fa fa-check"></i><b>4.1.1</b> MLflow Tracking</a></li>
<li class="chapter" data-level="4.1.2" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-models"><i class="fa fa-check"></i><b>4.1.2</b> MLflow Models</a></li>
<li class="chapter" data-level="4.1.3" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-model-registry"><i class="fa fa-check"></i><b>4.1.3</b> MLflow Model Registry</a></li>
<li class="chapter" data-level="4.1.4" data-path="core-components-1.html"><a href="core-components-1.html#mlflow-projects"><i class="fa fa-check"></i><b>4.1.4</b> MLflow Projects</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html"><i class="fa fa-check"></i><b>4.2</b> MLFflow Architecture</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-tracking-server"><i class="fa fa-check"></i><b>4.2.1</b> MLflow Tracking Server</a></li>
<li class="chapter" data-level="4.2.2" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-backend-store"><i class="fa fa-check"></i><b>4.2.2</b> MLflow Backend Store</a></li>
<li class="chapter" data-level="4.2.3" data-path="mlfflow-architecture.html"><a href="mlfflow-architecture.html#mlflow-artifact-store"><i class="fa fa-check"></i><b>4.2.3</b> MLflow Artifact Store</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="kubernetes.html"><a href="kubernetes.html"><i class="fa fa-check"></i><b>5</b> Kubernetes</a>
<ul>
<li class="chapter" data-level="5.1" data-path="core-components-2.html"><a href="core-components-2.html"><i class="fa fa-check"></i><b>5.1</b> Core Components</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="core-components-2.html"><a href="core-components-2.html#nodes"><i class="fa fa-check"></i><b>5.1.1</b> Nodes</a></li>
<li class="chapter" data-level="5.1.2" data-path="core-components-2.html"><a href="core-components-2.html#pods"><i class="fa fa-check"></i><b>5.1.2</b> Pods</a></li>
<li class="chapter" data-level="5.1.3" data-path="core-components-2.html"><a href="core-components-2.html#imperative-declarative-management"><i class="fa fa-check"></i><b>5.1.3</b> Imperative &amp; Declarative Management</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html"><i class="fa fa-check"></i><b>5.2</b> Application Deployment &amp; Design</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="application-deployment-design.html"><a href="application-deployment-design.html#deployments"><i class="fa fa-check"></i><b>5.2.1</b> Deployments</a></li>
<li class="chapter" data-level="5.2.2" data-path="application-deployment-design.html"><a href="application-deployment-design.html#resource-management"><i class="fa fa-check"></i><b>5.2.2</b> Resource Management</a></li>
<li class="chapter" data-level="5.2.3" data-path="application-deployment-design.html"><a href="application-deployment-design.html#daemonsets"><i class="fa fa-check"></i><b>5.2.3</b> DaemonSets</a></li>
<li class="chapter" data-level="5.2.4" data-path="application-deployment-design.html"><a href="application-deployment-design.html#statefulsets"><i class="fa fa-check"></i><b>5.2.4</b> StatefulSets</a></li>
<li class="chapter" data-level="5.2.5" data-path="application-deployment-design.html"><a href="application-deployment-design.html#jobs-cron-jobs"><i class="fa fa-check"></i><b>5.2.5</b> Jobs &amp; Cron Jobs</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="services-and-networking.html"><a href="services-and-networking.html"><i class="fa fa-check"></i><b>5.3</b> Services and Networking</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="services-and-networking.html"><a href="services-and-networking.html#services"><i class="fa fa-check"></i><b>5.3.1</b> Services</a></li>
<li class="chapter" data-level="5.3.2" data-path="services-and-networking.html"><a href="services-and-networking.html#service-discovery"><i class="fa fa-check"></i><b>5.3.2</b> Service Discovery</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html"><i class="fa fa-check"></i><b>5.4</b> Volumes and Storage</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#emptydir-volume"><i class="fa fa-check"></i><b>5.4.1</b> EmptyDir Volume</a></li>
<li class="chapter" data-level="5.4.2" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#hostpath-volume"><i class="fa fa-check"></i><b>5.4.2</b> HostPath Volume</a></li>
<li class="chapter" data-level="5.4.3" data-path="volumes-and-storage.html"><a href="volumes-and-storage.html#persistent-volumes"><i class="fa fa-check"></i><b>5.4.3</b> Persistent Volumes</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html"><i class="fa fa-check"></i><b>5.5</b> Environment, Configuration &amp; Security</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#namespaces"><i class="fa fa-check"></i><b>5.5.1</b> Namespaces</a></li>
<li class="chapter" data-level="5.5.2" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#labels-selectors-and-annotations"><i class="fa fa-check"></i><b>5.5.2</b> Labels, Selectors and Annotations</a></li>
<li class="chapter" data-level="5.5.3" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#configmaps"><i class="fa fa-check"></i><b>5.5.3</b> ConfigMaps</a></li>
<li class="chapter" data-level="5.5.4" data-path="environment-configuration-security.html"><a href="environment-configuration-security.html#secrets"><i class="fa fa-check"></i><b>5.5.4</b> Secrets</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="observability-maintenance.html"><a href="observability-maintenance.html"><i class="fa fa-check"></i><b>5.6</b> Observability &amp; Maintenance</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="observability-maintenance.html"><a href="observability-maintenance.html#health-checks"><i class="fa fa-check"></i><b>5.6.1</b> Health Checks</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="helm.html"><a href="helm.html"><i class="fa fa-check"></i><b>5.7</b> Helm</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="helm.html"><a href="helm.html#helm-chart-structure"><i class="fa fa-check"></i><b>5.7.1</b> Helm Chart Structure</a></li>
<li class="chapter" data-level="5.7.2" data-path="helm.html"><a href="helm.html#working-with-helm"><i class="fa fa-check"></i><b>5.7.2</b> Working with Helm</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="terraform.html"><a href="terraform.html"><i class="fa fa-check"></i><b>6</b> Terraform</a>
<ul>
<li class="chapter" data-level="6.1" data-path="basic-usage.html"><a href="basic-usage.html"><i class="fa fa-check"></i><b>6.1</b> Basic usage</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="basic-usage.html"><a href="basic-usage.html#terraform-init"><i class="fa fa-check"></i><b>6.1.1</b> terraform init</a></li>
<li class="chapter" data-level="6.1.2" data-path="basic-usage.html"><a href="basic-usage.html#terraform-validate"><i class="fa fa-check"></i><b>6.1.2</b> terraform validate</a></li>
<li class="chapter" data-level="6.1.3" data-path="basic-usage.html"><a href="basic-usage.html#terraform-plan"><i class="fa fa-check"></i><b>6.1.3</b> terraform plan</a></li>
<li class="chapter" data-level="6.1.4" data-path="basic-usage.html"><a href="basic-usage.html#terraform-apply"><i class="fa fa-check"></i><b>6.1.4</b> terraform apply</a></li>
<li class="chapter" data-level="6.1.5" data-path="basic-usage.html"><a href="basic-usage.html#terraform-destroy"><i class="fa fa-check"></i><b>6.1.5</b> terraform destroy</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="core-components-3.html"><a href="core-components-3.html"><i class="fa fa-check"></i><b>6.2</b> Core Components</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="core-components-3.html"><a href="core-components-3.html#providers"><i class="fa fa-check"></i><b>6.2.1</b> Providers</a></li>
<li class="chapter" data-level="6.2.2" data-path="core-components-3.html"><a href="core-components-3.html#resources"><i class="fa fa-check"></i><b>6.2.2</b> Resources</a></li>
<li class="chapter" data-level="6.2.3" data-path="core-components-3.html"><a href="core-components-3.html#data-sources"><i class="fa fa-check"></i><b>6.2.3</b> Data Sources</a></li>
<li class="chapter" data-level="6.2.4" data-path="core-components-3.html"><a href="core-components-3.html#state"><i class="fa fa-check"></i><b>6.2.4</b> State</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="modules.html"><a href="modules.html"><i class="fa fa-check"></i><b>6.3</b> Modules</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="modules.html"><a href="modules.html#input-variables"><i class="fa fa-check"></i><b>6.3.1</b> Input Variables</a></li>
<li class="chapter" data-level="6.3.2" data-path="modules.html"><a href="modules.html#output-variables"><i class="fa fa-check"></i><b>6.3.2</b> Output Variables</a></li>
<li class="chapter" data-level="6.3.3" data-path="modules.html"><a href="modules.html#local-variables"><i class="fa fa-check"></i><b>6.3.3</b> Local Variables</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html"><i class="fa fa-check"></i><b>6.4</b> Additional tips &amp; tricks</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#count"><i class="fa fa-check"></i><b>6.4.1</b> count</a></li>
<li class="chapter" data-level="6.4.2" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for-each"><i class="fa fa-check"></i><b>6.4.2</b> for-each</a></li>
<li class="chapter" data-level="6.4.3" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#for"><i class="fa fa-check"></i><b>6.4.3</b> for</a></li>
<li class="chapter" data-level="6.4.4" data-path="additional-tips-tricks.html"><a href="additional-tips-tricks.html#workspaces"><i class="fa fa-check"></i><b>6.4.4</b> Workspaces</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html"><i class="fa fa-check"></i><b>6.5</b> Exemplary Deployment</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#root"><i class="fa fa-check"></i><b>6.5.1</b> root</a></li>
<li class="chapter" data-level="6.5.2" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#vpc"><i class="fa fa-check"></i><b>6.5.2</b> vpc</a></li>
<li class="chapter" data-level="6.5.3" data-path="exemplary-deployment.html"><a href="exemplary-deployment.html#run-the-code"><i class="fa fa-check"></i><b>6.5.3</b> Run the code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ml-platform-design.html"><a href="ml-platform-design.html"><i class="fa fa-check"></i><b>7</b> ML Platform Design</a>
<ul>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#infrastructure"><i class="fa fa-check"></i>Infrastructure</a></li>
<li class="chapter" data-level="" data-path="ml-platform-design.html"><a href="ml-platform-design.html#mlops-tools"><i class="fa fa-check"></i>MLOps Tools</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="platform-deployment.html"><a href="platform-deployment.html"><i class="fa fa-check"></i><b>8</b> Platform Deployment</a>
<ul>
<li class="chapter" data-level="8.1" data-path="root-module.html"><a href="root-module.html"><i class="fa fa-check"></i><b>8.1</b> Root module</a></li>
<li class="chapter" data-level="8.2" data-path="infrastructure-2.html"><a href="infrastructure-2.html"><i class="fa fa-check"></i><b>8.2</b> Infrastructure</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="infrastructure-2.html"><a href="infrastructure-2.html#virtual-private-cloud"><i class="fa fa-check"></i><b>8.2.1</b> Virtual Private Cloud</a></li>
<li class="chapter" data-level="8.2.2" data-path="infrastructure-2.html"><a href="infrastructure-2.html#elastic-kubernetes-service"><i class="fa fa-check"></i><b>8.2.2</b> Elastic Kubernetes Service</a></li>
<li class="chapter" data-level="8.2.3" data-path="infrastructure-2.html"><a href="infrastructure-2.html#networking"><i class="fa fa-check"></i><b>8.2.3</b> Networking</a></li>
<li class="chapter" data-level="8.2.4" data-path="infrastructure-2.html"><a href="infrastructure-2.html#relational-database-service"><i class="fa fa-check"></i><b>8.2.4</b> Relational Database Service</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="components.html"><a href="components.html"><i class="fa fa-check"></i><b>8.3</b> Components</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="components.html"><a href="components.html#user-profiles"><i class="fa fa-check"></i><b>8.3.1</b> User Profiles</a></li>
<li class="chapter" data-level="8.3.2" data-path="components.html"><a href="components.html#airflow-1"><i class="fa fa-check"></i><b>8.3.2</b> Airflow</a></li>
<li class="chapter" data-level="8.3.3" data-path="components.html"><a href="components.html#mlflow-1"><i class="fa fa-check"></i><b>8.3.3</b> Mlflow</a></li>
<li class="chapter" data-level="8.3.4" data-path="components.html"><a href="components.html#jupyterhub"><i class="fa fa-check"></i><b>8.3.4</b> Jupyterhub</a></li>
<li class="chapter" data-level="8.3.5" data-path="components.html"><a href="components.html#monitoring"><i class="fa fa-check"></i><b>8.3.5</b> Monitoring</a></li>
<li class="chapter" data-level="8.3.6" data-path="components.html"><a href="components.html#sagemaker"><i class="fa fa-check"></i><b>8.3.6</b> Sagemaker</a></li>
<li class="chapter" data-level="8.3.7" data-path="components.html"><a href="components.html#dashboard"><i class="fa fa-check"></i><b>8.3.7</b> Dashboard</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="design-decisions.html"><a href="design-decisions.html"><i class="fa fa-check"></i><b>8.4</b> Design Decisions</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="use-case-development.html"><a href="use-case-development.html"><i class="fa fa-check"></i><b>9</b> Use Case Development</a>
<ul>
<li class="chapter" data-level="9.1" data-path="integrated-development-environment-1.html"><a href="integrated-development-environment-1.html"><i class="fa fa-check"></i><b>9.1</b> Integrated Development Environment</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="integrated-development-environment-1.html"><a href="integrated-development-environment-1.html#github-repository"><i class="fa fa-check"></i><b>9.1.1</b> Github Repository</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html"><i class="fa fa-check"></i><b>9.2</b> Training &amp; Deployment Pipeline Workflow</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#airflow-workflow"><i class="fa fa-check"></i><b>9.2.1</b> Airflow Workflow</a></li>
<li class="chapter" data-level="9.2.2" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#mlflow-integration"><i class="fa fa-check"></i><b>9.2.2</b> MLflow integration</a></li>
<li class="chapter" data-level="9.2.3" data-path="training-deployment-pipeline-workflow.html"><a href="training-deployment-pipeline-workflow.html#pipeline-workflow"><i class="fa fa-check"></i><b>9.2.3</b> Pipeline Workflow</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html"><i class="fa fa-check"></i><b>9.3</b> Training Pipeline Steps</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#data-preprocessing"><i class="fa fa-check"></i><b>9.3.1</b> Data Preprocessing</a></li>
<li class="chapter" data-level="9.3.2" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#model-training"><i class="fa fa-check"></i><b>9.3.2</b> Model Training</a></li>
<li class="chapter" data-level="9.3.3" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#data-preprocessing-1"><i class="fa fa-check"></i><b>9.3.3</b> Data Preprocessing</a></li>
<li class="chapter" data-level="9.3.4" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#model-training-1"><i class="fa fa-check"></i><b>9.3.4</b> Model Training</a></li>
<li class="chapter" data-level="9.3.5" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#model-comparison"><i class="fa fa-check"></i><b>9.3.5</b> Model Comparison</a></li>
<li class="chapter" data-level="9.3.6" data-path="training-pipeline-steps.html"><a href="training-pipeline-steps.html#model-deployment-serving"><i class="fa fa-check"></i><b>9.3.6</b> Model Deployment &amp; Serving</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="model-inferencing.html"><a href="model-inferencing.html"><i class="fa fa-check"></i><b>9.4</b> Model Inferencing</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="model-inferencing.html"><a href="model-inferencing.html#pipeline-workflow-1"><i class="fa fa-check"></i><b>9.4.1</b> Pipeline Workflow</a></li>
<li class="chapter" data-level="9.4.2" data-path="model-inferencing.html"><a href="model-inferencing.html#inference-workflow-code"><i class="fa fa-check"></i><b>9.4.2</b> Inference Workflow Code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i>Glossary</a></li>
<li class="chapter" data-level="" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i>Contributing</a></li>
<li class="chapter" data-level="" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">MLOps Engineering</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="training-deployment-pipeline-workflow" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Training &amp; Deployment Pipeline Workflow<a href="training-deployment-pipeline-workflow.html#training-deployment-pipeline-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The code and machine learning pipeline have been modularized into distinct steps, including preprocessing, model training, model comparison, and model serving. Airflow serves as the model workflow tool, generating DAGs for managing the pipeline. MLflow is integrated to facilitate model tracking, registry, and serving functionalities. To ensure portability and scalability, the codebase has been containerized using Docker, allowing it to be executed in Docker and/or Kubernetes environments. A detailed explanation of how these components function will be provided in the following section.</p>
<p>The <code>src</code> code is installed as a Python package within the Docker container, enabling easy invocation within the Airflow DAG. However, it is important to note that although Model Serving is triggered within the Airflow pipeline, the serving itself is not done on the Airflow and the EKS cluster respectively, but the model is served on an AWS Sagemaker instance.</p>
<div id="airflow-workflow" class="section level3 hasAnchor" number="9.2.1">
<h3><span class="header-section-number">9.2.1</span> Airflow Workflow<a href="training-deployment-pipeline-workflow.html#airflow-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The configuration for the Airflow DAG, encompassing its structure, tasks, and task dependencies, can be located within the <code>airflow_k8s_workflow_DAG.py</code> file. The DAG is constructed utilizing the TaskFlow API.</p>
<p>In the context of this use case, the ML pipeline comprises three primary phases: preprocessing, training, and serving. The preprocessing phase encompasses data manipulation and its subsequent storage within the S3 repository. The training phase and its associated code are designed to accommodate various TensorFlow models, facilitating parallel training across multiple models, consequently reducing the deployment time. Given the existence of multiple models, it becomes imperative to serve only the model that exhibits the most favorable metrics based on the present data. As a result, an intermediary step is incorporated to compare the metrics of all the models and select the most optimal one for serving.</p>
<p><img src="images/09-Deployment-Usage/use-case-pipeline-graph.png" style="width:100.0%" /></p>
<p>To execute these pipeline phases, the Airflow Kubernetes Operator is utilized. This operator guarantees that each phase operates within an independent and segregated environment using either Docker or Kubernetes jobs. To enable this process, it is necessary to containerize the code using Docker. Subsequently, the Airflow task invokes the relevant Python code methods and executes them in accordance with the specified requirements.</p>
</div>
<div id="mlflow-integration" class="section level3 hasAnchor" number="9.2.2">
<h3><span class="header-section-number">9.2.2</span> MLflow integration<a href="training-deployment-pipeline-workflow.html#mlflow-integration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Mlflow is leveraged in the preprocessing and model training stages to store crucial data parameters, model training parameters, and metrics, while also enabling the saving of trained models in the model registry. In the <code>airflow_k8s_workflow_DAG.py</code> file, Mlflow is invoked to create an experiment, and the experiment ID is passed to each pipeline step to store parameters in separate runs. This ensures a clear distinction between the execution of different models.</p>
<p>The <code>train_model</code> pipeline steps serve as a container for the model training procedure. Within the container, the model is trained using specific code. All the relevant information about the model and the model itself are logged using mlflow as well. This workflow ensures the comprehensive tracking of model parameters and metrics, and the saved model can be accessed and compared during the subsequent model comparison step. In fact, during this stage, the best model is transferred to another model stage within the model registry.</p>
</div>
<div id="pipeline-workflow" class="section level3 hasAnchor" number="9.2.3">
<h3><span class="header-section-number">9.2.3</span> Pipeline Workflow<a href="training-deployment-pipeline-workflow.html#pipeline-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The code below defines the <code>cnn_skin_cancer_workflow</code> function as an Airflow DAG using the <code>dag</code> decorator. Each step of the pipeline, including data preprocessing, model training, model comparison, and serving the best model, is represented as a separate task with the <code>@task.kubernetes</code> decorator. Dependencies between these tasks are established by passing the output of one task as an argument to the next task. The <code>cnn_skin_cancer_workflow</code> object serves as a representation of the entire DAG.</p>
<p>The code starts by importing various Python modules and libraries, defining several variables and parameters, and setting up an Enum class for distinguishing different models and model parameters.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb166-1"><a href="training-deployment-pipeline-workflow.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb166-2"><a href="training-deployment-pipeline-workflow.html#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb166-3"><a href="training-deployment-pipeline-workflow.html#cb166-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-4"><a href="training-deployment-pipeline-workflow.html#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb166-5"><a href="training-deployment-pipeline-workflow.html#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pendulum</span>
<span id="cb166-6"><a href="training-deployment-pipeline-workflow.html#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.decorators <span class="im">import</span> dag, task</span>
<span id="cb166-7"><a href="training-deployment-pipeline-workflow.html#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.kubernetes.secret <span class="im">import</span> Secret</span>
<span id="cb166-8"><a href="training-deployment-pipeline-workflow.html#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.models <span class="im">import</span> Variable</span>
<span id="cb166-9"><a href="training-deployment-pipeline-workflow.html#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.operators.bash <span class="im">import</span> BashOperator</span>
<span id="cb166-10"><a href="training-deployment-pipeline-workflow.html#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> airflow.providers.docker.operators.docker <span class="im">import</span> DockerOperator</span>
<span id="cb166-11"><a href="training-deployment-pipeline-workflow.html#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kubernetes.client <span class="im">import</span> models <span class="im">as</span> k8s</span>
<span id="cb166-12"><a href="training-deployment-pipeline-workflow.html#cb166-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-13"><a href="training-deployment-pipeline-workflow.html#cb166-13" aria-hidden="true" tabindex="-1"></a><span class="co">################################################################################</span></span>
<span id="cb166-14"><a href="training-deployment-pipeline-workflow.html#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb166-15"><a href="training-deployment-pipeline-workflow.html#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="co"># SET VARIOUS PARAMETERS</span></span>
<span id="cb166-16"><a href="training-deployment-pipeline-workflow.html#cb166-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb166-17"><a href="training-deployment-pipeline-workflow.html#cb166-17" aria-hidden="true" tabindex="-1"></a>EXPERIMENT_NAME <span class="op">=</span> <span class="st">&quot;cnn_skin_cancer&quot;</span>  <span class="co"># mlflow experiment name</span></span>
<span id="cb166-18"><a href="training-deployment-pipeline-workflow.html#cb166-18" aria-hidden="true" tabindex="-1"></a>skin_cancer_container_image <span class="op">=</span> <span class="st">&quot;seblum/cnn-skin-cancer-model:latest&quot;</span>  <span class="co"># base image for k8s pods</span></span>
<span id="cb166-19"><a href="training-deployment-pipeline-workflow.html#cb166-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-20"><a href="training-deployment-pipeline-workflow.html#cb166-20" aria-hidden="true" tabindex="-1"></a>MLFLOW_TRACKING_URI <span class="op">=</span> Variable.get(<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>)</span>
<span id="cb166-21"><a href="training-deployment-pipeline-workflow.html#cb166-21" aria-hidden="true" tabindex="-1"></a>ECR_REPOSITORY_NAME <span class="op">=</span> Variable.get(<span class="st">&quot;ECR_REPOSITORY_NAME&quot;</span>)</span>
<span id="cb166-22"><a href="training-deployment-pipeline-workflow.html#cb166-22" aria-hidden="true" tabindex="-1"></a>ECR_SAGEMAKER_IMAGE_TAG <span class="op">=</span> Variable.get(<span class="st">&quot;ECR_SAGEMAKER_IMAGE_TAG&quot;</span>)</span>
<span id="cb166-23"><a href="training-deployment-pipeline-workflow.html#cb166-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-24"><a href="training-deployment-pipeline-workflow.html#cb166-24" aria-hidden="true" tabindex="-1"></a><span class="co"># secrets to pass on to k8s pod</span></span>
<span id="cb166-25"><a href="training-deployment-pipeline-workflow.html#cb166-25" aria-hidden="true" tabindex="-1"></a>secret_name <span class="op">=</span> <span class="st">&quot;airflow-sagemaker-access&quot;</span></span>
<span id="cb166-26"><a href="training-deployment-pipeline-workflow.html#cb166-26" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_ROLE_NAME_SAGEMAKER <span class="op">=</span> Secret(</span>
<span id="cb166-27"><a href="training-deployment-pipeline-workflow.html#cb166-27" aria-hidden="true" tabindex="-1"></a>    deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>,</span>
<span id="cb166-28"><a href="training-deployment-pipeline-workflow.html#cb166-28" aria-hidden="true" tabindex="-1"></a>    deploy_target<span class="op">=</span><span class="st">&quot;AWS_ROLE_NAME_SAGEMAKER&quot;</span>,</span>
<span id="cb166-29"><a href="training-deployment-pipeline-workflow.html#cb166-29" aria-hidden="true" tabindex="-1"></a>    secret<span class="op">=</span>secret_name,</span>
<span id="cb166-30"><a href="training-deployment-pipeline-workflow.html#cb166-30" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="st">&quot;AWS_ROLE_NAME_SAGEMAKER&quot;</span>,</span>
<span id="cb166-31"><a href="training-deployment-pipeline-workflow.html#cb166-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-32"><a href="training-deployment-pipeline-workflow.html#cb166-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-33"><a href="training-deployment-pipeline-workflow.html#cb166-33" aria-hidden="true" tabindex="-1"></a>secret_name <span class="op">=</span> <span class="st">&quot;airflow-aws-account-information&quot;</span></span>
<span id="cb166-34"><a href="training-deployment-pipeline-workflow.html#cb166-34" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_ID <span class="op">=</span> Secret(deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>, deploy_target<span class="op">=</span><span class="st">&quot;AWS_ID&quot;</span>, secret<span class="op">=</span>secret_name, key<span class="op">=</span><span class="st">&quot;AWS_ID&quot;</span>)</span>
<span id="cb166-35"><a href="training-deployment-pipeline-workflow.html#cb166-35" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_REGION <span class="op">=</span> Secret(deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>, deploy_target<span class="op">=</span><span class="st">&quot;AWS_REGION&quot;</span>, secret<span class="op">=</span>secret_name, key<span class="op">=</span><span class="st">&quot;AWS_REGION&quot;</span>)</span>
<span id="cb166-36"><a href="training-deployment-pipeline-workflow.html#cb166-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-37"><a href="training-deployment-pipeline-workflow.html#cb166-37" aria-hidden="true" tabindex="-1"></a><span class="co"># secrets to pass on to k8s pod</span></span>
<span id="cb166-38"><a href="training-deployment-pipeline-workflow.html#cb166-38" aria-hidden="true" tabindex="-1"></a>secret_name <span class="op">=</span> <span class="st">&quot;airflow-s3-data-bucket-access-credentials&quot;</span></span>
<span id="cb166-39"><a href="training-deployment-pipeline-workflow.html#cb166-39" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_BUCKET <span class="op">=</span> Secret(deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>, deploy_target<span class="op">=</span><span class="st">&quot;AWS_BUCKET&quot;</span>, secret<span class="op">=</span>secret_name, key<span class="op">=</span><span class="st">&quot;AWS_BUCKET&quot;</span>)</span>
<span id="cb166-40"><a href="training-deployment-pipeline-workflow.html#cb166-40" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_ACCESS_KEY_ID <span class="op">=</span> Secret(</span>
<span id="cb166-41"><a href="training-deployment-pipeline-workflow.html#cb166-41" aria-hidden="true" tabindex="-1"></a>    deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>,</span>
<span id="cb166-42"><a href="training-deployment-pipeline-workflow.html#cb166-42" aria-hidden="true" tabindex="-1"></a>    deploy_target<span class="op">=</span><span class="st">&quot;AWS_ACCESS_KEY_ID&quot;</span>,</span>
<span id="cb166-43"><a href="training-deployment-pipeline-workflow.html#cb166-43" aria-hidden="true" tabindex="-1"></a>    secret<span class="op">=</span>secret_name,</span>
<span id="cb166-44"><a href="training-deployment-pipeline-workflow.html#cb166-44" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="st">&quot;AWS_ACCESS_KEY_ID&quot;</span>,</span>
<span id="cb166-45"><a href="training-deployment-pipeline-workflow.html#cb166-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-46"><a href="training-deployment-pipeline-workflow.html#cb166-46" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_SECRET_ACCESS_KEY <span class="op">=</span> Secret(</span>
<span id="cb166-47"><a href="training-deployment-pipeline-workflow.html#cb166-47" aria-hidden="true" tabindex="-1"></a>    deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>,</span>
<span id="cb166-48"><a href="training-deployment-pipeline-workflow.html#cb166-48" aria-hidden="true" tabindex="-1"></a>    deploy_target<span class="op">=</span><span class="st">&quot;AWS_SECRET_ACCESS_KEY&quot;</span>,</span>
<span id="cb166-49"><a href="training-deployment-pipeline-workflow.html#cb166-49" aria-hidden="true" tabindex="-1"></a>    secret<span class="op">=</span>secret_name,</span>
<span id="cb166-50"><a href="training-deployment-pipeline-workflow.html#cb166-50" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="st">&quot;AWS_SECRET_ACCESS_KEY&quot;</span>,</span>
<span id="cb166-51"><a href="training-deployment-pipeline-workflow.html#cb166-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-52"><a href="training-deployment-pipeline-workflow.html#cb166-52" aria-hidden="true" tabindex="-1"></a>SECRET_AWS_ROLE_NAME <span class="op">=</span> Secret(</span>
<span id="cb166-53"><a href="training-deployment-pipeline-workflow.html#cb166-53" aria-hidden="true" tabindex="-1"></a>    deploy_type<span class="op">=</span><span class="st">&quot;env&quot;</span>,</span>
<span id="cb166-54"><a href="training-deployment-pipeline-workflow.html#cb166-54" aria-hidden="true" tabindex="-1"></a>    deploy_target<span class="op">=</span><span class="st">&quot;AWS_ROLE_NAME&quot;</span>,</span>
<span id="cb166-55"><a href="training-deployment-pipeline-workflow.html#cb166-55" aria-hidden="true" tabindex="-1"></a>    secret<span class="op">=</span>secret_name,</span>
<span id="cb166-56"><a href="training-deployment-pipeline-workflow.html#cb166-56" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="st">&quot;AWS_ROLE_NAME&quot;</span>,</span>
<span id="cb166-57"><a href="training-deployment-pipeline-workflow.html#cb166-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-58"><a href="training-deployment-pipeline-workflow.html#cb166-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-59"><a href="training-deployment-pipeline-workflow.html#cb166-59" aria-hidden="true" tabindex="-1"></a><span class="co"># node_selector and toleration to schedule model training on specific nodes</span></span>
<span id="cb166-60"><a href="training-deployment-pipeline-workflow.html#cb166-60" aria-hidden="true" tabindex="-1"></a>tolerations <span class="op">=</span> [k8s.V1Toleration(key<span class="op">=</span><span class="st">&quot;dedicated&quot;</span>, operator<span class="op">=</span><span class="st">&quot;Equal&quot;</span>, value<span class="op">=</span><span class="st">&quot;t3_large&quot;</span>, effect<span class="op">=</span><span class="st">&quot;NoSchedule&quot;</span>)]</span>
<span id="cb166-61"><a href="training-deployment-pipeline-workflow.html#cb166-61" aria-hidden="true" tabindex="-1"></a>node_selector <span class="op">=</span> {<span class="st">&quot;role&quot;</span>: <span class="st">&quot;t3_large&quot;</span>}</span>
<span id="cb166-62"><a href="training-deployment-pipeline-workflow.html#cb166-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-63"><a href="training-deployment-pipeline-workflow.html#cb166-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-64"><a href="training-deployment-pipeline-workflow.html#cb166-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Enum Class to distiguish models</span></span>
<span id="cb166-65"><a href="training-deployment-pipeline-workflow.html#cb166-65" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model_Class(Enum):</span>
<span id="cb166-66"><a href="training-deployment-pipeline-workflow.html#cb166-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;This enum includes different models.&quot;&quot;&quot;</span></span>
<span id="cb166-67"><a href="training-deployment-pipeline-workflow.html#cb166-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-68"><a href="training-deployment-pipeline-workflow.html#cb166-68" aria-hidden="true" tabindex="-1"></a>    Basic <span class="op">=</span> <span class="st">&quot;Basic&quot;</span></span>
<span id="cb166-69"><a href="training-deployment-pipeline-workflow.html#cb166-69" aria-hidden="true" tabindex="-1"></a>    CrossVal <span class="op">=</span> <span class="st">&quot;CrossVal&quot;</span></span>
<span id="cb166-70"><a href="training-deployment-pipeline-workflow.html#cb166-70" aria-hidden="true" tabindex="-1"></a>    ResNet50 <span class="op">=</span> <span class="st">&quot;ResNet50&quot;</span></span>
<span id="cb166-71"><a href="training-deployment-pipeline-workflow.html#cb166-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-72"><a href="training-deployment-pipeline-workflow.html#cb166-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-73"><a href="training-deployment-pipeline-workflow.html#cb166-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Set various model params</span></span>
<span id="cb166-74"><a href="training-deployment-pipeline-workflow.html#cb166-74" aria-hidden="true" tabindex="-1"></a>model_params <span class="op">=</span> {</span>
<span id="cb166-75"><a href="training-deployment-pipeline-workflow.html#cb166-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;num_classes&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb166-76"><a href="training-deployment-pipeline-workflow.html#cb166-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;input_shape&quot;</span>: (<span class="dv">224</span>, <span class="dv">224</span>, <span class="dv">3</span>),</span>
<span id="cb166-77"><a href="training-deployment-pipeline-workflow.html#cb166-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;activation&quot;</span>: <span class="st">&quot;relu&quot;</span>,</span>
<span id="cb166-78"><a href="training-deployment-pipeline-workflow.html#cb166-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;kernel_initializer_glob&quot;</span>: <span class="st">&quot;glorot_uniform&quot;</span>,</span>
<span id="cb166-79"><a href="training-deployment-pipeline-workflow.html#cb166-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;kernel_initializer_norm&quot;</span>: <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb166-80"><a href="training-deployment-pipeline-workflow.html#cb166-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;optimizer&quot;</span>: <span class="st">&quot;adam&quot;</span>,</span>
<span id="cb166-81"><a href="training-deployment-pipeline-workflow.html#cb166-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;loss&quot;</span>: <span class="st">&quot;binary_crossentropy&quot;</span>,</span>
<span id="cb166-82"><a href="training-deployment-pipeline-workflow.html#cb166-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;metrics&quot;</span>: [<span class="st">&quot;accuracy&quot;</span>],</span>
<span id="cb166-83"><a href="training-deployment-pipeline-workflow.html#cb166-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;validation_split&quot;</span>: <span class="fl">0.2</span>,</span>
<span id="cb166-84"><a href="training-deployment-pipeline-workflow.html#cb166-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;epochs&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb166-85"><a href="training-deployment-pipeline-workflow.html#cb166-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;batch_size&quot;</span>: <span class="dv">64</span>,</span>
<span id="cb166-86"><a href="training-deployment-pipeline-workflow.html#cb166-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;learning_rate&quot;</span>: <span class="fl">1e-5</span>,</span>
<span id="cb166-87"><a href="training-deployment-pipeline-workflow.html#cb166-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;pooling&quot;</span>: <span class="st">&quot;avg&quot;</span>,  <span class="co"># needed for resnet50</span></span>
<span id="cb166-88"><a href="training-deployment-pipeline-workflow.html#cb166-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;verbose&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb166-89"><a href="training-deployment-pipeline-workflow.html#cb166-89" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Afterward, the MLflow tracking URI is set and a function <code>make_mlflow()</code> defined that creates an MLflow experiment or sets an existing one as active. The experiment ID is stored in <code>mlflow_experiment_id</code>. The function is called and the MLflow experiment is set respectively.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb167-1"><a href="training-deployment-pipeline-workflow.html#cb167-1" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)</span>
<span id="cb167-2"><a href="training-deployment-pipeline-workflow.html#cb167-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-3"><a href="training-deployment-pipeline-workflow.html#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="training-deployment-pipeline-workflow.html#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_mlflow() <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb167-5"><a href="training-deployment-pipeline-workflow.html#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb167-6"><a href="training-deployment-pipeline-workflow.html#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates an MLflow experiment and sets it as the active experiment.</span></span>
<span id="cb167-7"><a href="training-deployment-pipeline-workflow.html#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="training-deployment-pipeline-workflow.html#cb167-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb167-9"><a href="training-deployment-pipeline-workflow.html#cb167-9" aria-hidden="true" tabindex="-1"></a><span class="co">        str: The experiment ID of the created or existing MLflow experiment.</span></span>
<span id="cb167-10"><a href="training-deployment-pipeline-workflow.html#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="training-deployment-pipeline-workflow.html#cb167-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb167-12"><a href="training-deployment-pipeline-workflow.html#cb167-12" aria-hidden="true" tabindex="-1"></a><span class="co">        # Create an MLflow experiment and set it as active</span></span>
<span id="cb167-13"><a href="training-deployment-pipeline-workflow.html#cb167-13" aria-hidden="true" tabindex="-1"></a><span class="co">        experiment_id = make_mlflow()</span></span>
<span id="cb167-14"><a href="training-deployment-pipeline-workflow.html#cb167-14" aria-hidden="true" tabindex="-1"></a><span class="co">        print(f&quot;Active MLflow experiment ID: {experiment_id}&quot;)</span></span>
<span id="cb167-15"><a href="training-deployment-pipeline-workflow.html#cb167-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb167-16"><a href="training-deployment-pipeline-workflow.html#cb167-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb167-17"><a href="training-deployment-pipeline-workflow.html#cb167-17" aria-hidden="true" tabindex="-1"></a>        mlflow_experiment_id <span class="op">=</span> mlflow.create_experiment(EXPERIMENT_NAME)</span>
<span id="cb167-18"><a href="training-deployment-pipeline-workflow.html#cb167-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb167-19"><a href="training-deployment-pipeline-workflow.html#cb167-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb167-20"><a href="training-deployment-pipeline-workflow.html#cb167-20" aria-hidden="true" tabindex="-1"></a>    mlflow_experiment_id <span class="op">=</span> mlflow.set_experiment(EXPERIMENT_NAME).experiment_id</span>
<span id="cb167-21"><a href="training-deployment-pipeline-workflow.html#cb167-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mlflow_experiment_id</span>
<span id="cb167-22"><a href="training-deployment-pipeline-workflow.html#cb167-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-23"><a href="training-deployment-pipeline-workflow.html#cb167-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-24"><a href="training-deployment-pipeline-workflow.html#cb167-24" aria-hidden="true" tabindex="-1"></a><span class="co"># When dag is loaded, mlflow experiment is created</span></span>
<span id="cb167-25"><a href="training-deployment-pipeline-workflow.html#cb167-25" aria-hidden="true" tabindex="-1"></a>mlflow_experiment_id <span class="op">=</span> make_mlflow()</span></code></pre></div>
<p>After setting up all secrets, variables, and parameters, the Apache Airflow DAG itself is defined and named <code>cnn_skin_cancer_workflow</code> with default arguments and metadata. It’s the beginning of the DAG definition. All ML pipeline steps are defined within the DAG.</p>
<ul>
<li>The task labeled as <code>preprocessing_op</code> is in charge of the initial step within the workflow. Its primary role involves fetching data from an S3 bucket, executing preprocessing procedures, and subsequently storing the processed data back into the S3 storage. The <code>mlflow_experiment_id</code> parameter is provided as input to the task, and the outcome, including the paths to the preprocessed data, is captured within the <code>preprocessed_data</code> variable. The resulting path to the preprocessed data is communicated through the utilization of an XCOM dictionary.</li>
<li>The <code>model_training_op</code> task is specifically designed for the training of deep learning models using the preprocessed data. It offers flexibility in terms of model selection by means of the <code>model_class</code> parameter, which leverages the Enum type for making the choice, for example by specifying <code>Model_Class.ResNet50.name</code> and indicating the intention to train a ResNet50 model. Similar to the prior task, it utilizes identical <code>model_params</code> and <code>input</code> parameters derived from the preprocessed data. The outcomes of this task, containing training-related information, are stored within the <code>train_data_basic</code> variable.</li>
<li>The <code>model_comparison_op</code> task fulfills the role of comparing multiple previously trained models based on their accuracy. Additionally, it updates the stage of the models within MLflow to facilitate easier differentiation in subsequent stages. It accepts as input the outcomes of training for the Basic, ResNet50, and CrossVal models (<code>train_data_basic</code>, <code>train_data_resnet50</code>, and <code>train_data_crossval</code>). The results are captured within the <code>compare_models_dict</code> variable.</li>
<li>The task known as <code>deploy_model_to_sagemaker_op</code> manages the deployment of the top model to the SageMaker platform. It determines and selects the model with the highest performance based on the information contained within the <code>compare_models_dict</code>.</li>
</ul>
<div class="sourceCode" id="cb168"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb168-1"><a href="training-deployment-pipeline-workflow.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dag</span>(</span>
<span id="cb168-2"><a href="training-deployment-pipeline-workflow.html#cb168-2" aria-hidden="true" tabindex="-1"></a>    dag_id<span class="op">=</span><span class="st">&quot;cnn_skin_cancer_workflow&quot;</span>,</span>
<span id="cb168-3"><a href="training-deployment-pipeline-workflow.html#cb168-3" aria-hidden="true" tabindex="-1"></a>    default_args<span class="op">=</span>{</span>
<span id="cb168-4"><a href="training-deployment-pipeline-workflow.html#cb168-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;owner&quot;</span>: <span class="st">&quot;seblum&quot;</span>,</span>
<span id="cb168-5"><a href="training-deployment-pipeline-workflow.html#cb168-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;depends_on_past&quot;</span>: <span class="va">False</span>,</span>
<span id="cb168-6"><a href="training-deployment-pipeline-workflow.html#cb168-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;start_date&quot;</span>: pendulum.datetime(<span class="dv">2021</span>, <span class="dv">1</span>, <span class="dv">1</span>, tz<span class="op">=</span><span class="st">&quot;Europe/Amsterdam&quot;</span>),</span>
<span id="cb168-7"><a href="training-deployment-pipeline-workflow.html#cb168-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;tags&quot;</span>: [<span class="st">&quot;Keras CNN to classify skin cancer&quot;</span>],</span>
<span id="cb168-8"><a href="training-deployment-pipeline-workflow.html#cb168-8" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb168-9"><a href="training-deployment-pipeline-workflow.html#cb168-9" aria-hidden="true" tabindex="-1"></a>    schedule_interval<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb168-10"><a href="training-deployment-pipeline-workflow.html#cb168-10" aria-hidden="true" tabindex="-1"></a>    max_active_runs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb168-11"><a href="training-deployment-pipeline-workflow.html#cb168-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-12"><a href="training-deployment-pipeline-workflow.html#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cnn_skin_cancer_workflow():</span>
<span id="cb168-13"><a href="training-deployment-pipeline-workflow.html#cb168-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb168-14"><a href="training-deployment-pipeline-workflow.html#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Apache Airflow DAG for running a workflow to train, compare, and deploy skin cancer classification models.</span></span>
<span id="cb168-15"><a href="training-deployment-pipeline-workflow.html#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb168-16"><a href="training-deployment-pipeline-workflow.html#cb168-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-17"><a href="training-deployment-pipeline-workflow.html#cb168-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@task.kubernetes</span>(</span>
<span id="cb168-18"><a href="training-deployment-pipeline-workflow.html#cb168-18" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>skin_cancer_container_image,</span>
<span id="cb168-19"><a href="training-deployment-pipeline-workflow.html#cb168-19" aria-hidden="true" tabindex="-1"></a>        task_id<span class="op">=</span><span class="st">&quot;preprocessing_op&quot;</span>,</span>
<span id="cb168-20"><a href="training-deployment-pipeline-workflow.html#cb168-20" aria-hidden="true" tabindex="-1"></a>        namespace<span class="op">=</span><span class="st">&quot;airflow&quot;</span>,</span>
<span id="cb168-21"><a href="training-deployment-pipeline-workflow.html#cb168-21" aria-hidden="true" tabindex="-1"></a>        env_vars<span class="op">=</span>{<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>: MLFLOW_TRACKING_URI},</span>
<span id="cb168-22"><a href="training-deployment-pipeline-workflow.html#cb168-22" aria-hidden="true" tabindex="-1"></a>        in_cluster<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-23"><a href="training-deployment-pipeline-workflow.html#cb168-23" aria-hidden="true" tabindex="-1"></a>        get_logs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-24"><a href="training-deployment-pipeline-workflow.html#cb168-24" aria-hidden="true" tabindex="-1"></a>        do_xcom_push<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-25"><a href="training-deployment-pipeline-workflow.html#cb168-25" aria-hidden="true" tabindex="-1"></a>        startup_timeout_seconds<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb168-26"><a href="training-deployment-pipeline-workflow.html#cb168-26" aria-hidden="true" tabindex="-1"></a>        service_account_name<span class="op">=</span><span class="st">&quot;airflow-sa&quot;</span>,</span>
<span id="cb168-27"><a href="training-deployment-pipeline-workflow.html#cb168-27" aria-hidden="true" tabindex="-1"></a>        secrets<span class="op">=</span>[</span>
<span id="cb168-28"><a href="training-deployment-pipeline-workflow.html#cb168-28" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_BUCKET,</span>
<span id="cb168-29"><a href="training-deployment-pipeline-workflow.html#cb168-29" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_REGION,</span>
<span id="cb168-30"><a href="training-deployment-pipeline-workflow.html#cb168-30" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ACCESS_KEY_ID,</span>
<span id="cb168-31"><a href="training-deployment-pipeline-workflow.html#cb168-31" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_SECRET_ACCESS_KEY,</span>
<span id="cb168-32"><a href="training-deployment-pipeline-workflow.html#cb168-32" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ROLE_NAME,</span>
<span id="cb168-33"><a href="training-deployment-pipeline-workflow.html#cb168-33" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb168-34"><a href="training-deployment-pipeline-workflow.html#cb168-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-35"><a href="training-deployment-pipeline-workflow.html#cb168-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocessing_op(mlflow_experiment_id: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb168-36"><a href="training-deployment-pipeline-workflow.html#cb168-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb168-37"><a href="training-deployment-pipeline-workflow.html#cb168-37" aria-hidden="true" tabindex="-1"></a><span class="co">        Perform data preprocessing.</span></span>
<span id="cb168-38"><a href="training-deployment-pipeline-workflow.html#cb168-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-39"><a href="training-deployment-pipeline-workflow.html#cb168-39" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb168-40"><a href="training-deployment-pipeline-workflow.html#cb168-40" aria-hidden="true" tabindex="-1"></a><span class="co">            mlflow_experiment_id (str): The MLflow experiment ID.</span></span>
<span id="cb168-41"><a href="training-deployment-pipeline-workflow.html#cb168-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-42"><a href="training-deployment-pipeline-workflow.html#cb168-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb168-43"><a href="training-deployment-pipeline-workflow.html#cb168-43" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: A dictionary containing the paths to preprocessed data.</span></span>
<span id="cb168-44"><a href="training-deployment-pipeline-workflow.html#cb168-44" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb168-45"><a href="training-deployment-pipeline-workflow.html#cb168-45" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> os</span>
<span id="cb168-46"><a href="training-deployment-pipeline-workflow.html#cb168-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-47"><a href="training-deployment-pipeline-workflow.html#cb168-47" aria-hidden="true" tabindex="-1"></a>        aws_bucket <span class="op">=</span> os.getenv(<span class="st">&quot;AWS_BUCKET&quot;</span>)</span>
<span id="cb168-48"><a href="training-deployment-pipeline-workflow.html#cb168-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-49"><a href="training-deployment-pipeline-workflow.html#cb168-49" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> src.preprocessing <span class="im">import</span> data_preprocessing</span>
<span id="cb168-50"><a href="training-deployment-pipeline-workflow.html#cb168-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-51"><a href="training-deployment-pipeline-workflow.html#cb168-51" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb168-52"><a href="training-deployment-pipeline-workflow.html#cb168-52" aria-hidden="true" tabindex="-1"></a>            X_train_data_path,</span>
<span id="cb168-53"><a href="training-deployment-pipeline-workflow.html#cb168-53" aria-hidden="true" tabindex="-1"></a>            y_train_data_path,</span>
<span id="cb168-54"><a href="training-deployment-pipeline-workflow.html#cb168-54" aria-hidden="true" tabindex="-1"></a>            X_test_data_path,</span>
<span id="cb168-55"><a href="training-deployment-pipeline-workflow.html#cb168-55" aria-hidden="true" tabindex="-1"></a>            y_test_data_path,</span>
<span id="cb168-56"><a href="training-deployment-pipeline-workflow.html#cb168-56" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">=</span> data_preprocessing(mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id, aws_bucket<span class="op">=</span>aws_bucket)</span>
<span id="cb168-57"><a href="training-deployment-pipeline-workflow.html#cb168-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-58"><a href="training-deployment-pipeline-workflow.html#cb168-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create dictionary with S3 paths to return</span></span>
<span id="cb168-59"><a href="training-deployment-pipeline-workflow.html#cb168-59" aria-hidden="true" tabindex="-1"></a>        return_dict <span class="op">=</span> {</span>
<span id="cb168-60"><a href="training-deployment-pipeline-workflow.html#cb168-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;X_train_data_path&quot;</span>: X_train_data_path,</span>
<span id="cb168-61"><a href="training-deployment-pipeline-workflow.html#cb168-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;y_train_data_path&quot;</span>: y_train_data_path,</span>
<span id="cb168-62"><a href="training-deployment-pipeline-workflow.html#cb168-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;X_test_data_path&quot;</span>: X_test_data_path,</span>
<span id="cb168-63"><a href="training-deployment-pipeline-workflow.html#cb168-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;y_test_data_path&quot;</span>: y_test_data_path,</span>
<span id="cb168-64"><a href="training-deployment-pipeline-workflow.html#cb168-64" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-65"><a href="training-deployment-pipeline-workflow.html#cb168-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> return_dict</span>
<span id="cb168-66"><a href="training-deployment-pipeline-workflow.html#cb168-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-67"><a href="training-deployment-pipeline-workflow.html#cb168-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">@task.kubernetes</span>(</span>
<span id="cb168-68"><a href="training-deployment-pipeline-workflow.html#cb168-68" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>skin_cancer_container_image,</span>
<span id="cb168-69"><a href="training-deployment-pipeline-workflow.html#cb168-69" aria-hidden="true" tabindex="-1"></a>        task_id<span class="op">=</span><span class="st">&quot;model_training_op&quot;</span>,</span>
<span id="cb168-70"><a href="training-deployment-pipeline-workflow.html#cb168-70" aria-hidden="true" tabindex="-1"></a>        namespace<span class="op">=</span><span class="st">&quot;airflow&quot;</span>,</span>
<span id="cb168-71"><a href="training-deployment-pipeline-workflow.html#cb168-71" aria-hidden="true" tabindex="-1"></a>        env_vars<span class="op">=</span>{<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>: MLFLOW_TRACKING_URI},</span>
<span id="cb168-72"><a href="training-deployment-pipeline-workflow.html#cb168-72" aria-hidden="true" tabindex="-1"></a>        in_cluster<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-73"><a href="training-deployment-pipeline-workflow.html#cb168-73" aria-hidden="true" tabindex="-1"></a>        get_logs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-74"><a href="training-deployment-pipeline-workflow.html#cb168-74" aria-hidden="true" tabindex="-1"></a>        do_xcom_push<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-75"><a href="training-deployment-pipeline-workflow.html#cb168-75" aria-hidden="true" tabindex="-1"></a>        startup_timeout_seconds<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb168-76"><a href="training-deployment-pipeline-workflow.html#cb168-76" aria-hidden="true" tabindex="-1"></a>        node_selector<span class="op">=</span>node_selector,</span>
<span id="cb168-77"><a href="training-deployment-pipeline-workflow.html#cb168-77" aria-hidden="true" tabindex="-1"></a>        tolerations<span class="op">=</span>tolerations,</span>
<span id="cb168-78"><a href="training-deployment-pipeline-workflow.html#cb168-78" aria-hidden="true" tabindex="-1"></a>        service_account_name<span class="op">=</span><span class="st">&quot;airflow-sa&quot;</span>,</span>
<span id="cb168-79"><a href="training-deployment-pipeline-workflow.html#cb168-79" aria-hidden="true" tabindex="-1"></a>        secrets<span class="op">=</span>[</span>
<span id="cb168-80"><a href="training-deployment-pipeline-workflow.html#cb168-80" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_BUCKET,</span>
<span id="cb168-81"><a href="training-deployment-pipeline-workflow.html#cb168-81" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_REGION,</span>
<span id="cb168-82"><a href="training-deployment-pipeline-workflow.html#cb168-82" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ACCESS_KEY_ID,</span>
<span id="cb168-83"><a href="training-deployment-pipeline-workflow.html#cb168-83" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_SECRET_ACCESS_KEY,</span>
<span id="cb168-84"><a href="training-deployment-pipeline-workflow.html#cb168-84" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ROLE_NAME,</span>
<span id="cb168-85"><a href="training-deployment-pipeline-workflow.html#cb168-85" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb168-86"><a href="training-deployment-pipeline-workflow.html#cb168-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-87"><a href="training-deployment-pipeline-workflow.html#cb168-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> model_training_op(mlflow_experiment_id: <span class="bu">str</span>, model_class: <span class="bu">str</span>, model_params: <span class="bu">dict</span>, <span class="bu">input</span>: <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb168-88"><a href="training-deployment-pipeline-workflow.html#cb168-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb168-89"><a href="training-deployment-pipeline-workflow.html#cb168-89" aria-hidden="true" tabindex="-1"></a><span class="co">        Train a model.</span></span>
<span id="cb168-90"><a href="training-deployment-pipeline-workflow.html#cb168-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-91"><a href="training-deployment-pipeline-workflow.html#cb168-91" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb168-92"><a href="training-deployment-pipeline-workflow.html#cb168-92" aria-hidden="true" tabindex="-1"></a><span class="co">            mlflow_experiment_id (str): The MLflow experiment ID.</span></span>
<span id="cb168-93"><a href="training-deployment-pipeline-workflow.html#cb168-93" aria-hidden="true" tabindex="-1"></a><span class="co">            model_class (str): The class of the model to train.</span></span>
<span id="cb168-94"><a href="training-deployment-pipeline-workflow.html#cb168-94" aria-hidden="true" tabindex="-1"></a><span class="co">            model_params (dict): A dictionary containing the model parameters.</span></span>
<span id="cb168-95"><a href="training-deployment-pipeline-workflow.html#cb168-95" aria-hidden="true" tabindex="-1"></a><span class="co">            input (dict): A dictionary containing the input data.</span></span>
<span id="cb168-96"><a href="training-deployment-pipeline-workflow.html#cb168-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-97"><a href="training-deployment-pipeline-workflow.html#cb168-97" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb168-98"><a href="training-deployment-pipeline-workflow.html#cb168-98" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: A dictionary containing the results of the model training.</span></span>
<span id="cb168-99"><a href="training-deployment-pipeline-workflow.html#cb168-99" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb168-100"><a href="training-deployment-pipeline-workflow.html#cb168-100" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> os</span>
<span id="cb168-101"><a href="training-deployment-pipeline-workflow.html#cb168-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-102"><a href="training-deployment-pipeline-workflow.html#cb168-102" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> src.train <span class="im">import</span> train_model</span>
<span id="cb168-103"><a href="training-deployment-pipeline-workflow.html#cb168-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-104"><a href="training-deployment-pipeline-workflow.html#cb168-104" aria-hidden="true" tabindex="-1"></a>        aws_bucket <span class="op">=</span> os.getenv(<span class="st">&quot;AWS_BUCKET&quot;</span>)</span>
<span id="cb168-105"><a href="training-deployment-pipeline-workflow.html#cb168-105" aria-hidden="true" tabindex="-1"></a>        run_id, model_name, model_version, model_stage <span class="op">=</span> train_model(</span>
<span id="cb168-106"><a href="training-deployment-pipeline-workflow.html#cb168-106" aria-hidden="true" tabindex="-1"></a>            mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id,</span>
<span id="cb168-107"><a href="training-deployment-pipeline-workflow.html#cb168-107" aria-hidden="true" tabindex="-1"></a>            model_class<span class="op">=</span>model_class,</span>
<span id="cb168-108"><a href="training-deployment-pipeline-workflow.html#cb168-108" aria-hidden="true" tabindex="-1"></a>            model_params<span class="op">=</span>model_params,</span>
<span id="cb168-109"><a href="training-deployment-pipeline-workflow.html#cb168-109" aria-hidden="true" tabindex="-1"></a>            aws_bucket<span class="op">=</span>aws_bucket,</span>
<span id="cb168-110"><a href="training-deployment-pipeline-workflow.html#cb168-110" aria-hidden="true" tabindex="-1"></a>            import_dict<span class="op">=</span><span class="bu">input</span>,</span>
<span id="cb168-111"><a href="training-deployment-pipeline-workflow.html#cb168-111" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb168-112"><a href="training-deployment-pipeline-workflow.html#cb168-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-113"><a href="training-deployment-pipeline-workflow.html#cb168-113" aria-hidden="true" tabindex="-1"></a>        return_dict <span class="op">=</span> {</span>
<span id="cb168-114"><a href="training-deployment-pipeline-workflow.html#cb168-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;run_id&quot;</span>: run_id,</span>
<span id="cb168-115"><a href="training-deployment-pipeline-workflow.html#cb168-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;model_name&quot;</span>: model_name,</span>
<span id="cb168-116"><a href="training-deployment-pipeline-workflow.html#cb168-116" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;model_version&quot;</span>: model_version,</span>
<span id="cb168-117"><a href="training-deployment-pipeline-workflow.html#cb168-117" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;model_stage&quot;</span>: model_stage,</span>
<span id="cb168-118"><a href="training-deployment-pipeline-workflow.html#cb168-118" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-119"><a href="training-deployment-pipeline-workflow.html#cb168-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> return_dict</span>
<span id="cb168-120"><a href="training-deployment-pipeline-workflow.html#cb168-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-121"><a href="training-deployment-pipeline-workflow.html#cb168-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">@task.kubernetes</span>(</span>
<span id="cb168-122"><a href="training-deployment-pipeline-workflow.html#cb168-122" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>skin_cancer_container_image,</span>
<span id="cb168-123"><a href="training-deployment-pipeline-workflow.html#cb168-123" aria-hidden="true" tabindex="-1"></a>        task_id<span class="op">=</span><span class="st">&quot;compare_models_op&quot;</span>,</span>
<span id="cb168-124"><a href="training-deployment-pipeline-workflow.html#cb168-124" aria-hidden="true" tabindex="-1"></a>        namespace<span class="op">=</span><span class="st">&quot;airflow&quot;</span>,</span>
<span id="cb168-125"><a href="training-deployment-pipeline-workflow.html#cb168-125" aria-hidden="true" tabindex="-1"></a>        env_vars<span class="op">=</span>{<span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>: MLFLOW_TRACKING_URI},</span>
<span id="cb168-126"><a href="training-deployment-pipeline-workflow.html#cb168-126" aria-hidden="true" tabindex="-1"></a>        in_cluster<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-127"><a href="training-deployment-pipeline-workflow.html#cb168-127" aria-hidden="true" tabindex="-1"></a>        get_logs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-128"><a href="training-deployment-pipeline-workflow.html#cb168-128" aria-hidden="true" tabindex="-1"></a>        do_xcom_push<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-129"><a href="training-deployment-pipeline-workflow.html#cb168-129" aria-hidden="true" tabindex="-1"></a>        startup_timeout_seconds<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb168-130"><a href="training-deployment-pipeline-workflow.html#cb168-130" aria-hidden="true" tabindex="-1"></a>        service_account_name<span class="op">=</span><span class="st">&quot;airflow-sa&quot;</span>,  <span class="co"># Don&#39;t need Access Secrets as SA is given</span></span>
<span id="cb168-131"><a href="training-deployment-pipeline-workflow.html#cb168-131" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-132"><a href="training-deployment-pipeline-workflow.html#cb168-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compare_models_op(train_data_basic: <span class="bu">dict</span>, train_data_resnet50: <span class="bu">dict</span>, train_data_crossval: <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb168-133"><a href="training-deployment-pipeline-workflow.html#cb168-133" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb168-134"><a href="training-deployment-pipeline-workflow.html#cb168-134" aria-hidden="true" tabindex="-1"></a><span class="co">        Compare trained models.</span></span>
<span id="cb168-135"><a href="training-deployment-pipeline-workflow.html#cb168-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-136"><a href="training-deployment-pipeline-workflow.html#cb168-136" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb168-137"><a href="training-deployment-pipeline-workflow.html#cb168-137" aria-hidden="true" tabindex="-1"></a><span class="co">            train_data_basic (dict): A dictionary containing the results of training the basic model.</span></span>
<span id="cb168-138"><a href="training-deployment-pipeline-workflow.html#cb168-138" aria-hidden="true" tabindex="-1"></a><span class="co">            train_data_resnet50 (dict): A dictionary containing the results of training the ResNet50 model.</span></span>
<span id="cb168-139"><a href="training-deployment-pipeline-workflow.html#cb168-139" aria-hidden="true" tabindex="-1"></a><span class="co">            train_data_crossval (dict): A dictionary containing the results of training the CrossVal model.</span></span>
<span id="cb168-140"><a href="training-deployment-pipeline-workflow.html#cb168-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-141"><a href="training-deployment-pipeline-workflow.html#cb168-141" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb168-142"><a href="training-deployment-pipeline-workflow.html#cb168-142" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: A dictionary containing the results of the model comparison.</span></span>
<span id="cb168-143"><a href="training-deployment-pipeline-workflow.html#cb168-143" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb168-144"><a href="training-deployment-pipeline-workflow.html#cb168-144" aria-hidden="true" tabindex="-1"></a>        compare_dict <span class="op">=</span> {</span>
<span id="cb168-145"><a href="training-deployment-pipeline-workflow.html#cb168-145" aria-hidden="true" tabindex="-1"></a>            train_data_basic[<span class="st">&quot;model_name&quot;</span>]: train_data_basic[<span class="st">&quot;run_id&quot;</span>],</span>
<span id="cb168-146"><a href="training-deployment-pipeline-workflow.html#cb168-146" aria-hidden="true" tabindex="-1"></a>            train_data_resnet50[<span class="st">&quot;model_name&quot;</span>]: train_data_resnet50[<span class="st">&quot;run_id&quot;</span>],</span>
<span id="cb168-147"><a href="training-deployment-pipeline-workflow.html#cb168-147" aria-hidden="true" tabindex="-1"></a>            train_data_crossval[<span class="st">&quot;model_name&quot;</span>]: train_data_crossval[<span class="st">&quot;run_id&quot;</span>],</span>
<span id="cb168-148"><a href="training-deployment-pipeline-workflow.html#cb168-148" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-149"><a href="training-deployment-pipeline-workflow.html#cb168-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-150"><a href="training-deployment-pipeline-workflow.html#cb168-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(compare_dict)</span>
<span id="cb168-151"><a href="training-deployment-pipeline-workflow.html#cb168-151" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> src.compare_models <span class="im">import</span> compare_models</span>
<span id="cb168-152"><a href="training-deployment-pipeline-workflow.html#cb168-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-153"><a href="training-deployment-pipeline-workflow.html#cb168-153" aria-hidden="true" tabindex="-1"></a>        serving_model_name, serving_model_uri, serving_model_version <span class="op">=</span> compare_models(input_dict<span class="op">=</span>compare_dict)</span>
<span id="cb168-154"><a href="training-deployment-pipeline-workflow.html#cb168-154" aria-hidden="true" tabindex="-1"></a>        return_dict <span class="op">=</span> {</span>
<span id="cb168-155"><a href="training-deployment-pipeline-workflow.html#cb168-155" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;serving_model_name&quot;</span>: serving_model_name,</span>
<span id="cb168-156"><a href="training-deployment-pipeline-workflow.html#cb168-156" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;serving_model_uri&quot;</span>: serving_model_uri,</span>
<span id="cb168-157"><a href="training-deployment-pipeline-workflow.html#cb168-157" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;serving_model_version&quot;</span>: serving_model_version,</span>
<span id="cb168-158"><a href="training-deployment-pipeline-workflow.html#cb168-158" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-159"><a href="training-deployment-pipeline-workflow.html#cb168-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> return_dict</span>
<span id="cb168-160"><a href="training-deployment-pipeline-workflow.html#cb168-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-161"><a href="training-deployment-pipeline-workflow.html#cb168-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">@task.kubernetes</span>(</span>
<span id="cb168-162"><a href="training-deployment-pipeline-workflow.html#cb168-162" aria-hidden="true" tabindex="-1"></a>        image<span class="op">=</span>skin_cancer_container_image,</span>
<span id="cb168-163"><a href="training-deployment-pipeline-workflow.html#cb168-163" aria-hidden="true" tabindex="-1"></a>        task_id<span class="op">=</span><span class="st">&quot;deploy_model_to_sagemaker_op&quot;</span>,</span>
<span id="cb168-164"><a href="training-deployment-pipeline-workflow.html#cb168-164" aria-hidden="true" tabindex="-1"></a>        namespace<span class="op">=</span><span class="st">&quot;airflow&quot;</span>,</span>
<span id="cb168-165"><a href="training-deployment-pipeline-workflow.html#cb168-165" aria-hidden="true" tabindex="-1"></a>        env_vars<span class="op">=</span>{</span>
<span id="cb168-166"><a href="training-deployment-pipeline-workflow.html#cb168-166" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;MLFLOW_TRACKING_URI&quot;</span>: MLFLOW_TRACKING_URI,</span>
<span id="cb168-167"><a href="training-deployment-pipeline-workflow.html#cb168-167" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ECR_REPOSITORY_NAME&quot;</span>: ECR_REPOSITORY_NAME,</span>
<span id="cb168-168"><a href="training-deployment-pipeline-workflow.html#cb168-168" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ECR_SAGEMAKER_IMAGE_TAG&quot;</span>: ECR_SAGEMAKER_IMAGE_TAG,</span>
<span id="cb168-169"><a href="training-deployment-pipeline-workflow.html#cb168-169" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb168-170"><a href="training-deployment-pipeline-workflow.html#cb168-170" aria-hidden="true" tabindex="-1"></a>        in_cluster<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-171"><a href="training-deployment-pipeline-workflow.html#cb168-171" aria-hidden="true" tabindex="-1"></a>        get_logs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb168-172"><a href="training-deployment-pipeline-workflow.html#cb168-172" aria-hidden="true" tabindex="-1"></a>        startup_timeout_seconds<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb168-173"><a href="training-deployment-pipeline-workflow.html#cb168-173" aria-hidden="true" tabindex="-1"></a>        service_account_name<span class="op">=</span><span class="st">&quot;airflow-sa&quot;</span>,</span>
<span id="cb168-174"><a href="training-deployment-pipeline-workflow.html#cb168-174" aria-hidden="true" tabindex="-1"></a>        secrets<span class="op">=</span>[</span>
<span id="cb168-175"><a href="training-deployment-pipeline-workflow.html#cb168-175" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ROLE_NAME_SAGEMAKER,</span>
<span id="cb168-176"><a href="training-deployment-pipeline-workflow.html#cb168-176" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_REGION,</span>
<span id="cb168-177"><a href="training-deployment-pipeline-workflow.html#cb168-177" aria-hidden="true" tabindex="-1"></a>            SECRET_AWS_ID,</span>
<span id="cb168-178"><a href="training-deployment-pipeline-workflow.html#cb168-178" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb168-179"><a href="training-deployment-pipeline-workflow.html#cb168-179" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb168-180"><a href="training-deployment-pipeline-workflow.html#cb168-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> deploy_model_to_sagemaker_op(serving_model_dict: <span class="bu">dict</span>):</span>
<span id="cb168-181"><a href="training-deployment-pipeline-workflow.html#cb168-181" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb168-182"><a href="training-deployment-pipeline-workflow.html#cb168-182" aria-hidden="true" tabindex="-1"></a><span class="co">        Deploys a machine learning model to Amazon SageMaker using the specified parameters.</span></span>
<span id="cb168-183"><a href="training-deployment-pipeline-workflow.html#cb168-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-184"><a href="training-deployment-pipeline-workflow.html#cb168-184" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb168-185"><a href="training-deployment-pipeline-workflow.html#cb168-185" aria-hidden="true" tabindex="-1"></a><span class="co">            serving_model_dict (dict): A dictionary containing information about the model to deploy.</span></span>
<span id="cb168-186"><a href="training-deployment-pipeline-workflow.html#cb168-186" aria-hidden="true" tabindex="-1"></a><span class="co">                It should contain the following keys:</span></span>
<span id="cb168-187"><a href="training-deployment-pipeline-workflow.html#cb168-187" aria-hidden="true" tabindex="-1"></a><span class="co">                    - &quot;serving_model_name&quot; (str): The name of the MLflow model to be deployed.</span></span>
<span id="cb168-188"><a href="training-deployment-pipeline-workflow.html#cb168-188" aria-hidden="true" tabindex="-1"></a><span class="co">                    - &quot;serving_model_uri&quot; (str): The URI or path to the MLflow model in artifact storage.</span></span>
<span id="cb168-189"><a href="training-deployment-pipeline-workflow.html#cb168-189" aria-hidden="true" tabindex="-1"></a><span class="co">                    - &quot;serving_model_version&quot; (str): The version of the MLflow model to deploy.</span></span>
<span id="cb168-190"><a href="training-deployment-pipeline-workflow.html#cb168-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-191"><a href="training-deployment-pipeline-workflow.html#cb168-191" aria-hidden="true" tabindex="-1"></a><span class="co">        Example:</span></span>
<span id="cb168-192"><a href="training-deployment-pipeline-workflow.html#cb168-192" aria-hidden="true" tabindex="-1"></a><span class="co">            serving_model_info = {</span></span>
<span id="cb168-193"><a href="training-deployment-pipeline-workflow.html#cb168-193" aria-hidden="true" tabindex="-1"></a><span class="co">                &quot;serving_model_name&quot;: &quot;my_mlflow_model&quot;,</span></span>
<span id="cb168-194"><a href="training-deployment-pipeline-workflow.html#cb168-194" aria-hidden="true" tabindex="-1"></a><span class="co">                &quot;serving_model_uri&quot;: &quot;s3://my-bucket/mlflow/models/my_model&quot;,</span></span>
<span id="cb168-195"><a href="training-deployment-pipeline-workflow.html#cb168-195" aria-hidden="true" tabindex="-1"></a><span class="co">                &quot;serving_model_version&quot;: &quot;1&quot;,</span></span>
<span id="cb168-196"><a href="training-deployment-pipeline-workflow.html#cb168-196" aria-hidden="true" tabindex="-1"></a><span class="co">            }</span></span>
<span id="cb168-197"><a href="training-deployment-pipeline-workflow.html#cb168-197" aria-hidden="true" tabindex="-1"></a><span class="co">            deploy_model_to_sagemaker_op(serving_model_info)</span></span>
<span id="cb168-198"><a href="training-deployment-pipeline-workflow.html#cb168-198" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb168-199"><a href="training-deployment-pipeline-workflow.html#cb168-199" aria-hidden="true" tabindex="-1"></a>        mlflow_model_name, mlflow_model_uri, mlflow_model_version <span class="op">=</span> (</span>
<span id="cb168-200"><a href="training-deployment-pipeline-workflow.html#cb168-200" aria-hidden="true" tabindex="-1"></a>            serving_model_dict[<span class="st">&quot;serving_model_name&quot;</span>],</span>
<span id="cb168-201"><a href="training-deployment-pipeline-workflow.html#cb168-201" aria-hidden="true" tabindex="-1"></a>            serving_model_dict[<span class="st">&quot;serving_model_uri&quot;</span>],</span>
<span id="cb168-202"><a href="training-deployment-pipeline-workflow.html#cb168-202" aria-hidden="true" tabindex="-1"></a>            serving_model_dict[<span class="st">&quot;serving_model_version&quot;</span>],</span>
<span id="cb168-203"><a href="training-deployment-pipeline-workflow.html#cb168-203" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb168-204"><a href="training-deployment-pipeline-workflow.html#cb168-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-205"><a href="training-deployment-pipeline-workflow.html#cb168-205" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;mlflow_model_name: </span><span class="sc">{</span>mlflow_model_name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb168-206"><a href="training-deployment-pipeline-workflow.html#cb168-206" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;mlflow_model_uri: </span><span class="sc">{</span>mlflow_model_uri<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb168-207"><a href="training-deployment-pipeline-workflow.html#cb168-207" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;mlflow_model_version: </span><span class="sc">{</span>mlflow_model_version<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb168-208"><a href="training-deployment-pipeline-workflow.html#cb168-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-209"><a href="training-deployment-pipeline-workflow.html#cb168-209" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> src.deploy_model_to_sagemaker <span class="im">import</span> deploy_model_to_sagemaker</span>
<span id="cb168-210"><a href="training-deployment-pipeline-workflow.html#cb168-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-211"><a href="training-deployment-pipeline-workflow.html#cb168-211" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> deploy_model_to_sagemaker(</span>
<span id="cb168-212"><a href="training-deployment-pipeline-workflow.html#cb168-212" aria-hidden="true" tabindex="-1"></a>            mlflow_model_name<span class="op">=</span>mlflow_model_name,</span>
<span id="cb168-213"><a href="training-deployment-pipeline-workflow.html#cb168-213" aria-hidden="true" tabindex="-1"></a>            mlflow_model_uri<span class="op">=</span>mlflow_model_uri,</span>
<span id="cb168-214"><a href="training-deployment-pipeline-workflow.html#cb168-214" aria-hidden="true" tabindex="-1"></a>            mlflow_model_version<span class="op">=</span>mlflow_model_version,</span>
<span id="cb168-215"><a href="training-deployment-pipeline-workflow.html#cb168-215" aria-hidden="true" tabindex="-1"></a>            mlflow_experiment_name<span class="op">=</span><span class="st">&quot;cnn_skin_cancer&quot;</span>,</span>
<span id="cb168-216"><a href="training-deployment-pipeline-workflow.html#cb168-216" aria-hidden="true" tabindex="-1"></a>            sagemaker_endpoint_name<span class="op">=</span><span class="st">&quot;test-cnn-skin-cancer&quot;</span>,</span>
<span id="cb168-217"><a href="training-deployment-pipeline-workflow.html#cb168-217" aria-hidden="true" tabindex="-1"></a>            sagemaker_instance_type<span class="op">=</span><span class="st">&quot;ml.t2.large&quot;</span>,</span>
<span id="cb168-218"><a href="training-deployment-pipeline-workflow.html#cb168-218" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb168-219"><a href="training-deployment-pipeline-workflow.html#cb168-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-220"><a href="training-deployment-pipeline-workflow.html#cb168-220" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Script run successfully: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>Finally, all the previously declared tasks are linked to form the Airflow Workflow DAG. The <code>cnn_skin_cancer_workflow</code> function is called at the end of the code respectively.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb169-1"><a href="training-deployment-pipeline-workflow.html#cb169-1" aria-hidden="true" tabindex="-1"></a>    preprocessed_data <span class="op">=</span> preprocessing_op(</span>
<span id="cb169-2"><a href="training-deployment-pipeline-workflow.html#cb169-2" aria-hidden="true" tabindex="-1"></a>        mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id,</span>
<span id="cb169-3"><a href="training-deployment-pipeline-workflow.html#cb169-3" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb169-4"><a href="training-deployment-pipeline-workflow.html#cb169-4" aria-hidden="true" tabindex="-1"></a>    train_data_basic <span class="op">=</span> model_training_op(</span>
<span id="cb169-5"><a href="training-deployment-pipeline-workflow.html#cb169-5" aria-hidden="true" tabindex="-1"></a>        mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id,</span>
<span id="cb169-6"><a href="training-deployment-pipeline-workflow.html#cb169-6" aria-hidden="true" tabindex="-1"></a>        model_class<span class="op">=</span>Model_Class.Basic.name,</span>
<span id="cb169-7"><a href="training-deployment-pipeline-workflow.html#cb169-7" aria-hidden="true" tabindex="-1"></a>        model_params<span class="op">=</span>model_params,</span>
<span id="cb169-8"><a href="training-deployment-pipeline-workflow.html#cb169-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span><span class="op">=</span>preprocessed_data,</span>
<span id="cb169-9"><a href="training-deployment-pipeline-workflow.html#cb169-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb169-10"><a href="training-deployment-pipeline-workflow.html#cb169-10" aria-hidden="true" tabindex="-1"></a>    train_data_resnet50 <span class="op">=</span> model_training_op(</span>
<span id="cb169-11"><a href="training-deployment-pipeline-workflow.html#cb169-11" aria-hidden="true" tabindex="-1"></a>        mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id,</span>
<span id="cb169-12"><a href="training-deployment-pipeline-workflow.html#cb169-12" aria-hidden="true" tabindex="-1"></a>        model_class<span class="op">=</span>Model_Class.ResNet50.name,</span>
<span id="cb169-13"><a href="training-deployment-pipeline-workflow.html#cb169-13" aria-hidden="true" tabindex="-1"></a>        model_params<span class="op">=</span>model_params,</span>
<span id="cb169-14"><a href="training-deployment-pipeline-workflow.html#cb169-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span><span class="op">=</span>preprocessed_data,</span>
<span id="cb169-15"><a href="training-deployment-pipeline-workflow.html#cb169-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb169-16"><a href="training-deployment-pipeline-workflow.html#cb169-16" aria-hidden="true" tabindex="-1"></a>    train_data_crossval <span class="op">=</span> model_training_op(</span>
<span id="cb169-17"><a href="training-deployment-pipeline-workflow.html#cb169-17" aria-hidden="true" tabindex="-1"></a>        mlflow_experiment_id<span class="op">=</span>mlflow_experiment_id,</span>
<span id="cb169-18"><a href="training-deployment-pipeline-workflow.html#cb169-18" aria-hidden="true" tabindex="-1"></a>        model_class<span class="op">=</span>Model_Class.CrossVal.name,</span>
<span id="cb169-19"><a href="training-deployment-pipeline-workflow.html#cb169-19" aria-hidden="true" tabindex="-1"></a>        model_params<span class="op">=</span>model_params,</span>
<span id="cb169-20"><a href="training-deployment-pipeline-workflow.html#cb169-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span><span class="op">=</span>preprocessed_data,</span>
<span id="cb169-21"><a href="training-deployment-pipeline-workflow.html#cb169-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb169-22"><a href="training-deployment-pipeline-workflow.html#cb169-22" aria-hidden="true" tabindex="-1"></a>    compare_models_dict <span class="op">=</span> compare_models_op(train_data_basic, train_data_resnet50, train_data_crossval)</span>
<span id="cb169-23"><a href="training-deployment-pipeline-workflow.html#cb169-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-24"><a href="training-deployment-pipeline-workflow.html#cb169-24" aria-hidden="true" tabindex="-1"></a>    deploy_model_to_sagemaker_op(compare_models_dict)</span>
<span id="cb169-25"><a href="training-deployment-pipeline-workflow.html#cb169-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-26"><a href="training-deployment-pipeline-workflow.html#cb169-26" aria-hidden="true" tabindex="-1"></a>cnn_skin_cancer_workflow()</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="integrated-development-environment-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="training-pipeline-steps.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/seblum/kubernetes-training/edit/master/09.2-Deployment-Usage_Pipeline-Workflow.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
